![avatar](../../images/openGauss.png)

版权所有 © 2022  openGauss社区
您对“本文档”的复制、使用、修改及分发受知识共享(Creative Commons)署名—相同方式共享4.0国际公共许可协议(以下简称“CC BY-SA 4.0”)的约束。为了方便用户理解，您可以通过访问https://creativecommons.org/licenses/by-sa/4.0/ 了解CC BY-SA 4.0的概要 (但不是替代)。CC BY-SA 4.0的完整协议内容您可以访问如下网址获取：https://creativecommons.org/licenses/by-sa/4.0/legalcode。

修订记录

| 日期       | 修订版本 | 修改描述             | 作者      |
| ---------- | -------- | -------------------- | --------- |
| 2022-09-15 | 1.0      | 特性测试报告初稿完成 | zhanghang |
| 2022-09-16 | 1.1      | 修改评审意见         | zhanghang |
|            |          |                      |           |

关键词： 

kafka；debezium；onlineMigration；`O*`；openGauss；在线迁移；数据类型

摘要：

在线迁移工具由`O*`（生产端），debezium，kafka， onlineMigration，openGauss（消费端）这几部分组成，本文档针对在线迁移工具支持在线迁移常用数据类型进行测试。本次测试是对迁移工具实现的12种数据类型（LONG，LONG RAW，RAW，XML，JSON，OBJECT，VARRAYS，URITYPE，HTTPURITYPE，XDBURITYPE，SDO_GEOMETRY，SDO_TOPO_GEOMETRY）的增、删、改操作从`O*`在线迁移到openGauss特性的测试。

缩略语清单：

| 缩略语 | 英文全名 | 中文解释 |
| ------ | -------- | -------- |
| NA     |          |          |

# 1     特性概述

openGauss在兼容A库情形下，依次开启kafka、kafka_connector、onlineMigration工具，由debezium监控`O*`中DML语句并把记录捕捉到kafka的topic中，然后通过onlineMigration消费topic中的记录并迁移到openGauss数据库中，完成从`O*`到openGauss的在线迁移。

本特性支持12种常用数据类型（LONG，LONG RAW，RAW，XML，JSON，OBJECT，VARRAYS，URITYPE，HTTPURITYPE，XDBURITYPE，SDO_GEOMETRY，SDO_TOPO_GEOMETRY）迁移，即在线迁移阶段，`O*`侧的常用数据类型能够同步到openGauss侧并成功执行。

# 2     特性测试信息

| 版本名称                       | 测试起始时间 | 测试结束时间 |
| ------------------------------ | ------------ | ------------ |
| openGauss 3.0.0 build 02c14696 | 2022-08-29   | 2022-09-08   |
| openGauss 3.1.0 build b4215eeb | 2022-09-08   | 2022-09-15   |
| `O*` version 19.3.0.0.0        | 2022-08-29   | 2022-09-09   |
| kafka v2.13-2.8.1              | 2022-08-29   | 2022-09-09   |
| debezium v1.8.1 db65f71        | 2022-08-29   | 2022-09-14   |
| debezium v1.8.1 041ae64        | 2022-09-14   | 2022-09-15   |
| onlineMigration v1.0 fb0500b   | 2022-08-29   | 2022-09-14   |
| onlineMigration v1.0 3fd4be6   | 2022-09-14   | 2022-09-15   |

| 环境信息 | 配置信息                                                     | 备注 |
| -------- | ------------------------------------------------------------ | ---- |
| 虚拟机   | CPU：Intel(R) Xeon(R) Platinum 8378A CPU @ 3.00GHz<br>内存：30GB<br>硬盘：59GB<br>OS：CentOS Linux release 7.6.1810 (Core) |      |

# 3     测试结论概述

## 3.1   测试整体结论

在线迁移工具支持在线迁移常用数据类型共计执行30条用例，主要覆盖了功能测试及资料测试。功能测试主要覆盖以下14个方面：

1. 表中含12种数据类型中的一种数据类型，且表有主键，`O*`侧进行增删改操作
2. 表中含12种数据类型中的多种数据类型，且表有主键，`O*`侧进行增删改操作
3. 表中含12种数据类型中的多种数据类型，且表有联合主键，`O*`侧进行增删改操作
4. 表中含12种数据类型中的多种数据类型，`O*`侧和openGauss侧表的主键列不一致，`O*`侧进行增删改操作
5. 表中含12种数据类型中的多种数据类型，`O*`侧有主键，openGauss侧无主键，`O*`侧进行增删改操作
6. 表中含12种数据类型中的多种数据类型，`O*`侧无主键，openGauss侧有主键，`O*`侧进行增删改操作
7. 表中含12种数据类型中的多种数据类型，且表无主键，`O*`侧进行增删改操作
8. `O*`侧增改操作包含与数据类型不符的数据
9. `O*`侧提前建表，开启在线迁移后openGauss侧建表，执行DML语句
10. openGauss侧提前建表，开启在线迁移后`O*`侧建表，执行DML语句
11. 两端数据库无表，开启在线迁移后`O*`侧建表，查看表是否迁移
12. 两端数据库无表，开启在线迁移后openGauss侧先建表，`O*`侧建表并执行DML语句
13. `O*`侧在事务中嵌套DML语句，查看语句执行顺序及结果
14. openGauss侧验证DML语句

资料测试主要验证资料的描述的准确性以及示例的正确性。

测试中共计发现问题单3个，3个问题单均已修复且回归通过，无遗留风险，整体质量良好。

| 测试活动 | 活动评价                                                     |
| -------- | ------------------------------------------------------------ |
| 功能测试 | 表中含12种数据类型中的一种数据类型，且表有主键，`O*`侧进行增删改操作，通过 |
| 功能测试 | 表中含12种数据类型中的多种数据类型，且表有主键，`O*`侧进行增删改操作，通过 |
| 功能测试 | 表中含12种数据类型中的多种数据类型，且表有联合主键，`O*`侧进行增删改操作，通过 |
| 功能测试 | 表中含12种数据类型中的多种数据类型，`O*`侧和openGauss侧表的主键列不一致，`O*`侧进行增删改操作，通过 |
| 功能测试 | 表中含12种数据类型中的多种数据类型，`O*`侧有主键，openGauss侧无主键，`O*`侧进行增删改操作，通过 |
| 功能测试 | 表中含12种数据类型中的多种数据类型，`O*`侧无主键，openGauss侧有主键，`O*`侧进行增删改操作，通过 |
| 功能测试 | 表中含12种数据类型中的多种数据类型，且表无主键，`O*`侧进行增删改操作，通过 |
| 功能测试 | `O*`侧增改操作包含与数据类型不符（不能隐式转换）的数据，通过 |
| 功能测试 | `O*`侧增改操作包含与数据类型不符（能隐式转换）的数据，通过   |
| 功能测试 | `O*`侧提前建表，开启在线迁移后openGauss侧建表，依次执行DML语句，通过 |
| 功能测试 | openGauss侧提前建表，开启在线迁移后`O*`侧建表，依次执行DML语句，通过 |
| 功能测试 | 两端数据库无表，开启在线迁移后`O*`侧建表，查看表是否迁移，通过 |
| 功能测试 | 两端数据库无表，开启在线迁移后openGauss侧先建表，`O*`侧建表并执行DML语句，通过 |
| 功能测试 | `O*`侧在事务中嵌套DML语句，查看语句执行顺序及结果，通过      |
| 功能测试 | openGauss侧验证DML语句，通过                                 |
| 资料测试 | 资料描述准确，示例执行无误，整体质量良好                     |

## 3.2   约束说明

1. openGauss数据库为兼容A库
2. `O*`数据库版本为19.3.0.0.0
3. `O*`及openGauss两端数据库需有同名schema，如“C##DBZUSER”
4. 开启zookeeper、kafka、kafka_connector、onlineMigration工具并保证正常运行，连接使用xstream方式
5. `O*`数据库和openGauss数据库需要提前建表
6. openGauss中xml功能默认未开启，如需使用，需要重新使用build.sh脚本编译数据库，修改./configure配置参数，在其中加入–with-libxml参数
7. OBJECT数据类型的属性嵌套数组类型时，数组类型的元素数量必须大于1
8. 目前SDO_GEOMETRY、SDO_TOPO_GEOMETRY类型在opengGauss端以JSON方式存储
9. 当表中有以下类型：LONG、LONG RAW、XML、JSON、OBJECT、VARRAYS、URITYPE、HTTPURITYPE、XDBURITYPE、SDO_GEOMETRY、SDO_TOPO_GEOMETRY，必须有其他类型列作为主键，否则会出现更新或删除迁移报错
10. 关闭迁移工具后需更改kafka_connector连接名或清空kafka日志

## 3.3   遗留问题分析

### 3.3.1 遗留问题影响以及规避措施

| 问题单号 | 问题描述 | 问题级别 | 问题影响和规避措施 | 当前状态 |
| -------- | -------- | -------- | ------------------ | -------- |
| NA       |          |          |                    |          |

### 3.3.2 问题统计

|        | 问题总数 | 严重 | 主要 | 次要 | 不重要 |
| ------ | -------- | ---- | ---- | ---- | ------ |
| 数目   | 3        | 0    | 0    | 3    | 0      |
| 百分比 | 100%     | 0%   | 0%   | 100% | 0%     |

### 3.3.3  问题单汇总

| 序号 | issue号                                                      | 级别 | 问题简述                                                     | 状态   |
| ---- | ------------------------------------------------------------ | ---- | ------------------------------------------------------------ | ------ |
| 1    | [I5QJJY](https://gitee.com/openGauss/openGauss-tools-onlineMigration/issues/I5QJJY?from=project-issue) | 次要 | 在线迁移工具插入含xmltype类型数据进行迁移，迁移至openGauss的数据类型与预期不符 | 已验收 |
| 2    | [I5QJFG](https://gitee.com/openGauss/openGauss-tools-onlineMigration/issues/I5QJFG?from=project-issue) | 次要 | 执行资料中sdo_topo_geometry数据类型的用例，执行迁移失败      | 已取消 |
| 3    | [I5Q03A](https://gitee.com/openGauss/openGauss-tools-onlineMigration/issues/I5Q03A?from=project-issue) | 次要 | 补充完善onlineMigration及相关工具的资料                      | 已验收 |

# 4     测试执行

## 4.1   测试执行步骤

### 4.1.1 功能测试

#### 4.1.1.1 表中含12种数据类型中的一种数据类型，且表有主键

| 测试步骤                                                     | 测试结果                                     |
| ------------------------------------------------------------ | -------------------------------------------- |
| 前置条件：两端数据库中提前建表后开启在线迁移，表中含12种数据类型中的一种数据类型，表有主键，主键列一致<br />1.`O*`侧增删改数据<br />2.openGauss侧查询<br />3.openGauss侧执行DML语句 | 执行12条用例，发现1个bug，现已修复且验收通过 |

#### 4.1.1.2 表中含12种数据类型中的多种数据类型，且表有主键

| 测试步骤                                                     | 测试结果                             |
| ------------------------------------------------------------ | ------------------------------------ |
| 前置条件：两端数据库中提前建表后开启在线迁移，表中含12种数据类型中的多种数据类型，表有主键，主键列一致<br />1.`O*`侧增删改数据<br />2.openGauss侧查询<br />3.openGauss侧执行DML语句 | 执行1条用例，未发现bug，结果符合预期 |

#### 4.1.1.3 表中含12种数据类型中的多种数据类型，且表有联合主键

| 测试步骤                                                     | 测试结果                             |
| ------------------------------------------------------------ | ------------------------------------ |
| 前置条件：两端数据库中提前建表后开启在线迁移，表中含12种数据类型中的多种数据类型，表有联合主键，主键列一致<br />1.`O*`侧增删改数据<br />2.openGauss侧查询<br />3.openGauss侧执行DML语句 | 执行1条用例，未发现bug，结果符合预期 |

#### 4.1.1.4 `O*`侧和openGauss侧表的主键列不一致

| 测试步骤                                                     | 测试结果                             |
| ------------------------------------------------------------ | ------------------------------------ |
| 前置条件：两端数据库中提前建表后开启在线迁移，表中含12种数据类型中的多种数据类型，表有主键，表的主键列不一致<br />1.`O*`侧增删改数据<br />2.openGauss侧查询<br />3.openGauss侧执行DML语句 | 执行1条用例，未发现bug，结果符合预期 |

#### 4.1.1.5 `O*`侧有主键，openGauss侧无主键

| 测试步骤                                                     | 测试结果                             |
| ------------------------------------------------------------ | ------------------------------------ |
| 前置条件：两端数据库中提前建表后开启在线迁移，表中含12种数据类型中的多种数据类型，`O*`侧有主键，openGauss侧无主键<br />1.`O*`侧增删改数据<br />2.openGauss侧查询<br />3.openGauss侧执行DML语句 | 执行1条用例，未发现bug，结果符合预期 |

#### 4.1.1.6 `O*`侧无主键，openGauss侧有主键

| 测试步骤                                                     | 测试结果                             |
| ------------------------------------------------------------ | ------------------------------------ |
| 前置条件：两端数据库中提前建表后开启在线迁移，表中含12种数据类型中的多种数据类型，`O*`侧无主键，openGauss侧有主键<br />1.`O*`侧增删改数据<br />2.openGauss侧查询<br />3.openGauss侧执行DML语句 | 执行1条用例，未发现bug，结果符合预期 |

#### 4.1.1.7 `O*`侧和openGauss侧表无主键

| 测试步骤                                                     | 测试结果                             |
| ------------------------------------------------------------ | ------------------------------------ |
| 前置条件：两端数据库中提前建表后开启在线迁移，表中含12种数据类型中的多种数据类型，表无主键<br />1.`O*`侧增删改数据<br />2.openGauss侧查询<br />3.openGauss侧执行DML语句 | 执行2条用例，未发现bug，结果符合预期 |

#### 4.1.1.8 `O*`侧增改操作包含与数据类型不符的数据

| 测试步骤                                                     | 测试结果                             |
| ------------------------------------------------------------ | ------------------------------------ |
| 前置条件：两端数据库中提前建表后开启在线迁移，表中含12种数据类型中的多种数据类型，表有主键，主键列一致<br />1.`O*`侧增删改数据<br />2.openGauss侧查询<br />3.openGauss侧执行DML语句 | 执行2条用例，未发现bug，结果符合预期 |

#### 4.1.1.9 `O*`侧提前建表，开启在线迁移后openGauss侧建表

| 测试步骤                                                     | 测试结果                             |
| ------------------------------------------------------------ | ------------------------------------ |
| 前置条件：`O*`侧提前建表后开启在线迁移，表中含12种数据类型中的多种数据类型，表有主键<br />1.openGauss侧建表<br />2.`O*`侧增删改数据<br />3.openGauss侧查询<br />4.openGauss侧执行DML语句 | 执行1条用例，未发现bug，结果符合预期 |

#### 4.1.1.10 openGauss侧提前建表，开启在线迁移后`O*`侧建表

| 测试步骤                                                     | 测试结果                             |
| ------------------------------------------------------------ | ------------------------------------ |
| 前置条件：openGauss侧提前建表后开启在线迁移，表中含12种数据类型中的多种数据类型，表有主键<br />1.`O*`侧建表<br />2.`O*`侧增删改数据<br />3.openGauss侧查询<br />4.openGauss侧执行DML语句 | 执行1条用例，未发现bug，结果符合预期 |

#### 4.1.1.11 开启在线迁移后`O*`侧建表，查看表是否迁移

| 测试步骤                                                     | 测试结果                             |
| ------------------------------------------------------------ | ------------------------------------ |
| 前置条件：两端数据库无表，开启在线迁移<br />1.`O*`侧建表<br />2.openGauss侧查询表是否存在 | 执行1条用例，未发现bug，结果符合预期 |

#### 4.1.1.12 开启在线迁移后openGauss侧先建表，`O*`侧建表后执行DML语句

| 测试步骤                                                     | 测试结果                             |
| ------------------------------------------------------------ | ------------------------------------ |
| 前置条件：两端数据库无表，开启在线迁移<br />1.openGauss侧建表<br />2.`O*`侧建表，onlineMigration中合理报错<br />3.`O*`侧增删改数据<br />4.openGauss侧查询<br />5.openGauss侧执行DML语句 | 执行1条用例，未发现bug，结果符合预期 |

#### 4.1.1.13 `O*`侧在事务中嵌套DML语句，查看语句执行顺序及结果

| 测试步骤                                                     | 测试结果                             |
| ------------------------------------------------------------ | ------------------------------------ |
| 前置条件：两端数据库中提前建表后开启在线迁移，表中含12种数据类型中的多种数据类型，表有主键，主键列一致<br />1.`O*`侧事务中嵌套DML语句并执行<br />2.onlineMigration中查看语句执行顺序<br />3.openGauss侧查询 | 执行1条用例，未发现bug，结果符合预期 |

#### 4.1.1.14 openGauss侧验证DML语句

| 测试步骤                                                     | 测试结果                             |
| ------------------------------------------------------------ | ------------------------------------ |
| 前置条件：两端数据库中提前建表后开启在线迁移，表中含12种数据类型中的多种数据类型，表有主键，主键列一致<br />1.`O*`侧增删改数据<br />2.openGauss侧查询<br />3.openGauss侧执行DML语句 | 执行2条用例，未发现bug，结果符合预期 |

### 4.1.2 资料测试

| 测试步骤                                                | 测试结果                          |
| ------------------------------------------------------- | --------------------------------- |
| 1. 资料是否描述准确，示例执行无误<br />2.资料是否描完整 | 共发现2个bug，2个已修复且验收通过 |

## 4.2   测试执行统计数据

| 版本名称                                                     | 测试用例数 | 用例执行结果               | 发现问题单数 |
| ------------------------------------------------------------ | ---------- | -------------------------- | ------------ |
| openGauss 3.0.0 build 02c14696<br/>openGauss 3.1.0 build b4215eeb<br/>debezium v1.8.1 db65f71<br />onlineMigration v1.0 fb0500b | 30         | Passed：18<br />Failed：12 | 3            |
| openGauss 3.1.0 build b4215eeb<br/>debezium v1.8.1 db65f71<br />onlineMigration v1.0 fb0500b | 30         | Passed：30<br />Failed：0  | 0            |

数据项说明

1. 共发现3个问题，3个问题单均已修复且回归通过
2. 失败用例已在后续问题修复后，回归issue执行通过
3. 缺陷密度：3个(缺陷个数)/1.583kloc(代码行数)=1.9(个/kloc)

## 4.3   后续测试建议

1. 验证是否所有可隐式转换的类型的数据都可以迁移成功
2. 关注xstream连接方式下，已实现的DDL语句是否全部支持迁移

# 5     附件

### 5.1 在线迁移工具支持在线迁移long数据类型过程示例

```sql
--pre_step:`O*`和openGauss侧建表，开启在线迁移;except:建表成功，开启在线迁移
--`O*`侧建表  
create table t_type_0001 (
	col01 int primary key,
	col02 long,
	col03 varchar(255)
);
commit;
--openGauss侧建表
CREATE TABLE "T_TYPE_0001" (
    "COL01" INT PRIMARY KEY,
    "COL02" TEXT,
    "COL03" VARCHAR(255)
);
--开启在线迁移
依次开启kafka、kafka_connector、onlineMigration工具

--step1:`O*`侧插入数据;except:迁移成功
insert into t_type_0001(col01,col02,col03) values(1, 'long', '05qd5a7f8e6b213');
insert into t_type_0001 values(2,'longtype','ioagsduhbn15696247');
commit;
--step2:openGauss侧查询;except:表中查询到数据
select * from "T_TYPE_0001";
--step3:`O*`侧更新数据;except:迁移成功
update t_type_0001 set col03 = 'new05qd5a7f8e6b213' where col01 = 1;
commit;
--step4:openGauss侧查询;except:表中查询到数据
select * from "T_TYPE_0001";
--step5:`O*`侧删除数据;except:迁移成功
delete from t_type_0001 where col01 = 2;
commit;
--step6:openGauss侧查询;except:表中查询到数据
select * from "T_TYPE_0001";
--step7:openGauss侧对表进行插入、更新、删除;except:插入、更新、删除成功
insert into "T_TYPE_0001" values (10, 'long数据类型', 'varchar数据类型');
select * from "T_TYPE_0001";
update "T_TYPE_0001" set "COL01" = 3 where "COL01" = 10;
select * from "T_TYPE_0001";
delete from "T_TYPE_0001" where "COL01" = 3;
select * from "T_TYPE_0001";
truncate table "T_TYPE_0001";
```