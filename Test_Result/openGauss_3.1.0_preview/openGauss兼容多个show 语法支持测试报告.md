![avatar](../../images/openGauss.png)

版权所有 © 2022  openGauss社区
 您对“本文档”的复制、使用、修改及分发受知识共享(Creative Commons)署名—相同方式共享4.0国际公共许可协议(以下简称“CC BY-SA 4.0”)的约束。为了方便用户理解，您可以通过访问https://creativecommons.org/licenses/by-sa/4.0/ 了解CC BY-SA 4.0的概要 (但不是替代)。CC BY-SA 4.0的完整协议内容您可以访问如下网址获取：https://creativecommons.org/licenses/by-sa/4.0/legalcode。

修订记录

| 日期       | 修订   版本 | 修改描述             | 作者       |
| ---------- | ----------- | -------------------- | ---------- |
| 2022-09-27 | 1.0         | 特性测试报告初稿完成 | yangruolan |
| 2022-09-29 | 1.1         | 根据评审意见修改测试报告 | yangruolan |

 关键词： 

show grants 、 mysql、dolphin插件、兼容B库

摘要：

本文档主要对openGauss兼容多个show语法进行测试，并给出测试报告。

缩略语清单：

| 缩略语 | 英文全名 | 中文解释 |
| ------ | -------- | -------- |
| N/A    |          |          |

# 1 特性概述

openGauss兼容包括show grants/show function status、show procedure status、show triggers语法，show grants是查询用户权限，共3中，分别为anyprivilege权限、acl权限、角色权限，anyprivilege是依据角色ID、权限类型、admin_option语句拼接出的赋权语句，在gs_db_privilege表中获取数据，*acl记录各个用户的访问权限，角色权限主要储存在pg_authid里；show grants查询对象为表/视图/序列/数据库/域/数据封装器/外部服务器/函数/过程语言等等；show function status主要是查询函数名/函数创建时间/修改时间/安全类型/注释等函数信息；show procedure status主要是查询存储过程名/创建时间/修改时间等存储过程的信息；show triggers主要是查看触发器名字/出发事件/触发器定义的表、内容、时机等信息。

# 2 特性测试信息

| 版本名称                       | 测试起始时间 | 测试结束时间 |
| ------------------------------ | ------------ | ------------ |
| openGauss 3.0.0 build 801d945a | 2022-09-23  | 2022-09-27   |
|                                |              |              |

| 环境信息 | 配置信息                                                     | 备注 |
| -------- | ------------------------------------------------------------ | ---- |
| 虚拟机   | CPU：Intel(R) Xeon(R) Gold 6278C CPU @ 2.60GHz<br />内存：31GB<br />硬盘：100GB<br />OS：CentOS Linux release 7.6.1810 (Core) |      |

# 3  测试结论概述

## 3.1 测试整体结论

openGauss兼容多个语法共计执行用例30条，主要覆盖功能测试和资料测试。功能测试主要是用show grants语法对用户权限和函数/存储过程/触发器的相关信息进行显示。资料测试覆盖校验资料的描述是否正确，示例的执行结果是否成功。累计发现问题单2个，1个问题已解决并回归通过，1个问题已解决待转测回归，无遗留风险，整体质量良好。

| 测试活动 | 活动评价                                                     |
| -------- | ------------------------------------------------------------ |
| 功能测试 | 对表/视图/序列/数据库/域/数据封装器/外部服务器/函数/过程语言等对象的信息进行查询显示，通过 |
| 功能测试 | 用户的权限进行grant和revoke操作后，用show grants进行查询，通过 |
| 功能测试 | 对函数的函数名/函数创建时间/修改时间/安全类型/注释等函数信息进行查询显示，通过 |
| 功能测试 | 对存储过程名/创建时间/修改时间等存储过程的信息进行查询显示，通过 |
| 功能测试 | 对触发器名字/出发事件/触发器定义的表、内容、时机等信息进行查询显示，通过 |
| 资料测试 | 资料描述完整准确，示例执行结果正确，整体质量良好             |

## 3.2 约束说明

1. 普通用户得先获取pg_authid存储表的访问权限才能对初始用户或管理员用户的权限进行查询；
2. 外部数据源(data source)和目录(directory)的创建者必须是sysadmin或者初始用户；
3. 测试对象globe_setting和column_setting建立之前需要在在etc目录下创建一个localkms文件夹,然后创建客户端主密钥对象(client master key)和列加密密钥(column encrytion)进行测试；
4. 同一个schema下用show grants很难看出权限变化，建议用通过权限存储表查看对象的acl权限变化进行比对，看权限授予和撤销是否合法。

## 3.3  遗留问题分析

### 3.3.1 遗留问题影响以及规避措施

| 问题单号 | 问题描述 | 问题级别 | 问题影响和规避措施 | 当前状态 |
| -------- | -------- | -------- | ------------------ | -------- |
| N/A      |          |          |                    |          |

### 3.3.2 问题统计

|        | 问题总数 | 严重 | 主要 | 次要 | 不重要 |
| ------ | -------- | ---- | ---- | ---- | ------ |
| 数目   | 2        | 0    | 0    | 2    | 0      |
| 百分比 | 100%     | 0    | 0    | 100% | 0      |

### 3.3.3 问题单汇总

| 序号 | issue号                                                      | 问题级别 | 问题简述                                                     | 问题状态 |
| ---- | ------------------------------------------------------------ | -------- | ------------------------------------------------------------ | -------- |
| 1    | [I5SMPK](https://gitee.com/opengauss/openGauss-server/issues/I5SMPK) | 次要     | truncate事件触发器，使用show triggers语句查询不到触发器且所有触发器Created字段显示有误 | 已验收   |
| 2    | [I5TSFC](https://gitee.com/opengauss/openGauss-server/issues/I5TSFC) | 次要     | show grants 用户的CMK或者CEK权限时，数据库会挂库 | 已完成   |

# 4 测试执行

## 4.1 功能测试

#### 4.1.1 对表/视图/序列/数据库/域/函数/过程语言等对象的信息进行查询显示

| 测试步骤                                                     | 测试结果                      |
| ------------------------------------------------------------ | ----------------------------- |
| 1.新建普通用户或管理员用户<br/>2.新建表/视图/序列/数据库/域/数据封装器/外部服务器/函数/过程语言等测试对象<br/>3.对测试对象进行show grants查询信息验证<br/> | 执行9条用例，发现1个bug，已解决待转测 |

#### 4.1.2 用户的权限进行grant和revoke操作后，用show grants进行查询测试

| 测试步骤                                                     | 测试结果                      |
| ------------------------------------------------------------ | ----------------------------- |
| 1.新建普通用户、管理员用户、监控管理员用户<br/>2.对用户进行show grants查询信息验证<br/> | 执行6条用例，执行结果符合预期 |

#### 4.1.3 对存储过程名/创建时间/修改时间等存储过程的信息进行查询显示测试

| 测试步骤：                                                   | 测试结果                      |
| ------------------------------------------------------------ | ----------------------------- |
| 1.新建存储过程<br/>2.对存储过程进行show grants查询相关信息验证<br/> | 执行2条用例，执行结果符合预期 |

#### 4.1.4 对函数的函数名/函数创建时间/修改时间/安全类型等函数信息进行查询显示测试

| 测试步骤：                                                   | 测试结果                      |
| ------------------------------------------------------------ | ----------------------------- |
| 1.新建函数<br/>2.对函数进行show grants查询相关信息验证<br/> | 执行3条用例，执行结果符合预期 |

#### 4.1.5 对触发器名字/出发事件/触发器定义的表、内容、时机等信息进行查询显示测试

| 测试步骤：                                                   | 测试结果                       |
| ------------------------------------------------------------ | ------------------------------ |
| 1.新建触发器<br/>2.对触发器进行show grants查询相关信息验证<br/> | 执行10条用例，发现1个bug，已修复且验收通过|

### 4.4 测试执行统计数据

| 版本名称                       | 测试用例数 | 用例执行结果              | 发现问题单数 |
| ------------------------------ | ---------- | ------------------------- | ------------ |
| openGauss 3.0.0 build 801d945a |     30      | Passed：28<br />Failed：2 | 2           |
| openGauss 3.1.0 build 2c0ccaf9 |     1       | Passed：1<br />Failed：0 | 0           |

数据说明

1.  测试过程中共发现2个bug，2个已解决，1个回归通过，1个已解决待转测；
2.  缺陷密度为2（缺陷个数）/1.309k（代码行数）=1.528（个/kloc）；

### 4.5 后续测试建议

## 5 附件

##  5.1 show grants查询用户权限执行结果

```sql
--新建普通用户
test_yat=# create user u_sg_tester08 identified by 'password@123'; 
CREATE ROLE 
test_yat=# set session authorization u_sg_tester08 password 'password@123'; 
SET  
test_yat=> show grants for 'u_sg_tester08'; 
               Grants
------------------------------------- 
ALTER ROLE u_sg_tester08 WITH LOGIN 
(1 row)

--授予普通用户创建和修改任何表的权限
test_yat=> reset session authorization; 
test_yat=#grant create any table,alter any table to u_sg_tester08;

--用show grants查询用户权限
test_yat=# show grants for 'u_sg_tester08'; 
               Grants
------------------------------------- 
GRANT alter any table TO u_sg_tester08;
GRANT create any table TO u_sg_tester08;
ALTER ROLE u_sg_tester08 WITH LOGIN 
(3 rows)
```

