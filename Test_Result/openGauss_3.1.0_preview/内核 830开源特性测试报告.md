![avatar](../../images/openGauss.png)

版权所有 © 2022  openGauss社区
您对“本文档”的复制、使用、修改及分发受知识共享(Creative Commons)署名—相同方式共享4.0国际公共许可协议(以下简称“CC BY-SA 4.0”)的约束。为了方便用户理解，您可以通过访问https://creativecommons.org/licenses/by-sa/4.0/ 了解CC BY-SA 4.0的概要 (但不是替代)。CC BY-SA 4.0的完整协议内容您可以访问如下网址获取：https://creativecommons.org/licenses/by-sa/4.0/legalcode。

修订记录

| 日期       | 修订   版本 | 修改描述             | 作者 |
| ---------- | ----------- | -------------------- | ---- |
| 2022-09-06 | 1.0         | 特性测试报告初稿完成 |   张长军，附雄道 |

关键词：

测试报告

摘要：

主要描述了 openGauss内核特性开源整体测试情况，给出本阶段的测试范围、结果、分析、以及质量评价

缩略语清单：

| 缩略语 | 英文全名                    | 中文解释       |
| ------ | --------------------------- | -------------- |
| DML    | Data  Manipulation Language | 数据操纵语言   |
| DDL    | Data Manipulation Language  | 数据操纵语言   |
| DCL    | Data Definition Language    | 数据定义语言   |
| DQL    | Data Control Language       | 数据控制语言   |
| DFX    | Data Query Language         | 数据查询语言   |
| CI     | Design for X                | 面向X的设计    |
| SDV    | Continuous Integration      | 持续集成       |
| SIT    | System Design Verification  | 系统设计验证   |

# 1     特性概述

该特性支持了支持细粒度Any权限增强ANY权限管、支持行存表和索引压缩、DCF策略化多数派，基础算子性能提升，DBMind自治运维平台，智能优化器，M*兼容性，流式容灾。

# 2     特性测试信息

本节描述被测对象的版本信息和测试的时间及测试轮次，包括依赖的硬件。

## 2.1 测试版本信息

gaussdb(openGauss 3.0.0 build f1d0d1a9) compiled at 2022-08-31 20:51:44 commit 256 last mr 5814 release 

## 2.2 硬件环境信息

| 硬件型号 | 硬件配置信息                                             | 备注 |
| -------- | -------------------------------------------------------- | ---- |
| 物理机   | CPU: 48核 ``内存：256GB``OS：CentOS Linux 7 (Core)       |      |
| 虚拟机   | CPU: 8核 ``内存：30GB``OS：openEuler release 20.03 (LTS) |      |


# 3     测试结论概述

## 3.1   测试整体结论

主要针对上个版本的风险特性、以及本版本的目标客户场景进行补充测试。SDV阶段重点开展新增特性的功能测试。新增测试用例执行覆盖率100%，问题均已回归通过。

| 测试活动 | 活动评价                                                                                                                                                                                                                                                                                 |
| -------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 接口测试 | 版本所有新增需求的代码覆盖率，DT覆盖率，相比于基线不劣化。此外，对新增代码进行分析，识别出高风险模块。高风险模块均开展人工代码检视。参照白盒DT Fuzz测试策略，对计划开展DT Fuzz的高风险模块均完成DT Fuzz测试。版本测试活动覆盖全量模块和接口，版本全量自动化测试用例的HLT代码行覆盖率达标 |
| 功能测试 | 运维OM相关用例及SQL排序的用例，测试用例全部通过，无兼容性功能问题。对资料的正确性、易用性、完整性、语言描述书面化等进行测试，对于示例和命令进行了有效性测试。                                                                                                                            |

## 3.2   新增特性验证结论

### 3.2.1   DCF支持策略化多数派

#### 3.2.1.1   需求描述

当前多副本达成多数派不感知AZ，若多数派副本在同一AZ内发生故障，其他AZ剩余副本数据不是最新，有数据丢失风险；支持在多AZ场景，当某一AZ故障时，另外AZ有可用副本。

#### 3.2.1.2   特性约束

passive、级联备不支持配置

#### 3.2.1.3   性能规格

无

#### 3.2.1.4   测试充分性

参数测试
1、覆盖正常值、异常值、边界值
功能测试
1、覆盖配置group、增加group、删除group、变更group等
可靠性测试
1、覆盖switchover、failover、重启、网络故障等场景 
耦合测试
1、覆盖升级、增副本、节点替换、节点修复等。

### 3.2.2   基础算子性能提升

#### 3.2.2.1   需求描述

进行下列基础算子及代价模型优化，提升执行效率
1、新型选择率模型
2、分区表页面估算优化
3、PI算子消除
4、函数依赖
5、SeqScan底噪消除

#### 3.2.2.2   特性约束

PI算子消除
1、GUC参数partition_iterator_elimination打开后，且优化器剪枝结果只有一个分区时，目标场景优化才能生效
2、不支持二级分区表
3、支持cplan，支持部分gplan场景，如分区键a = $1（即优化器阶段可以剪枝到一个分区的场景）
4、支持SeqScan/Indexscan/Indexonlyscan/Bitmapscan/RowToVec/Tidscan算子
5、支持行存，列存，ustore，SQLBypass
6、Partition Iterator算子下层算子是支持的Scan算子时，才支持消除

函数依赖
1、新增GUC参数enable_functional_dependency=on 生效
2、GUC设置为ON，生成多列统计信息时候，如果涉及属性的个数不超过4个 SeqScan

底噪消除
1、GUC参数enable_seqscan_fusion=on
2、不涉及分区表
3、只针对seqScan算子

分区表页面估算
1、支持一级分区表，二级分区表
2、GUC参数partition_page_estimation打开后，且语句存在剪枝情况下目标场景优化才能生效
3、本特性只校准分区表页面估算部分的准确率，其他不准确的地方（如distinct值估算，独立性假设模型，采样等）在后续版本中校准

新型选择率模型
1、GUC参数var_eq_const_selectivity=on
2、对选择率的优化模型只适用于Int型数据类型，且表达式是Var = Const，其中Var必须是直接的属性，不支持类型强转、表达式、操作符等
3、本特性只校准常量等值谓词选择率估算的准确率，其他不准确的地方（如distinct值估算，独立性假设模型，采样等）在后续版本中校准

#### 3.2.2.3   性能规格

无

#### 3.2.2.4   测试充分性

新型选择率模型 ：
1、性能看护场景性能测试包括（tpcc，tpch，sysbench，基础算子）
2、应用场景构造落入mcv、直方图等
3、特性交互覆盖升级等场景
4、新增GUC参数的设置方式、参数值测试等

分区表页面估算：
1、特性交互覆盖升级等场景
2、测试新增guc参数
3、分区表在分区剪枝情况下是否进行页面估算

PI算子消除：
1、性能看护场景性能测试包括（tpcc，tpch，sysbench，基础算子）
2、应用场景构造落入mcv、直方图等

函数依赖：
1、analyze对不同数据量不同数据类型开启函数依赖执行时间测试
2、函数依赖行数估算准确性测试
3、线下性能看护场景测试（tpcc，tpch，sysbench，基础算子等）

SeqScan底噪消除 
1、seqscan单一计划和复杂计划性能测试
2、线下看护环境包括（tpcc、tpch、sysbench、基础算子）看护不劣化
3、关注对WDR的影响

### 3.2.3   智能优化器

#### 3.2.3.1   需求描述

智能基数估计：实现库内Bayes网络算法并基于此实现智能统计信息以提高多列基数估计准确度，进而提升生成的执行计划质量。

#### 3.2.3.2   特性约束

智能计划选择
1、不支持GPC

#### 3.2.3.3   性能规格

无

#### 3.2.3.4   测试充分性

自适应计划选择
1、特性交互覆盖升级等场景
2、测试新增guc参数
3、hint测试-参数使用
4、数据一致性

基于贝叶斯网络的智能基数估计
1、特性交互覆盖升级等场景
2、测试新增guc参数
3、hint测试-参数使用
4、数据一致性

### 3.2.4   DBMind自治运维平台

#### 3.2.4.1   需求描述

构建端到端自治运维平台：新增异常检测能力，完善自监控、自诊断、自调优能力
1、DBMind服务化：提供简易的部署能力、通过新增cmd exporter扩充采集指标；将原有的openGauss-exporter扩展为Agent, 便于获得即时信息
2、异常检测：通过对监控到的指标进行分析，可以给出系统异常状态波动告警，包括基于规则的和基于算法的两种模式。其中，基于算法的包括对spike, mean shift等典型异常场景进行分析

#### 3.2.4.2   特性约束

python版本大于3.6且提供依赖包 ，prometheus-server与各exporter间通信正常

#### 3.2.4.3   性能规格

无

#### 3.2.4.4   测试充分性

1、一键式部署接口测试，包括正常和异常测试，online/offline的交互、非交互模式测试，包括正常场景测试、鉴权测试、prometheus和各exporter的参数测试等
2、sql_rewriter，所有接口正常和异常测试、用户鉴权测试。改写规则测试，改写文件中SQL语句类型测试
3、cmd_exporter，所有接口正常和异常测试
4、其他已有模块新增接口、参数的正常和异常测试
5、慢SQL根因分析，

新增接口diagnosis测试、新增根因测试
1、异常检测服务接口测试正常和异常测试
2、异常检测Anomaly Detection接口测试正常和异常测试
3、数据库主节点构造异常场景测试
4、数据库备节点构造异常场景测试

### 3.2.5   支持行存压缩

#### 3.2.5.1   需求描述

通过新增高效压缩算法，提升行存表压缩效率和执行性能

#### 3.2.5.2   特性约束

1、需要支持punch hole的文件管理系统，对于不支持punch hole操作的系统，选择压缩无法减少磁盘空间占用
2、对数据进行压缩，在节省存储空间的同时，可能在压缩和解压缩过程中，对CPU有一定冲击，可能会CPU使用率冲高
3、只支持行存表、Btree索引压缩
4、压缩表建立后不支持修改压缩相关参数，非压缩表转化为压缩表操作暂不支持

#### 3.2.5.3   性能规格

1、非压缩表：压缩表压缩率达到2:1
2、tpcc性能劣化 <5%

#### 3.2.5.4   测试充分性

功能测试，主要涉及到压缩表对象，压缩索引测试，接口测试
1 、压缩表和压缩索引,主要包括DDL/DML相关基本语法测试.压缩表的创建，修改，删除等,表的类型有普通表，分区表，toast表等，DML语法中，主要涉及到压缩表数据的增删改查，数据对比等语法操作。 压缩索引测试，包括DDL的相关基本语法测试。在压缩表上和非压缩表上创建/修改/删除索引等基本操作
2 、接口测试：主要包含了内置接口函数的功能测试，涉及到的接口如下： compress_buffer_stat_info()，   compress_ratio_info(file_path) ，compress_statistic_info(file_path，step) ，compress_address_header(oid, seg_id) ，  compress_address_details(oid, seg_id)
3 、表和索引的碎片化整理。主要涉及到shrink table/shrink index这两个操作，覆盖了shrink不存在的表，非压缩表，索引不存在的索引和非压缩索引等。

性能指标测试充分性:
1、物理机(性能较差，tpmc很低)tpcc1000仓，512并发的配置,分别运行了4个小时和8个小时，两个观察点，计算压缩比和tpcc性能劣化率，性能达标

### 3.2.6   支持细粒度Any权限增强

#### 3.2.6.1   需求描述

Any权限管理，新增支持以下5种对象共12种ANY权限功能：

1、ALTER ANY TYPE、DROP ANY TYPE
2、ALTER ANY SEQUENCE、DROP ANY SEQUENCE、SELECT ANY SEQUENCE
3、ALTER ANY INDEX、DROP ANY INDEX
4、CREATE ANY TRIGGER、ALTER ANY TRIGGER、DROP ANY TRIGGER
5、CREATE ANY SYNONYM、DROP ANY SYNONYM

#### 3.2.6.2   特性约束

ANY权限可以通过角色被继承，但不能赋予PUBLIC。初始用户和三权分立关闭时的系统管理员用户可以给任何角色/用户授予或撤销ANY权限

#### 3.2.6.3   性能规格

无

#### 3.2.6.4   测试充分性。

功能测试：执行权限可以赋予和回收操作正常，功能正常。any权限生效。未发现由于any权限引入的越权问题和功能问题，不涉及到性能测试

### 3.2.7   M*兼容性

#### 3.2.7.1   需求描述

UPDATE 语句支持多表连接，同时更新多个表
DELETE语句支持同时从多个表中删除数据
UPDATE支持ORDER BY和LIMIT子句
DELETE语句支持 ORDER BY功能
CREATE TABLE 适配mysql的创建主键、外键、unique索引的语法
ALTER 语句中支持新增主键、外键、唯一键的语法适配
新增SHA2系统函数
新增SHA/SHA1系统函数
实现对M*的<=>操作符的兼容
实现aes_encrypt和aes_encrypt函数
支持AUTO_INCREMENT自增列语法和功能
支持DELETE指定多分区语法和功能
支持SET数据类型及功能

#### 3.2.7.2   特性约束

自增列
1、仅支持B模式
2、数据类型仅支持GAUSS已有整型、浮点型和BOOL
3、对象创建DDL语法约束详见成功场景1：对象创建DDL
4、对象变更操作DDL语法约束详见成功场景2：对象变更操作DDL
5、不支持SQL Mode参数NO_AUTO_VALUE_ON_ZERO
6、不支持参数AUTO_INCREMENT_INCREMENT和AUTO_INCREMENT_OFFSET
7、不支持参数INNODB_AUTOINC_LOCK_MODE
8、不支持REPLACE
9、批量插入后自增计数器的值以Gauss结果为准，详见扩展场景8：批量插入
10、不支持LAST_INSERT_ID返回值为UNSIGNED
11、LAST_INSERT_ID不会忽略在触发器和函数中的自增值

SHA系列函数
差异说明：M对于字符串中连续两个符为 ： ‘\’,‘\0’，‘\b’，‘\n’，‘\r’，‘\t’, ‘\Z’会将相连的两个字符转换为转义为对应的一个字符的ASCII，而在 GaussDB 中字符串没有相同的转义操作。由于差异性与函数本身无关，非sha函数单独存在该差异，因此，当输入的明文字符串包含上述的转义字符，GaussDB的sha系列函数结果会与M结果不一致，导致该差异直接原因是GaussDB中sha 哈希的是输入的明文字符串本身，而M* 哈希的字符串为转义后的新字符串。

SET数据类型
1、仅在兼容B模式下生效。
1.3.2.4	AES_ENCRYPT和AES_DECRYPT加解密函数
（1）差异说明一：M对于字符串中连续两个符为 ： ‘\’,‘\0’，‘\b’，‘\n’，‘\r’，‘\t’, ‘\Z’会将相连的两个字符转换为转义为对应的一个字符的ASCII，而在 GaussDB中字符串没有相同的转义操作（可通过E转义或者参数standard_conforming_strings）。由于差异性与函数本身无关，非加解密函数单独存在该差异，因此，当输入的字符串包含上述的转义字符，GaussDB的加解密函数结果会与M结果不一致，导致该差异直接原因是GaussDB中输入的是字符串本身，而M输入的是转义后的新字符串
（2）只在B模式数据库下支持。
4、约束与索引语法功能增强
只在B模式数据库下支持。
USING method字段中，M支持的索引方法为BTREE和HASH（其中HASH索引仅在存储引擎为MEMORY/HEAP和NDB支持），GaussDB支持的索引方法为BTREE, HASH, GIN, GIST, Psort, UBTREE，当走默认的存储方式（ASTROR）时，HASH, GIN, GIST, Psort, UBTREE均不支持。当指定存储方式为USTORE时，支持UBTREE索引方法。
（4）适配M*的主键、外键、唯一键特性仅完成语法兼容。例如：若GaussDB的表达式索引在查询的时候可以生效，则该特性适配后也可以生效，否则，只是完成语法兼容。
5、DML语法约束
（1）delete、update多表仅在B模式和集中式中支持。
（2）delete、update的order by和limit在所有兼容模式和部署模式下生效。
（3）delete支持多分区仅在B模式下生效，分布式下行为同单分区相同（语法不报错但无实际功能）。

#### 3.2.7.3   性能规格

无

#### 3.2.7.4   测试充分性

自增列：
1、CREATE TABLE 支持自增列语法功能验证完成
2、非持久化表支持自增列验证完成
3、新增系统函数 LAST_INSERT_ID验证完成
4、支持简单DML的自增列相关功能验证完成
5、ALTER TABLE中新增、删除自增列验证完成
6、TRUNCATE 支持清空含自增列的表验证完成
7、DROP TABLE 支持删除包含自增列的表验证完成
8、基于copy导入自增列数据验证完成
9、基于gs_dump导出自增列数据验证完成
10、基于gs_restore导入自增列数据验证完成

支持SET数据类型及功能

1、CREATE TABLE 支持创建包含SET数据类型的表以及相关约束测试。
2、SET数据类型支持以字符串和数值的方式输入。
3、pbe模式、存储过程测试支持字符串和数值的方式输入
4、ALTER TABLE tab 支持变更SET数类型字段的属性。
5、DROP TABLE 删除具有SET类型的字段。含SET类型不支持闪回
6、JDBC/ODBC/LIBPQ/PYTHON/GO驱动支持SET类型。

### 3.2.8   流式容灾

#### 3.2.8.1   需求描述

针对异地容灾特性，在不借助额外存储介质的情况下实现跨region的异地容灾。对外提供容灾搭建，灾备升主，计划内主备切换，容灾状态监控功能

#### 3.2.8.2   特性约束

日常监控RPO和RTO数值需要在目标范围内。如果灾备升主前容灾指标不在目标范围内，则可能导致灾备升主或者容灾演练时达不到容灾指标。灾备升主failover支持少数派故障场景(即degraded状态)下的升主，但在升主过程中如果出现故障叠加场景下，执行灾备集群升主RTO会超过10min。容灾演练特性switchover要求主备集群都处于normal态才可执行，执行过程中如果出现节点或实例故障会导致倒换失败，主集群回滚等现象，用以保证有集群可对外提供服务。要达到容灾性能指标，集群使用的磁盘至少是SAS SSD，比如服务器典型配置（104U/512G/SAS SSD）。

#### 3.2.8.3   性能规格

测试背景业务流量：sata ssd盘正常xlog日志同步速率10MB/s下测试 搭建前后性能损耗 主集群性能影响小于20% 容灾存续 RPO<10s，RTO<=10分钟 容灾倒换 RPO=0，RTO<=20分钟 灾备normal状态下：RPO<10s，RTO<=10分钟 灾备degraded状态下：RPO<10s，RTO<=20分钟 容灾查询 执行时间 < 30 s

#### 3.2.8.4   测试充分性

1、基本功能: 流式容灾搭建，流式容灾倒换，流式容灾灾备升主 ，流式容灾解除，流式容灾查询
2、特性耦合: 操作方式场景，节点类型，特性分类
3、性能压力: 性能指标测试场景，超规格压力测试
4、长稳: 测试背景业务流量：sata ssd盘正常xlog日志同步速率10MB/s下测试
5、可靠性：容灾搭建过程可靠性，灾备升主可靠性，容灾解除可靠性
6、约束/安全: 容灾用户名密码操作相关日志检查，容灾用户名密码信息查询检查 ，约束性测试
7、资料测试：技术白皮书。开发者指南等资料
