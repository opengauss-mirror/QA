

![avatar](../../images/openGauss.png)

版权所有 © 2022  openGauss社区
 您对“本文档”的复制、使用、修改及分发受知识共享(Creative Commons)署名—相同方式共享4.0国际公共许可协议(以下简称“CC BY-SA 4.0”)的约束。为了方便用户理解，您可以通过访问https://creativecommons.org/licenses/by-sa/4.0/ 了解CC BY-SA 4.0的概要 (但不是替代)。CC BY-SA 4.0的完整协议内容您可以访问如下网址获取：https://creativecommons.org/licenses/by-sa/4.0/legalcode。

修订记录

| 日期       | 修订   版本 | 修改描述                 | 作者     |
| ---------- | ----------- | ------------------------ | -------- |
| 2022-09-21 | 1.0         | 特性测试报告初稿完成     | wangke18 |
| 2022-09-28 | 2.0         | 根据评审意见修改测试报告    | wangke18 |

关键词：灰度升级，滚动升级，升级回退，一主多备

摘要：本节主要介绍openGauss支持细粒度滚动升级的测试活动。测试活动包含该功能支持的三个特性场景的功能测试，数据一致性测试，可靠性测试以及资料测试。同时统计了测试过程中发现的问题个数以及问题的解决情况。

缩略语清单：无

| 缩略语 | 英文全名 | 中文解释 |
| ------ | -------- | -------- |
|        |          |          |



# 1     特性概述

滚动升级在灰度升级的基础上，支持在集中式环境下，集群的滚动升级操作，可以先升级部分节点再升级剩余节点，同时支持升级过程中的switchover操作，为多集群环境下的升级提供便利。

# 2     特性测试信息

本节描述被测对象的版本信息，测试的时间

| 版本名称                       | 测试起始时间 | 测试结束时间 |
| ------------------------------ | ------------ | ------------ |
| openGauss 2.0.3 build 1ecd2439 | 2022-08-20   | 2022-08-25   |
| openGauss 2.0.4 build 439d7c32 | 2022-08-25   | 2022-09-20   |
| openGauss 2.0.5 build 439d7c32 | 2022-09-05   | 2022-09-10   |
| openGauss 3.0.0 build 02c14696 | 2022-09-08   | 2022-09-08   |
| openGauss 3.1.0 build 0b50eccc | 2022-08-20   | 2022-09-13   |
| openGauss 3.1.0 build 0xcd85gs | 2022-09-13   | 2022-09-16   |
| openGauss 3.1.0 build 88ca9bcd | 2022-09-16   | 2022-09-19   |
| openGauss 3.1.0 build ab8301ad | 2022-09-19   | 2022-09-22   |

描述特性测试的环境信息

| 环境信息       | 配置信息                                                     | 备注 |
| -------------- | ------------------------------------------------------------ | ---- |
| OpenStack Nova | CPU:  Intel(R) Xeon(R) Gold 6266C CPU @ 3.00GHz<br>内存：32GB<br>硬盘：ssd<br>OS：Centos Linux 7 |      |
| OpenStack Nova | CPU:  Intel(R) Xeon(R) Gold 6266C CPU @ 3.00GHz<br/>内存：32GB<br/>硬盘：ssd<br/>OS：openEuler release 20.03 (LTS-SP1) |      |



# 3     测试结论概述

## 3.1   测试整体结论

openGauss支持细粒度滚动升级共计执行178条用例。其中2.0.3-3.1.0，2.0.5-3.1.0，3.0.0-3.1.0三条升级路径覆盖主功能测试，每条路径涉及无cm-无cm，无cm-有cm，有cm-有cm三个特性场景。升级路径2.0.4-3.1.0覆盖功能测试，可靠性测试，数据一致性测试。资料测试覆盖校验资料的描述及示例的执行结果。共计发现6条问题，其中5条问题已解决，剩余1条问题待解决，整体质量一般。

| 测试活动       | 活动评价                                       |
| -------------- | ---------------------------------------------- |
| 功能测试       | 使用-h命令升级指定节点的功能测试，通过         |
| 功能测试       | 使用--continue命令升级剩余节点的功能测试，通过 |
| 功能测试       | 使用rollback命令进行升级回退的功能测试，通过   |
| 功能测试       | 使用commit命令进行升级提交的功能测试，通过     |
| 数据一致性测试 | 升级前后用户数据一致性对比测试，通过           |
| 可靠性测试     | 升级过程中注入故障的可靠性测试，通过           |
| 资料测试       | 资料描述准确，示例的命令结果正确，整体质量良好 |
## 3.2   约束说明

1. 滚动升级过程中不允许打开kerberos开关

2. 滚动升级过程中不允许对wal_level,max_connections,max_prepared_transactions,max_locks_per_transaction四个guc参数进行修改

3. 滚动升级过程中需要guc参数enable_stream_replication=on,参数值为off时不允许升级

4. 滚动升级过程中进行不支持进行扩容/减容操作

5. 滚动升级-h参数只能是hostname值，不能是ip地址

6. 滚动升级支持三种特性场景
  
   a.不带CM工具的数据库升级到不带CM工具的数据库
  
   b.不带CM工具的数据库升级到不带CM工具的数据库
  
   c.带CM工具的数据库升级到带CM工具的数据库

7. 无CM-有CM升级过程中只有所有节点升级后才能使用CM工具，单个节点升级后不支持使用cm工具

## 3.3 遗留问题分析

### 3.3.1 遗留问题影响以及规避措施

| 问题单号 | 问题描述 | 问题级别 | 问题影响和规避措施 | 当前状态 |
| -------- | -------- | -------- | ------------------ | -------- |
| [I5RH92](https://gitee.com/opengauss/openGauss-server/issues/I5RH92?from=project-issue) | 3.0.0-3.1.0灰度升级后回滚再次灰度升级报错 | 主要 |                   | 待办的 |

### 3.3.2 问题统计

|        | 问题总数 | 严重 | 主要 | 次要 | 不重要 | 备注 |
| ------ | -------- | ---- | ---- | ---- | ------ | ---- |
| 数目   | 6        | 0    | 6    | 0    | 0      |      |
| 百分比 | 100%     | 0%   | 100% | 0%   | 0%     |      |

### 3.3.3 问题单汇总

| 序号 | issue号                                                      | 级别 | 问题简述                                                     | 状态   |
| ---- | ------------------------------------------------------------ | ---- | ------------------------------------------------------------ | ------ |
| 1    | [I5NRP8](https://gitee.com/opengauss/openGauss-OM/issues/I5NRP8?from=project-issue) | 主要 | 滚动升级--单节点滚动升级主节点，滚动升级失败                 | 已验收 |
| 2    | [I5O0XA](https://gitee.com/opengauss/openGauss-OM/issues/I5O0XA?from=project-issue) | 主要 | 滚动升级--所有节点升级成功后，回退异常报错2.0.4-master       | 已验收 |
| 3    | [I5RGQR](https://gitee.com/opengauss/openGauss-OM/issues/I5RGQR?from=project-issue) | 主要 | 滚动升级--单节点升级成功后执行--continue升级其余节点报错     | 已验收 |
| 4    | [I5S8I8](https://gitee.com/opengauss/openGauss-OM/issues/I5S8I8?from=project-issue) | 主要 | 滚动升级--无cm-带cm主机执行命令单节点升级备机，升级成功后备机升级主节点，升级报错 | 已验收 |
| 5    | [I5RWR4](https://gitee.com/opengauss/openGauss-server/issues/I5RWR4?from=project-issue) | 主要 | 2.0.4-3.1.0灰度升级成功后回滚再次升级回滚失败报错            | 已验收 |
| 6    | [I5RH92](https://gitee.com/opengauss/openGauss-server/issues/I5RH92?from=project-issue) | 主要 | 3.0.0-3.1.0灰度升级后回滚再次灰度升级报错                    | 待办的 |

# 4     测试执行

## 4.1   测试执行步骤

### 4.1.1 功能测试

| 测试步骤                                                     | 测试结果                                                 |
| ------------------------------------------------------------ | -------------------------------------------------------- |
| 1.取2.0.3/2.0.4/2.0.5/3.0.0包安装一主两备数据库<br />2.在master包的script路径下进行升级预安装<br />3.执行用例 | 共执行163条用例<br />共发现6条bug，5条现已修复且验收通过 |

### 4.1.2 数据一致性测试

#### 4.1.2.1检查升级前后用户表的一致性

| 测试步骤                                                     | 测试结果                            |
| ------------------------------------------------------------ | ----------------------------------- |
| 1.取2.0.4包安装一主两备数据库<br />2.升级前连接tpcc在数据库内build数据<br />3.checksum表样值<br />4.2.0.4-master进行升级并提交<br />5.checksum表样值并与升级前的checksum值进行对比<br />6.清理tpcc所build的数据 | 共执行1条用例<br />执行结果符合预期 |

#### 4.1.2.2检查升级前后guc参数值一致性

| 测试步骤                                                     | 测试结果                             |
| ------------------------------------------------------------ | ------------------------------------ |
| 1.取2.0.4包安装一主两备数据库<br />2.查看部分guc参数的参数值<br />3.2.0.4-master进行升级并提交<br />4.查看部分guc参数的参数值并与升级前进行对比 | 共执行1条用例 <br />执行结果符合预期 |

#### 4.1.2.3检查升级前后用户一致性

| 测试步骤                                                     | 测试结果                        |
| ------------------------------------------------------------ | ------------------------------- |
| 1.取2.0.4包安装一主两备数据库 <br />2.2.0.4-master升级后主机新建用户 <br />3.2.0.4-master升级回退 <br />4.查看新建用户是否存在 | 共执行3条用例  执行结果符合预期 |

#### 4.1.2.4检查直接安装的master数据库与2.0.4升级到master数据库表样一致性

| 测试步骤                                                     | 测试结果                        |
| ------------------------------------------------------------ | ------------------------------- |
| 1.取2.0.4包安装一主两备数据库  <br />2.2.0.4-master进行升级并提交  <br />3.取master包安装 （该master包与升级master包版本一致） <br />4.执行脚本对比系统表数据一致性 | 共执行1条用例  执行结果符合预期 |

### 4.1.3 可靠性测试

| 测试步骤                                                     | 测试结果                        |
| ------------------------------------------------------------ | ------------------------------- |
| 1.取2.0.4包安装一主两备数据库  <br />2.2.0.4-master进行升级<br />3.升级过程中注入故障 | 共执行9条用例  执行结果符合预期 |

### 4.1.3 资料测试

| 测试步骤                               | 测试结果 |
| -------------------------------------- | -------- |
| 资料叙述准确无误，命令正确，约束全面。 | 通过     |

## 4.2   测试执行统计数据

| 版本名称                       | 测试用例数 | 用例执行结果            | 发现问题单数 |
| ------------------------------ | ---------- | ----------------------- | ------------ |
| openGauss 3.1.0 build 0b50eccc | 178        | Passed：148  Failed：30 | 6            |
| openGauss 3.1.0 build ab8301ad | 178        | Passed：174  Failed：4  | 0            |


说明：

1.openGauss 3.1.0 build 0b50eccc版本测试中共发现6个问题，其中6个均为主要单，1个待办，其余5个已回归，验收通过。

2.缺陷密度为 6(缺陷个数)/0.18k(代码行数)=33.33(个/kloc)。

## 4.3   后续测试建议

无

# 5     附件

 无