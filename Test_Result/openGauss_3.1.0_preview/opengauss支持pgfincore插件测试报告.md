

![avatar](../../images/openGauss.png)

版权所有 © 2022  openGauss社区
 您对“本文档”的复制、使用、修改及分发受知识共享(Creative Commons)署名—相同方式共享4.0国际公共许可协议(以下简称“CC BY-SA 4.0”)的约束。为了方便用户理解，您可以通过访问https://creativecommons.org/licenses/by-sa/4.0/ 了解CC BY-SA 4.0的概要 (但不是替代)。CC BY-SA 4.0的完整协议内容您可以访问如下网址获取：https://creativecommons.org/licenses/by-sa/4.0/legalcode。

修订记录

| 日期       | 修订   版本 | 修改描述                 | 作者     |
| ---------- | ----------- | ------------------------ | -------- |
| 2022-09-05 | 1.0         | 特性测试报告初稿完成     | wangke18 |
| 2022-09-09 | 1.1         | 根据评审意见修改测试报告 | wangke18 |

关键词：pgfincore，编译，插件，tps

摘要：本节主要介绍openGauss在编译之后支持pgfincore12类函数的测试活动。测试活动包含函数的入参测试，返回值测试，性能测试以及资料测试。在测试活动中发现的问题以及问题解决回归情况。

缩略语清单：

| 缩略语    | 英文全名               | 中文解释                                                     |
| --------- | ---------------------- | ------------------------------------------------------------ |
| pgfincore | pgfincore              | 插件名称                                                     |
| tps       | Transaction Per Second | 每秒钟系统能够处理的交易或事务的数量。它是衡量系统处理能力的重要指标。 |



# 1     特性概述

pgfincore是插件的名称，该插件总共包含12个函数。其中pgsysconf（包含2个函数）这个函数输出操作系统块的大小，操作系统页面缓冲区中空闲页面的数量；pgfincore（包含2个函数）函数提供页面缓存的信息；pgfincore_drawer函数，渲染返回的databit字段值；pgadvise函数（总共包含7个函数）用来将占用磁盘的数据刷入或刷出内存，由于内存不占用数据库的buffer，刷入内存可以提升数据库的查询性能。

# 2     特性测试信息

本节描述被测对象的版本信息，测试的时间

| 版本名称                       | 测试起始时间 | 测试结束时间 |
| ------------------------------ | ------------ | ------------ |
| openGauss 3.0.0 build b07c959b | 2022-08-30   | 2022-09-02   |
| openGauss 3.1.0 build b4215eeb | 2022-09-08   | 2022-09-08   |
| pgbench (postgresql-14.0)      | 2022-09-02   | 2022-09-08   |
| pgfincore-12.0                 | 2022-08-30   | 2022-09-08   |

描述特性测试的环境信息

| 环境信息       | 配置信息                                                     | 备注 |
| -------------- | ------------------------------------------------------------ | ---- |
| OpenStack Nova | CPU:  Intel(R) Xeon(R) Gold 6266C CPU @ 3.00GHz<br>内存：16GB<br>硬盘：ssd<br>OS：Centos Linux 7<br>文件系统：ext3 |      |



# 3     测试结论概述

## 3.1   测试整体结论

openGauss支持pgfincore插件共计执行60条用例，主要覆盖了功能测试，性能测试，资料测试。功能测试覆盖pgfincore12个函数的入参测试，返回值测试，pgfincore函数支持对象测试。性能测试覆盖pgadvise函数。资料测试覆盖校验资料的描述及示例的执行结果。共计发现5条问题，其中5条问题已解决。问题均回归通过，无遗留风险，整体质量良好。

| 测试活动 | 活动评价                                                  |
| -------- | --------------------------------------------------------- |
| 功能测试 | pgfincore插件12个函数的支持对象测试，通过                 |
| 功能测试 | pgsysconf函数和pgsysconf_pretty函数入参及返回值测试，通过 |
| 功能测试 | pgfincore函数入参测试及返回值测试，通过                   |
| 功能测试 | pgadvise函数入参测试及返回值测试，通过                    |
| 功能测试 | pgfincore_drawer函数入参测试及返回值测试，通过            |
| 性能测试 | 使用pgadvise函数前后对比性能测试，通过                    |
| 资料测试 | 资料描述准确，示例的执行结果正确，整体质量良好            |
## 3.2   约束说明

1. 使用select * from pgfincore('test1',true)函数需要输入第二项参数true来激活函数返回的databit字段值，opengauss中整数型数据和布尔类型数据存在转义，支持使用整数来激活databit字段

2. pgadvise函数以及pgfincore函数暂不支持段页式表和列存表

3. 对于分区表，relpath信息不显示表样的oid值，显示分区信息的relfilenode值

4. 将表样刷入刷出内存时，同时将表样上的索引信息刷入刷出内存

## 3.3 遗留问题分析

### 3.3.1 遗留问题影响以及规避措施

| 问题单号 | 问题描述 | 问题级别 | 问题影响和规避措施 | 当前状态 |
| -------- | -------- | -------- | ------------------ | -------- |
| NA       |          |          |                    |          |

### 3.3.2 问题统计

|        | 问题总数 | 严重 | 主要 | 次要 | 不重要 | 备注 |
| ------ | -------- | ---- | ---- | ---- | ------ | ---- |
| 数目   | 5        | 0    | 2    | 3    | 0      |      |
| 百分比 | 100%     | 0%   | 40%  | 60%  | 0%     |      |

### 3.3.3 问题单汇总

| 序号 | issue号                                                      | 级别 | 问题简述                                                     | 状态   |
| ---- | ------------------------------------------------------------ | ---- | ------------------------------------------------------------ | ------ |
| 1    | [I5PCGC](https://e.gitee.com/opengaussorg/projects/379702/bugs/table?%2Fissue=I5P6SJ&issue=I5PCGC) | 主要 | 调用函数当表样为分区表时，回显的relpath的oid值和分区表的oid值对应不上 | 已验收 |
| 2    | [I5PAK0](https://e.gitee.com/opengaussorg/projects/379702/bugs/table?%2Fissue=I5P6SJ&issue=I5PAK0) | 主要 | 使用select \* from pgfadvise_loader('pgbench_accounts', 0, true, true, B'111000')函数 ，第一项参数为函数支持的表样名称，第五项参数是databit字段值，第五项参数和第一项参数之间缺少对应关系 | 已验收 |
| 3    | [I5PAIE](https://e.gitee.com/opengaussorg/projects/379702/bugs/table?%2Fissue=I5P6SJ&issue=I5PAIE) | 次要 | 使用select \* from pgfincore(‘test’, true)函数第二项参数输入布尔类型来实现databit字段的激活，当表样中没有插入数据，表样不占用内存的时候，使用true参数激活databit字段不回显数值，（只有表样中插入数据占用内存的时候回显数值） | 已验收 |
| 4    | [I5PAGF](https://e.gitee.com/opengaussorg/projects/379702/bugs/table?%2Fissue=I5P6SJ&issue=I5PAGF) | 次要 | 使用select \* from pgfincore(‘test’, true)函数第二项参数输入布尔类型来实现databit字段的激活，然而opengauss中，真值的有效文本除了true参数值，还有整数型的输入，输入范围（-2^63-1~-1,1~2^63）;假值的有效文本除了false参数值,还有0值 | 已验收 |
| 5    | [I5P6SJ](https://e.gitee.com/opengaussorg/projects/379702/bugs/table?%2Fissue=I5P6SJ&issue=I5P6SJ) | 次要 | select \* from pgfadvise_loader('pgbench_accounts', 0, true, true, B'111000');对于不支持的对象分区表报错信息有误 | 已验收 |

# 4     测试执行

## 4.1   测试执行步骤

### 4.1.1 功能测试

| 测试步骤                                   | 测试结果                                                     |
| ------------------------------------------ | ------------------------------------------------------------ |
| 1.编译安装opengauss数据库 <br />2.执行用例 | 共执行58条用例<br />共发现5个bug，5条现已修复且验收通过<br /> |

#### 4.1.1.1pgfincore12个函数的支持对象测试

| 测试步骤                           | 测试结果                                                |
| ---------------------------------- | ------------------------------------------------------- |
| 1. pgfincore12个函数的支持对象测试 | 共执行24条用例<br />共发现1个bug，1条现已修复且验收通过 |

#### 4.1.1.2  pgsysconf函数和pgsysconf_pretty函数入参及返回值测试

| 测试步骤                                               | 测试结果                        |
| ------------------------------------------------------ | ------------------------------- |
| 1. pgsysconf函数和pgsysconf_pretty函数入参及返回值测试 | 共执行7条用例，测试结果符合预期 |

#### 4.1.1.3 pgfincore函数入参测试及返回值测试

| 测试步骤                             | 测试结果                                               |
| ------------------------------------ | ------------------------------------------------------ |
| 1. pgfincore函数入参测试及返回值测试 | 共执行3条用例<br />共发现2个bug，2条现已修复且验收通过 |

#### 4.1.1.4  pgadvise函数入参测试及返回值测试

| 测试步骤                            | 测试结果                                                  |
| ----------------------------------- | --------------------------------------------------------- |
| 1. pgadvise函数入参测试及返回值测试 | 共执行21条用例<br />累计发现2个bug ,2条现已修复且验收通过 |

#### 4.1.1.5pgfincore_drawer函数入参测试及返回值测试

| 测试步骤                                    | 测试结果                        |
| ------------------------------------------- | ------------------------------- |
| 1. pgfincore_drawer函数入参测试及返回值测试 | 共执行3条用例，测试结果符合预期 |

### 4.1.2 性能测试

| 测试步骤                                                     | 测试结果                                                     |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| 1.编译安装数据库<br />2.安装pgbench工具<br />3.基础数据量1w<br />4.在16并发，4线程，duration30s的情况下使用pgbench工具执行select查询语句，观察tps<br />5.使用pgadvise_dontneed函数<br />6.在16并发，4线程，duration30s的情况下使用pgbench工具执行select查询语句，观察tps<br />7.使用pgadvise_willneed函数<br />8.在16并发，4线程，duration30s的情况下使用pgbench工具执行select查询语句，观察tps | 1.对于pgadvise_willneed函数<br />使用前tps:20653.86<br />使用后tps:59976.64<br />性能提升<br />2.对于pgadvise_dontneed函数<br />使用前tps:59976.64<br />使用后tps:24757.85<br />性能下降<br />共执行2条用例，测试结果符合预期 |

### 4.1.3 资料测试

| 测试步骤                        | 测试结果                       |
| ------------------------------- | ------------------------------ |
| 1. 使用方法描述<br/>2. 示例测试 | 使用方法描述准确，示例正确无误 |

## 4.2   测试执行统计数据

| 版本名称                       | 测试用例数 | 用例执行结果          | 发现问题单数 |
| ------------------------------ | ---------- | --------------------- | ------------ |
| openGauss 3.0.0 build b07c959b | 60         | Passed：55  Failed：5 | 5            |
| openGauss 3.1.0 build b4215eeb | 60         | Passed：60  Failed：0 | 0            |

说明：

1.openGauss 3.0.0 build b07c959b版本测试时发现5个问题。

2.openGauss 3.1.0 build b4215eeb版本回归5个问题单，验收通过。

3.缺陷密度为 5(缺陷个数)/1.826k(代码行数)=2.7(个/kloc)。

## 4.3   后续测试建议

因databit值回显数值过多，选择部分输入时需要手动键入，pgadvise_loader函数第五项参数的输入建议增加周期性输入方式。

# 5     附件

 无