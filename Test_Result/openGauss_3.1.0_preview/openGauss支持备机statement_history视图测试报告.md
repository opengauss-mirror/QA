

![avatar](../../images/openGauss.png)

版权所有 © 2022  openGauss社区
 您对“本文档”的复制、使用、修改及分发受知识共享(Creative Commons)署名—相同方式共享4.0国际公共许可协议(以下简称“CC BY-SA 4.0”)的约束。为了方便用户理解，您可以通过访问https://creativecommons.org/licenses/by-sa/4.0/ 了解CC BY-SA 4.0的概要 (但不是替代)。CC BY-SA 4.0的完整协议内容您可以访问如下网址获取：https://creativecommons.org/licenses/by-sa/4.0/legalcode。

修订记录

| 日期       | 修订版本 | 修改描述             | 作者      |
| ---------- | -------- | -------------------- | --------- |
| 2022-09-22 | 1.0      | 特性测试报告初稿完成 | baixiaoli |
| 2022-09-26 | 1.1      | 根据评审意见修改报告 | baixiaoli |
| 2022-09-29 | 1.2      | 添加回归测试版本     | baixiaoli |

关键词：备机  statement_history视图 慢SQL

摘要：本文档为openGauss支持备机归档statement_history数据，并提供参数配置、查询等功能，以便定位慢SQL问题的测试报告。

缩略语清单：

| 缩略语 | 英文全名 | 中文解释 |
| ------ | -------- | -------- |
| 无     |          |          |

# 1     特性概述

主机使用statement_history这个unlogged表存放和归档SQL执行性能数据，备机使用一个新的数据结构“内存文件链”来存储fast sql和slow sql数据，提供参数track_stmt_standby_chain_size约束fast sql和slow sql的内存、磁盘的使用量，提供函数standby_statement_history(bool only_slow,timestamp T1,timestamp T2)执行数据的扫描。

# 2     特性测试信息

本节描述被测对象的版本信息，测试的时间

| 版本名称                       | 测试起始时间 | 测试结束时间 |
| ------------------------------ | ------------ | ------------ |
| openGauss 3.1.0 build 187ac871 | 2022-09-11   | 2022-09-19   |
| openGauss 3.1.0 build 73e83d99 | 2022-09-27   | 2022-09-28   |

描述特性测试的硬件环境信息

| 环境信息       | 配置信息                                                 | 备注 |
| -------------- | ------------------------------------------------------------ | ---- |
| 虚拟机 | CPU:  Intel(R) Xeon(R) Gold 6266C CPU @ 3.00GHz<br>内存：15GB<br>硬盘：ssd<br>OS：openEuler release 20.03 (LTS-SP1) |      |

# 3     测试结论概述

## 3.1   测试整体结论

openGauss支持备机statement_history视图共计执行93条用例，主要覆盖了功能测试，兼容性测试、可靠性测试、升级测试和资料测试。功能测试覆盖函数standby_statement_history不同参数组合测试，包括有效值和无效值测试，guc reload方式设置参数track_stmt_standby_chain_size不同取值组合测试，guc set方式设置参数track_stmt_standby_chain_size不同取值组合测试，alter system set方式设置参数track_stmt_standby_chain_size不同取值组合测试；兼容性测试覆盖满足时间或空间条件清除deb_ferf_standby目录下数据文件测试；可靠性测试覆盖主备切换、主机或备机异常等场景的测试；升级测试覆盖2.0.3版本1主1备1级联升级至3.1.0版本和2.0.4版本1主1备1级联升级至3.1.0版本，分别测试带CM和不带CM测试；资料测试覆盖校验资料的描述。共计发现1个问题，回归通过，无遗留风险，整体质量较好。

| 测试活动   | 活动评价                                                     |
| ---------- | ------------------------------------------------------------ |
| 功能测试   | 函数standby_statement_history不同参数组合测试，包括有效值和无效值测试，通过 |
| 功能测试   | guc reload方式设置参数track_stmt_standby_chain_size不同取值组合测试，通过 |
| 功能测试   | guc set方式设置参数track_stmt_standby_chain_size不同取值组合测试，通过 |
| 功能测试   | alter system set方式设置参数track_stmt_standby_chain_size不同取值组合测试，通过 |
| 兼容性测试 | 满足时间或空间条件清除deb_ferf_standby目录下数据文件，通过   |
| 可靠性测试 | 主备切换、主机或备机异常等场景的测试，通过                   |
| 升级测试   | 2.0.3版本1主1备1级联升级至3.1.0版本和2.0.4版本1主1备1级联升级至3.1.0版本，通过 |
| 资料测试   | 检查资料描述是否准确无误，通过                              |
## 3.2   约束说明

1. 仅在备机生效；
2. enable_stmt_track参数关闭，备机查不到数据；
3. 不存在仅查询fast sql的选项；
4. 查询结果基本会按照finish_time自动进行降序排序；
5. 备机数据并非存在表里，没有索引存在，用where条件进行时间过滤无法传递到函数内部，只能类似全表扫描，效率比较低，推荐使用参数进行时间范围的选择，但不要轻易改动系统时间，否则函数的参数减枝优化会不准。

## 3.3   遗留问题分析

### 3.3.1 遗留问题影响以及规避措施

| 序号 | 问题单号                                                     | 问题描述                                      | 问题级别 | 问题影响和规避措施 | 当前状态 |
| ---- | ------------------------------------------------------------ | --------------------------------------------- | -------- | ------------------ | -------- |
| NA    |  |    |      |                    |    |

### 3.3.2 问题统计

|        | 问题总数 | 严重 | 主要 | 次要 | 不重要 | 备注 |
| ------ | -------- | ---- | ---- | ---- | ------ | ---- |
| 数目   | 1        | 0    | 1    | 0    | 0      |      |
| 百分比 | 100%     | 0%   | 100% | 0%   | 0%     |      |

### 3.3.3 问题单汇总

| 序号 | issue号                                                      | 级别 | 问题简述                                      | 状态   |
| ---- | ------------------------------------------------------------ | ---- | --------------------------------------------- | ------ |
| 1    | [I5RWR4](https://gitee.com/opengauss/openGauss-server/issues/I5RWR4?from=project-issue) | 主要 | 2.0.4-3.1.0灰度升级成功后回滚再次升级回滚失败 | 已验收 |

# 4     测试执行

## 4.1   测试执行步骤

### 4.1.1 功能测试

#### 4.1.1.1 函数standby_statement_history不同参数组合测试，包括有效值和无效值测试

| 测试步骤                                                     | 测试结果                         |
| ------------------------------------------------------------ | -------------------------------- |
| 1.设置参数enable_stmt_track=on，<br />log_min_duration_statement=30ms<br />2.创建表并插入数据<br />3.备机查询数据<br />4.函数standby_statement_history传入不同的参数进行查询 | 共执行18条用例，测试结果符合预期 |

#### 4.1.1.2 guc reload方式设置参数track_stmt_standby_chain_size不同取值组合测试

| 测试步骤                                                     | 测试结果                         |
| ------------------------------------------------------------ | -------------------------------- |
| 1.guc reload方式设置参数track_stmt_standby_chain_size不同取值组合 | 共执行19条用例，测试结果符合预期 |

#### 4.1.1.3 guc set方式设置参数track_stmt_standby_chain_size不同取值组合测试

| 测试步骤                                                     | 测试结果                         |
| ------------------------------------------------------------ | -------------------------------- |
| 1.guc set方式设置参数track_stmt_standby_chain_size不同取值组合 | 共执行19条用例，测试结果符合预期 |

#### 4.1.1.4 alter system set方式设置参数track_stmt_standby_chain_size不同取值组合测试

| 测试步骤                                                     | 测试结果                         |
| ------------------------------------------------------------ | -------------------------------- |
| 1.alter system set方式设置参数track_stmt_standby_chain_size不同取值组合 | 共执行19条用例，测试结果符合预期 |

### 4.1.2 兼容性测试

#### 4.1.2.1 满足时间或空间条件清除deb_ferf_standby目录下数据文件

| 测试步骤                                                     | 测试结果                        |
| ------------------------------------------------------------ | ------------------------------- |
| 1.设置参数enable_stmt_track=on，<br />log_min_duration_statement=30ms，<br />设置文件保留时间和磁盘占用大小<br />2.创建表并插入数据<br />3.备机执行快、慢SQL语句<br />4.查看deb_ferf_standby目录下fast sql和slow sql文件生成和清理情况 | 共执行4条用例，测试结果符合预期 |

### 4.1.3可靠性测试

#### 4.1.3.1主备切换、重启、主机或备机异常等场景的测试

| 测试步骤                                                     | 测试结果                         |
| ------------------------------------------------------------ | -------------------------------- |
| 1.执行主备切换、重启、构造主机或备机异常等场景<br />2.备机执行fast sql、slow sql语句<br />3.查询函数standby_statement_history<br />4.查看deb_ferf_standby目录下fast sql和slow sql文件 | 共执行10条用例，测试结果符合预期 |

### 4.1.4升级测试

#### 4.1.4.1 2.0.3版本1主1备1级联升级至3.1.0版本和2.0.4版本1主1备1级联升级至3.1.0版本

| 测试步骤                                                     | 测试结果                                |
| ------------------------------------------------------------ | --------------------------------------- |
| 1.安装旧版本1主1备1级联<br />2.灰度升级至3.1.0版本<br />3.创建表并插入数据<br />4.查询函数standby_statement_history<br />5.回退至旧版本<br />6.再次灰度升级至3.1.0版本并提交<br />7.查询函数standby_statement_history | 共执行4条用例<br />共发现1个bug，已验收 |

### 4.1.5 资料测试

| 测试步骤                    | 测试结果     |
| --------------------------- | ------------ |
| 1.检查资料描述是否准确无误 | 资料描述准确 |

## 4.2   测试执行统计数据

| 版本名称                       | 测试用例数 | 用例执行结果           | 发现问题单数 |
| ------------------------------ | ---------- | ---------------------- | ------------ |
| openGauss 3.1.0 build 187ac871 | 93         | Passed：91  Failed：2  | 1            |
| openGauss 3.1.0 build 73e83d99 | 4          | Passed：4    Failed：0 | 0            |

说明：

1.openGauss 3.1.0 build 187ac871版本测试时发现1个问题（升级问题，非本需求功能问题）。

2.缺陷密度为 0(缺陷个数)/2.5k(代码行数)=0(个/kloc)。

## 4.3   后续测试建议

无

# 5     附件

 无