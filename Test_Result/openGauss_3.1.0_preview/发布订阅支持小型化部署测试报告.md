![avatar](../../images/openGauss.png)

版权所有 © 2022  openGauss社区
 您对“本文档”的复制、使用、修改及分发受知识共享(Creative Commons)署名—相同方式共享4.0国际公共许可协议(以下简称“CC BY-SA 4.0”)的约束。为了方便用户理解，您可以通过访问https://creativecommons.org/licenses/by-sa/4.0/ 了解CC BY-SA 4.0的概要 (但不是替代)。CC BY-SA 4.0的完整协议内容您可以访问如下网址获取：https://creativecommons.org/licenses/by-sa/4.0/legalcode。

修订记录

| 日期       | 修订   版本 | 修改描述             | 作者        |
| ---------- | ----------- | -------------------- | ----------- |
| 2022-09-21 | 1.0         | 特性测试报告初稿完成 | chengjiaqi1 |

 关键词： 

小型化，发布订阅

摘要：

本文档主要介绍openGauss开放发布订阅关于小型化的限制宏，使发布订阅功能在小型化版本开放。

缩略语清单：

| 缩略语 | 英文全名 | 中文解释 |
| ------ | -------- | -------- |
| 无     |          |          |

# 1 特性概述

openGauss开放了发布订阅关于小型化的限制宏，使得小型化版本支持创建发布订阅，同时又不影响原本的小型化特性。

# 2 特性测试信息

本节描述被测对象的版本信息和测试的时间及测试轮次，包括依赖的硬件。

| 版本名称                       | 测试起始时间 | 测试结束时间 |
| ------------------------------ | ------------ | ------------ |
| openGauss 3.1.0 build 88ca9bcd | 2022-09-15   | 2022-09-21   |

描述特性测试的环境信息

| 环境信息 | 配置信息                                                     | 备注 |
| -------- | ------------------------------------------------------------ | ---- |
| 虚拟机   | CPU：Intel(R) Xeon(R) Gold 6266C CPU @ 3.00GHz<br />内存：16GB<br />硬盘：320G<br />OS：openEuler release 20.03 (LTS-SP1) |      |



# 3 测试结论概述

## 3.1 测试整体结论

​	发布订阅支持小型化部署共计执行用例589条，主要包括覆盖已有发布订阅功能用例，如发布订阅的简单创建，发布订阅与主备切换结合，发布订阅与升级结合，发布订阅在不同场景下的数据同步状态以及针对不同的数据表类型创建发布订阅，创建发布订阅时的参数校验，事务/函数中创建发布订阅，发布订阅与备份恢复结合，创建发布订阅安全/权限校验，发布订阅与减/扩容结合，此次共执行用例282条。除此之外，新增发布端/订阅端小型化版本与企业版本交互相关用例25条，执行已有小型化用例282条以及资料测试。测试过程一共发现问题3个，已提单，状态均为待办的。

| 测试活动 | 活动评价                                                     |
| -------- | ------------------------------------------------------------ |
| 功能测试 | 覆盖已有发布订阅功能用例282条，如发布订阅的简单创建，发布订阅与主备切换结合，发布订阅与升级结合，<br>发布订阅在不同场景下的数据同步状态以及针对不同的数据表类型创建发布订阅，创建发布订阅时的参数校验，<br>事务/函数中创建发布订阅，发布订阅与备份恢复结合，创建发布订阅安全/权限校验，发布订阅与减/扩容结合，<br>发现问题3个，已提单，状态均为待办的。 |
| 功能测试 | 覆盖已有小型化用例282条，通过                                |
| 资料测试 | 资料叙述准确无误，示例正确，约束全面，通过                   |

## 3.2 约束说明

1. 同一数据库内的多个订阅不应当订阅内容重复的发布（指发布相同的表），否则会产生数据重复或者主键冲突。
2. 如果被发布的表中包含不支持btree/hash索引的数据类型（如地理类型等），那么该表需要有主键，才能成功的复制UPDATE/DELETE操作到订阅端。否则复制会失败，同时订阅端会出现“FATAL: could not identify an equality operator for type xx”的日志。
3. 发布的属主和系统管理员才能执行ALTER PUBLICATION，同理订阅的所有者才能执行ALTER SUBSCRIPTION。
4. 权限问题，要创建一个发布，调用者必须拥有当前数据库的CREATE权限，要将表添加到发布中，调用者必须拥有该表的所有权。
5. 支持发布的表类型：只有持久基表才能成为发布的一部分，临时表、非日志表、外表、MOT表、物化视图、常规视图不能被发布。
6. 创建订阅时使用的发布端端口，不能为发布端主端口，而应该使用主端口+1端口，否则会与线程池冲突。
7. 一个订阅可以对应多个发布，每一个发布都可以有多个订阅者。
8. 要创建订阅，用户必须是一个具有SYSADMIN权限用户。
9. 在发布者端，wal_level必须被设置为logical。

## 3.3 遗留问题分析

### 3.3.1 遗留问题影响以及规避措施

| 问题单号                                                     | 问题描述                                                     | 问题级别 | 问题影响和规避措施 | 当前状态 |
| ------------------------------------------------------------ | ------------------------------------------------------------ | -------- | ------------------ | -------- |
| [I5SBUN](https://gitee.com/opengauss/openGauss-server/issues/I5SBUN?from=project-issue) | 小型化gaussdb进程中，有明文密码                              | 严重     | 待开发修复         | 待办的   |
| [I5RU0V](https://gitee.com/opengauss/openGauss-server/issues/I5RU0V?from=project-issue) | 发布订阅开启基础数据同步，使用gs_dump备份订阅端数据，<br/>会出现修改订阅超时的情况 | 待办的    |
| [I5SAZB](https://gitee.com/opengauss/openGauss-server/issues/I5SAZB?from=project-issue) | 小型化一主两备环境主备切换switchover超时                     | 次要     | 待开发修复         | 待办的   |

### 3.3.2 问题统计

|        | 问题总数 | 严重 | 主要 | 次要 | 不重要 |
| ------ | -------- | ---- | ---- | ---- | ------ |
| 数目   | 3        | 1    | 1    | 1    | 0      |
| 百分比 | 100%     | 33%  | 33%  | 34%  | 0      |

### 3.3.3 问题单汇总

| 序号 | issue号                                                      | 问题级别 | 问题简述                                                     | 问题状态 |
| ---- | ------------------------------------------------------------ | -------- | ------------------------------------------------------------ | -------- |
| 1    | [I5SBUN](https://gitee.com/opengauss/openGauss-server/issues/I5SBUN?from=project-issue) | 严重     | 小型化gaussdb进程中，有明文密码                              | 待办的   |
| 2    | [I5RU0V](https://gitee.com/opengauss/openGauss-server/issues/I5RU0V?from=project-issue) | 主要     | 发布订阅开启基础数据同步，使用gs_dump备份订阅端数据，<br/>会出现修改订阅超时的情况 | 待办的   |
| 3    | [I5SAZB](https://gitee.com/opengauss/openGauss-server/issues/I5SAZB?from=project-issue) | 次要     | 小型化一主两备环境主备切换switchover超时                     | 待办的   |



# 4 测试执行

## 4.1 功能测试

### 4.1.1 覆盖已有发布订阅功能用例

| 测试步骤                                                     | 测试结果                                                     |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| 1. 安装2套一主两备小型化数据库<br />2. 配置发布订阅端配置pg_hba.conf文件白名单<br>3. 执行用例 | 覆盖已有发布订阅功能用例，如发布订阅的简单创建，发布订阅与主备切换结合，发布订阅与升级结合，发布订阅在不同场景下的数据同步状态以及针对不同的数据表类型创建发布订阅，创建发布订阅时的参数校验，事务/函数中创建发布订阅，发布订阅与备份恢复结合，创建发布订阅安全/权限校验，发布订阅与减/扩容结合。一共执行用例282条。<br />共发现3个bug，已提单，状态均为待办的。 |

### 4.1.2 新增发布端/订阅端小型化版本与企业版本交互

| 测试步骤                                                     | 测试结果                       |
| ------------------------------------------------------------ | ------------------------------ |
| 1. 安装2套一主两备数据库，发布端与订阅端保证一端为小型化版本，一端为企业版本<br />2. 配置发布订阅端配置pg_hba.conf文件白名单<br>3.  执行用例 | 执行用例25条，执行结果符合预期 |

### 4.1.3 覆盖已有小型化用例

| 测试步骤                             | 测试结果                                                     |
| ------------------------------------ | ------------------------------------------------------------ |
| 1. 安装小型化数据库<br />2. 执行用例 | 执行已有小型化用例282条，执行结果符合预期，小型化新增发布订阅功能对原版特性无影响。 |

### 4.1.4 资料测试

| 测试步骤                               | 测试结果 |
| -------------------------------------- | -------- |
| 资料叙述准确无误，示例正确，约束全面。 | 通过     |

## 4.2 测试执行统计数据

| 版本名称                       | 测试用例数 | 用例执行结果               | 发现问题单数 |
| ------------------------------ | ---------- | -------------------------- | ------------ |
| openGauss 3.1.0 build 88ca9bcd | 589        | Passed：584<br />Failed：5 | 3            |

数据说明

1.  openGauss 3.1.0 build 88ca9bcd版本测试过程中共发现3个bug，其中2个主要，1个严重，状态均为待办的。缺陷密度为3（缺陷个数）/1.127k（代码行数）=2.7（个/kloc）

## 4.3 后续测试建议

1. 现有3个issus遗留，后续测试建议重点关注遗留问题的解决。

# 5     附件

无
