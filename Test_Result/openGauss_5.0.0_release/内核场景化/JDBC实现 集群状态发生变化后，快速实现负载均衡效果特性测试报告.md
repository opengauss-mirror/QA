![avatar](../../../images/openGauss.png)

版权所有 © 2023  openGauss社区
 您对“本文档”的复制、使用、修改及分发受知识共享(Creative Commons)署名—相同方式共享4.0国际公共许可协议(以下简称“CC BY-SA 4.0”)的约束。为了方便用户理解，您可以通过访问https://creativecommons.org/licenses/by-sa/4.0/ 了解CC BY-SA 4.0的概要 (但不是替代)。CC BY-SA 4.0的完整协议内容您可以访问如下网址获取：https://creativecommons.org/licenses/by-sa/4.0/legalcode。

修订记录

| 日期      | 修订   版本 | 修改描述     | 作者       |
| --------- | ----------- | ------------ | ---------- |
| 2023-3-23 | 1.0         | 测试报告初版 | peilinqian |
|           |             |              |            |

关键词： JDBC负载均衡、快速负载均衡

摘要：本文档主要验证最小连接负载模式、快速负载均衡开关打开的情况下，负载集群内节点恢复时，是否根据相应快速负载参数配置，对已经建连节点的符合关闭条件的连接进行关闭，并且后续新建连根据集群内最小连接节点进行负载。

 

缩略语清单：

| 缩略语    | 英文全名                   | 中文解释                                                     |
| --------- | -------------------------- | ------------------------------------------------------------ |
| JDBC      | Java Database Connectivity | Java数据库连接，是一种用于执行SQL语句的Java API，可以为多种关系数据库提供统一访问接口，应用程序可基于它操作数据。 |
| DN        | data node                  | 数据节点。                                                   |
| LeastConn | Least Connection Model     | 最小连接模式，即JDBC建立连接时，优先在集群中连接最少的节点创建连接。 |

# 1     特性概述

opengauss-jdbc本身已实现了部分负载均衡算法，可以在客户端层面，实现客户端通过JDBC创建连接时，JDBC基于负载均衡算法均匀地选择集群内节点创建连接。本特性在此基础上增加实现LeastConn负载均衡算法，并且基于LeastConn实现当集群内节点恢复时，集群内连接快速负载均衡。即：当监测到集群内存在某节点故障再恢复后，选择已有节点中的部分空闲连接关闭，客户端新建连接时会基于LeastConn模式在恢复节点上创建连接，以实现快速负载均衡。

# 2     特性测试信息

| 版本名称           | 测试起始时间 | 测试结束时间 |
| ------------------ | ------------ | ------------ |
| JDBC build 19d4aa4 | 2023-3-6     | 2023-3-13    |
| JDBC build be68803 | 2023-3-15    | 2023-3-17    |
| JDBC build 6342f8f | 2023-3-22    | 2023-3-22    |

| 环境信息                                    | 配置信息                                                     | 备注                                                         |
| ------------------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| ARM+openEuler<br />TaiShan 200 (Model 2280) | CPU：Kunpeng 920-4826 2p 96核<br />内存：256GB<br />硬盘：300G<br />OS：openEuler release 20.03 (LTS)<br />文件系统：EXT4<br />网卡：1GE | 一主两备集群环境；<br />JDBC客户端环境；<br />备注：实际对环境无具体要求，只要能正常安装运行一主两备集群即可。 |

| 软件名称  | 软件版本                                                     | 备注               |
| --------- | ------------------------------------------------------------ | ------------------ |
| openGauss | openGauss 5.0.0 build e94d3b43                               |                    |
| JDBC      | JDBC build 19d4aa4<br />JDBC build be68803<br />JDBC build 6342f8f | 共测试3轮，3个版本 |

   

# 3     测试结论概述

## 3.1   测试整体结论

共计执行36个用例，主要覆盖了功能测试、可靠性、性能测试；发现问题5个，已解决5个，回归通过，无遗留风险，整体质量良好；

| 测试活动   | 活动评价                                                     |
| ---------- | ------------------------------------------------------------ |
| 功能测试   | （1）新增负载模式leastconn功能验证，验证遵循最小连接，功能正常；<br />（2）新增快速负载均衡4个参数异常配置、正常配置及生效、不同参数组合配置场景验证，功能正常；<br />（3）快速负载参数与其他参数targetServerType组合配置、进行主备切换等场景验证，功能正常；<br />（4）验证集群某些节点stop后再start、集群密码变更后又恢复场景下，监测集群节点状态正常；<br />（5）验证同一JDBC应用，不同连接串场景下负载均衡，功能正常。 |
| 可靠性测试 | （1）新增快速负载均衡场景下，不同节点来回启停或者主备切换，JDBC应用进程正常，监测心跳线程不异常抛错；<br />（2）新增负载模式leastconn，在并发场景下，遵循最小连接，功能正常。 |
| 性能测试   | （1）验证开启负载均衡、快速负载均衡两种场景下，tpcc只读性能。性能无下降。 |

## 3.2   约束说明

（1）JDBC连接串集群节点数量大于1且设置参数autoBalance=leastconn&enableQuickAutoBalance=true，开启快速负载均衡。

（2）JDBC支持的负载均衡是客户端级别的负载均衡，会对基于该驱动程序在同一集群上创建的连接负载均衡，不会基于该集群中各节点的实际连接数负载均衡，也不会基于其他驱动程序创建的连接负载均衡。

（3）JDBC无法感知到连接是否为连接池中的空闲连接，根据配置的参数，快速负载均衡可能会关闭用户已持有的连接。

（4）JDBC在进行节点恢复后的快速负载均衡时，会根据配置的配置参数，筛选满足条件的部分连接关闭，最后各节点的连接数量未必会非常相近。如果大部分已有连接都不满足关闭条件，比如全部处于活跃状态，则无法进行快速负载均衡。

（5）targetServerType的优先级高于创建连接时的负载均衡，jdbc会根据targetServerType对连接串中的节点做筛选。

## 3.3   遗留问题分析

### 3.3.1 遗留问题影响以及规避措施

| 问题单号 | 问题描述 | 问题级别 | 问题影响和规避措施 | 当前状态 |
| -------- | -------- | -------- | ------------------ | -------- |
| N/A      |          |          |                    |          |

### 3.3.2 问题统计

|        | 问题总数 | 严重 | 主要 | 次要 | 不重要 |
| ------ | -------- | ---- | ---- | ---- | ------ |
| 数目   | 5        | 0    | 1    | 4    | 0      |
| 百分比 | 100%     | 0%   | 20%  | 80%  | 0%     |

### 3.3.3 问题单汇总

| 序号 | issue号                                                      | 问题级别 | 问题简述                                                     | 问题状态 |
| ---- | ------------------------------------------------------------ | -------- | ------------------------------------------------------------ | -------- |
| 1    | [I6KBRQ](https://e.gitee.com/opengaussorg/projects/477260/bugs/table?issue=I6KBRQ) | 次要     | 【测试类型：接口功能】【测试版本：5.0.0】 JDBC连接参数autoBalance=leastconn后，java主程序执行完成后进程不能正常退出 | 已验收   |
| 2    | [I6ODM5](https://e.gitee.com/opengaussorg/projects/477260/bugs/table?issue=I6ODM5) | 次要     | 【测试类型：接口功能】【测试版本：5.0.0】 定时关闭部分连接线程，间隔5s进行kill连接，但是实际隔了20s进行kill | 已验收   |
| 3    | [I6LW3C](https://e.gitee.com/opengaussorg/projects/477260/bugs/table?issue=I6LW3C) | 次要     | 【测试类型：接口功能】【测试版本：5.0.0】 leastconn负载均衡模式下，JDBC连接失效，数据库端连接未kill | 已验收   |
| 4    | [I6LUZL](https://e.gitee.com/opengaussorg/projects/477260/bugs/table?issue=I6LUZL) | 次要     | 【测试类型：资料】【测试版本：5.0.0】快速负载均衡相关说明文档，存在问题 | 已验收   |
| 5    | [I6KCEL](https://e.gitee.com/opengaussorg/projects/477260/bugs/table?issue=I6KCEL) | 次要     | 【测试类型：接口功能】【测试版本：5.0.0】 JDBC连接快速负载均衡相关参数设置异常值，应该先抛错，不进行连接，现状是抛错后仍连接 | 已验收   |

# 4     测试执行

## 4.1   测试执行统计数据

| 版本名称           | 测试用例数 | 用例执行结果         | 发现问题单数 |
| ------------------ | ---------- | -------------------- | ------------ |
| JDBC build 19d4aa4 | 36         | Passed：30 Failed：6 | 4            |
| JDBC build be68803 | 36         | Passed：35 Failed：1 | 1            |
| JDBC build 6342f8f | 1          | Passed：1 Failed：0  | 0            |

**数据项说明：**

- 测试用例数：到本测试活动结束时，所有可用测试用例数；
- 发现问题单数：本测试活动可靠性用例总共发现的问题单数；
- 用例执行结果：第一、二轮测试全量执行，第三轮回归问题单。
- 缺陷密度：5(缺陷个数)/3.933kloc(代码行数)=1.27(个/kloc)

## 4.2   后续测试建议

无

# 5     附件

## 5.1   特性新增4个参数

- enableQuickAutoBalance： 是否开启节点变化后快速负载均衡功能。
- maxIdleTimeBeforeTerminal：开启快速负载均衡功能时可用，触发快速负载均衡时，至少处于空闲状态多久的连接可以被关闭。
- minReservedConPerCluster：快速负载均衡时，一个集群内筛选出来的可关闭连接最小保留百分比。
- minReservedConPerDatanode：快速负载均衡时，一个节点要保留内筛选出来的可关闭连接最小保留百分比。

## 5.2   资料链接

| 资料内容                               | 资料链接                                                     |
| -------------------------------------- | ------------------------------------------------------------ |
| 新增4个JDBC参数简单说明                | https://docs.opengauss.org/zh/docs/latest/docs/Developerguide/%E8%BF%9E%E6%8E%A5%E6%95%B0%E6%8D%AE%E5%BA%93-0.html |
| 快速负载均衡应用场景示例及参数详细说明 | https://docs.opengauss.org/zh/docs/latest/docs/Developerguide/%E7%A4%BA%E4%BE%8B-jdbc%E4%B8%BB%E5%A4%87%E9%9B%86%E7%BE%A4%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1.html |







 

 
