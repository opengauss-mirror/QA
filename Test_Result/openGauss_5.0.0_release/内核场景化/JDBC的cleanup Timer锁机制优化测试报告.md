![avatar](../../../images/openGauss.png)

版权所有 © 2023  openGauss社区
 您对“本文档”的复制、使用、修改及分发受知识共享(Creative Commons)署名—相同方式共享4.0国际公共许可协议(以下简称“CC BY-SA 4.0”)的约束。为了方便用户理解，您可以通过访问https://creativecommons.org/licenses/by-sa/4.0/ 了解CC BY-SA 4.0的概要 (但不是替代)。CC BY-SA 4.0的完整协议内容您可以访问如下网址获取：https://creativecommons.org/licenses/by-sa/4.0/legalcode。

修订记录

| 日期       | 修订   版本 | 修改描述             | 作者        |
| ---------- | ----------- | -------------------- | ----------- |
| 2023-03-16 | 1.0         | 特性测试报告初稿完成 | chengjiaqi1 |

 关键词： 

  JDBC，cleanup Timer锁，TPC-C，tpmc

摘要：

  本文档主要介绍对JDBC cleanup Timer锁机制的优化，以提升高并发场景下的JDBC性能。

缩略语清单：

| 缩略语 | 英文全名                               | 中文解释                                                     |
| ------ | -------------------------------------- | ------------------------------------------------------------ |
| TPC-C  | Trade Promotion Coordination Committee | 在线事务处理(OLTP)的基准程序                                 |
| tpmc   | transaction per minute                 | TPC-C的吞吐量，按有效TPC-C配置期间每分钟处理的平均交易次数测试 |

# 1 特性概述

  JDBC会在statement执行SQL语句前后通过配置setQueryTimeout>0触发cleanup Timer锁执行一些清理操作。现有的锁触发机制是整个JAVA程序共用一个锁变量，即在JDBC应用初始化时创建，所有线程共享。这就导致在SQL执行并发度很高的情况下产生大量的锁等待，影响性能。

  此次需求针对目前JDBC锁调用存在的问题加以优化，将cleanup Timer锁的粒度降低到线程级别，把锁与连接connection对应起来，即每个connection对应各自的cleanup Timer锁。这样在每个connection下创建单个/多个statement执行SQL语句时，statement之间只会竞争自己所在的connection对应的cleanup Timer锁，从而降低了锁竞争的压力，提升高并发场景下的JDBC性能。

# 2 特性测试信息

  本节描述被测对象的版本信息和测试的时间及测试轮次，包括依赖的软件。

| 版本名称                       | 测试起始时间 | 测试结束时间 |
| ------------------------------ | ------------ | ------------ |
| openGauss 5.0.0 build 5a69c469 | 2023-03-06   | 2023-03-10   |

描述特性测试的环境信息

| 环境信息 | 配置信息                                                     | 备注 |
| -------- | ------------------------------------------------------------ | ---- |
| 虚拟机   | CPU：Kunpeng-920<br />内存：254GB<br />硬盘：1.1TB<br />OS：openEuler release 20.03 (LTS) |      |

| 软件名称     | 软件版本                                              |
| ------------ | ----------------------------------------------------- |
| benchmarksql | 定制版本<br>https://gitee.com/chen-czywj/benchmarksql |



# 3  测试结论概述

## 3.1 测试整体结论

  JDBC的cleanup Timer锁机制优化共计执行用例83条，主要覆盖功能测试，性能测试和可靠性测试。其中，功能测试主要覆盖验证现有JDBC功能用例不受影响；验证多线程下创建多connection，每个connection下创建多个statement执行SQL语句是否成功以及验证设置setQueryTimeout小于SQL语句实际执行时间时返回结果是否合理。 性能测试主要覆盖java脚本中开启多线程创建多个connection，每个connection下创建多个statement执行SQL（select，update，insert，delete）语句，通过对比优化前后SQL语句执行时间以及SQL语句峰值执行时间，验证优化后JDBC性能是否提升；java脚本中开启多线程创建多个connection，每个connection下创建单个statement执行SQL（select，update，insert，delete）语句，通过对比优化前后SQL语句执行时间以及SQL语句峰值执行时间，验证优化后JDBC性能是否提升；验证优化后在理想场景（不涉及对数据表的操作，仅连接数据库获取当前时间）下JDBC性能是否提升；java脚本使用prestatement预编译语句执行单次/多次批量插入，通过对比优化前后SQL语句执行时间以及SQL语句峰值执行时间，验证优化后JDBC性能是否提升；java脚本中分别设置setQueryTimeout3种场景(>0，=0，不设置)，验证配置setQueryTimeout>0与setQueryTimeout=0，不设置setQueryTimeout相比性能是否提升；多次执行TPC-C，通过对比优化前后tpmc值，验证优化后JDBC性能是否提升。可靠性测试主要覆盖在JDBC连接数据库执行SQL语句过程中kill -9数据库进程，验证程序是否合理报错结束，是否陷入死锁以及JDBC连接数据库执行SQL语句过程中kill -19数据库进程，验证程序是否合理报错，是否陷入死锁，kill -18重新拉起进程程序是否继续执行。测试过程中未发现缺陷。

| 测试活动   | 活动评价                                                     |
| ---------- | ------------------------------------------------------------ |
| 功能测试   | 执行现有JDBC功能用例，通过                                   |
| 功能测试   | 验证新增多线程下创建多connection，每个connection下创建多个statement执行<br>SQL语句是否成功，通过 |
| 功能测试   | 验证设置setQueryTimeout小于SQL语句实际执行时间时执行结果是否合理，通过 |
| 性能测试   | 开启多线程创建多个connection，每个connection下创建多个statement<br>执行SQL（select，update，insert，delete）语句，通过对比优化前后SQL语句执<br>行时间以及SQL语句峰值执行时间，验证优化后JDBC性能是否提升，通过 |
| 性能测试   | 开启多线程创建多个connection，每个connection下创建单个statement<br>执行SQL（select，update，insert，delete）语句，通过对比优化前后SQL语句<br>执行时间以及SQL语句峰值执行时间，验证优化后JDBC性能是否提升，通过 |
| 性能测试   | 验证优化后在理想场景（不涉及对数据表的操作，仅连接数据库获取当前时间）下<br>JDBC性能是否提升，通过 |
| 性能测试   | prestatement预编译语句执行单次/多次批量插入，通过对比优化<br>前后SQL语句执行时间以及SQL语句峰值执行时间，验证优化后JDBC性<br>能是否提升，通过 |
| 性能测试   | 分别设置setQueryTimeout3种场景(>0，=0，不设置)，<br>验证setQueryTimeout>0与setQueryTimeout=0，不设置setQueryTimeout<br>相比性能是否提升，通过 |
| 性能测试   | 多次执行TPC-C，通过对比优化前后tpmc值，验证优化后JDBC性能是否提升，通过 |
| 可靠性测试 | 在JDBC连接数据库执行SQL语句过程中kill -9数据库进程，验证程序是否合理报错，<br>是否陷入死锁，通过 |
| 可靠性测试 | JDBC连接数据库执行SQL语句过程中kill -19数据库进程，验证程序是否合理报错，<br>是否陷入死锁，kill -18重新拉起进程程序是否继续执行，通过 |

## 3.2 约束说明

1. 仅是提升高并发场景的SQL执行的并发度，不影响JDBC使用功能；
1. 必须设置参数setQueryTimeout>0才能触发锁


## 3.3  遗留问题分析

### 3.3.1 遗留问题影响以及规避措施

| 问题单号 | 问题描述 | 问题级别 | 问题影响和规避措施 | 当前状态 |
| -------- | -------- | -------- | ------------------ | -------- |
| NA       |          |          |                    |          |

### 3.3.2 问题统计

|        | 问题总数 | 严重 | 主要 | 次要 | 不重要 |
| ------ | -------- | ---- | ---- | ---- | ------ |
| 数目   | 0        | 0    | 0    | 0    | 0      |
| 百分比 | 0%       | 0    | 0%   | 0    | 0      |

### 3.3.3 问题单汇总

| 序号 | issue号 | 问题级别 | 问题简述 | 问题状态 |
| ---- | ------- | -------- | -------- | -------- |
| 无   |         |          |          |          |



# 4 测试执行

## 4.1 功能测试

#### 4.1.1 执行现有JDBC功能用例

| 测试步骤                                                     | 测试结果                         |
| ------------------------------------------------------------ | -------------------------------- |
| 1. 使用优化后opengauss-jdbc-5.0.0-jar执行现有功<br>能JDBC用例 | 共执行66条用例，执行结果符合预期。 |

#### 4.1.2 验证新增多线程下创建多connection，每个connection下创建多个statement执行SQL语句是否成功

| 测试步骤                                                     | 测试结果                        |
| ------------------------------------------------------------ | ------------------------------- |
| 1. 编写java脚本，在多线程下创建多connection，每个<br>connection下创建多个statement执行SQL语句<br>2. 使用优化后opengauss-jdbc-5.0.0-jar执行脚本<br>3. 根据java脚本日志返回结果判断执行是否成功 | 共执行1条用例，执行结果符合预期。 |

#### 4.1.3 验证设置setQueryTimeout小于SQL语句实际执行时间时执行结果是否合理

| 测试步骤                                                     | 测试结果                      |
| ------------------------------------------------------------ | ----------------------------- |
| 1. 编写java脚本，设置setQueryTimeout小于SQL语句实际执行时间<br>2. 使用优化后opengauss-jdbc-5.0.0-jar执行脚本<br>3. 根据java脚本日志返回结果判断执行结果是否正确，<br>是否陷入死锁 | 共执行1条用例，执行结果符合预期 |

## 4.2 性能测试

#### 4.2.1 开启多线程创建多个connection，每个connection下创建多个statement，执行SQL语句，验证优化后JDBC性能是否提升

| 测试步骤                                                     | 测试结果                      |
| ------------------------------------------------------------ | ----------------------------- |
| 1. 编写java脚本，开启多线程创建多个connection，<br>每个connection下创建多个statement，执行SQL<br>(select,update,insert,delete)语句<br/>2. 分别使用优化前后opengauss-jdbc-5.0.0-jar多次执行脚本，<br>通过对比优化前后SQL语句执行时间以及SQL语句峰值执行时间，验证优化后JDBC性能是否提升 | 共计执行4条用例，分别使用优化前后jdbc执行5次脚本，得出执行select语句优化后较优化前SQL平均执行时间性能提升4.4%，SQL语句平均峰值执行时间性能提升8.1%。insert语句优化后较优化前针对SQL平均执行时间性能提升13%，SQL语句平均峰值执行时间性能未提升。delete和update语句性能优化前后未提升。|

#### 4.2.2 开启多线程创建多个connection，每个connection下创建单个statement，执行SQL语句，验证优化后JDBC性能是否提升

| 测试步骤                                                     | 测试结果                      |
| ------------------------------------------------------------ | ----------------------------- |
| 1. 编写java脚本，开启多线程创建多个connection，<br>每个connection下创建单个statement，执行SQL<br>(select,update,insert,delete)语句<br/>2. 分别使用优化前后opengauss-jdbc-5.0.0-jar多次执行脚本，<br>通过对比优化前后SQL语句执行时间验证优化后JDBC性能是否提升 | 共执行4条用例，分别使用优化前后jdbc执行5次脚本，得出执行select语句优化后较优化前针对SQL平均执行时间性能提升13%。insert语句优化后较优化前针对SQL平均执行时间性能提升17.6%。delete和update语句性能优化前后未提升。|

#### 4.2.3 验证优化后在理想场景下JDBC性能是否提升

| 测试步骤                                                     | 测试结果                      |
| ------------------------------------------------------------ | ----------------------------- |
| 1. 编写java脚本，开启多线程创建多个connection，<br>每个connection下创建多个statement，执行不涉及<br>对数据表的操作，仅连接数据库获取当前时间<br>2. 分别使用优化前后opengauss-jdbc-5.0.0-jar多次执行脚本，<br>通过对比优化前后SQL语句执行时间，验证优化后JDBC性能是否提升 | 共执行1条用例，分别使用优化前后jdbc执行5次脚本，得出优化后较优化前理想场景下SQL平均执行时间性能提升3.6% |

#### 4.2.4 prestatement预编译语句执行单次/多次批量插入，验证优化后JDBC性能是否提升

| 测试步骤                                                     | 测试结果                      |
| ------------------------------------------------------------ | ----------------------------- |
| 1. 编写java脚本，开启多线程创建多个connection，<br>每个connection下创建prestatement执行单次/多次批量插入<br>2. 分别使用优化前后opengauss-jdbc-5.0.0-jar多次执行脚本，<br>通过对比优化前后SQL语句执行时间以及SQL语句峰值执行时间，验证优化后JDBC性能是否提升 | 共执行2条用例，分别使用优化前后jdbc执行5次脚本，得出优化后较优化前SQL平均执行时间和SQL语句平均峰值执行时间性能未提升 |

#### 4.2.5 设置setQueryTimeout3种场景(>0，=0，不设置)，验证setQueryTimeout>0时与setQueryTimeout=0，setQueryTimeout不设置相比性能是否提升

| 测试步骤                                                     | 测试结果                      |
| ------------------------------------------------------------ | ----------------------------- |
| 1. 编写java脚本，开启多线程创建多个connection，<br>每个connection下创建多个statement，分别设置setQueryTimeout>0，setQueryTimeout=0，不设置setQueryTimeout<br>2. 分别多次执行3种setQueryTimeout创建下的java脚本，<br>对比sql平均执行时间和sql语句平均峰值执行时间，验证setQueryTimeout>0与setQueryTimeout=0，不设置setQueryTimeout相比JDBC性能是否提升 | 共执行1条用例，3种setQueryTimeout取值下分别执行5次脚本，得出setQueryTimeout>0时JDBC性能较setQueryTimeout=0和不设置setQueryTimeout相比，SQL语句平均执行时间和SQL语句平均峰值执行时间性能均有提升，SQL语句平均执行时间分别提升8.3%和10.8%，SQL语句平均峰值执行时间分别提升12.3%和16.8% |

#### 4.2.6 执行TPC-C，通过对比优化前后tpmc值，验证优化后JDBC性能是否提升

| 测试步骤                                                     | 测试结果                      |
| ------------------------------------------------------------ | ----------------------------- |
| 1. 下载定制版本benchmarksql并编译，配置pros.pg<br>2. 使用原始版本benchmarksql连接优化前后数据库构造数据<br>3. 切换至定制版本benchmarksql，分别使用优化前后opengauss-jdbc-5.0.0-jar跑TPC-C<br>4. 获取多次执行的tpmc平均值，验证优化后JDBC性能是否提升 | 共执行1条用例，分别在优化前后数据库中执行TPC-C5次，得出优化后tpmc较优化前提升0.7% |

### 4.3 可靠性测试

#### 4.3.1 JDBC连接数据库执行SQL语句过程中kill -9数据库进程，验证程序是否合理报错结束，是否陷入死锁

| 测试步骤                                                     | 测试结果                      |
| ------------------------------------------------------------ | ----------------------------- |
| 1. 使用优化后opengauss-jdbc-5.0.0-jar连接数据库执行SQL命令<br>2. step1执行过程中kill -9 数据库进程<br>3. 观察java程序是否正常报错，是否陷入死锁 | 共执行1条用例，执行结果符合预期 |

#### 4.3.2 JDBC连接数据库执行SQL语句过程中kill -19数据库进程，验证程序是否合理报错，是否陷入死锁，kill -18重新拉起进程后程序是否继续执行

| 测试步骤                                                     | 测试结果                      |
| ------------------------------------------------------------ | ----------------------------- |
| 1. 使用优化后opengauss-jdbc-5.0.0-jar连接数据库执行SQL命令<br>2. step1执行过程中kill -19 数据库进程<br>3. 观察java程序是否正常报错，是否陷入死锁<br>4. 程序持续运行一段时间后kill -18重新拉起数据库进程，观察<br>程序是否继续执行 | 共执行1条用例，执行结果符合预期 |

### 4.4 测试执行统计数据

| 版本名称                       | 测试用例数 | 用例执行结果                        | 发现问题单数 |
| ------------------------------ | ---------- | ----------------------------------- | ------------ |
| openGauss 5.0.0 build 5a69c469 | 83         | 2023-03-10Passed：83<br />Failed：0 | 0            |

数据说明

1.  openGauss 5.0.0 build 5a69c469 版本测试过程共执行用例83条，未发现bug。

### 4.4 后续测试建议

1. 优化后JDBC性能的优化只体现在select语句，对dml语句（insert，delete，update）会出现性能不提升或性能劣化的情况，与开发讨论后确认是数据库端对并发修改表数据存在排它锁的影响以及数据库本身性能波动影响，建议后续关注此方面。
2. 性能提升未提供具体提升指标，建议后续关注是否补充。

# 5 附件

无