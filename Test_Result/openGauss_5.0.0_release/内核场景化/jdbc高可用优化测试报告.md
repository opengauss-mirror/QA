![avatar](../../../images/openGauss.png)

版权所有 © 2023  openGauss社区
您对“本文档”的复制、使用、修改及分发受知识共享(Creative Commons)署名—相同方式共享4.0国际公共许可协议(以下简称“CC BY-SA 4.0”)的约束。为了方便用户理解，您可以通过访问https://creativecommons.org/licenses/by-sa/4.0/ 了解CC BY-SA 4.0的概要 (但不是替代)。CC BY-SA 4.0的完整协议内容您可以访问如下网址获取：https://creativecommons.org/licenses/by-sa/4.0/legalcode。

修订记录

| 日期      | 修订   版本 | 修改描述     | 作者       |
| --------- | ----------- | ------------ | ---------- |
| 2023-3-15 | 1.0         | 测试报告初稿 | lichunlong |

 关键词： JDBC

 

摘要：本文验证opengauss-JDBC是否实现对数据库节点的探活。当主节点故障之后，是否可以将新的建连请求切换到新的主节点上面去请求建连，达到用户无感知使用JDBC操作数据库的目标。

 

缩略语清单：

| 缩略语 | 英文全名                   | 中文解释                                                     |
| ------ | -------------------------- | ------------------------------------------------------------ |
| JDBC   | Java Database Connectivity | 一种用于执行SQL语句的Java API，可以为多种关系数据库提供统一访问接口，应用程序可基于它操作数据 |

# 1     特性概述

JDBC心跳线程感知主节点故障，通过在备机上查询节点信息，获取当前主节点，对原先连到主节点的连接kill掉，用户新连接直接连到新主节点；该需求用于实现集群中主节点挂掉时，快速实现下次建连路由到新的主节点上创建链接。

# 2     特性测试信息

本节描述被测对象的版本信息和测试的时间及测试轮次，包括依赖的硬件。

| 版本名称                       | 测试起始时间 | 测试结束时间 |
| ------------------------------ | ------------ | ------------ |
| openGauss 5.0.0 build 5a69c469 | 2023-03-06   | 2023-03-10   |

描述特性测试的硬件环境信息

| 环境信息 | 配置信息                                                     | 备注 |
| -------- | ------------------------------------------------------------ | ---- |
| 虚拟机   | Intel(R) Xeon(R) Gold 6266C CPU @ 3.00GHz<br/>内存：32GB<br/>硬盘：ssd<br/>OS：openEuler release 20.03 (LTS-SPI) |      |

# 3     测试结论概述

## 3.1   测试整体结论

JDBC高可用优化测试攻击用例17条，主要覆盖了功能，可靠性，性能分析和资料测试。功能测试包含参数参数测试、JDBC连接主备集群时主机异常，JDBC心跳检测切换新主的测试；可靠性测试包含双主、连接信息失效以及主备频繁切换的场景；性能分析主要测试当打开心跳检测线程时，不影响JDBC的性能；可维护性分析测试；模块交互影响分析；关于心跳检测优化的资料无异常。测试过程中发现2个问题，均已回归通过。

| 测试活动         | 活动评价                                                     |
| ---------------- | ------------------------------------------------------------ |
| 功能测试         | 参数测试，测试与预期结果一致                                 |
| 功能测试         | JDBC打开心跳检测连接数据库，主机异常、主机恢复，原连接中断，新建连接建立成功 |
| 功能测试         | JDBC打开心跳检测连接数据库，主机异常，备机升主，原连接中断，新建连接识别新主成功 |
| 功能测试         | JDBC打开心跳检测连接数据库，关闭连接，程序正常退出成功       |
| 功能测试         | 建立多个JDBC连接，并打开心跳检测线程，分别识别每个连接的主机测试成功 |
| 模块交互影响测试 | targetServerType=slave时，不触发心跳检测                     |
| 可维护性测试     | 日志打开时可看到检测主机连接日志，关闭时无日志               |
| 可靠性测试       | JDBC打开心跳检测连接数据库，连接url中包含多个主机，识别第一个主机，不识别后面的主机测试 |
| 可靠性测试       | JDBC打开心跳检测连接数据库，数据库方修改密码后，连接失效测试成功 |
| 可靠性测试       | JDBC打开心跳检测频繁建连数据库，主备频繁切换测试，无异常报错 |
| 性能分析         | 打开心跳检测、关闭心跳检测，分别执行tpcc 1000warehouses，1000 terminals测试，对比测试结果，性能无劣化 |
| 资料测试         | 资料描述准确，整体质量良好                                   |

## 3.2   约束说明

1.  仅支持JDBC高可用方式连接openGauss，才会加到缓存进行心跳维护
2. 为保证新的主节点的探测，JDBC连接属性url设置： jdbc:opengauss://host1:port,host2:port,host3:port//database?targetServerType=master& heartbeatPeriod=5000

## 3.3   遗留问题分析

### 3.3.1 遗留问题影响以及规避措施

| 问题单号 | 问题描述 | 问题级别 | 问题影响和规避措施 | 当前状态 |
| -------- | -------- | -------- | ------------------ | -------- |
| NA       |          |          |                    |          |

### 3.3.2 问题统计

|        | 问题总数 | 严重 | 主要 | 次要 | 不重要 |
| ------ | -------- | ---- | ---- | ---- | ------ |
| 数目   | 2        | 0    | 1    | 1    | 0      |
| 百分比 | 100%     | 0%   | 50%  | 50%  | 0      |

### 3.3.3 问题单汇总

| 序号 | issue号                                                      | 级别 | 问题简述                                                     | 状态   |
| ---- | ------------------------------------------------------------ | ---- | ------------------------------------------------------------ | ------ |
| 1    | [I6NP94](https://gitee.com/opengauss/openGauss-connector-JDBC/issues/I6NP94) | 主要 | JDBC连接加入targetServerType=slave&heartbeatPeriod=5000参数后，进程不能正常退出 | 已完成 |
| 2    | [I6K85Q](https://gitee.com/opengauss/openGauss-connector-JDBC/issues/I6K85Q) | 次要 | JDBC连接加入targetServerType=master&heartbeatPeriod=5000参数后，进程不能正常退出 | 已完成 |



# 4     测试执行

## 4.1   功能测试

### 4.1.1 参数测试

| 测试步骤                                                     | 测试结果               |
| ------------------------------------------------------------ | ---------------------- |
| 1. 配置targetServerType=master&heartbeatPeriod=5000，执行JDBC建连，心跳检测线程启动，间隔5秒<br />2. 配置targetServerType=master&heartbeatPeriod=0/-1，执行JDBC建连，无心跳检测线程<br />3. 配置 targetServerType=master&heartbeatPeriod=test，执行JDBC建连，合理报错<br />4. 配置heartbeatPeriod=5000，执行JDBC建连，无心跳检测线程 | 执行3条用例，未发现bug |

### 4.1.2 JDBC建连时，主机异常、主机恢复，

| 测试步骤                                                     | 测试结果               |
| ------------------------------------------------------------ | ---------------------- |
| 1. JDBC打开心跳检测连接数据库，并打开心跳检测，kill数据库主节点，心跳检测主机失败；恢复主节点，心跳检测识别主机<br />2. JDBC打开心跳检测连接数据库，并打开心跳检测，kill数据库主节点，心跳检测主机失败；不恢复主节点，心跳检测识别不到主机 | 执行2条用例，未发现bug |

### 4.1.3 JDBC建连时，备机执行switchover

| 测试步骤                                                     | 测试结果               |
| ------------------------------------------------------------ | ---------------------- |
| 1. JDBC打开心跳检测连接数据库，kill数据库主节点，备机执行switchover，心跳检测主机失败；switchover成功后，心跳检测识别新主机成功<br />2. JDBC打开心跳检测连接数据库，kill数据库主节点，备机执行switchover，JDBC连接执行sql失败，心跳检测主机失败；switchover成功后，心跳检测识别新主机成功，再次执行sql成功 | 执行2条用例，未发现bug |

### 4.1.4  JDBC建连时，主备执行failover

| 测试步骤                                                     | 测试结果               |
| ------------------------------------------------------------ | ---------------------- |
| 1. JDBC打开心跳检测连接数据库，kill主机，备机执行failover，心跳检测主机失败；failover成功后，心跳检测识别新主机成功<br />2. JDBC打开心跳检测连接数据库，kill主机，备机执行failove，JDBC连接执行sql失败，心跳检测主机失败；failove成功后，心跳检测识别新主机成功，再次执行sql成功 | 执行2条用例，未发现bug |

### 4.1.5 JDBC建连，关闭连接，程序正常退出

| 测试步骤                                              |                                 |
| ----------------------------------------------------- | ------------------------------- |
| 1. JDBC打开心跳检测连接数据库，关闭连接，程序正常退出 | 执行1条用例，发现1个bug，已修复 |

### 4.1.6 多主机连接

| 测试步骤                                          | 测试结果               |
| ------------------------------------------------- | ---------------------- |
| 1. JDBC打开心跳检测建立多个连接，分别识别主机成功 | 执行1条用例，未发现bug |

### 4.1.7 配置targetServerType=slave时，心跳线程不启动

| 测试步骤                                                     | 测试结果                        |
| ------------------------------------------------------------ | ------------------------------- |
| 1. 配置targetServerType=slave&heartbeatPeriod=5000，执行JDBC建连，不开启心跳检测线程 | 执行1条用例，发现1个bug，已修复 |

### 4.1.8 日志验证

| 测试步骤                                                     | 测试                   |
| ------------------------------------------------------------ | ---------------------- |
| 1. 配置loggerLevel=DEBUG时，打印心跳检测过程日志<br />2. 配置loggerLevel=OFF时，不打印日志 | 执行1条用例，未发现bug |



## 4.2 可靠性测试

| 测试步骤                                                     | 测试结果               |
| ------------------------------------------------------------ | ---------------------- |
| 1. JDBC打开心跳检连接url中配置多个主机ip，识别第一个主机后，不识别后面的主机<br />2. JDBC打开心跳检连接期间，连接信息失效，连接中断测试成功<br />3. JDBC打开心跳检不停的进行建连，同时数据库频繁切换主备，连接不异常关闭，并且识别主机成功 | 执行3条用例，未发现bug |

### 4.3 性能分析

| 测试步骤                                                     | 测试结果                    |
| ------------------------------------------------------------ | --------------------------- |
| 1. 打开心跳检测、关闭心跳检测，分别执行tpcc 1000warehouses，1000 terminals测试，对比测试结果，性能无劣化 | 执行1条用例，未发现性能劣化 |

## 4.4 测试执行统计数据

| 版本名称                       | 测试用例数 | 用例执行结果         | 发现问题数 |
| ------------------------------ | ---------- | -------------------- | ---------- |
| openGauss 5.0.0 build 5a69c469 | 17         | Passed：15 Failed：2 | 2          |

数据说明：

- 累计发现问题单2个，2个已完成。
- 缺陷密度：2(缺陷个数)/1.393kloc(代码行数)=1.43(个/kloc)

## 4.3  后续测试建议

无

# 5     附件

无

 



 

 
