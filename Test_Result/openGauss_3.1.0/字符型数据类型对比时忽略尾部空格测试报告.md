![avatar](../../images/openGauss.png)

版权所有 © 2022  openGauss社区
 您对“本文档”的复制、使用、修改及分发受知识共享(Creative Commons)署名—相同方式共享4.0国际公共许可协议(以下简称“CC BY-SA 4.0”)的约束。为了方便用户理解，您可以通过访问https://creativecommons.org/licenses/by-sa/4.0/ 了解CC BY-SA 4.0的概要 (但不是替代)。CC BY-SA 4.0的完整协议内容您可以访问如下网址获取：https://creativecommons.org/licenses/by-sa/4.0/legalcode。

修订记录

|   日期    | 修订版本 |               修改描述               |      作者       |
| :------- | :------ | :---------------------------------- | :------------- |
| 2022-8-5  |   1.0    |           特性测试报告初稿           | zou_jialiang050 |
| 2022-8-15 |   1.1    | bug回归修改bug状态并增加测试执行步骤 | zou_jialiang050 |
| 2022-8-31 | 1.2 | 修改缺陷密度 | zou_jialiang050 |

 关键词： 字符型数据类型、忽略尾部空格

摘要：

本文对openGauss支持VARCHAR(n)，CHARACTER VARYING(n)，VARCHAR2(n)，NVARCHAR(n)，TEXT，CLOB字符型数据类型对比时忽略尾部空格特性测试，并给出最终测试结论。

缩略语清单：

| 缩略语 |                       英文全名                        | 中文解释                                             |
| :---- | :--------------------------------------------------- | :---------------------------------------------------- |
|  UTF8  | Universal Character Set/Unicode Transformation Format | 针对Unicode的一种可变长度字符编码                    |
| ASCII  |  American Standard Code for Information Interchange   | 美国信息交换标准代码是基于拉丁字母的一套电脑编码系统 |

# 1     特性概述

openGauss在兼容b库下，可以实现对VARCHAR(n)，CHARACTER VARYING(n)，VARCHAR2(n)，NVARCHAR(n)，TEXT，CLOB字符型数据类型对比时忽略尾部空格兼容，其执行结果与MYSQL侧一致。

# 2     特性测试信息

| 版本名称                      | 测试起始时间 | 测试结束时间 |
| :---------------------------- | :----------- | :----------- |
| MYSQL 5.7                     | 2022-8-1     | 2022-8-9     |
| openGauss3.0.0 build 111ff9ef | 2022-8-1     | 2022-8-9     |
| openGauss3.0.0 build 038d63d6 | 2022-8-7     | 2022-8-9     |

| 环境信息 | 配置信息                                                     | 备注 |
| :------- | :----------------------------------------------------------- | :---- |
| 虚拟机   | CPU：Intel(R) Xeon(R) Gold 6161 8核<br />内存：32GB<br />硬盘：100G<br />OS：openEluer release 20.03(LTS) |      |

# 3     测试结论概述

## 3.1   测试整体结论

openGauss字符型数据类型对比忽略尾部空格特性，共计执行用例57个，主要涉及VARCHAR(n)，CHARACTER VARYING(n)，VARCHAR2(n)，NVARCHAR(n)，TEXT，CLOB几种字符型数据类型，发现2条问题已解决，回归通过，无遗留风险，整体质量良好。

| 测试活动 | 活动评价                                                     |
| :------ | :----------------------------------------------------------- |
| 功能测试 | VARCHAR(n)、CHARACTER VARYING(n)字符类型对比忽略尾部空格测试通过 |
| 功能测试 | VARCHAR2(n)字符类型对比忽略尾部空格测试通过                  |
| 功能测试 | NVARCHAR(n)字符类型对比忽略尾部空格测试通过                  |
| 功能测试 | TEXT字符类型对比忽略尾部空格测试通过                         |
| 功能测试 | CLOB字符类型对比忽略尾部空格测试通过                         |
| 性能测试 | 对比有无插件对查询性能影响                                   |
| 资料测试 | 资料叙述准确无误，示例正确，通过                             |

## 3.2   约束说明

- 兼容MYSQL 5.7
- openGauss需在兼容b库下执行
- 使用hashjoin时需设置string_hash_compatible = on
- 使用group by时需设置enable_hashagg = off

## 3.3   遗留问题分析

### 3.3.1 遗留问题影响以及规避措施

| 问题单号 | 问题描述 | 问题级别 | 问题影响和规避措施 | 当前状态 |
| :------ | :------ | :------ | :---------------- | :------ |
|    NA    |          |          |                    |          |

### 3.3.2 问题统计

|             | 问题总数 | 严重 | 主要 | 次要 | 不重要 |
| :--------- | :------ | :-- | :-- | :-- | :---- |
|  数目 (个)  |    2     |  1   |  0   |  1   |   0    |
| 百分比  (%) |   100    |  50  |  0   |  50  |   0    |

### 3.3.3 问题单汇总

| 序号 |                           issue号                            | 问题级别 |                           问题简述                           | 问题状态 |
| :-- | :---------------------------------------------------------- | :------ | :---------------------------------------------------------- | :------ |
|  1   |  [I5QKZ6](https://gitee.com/opengauss/Plugin/issues/I5KQZ6)  |   次要   | 字符串忽略尾部空格进行group by having时需要设置string_hash_compatible=on或enable_hashagg=off文档中未说明 |  已验收  |
|  2   | [I5JXBG](https://gitee.com/opengauss/openGauss-server/issues/I5JXBG?from=project-issue) |   严重   |            创建兼容b库连接后数据库挂掉并产生core             |  已验收  |

# 4     测试执行

## 4.1   功能测试

### 4.1.1   字符型数据类型尾部忽略空格结合where比较操作符验证

| 测试步骤                                                     | 测试结果                           |
| :------------------------------------------------------------ | :---------------------------------- |
| 1.分别创建包含VARCHAR(n)，CHARACTER VARYING(n)，VARCHAR2(n)，NVARCHAR(n)，TEXT，CLOB几种字符串字段的表并插入尾部不含空格及单个空格、多个空格数据；<br />2.查询数据并结合where =，!=，>=，<=，>，<条件进行筛选。 | 共执行测试用例6条<br />未发现bug。 |

###  4.1.2   字符型数据类型尾部忽略空格结合group by having比较操作符验证

| 测试步骤                                                     | 测试结果                                                |
| :------------------------------------------------------------ | :------------------------------------------------------- |
| 1.set enable_hashagg to off；<br />2.分别创建包含VARCHAR(n)，CHARACTER VARYING(n)，VARCHAR2(n)，NVARCHAR(n)，TEXT，CLOB几种字符串字段的表并插入尾部不含空格及单个空格、多个空格数据；<br />3.查询数据并结合group by having =，!=，>=，<=，>，<条件进行筛选。 | 共执行测试用例8条<br />发现1条bug，现已验收并回归通过。 |

###  4.1.3   列存表、行存转向量化表中字符型数据类型尾部忽略空格结合where比较操作符验证

| 测试步骤                                                     | 测试结果                            |
| :------------------------------------------------------------ | :----------------------------------- |
| 1.创建行存转向量化表，创建列存表；<br />2.分别创建包含VARCHAR(n)，CHARACTER VARYING(n)，VARCHAR2(n)，NVARCHAR(n)，TEXT，CLOB几种字符串字段的表并插入尾部不含空格及单个空格、多个空格数据；<br />3.查询数据并结合where =，!=，>=，<=，>，<条件进行筛选。 | 共执行测试用例12条<br />未发现bug。 |

###  4.1.4   字符型数据类型尾部忽略空格结合mergejoin、nestloop、hashjoin三种join方式并结合where比较操作符验证

| 测试步骤                                                     | 测试结果                            |
| :------------------------------------------------------------ | :----------------------------------- |
| 1.创建兼容b库并通过enable_hashjoin、enable_mergejoin、enable_nestloop参数控制连接查询方式；<br />2.分别创建包含VARCHAR(n)，CHARACTER VARYING(n)，VARCHAR2(n)，NVARCHAR(n)，TEXT，CLOB几种字符串字段的表并插入尾部不含空格及单个空格、多个空格数据；<br />3.分别在三种不同连接查询模式下查询数据并结合where  =，!=，>=，<=，>，<条件进行筛选。 | 共执行测试用例19条<br />未发现bug。 |

###  4.1.5   字符型数据类型尾部忽略空格结合字符串常用函数并结合where比较操作符条件验证

| 测试步骤                                                     | 测试结果                           |
| :------------------------------------------------------------ | :---------------------------------- |
| 1.分别创建包含VARCHAR(n)，CHARACTER VARYING(n)，VARCHAR2(n)，NVARCHAR(n)，TEXT，CLOB几种字符串字段的表并插入尾部不含空格及单个空格、多个空格数据；<br />2.查询数据并结合count()，length()，reverse()，concat()，lower()，upper()，trim()，lpad()，rpad()及where =，!=，>=，<=，>，<条件进行筛选。 | 共执行测试用例9条<br />未发现bug。 |

###  4.1.6   字符型数据类型尾部忽略空格在UTF8及ASCII编码数据库下条件查询验证

| 测试步骤                                                     | 测试结果                           |
| :------------------------------------------------------------ | :---------------------------------- |
| 1.分别创建UTF8与ASCII编码格式兼容b库；<br />2.分别创建包含VARCHAR(n)，CHARACTER VARYING(n)，VARCHAR2(n)，NVARCHAR(n)，TEXT，CLOB几种字符串字段的表并插入尾部不含空格及单个空格、多个空格数据；<br />3.分别在两种不同编码格式数据库下进行查询数据并结合where =，!=，>=，<=，>，<条件进行筛选。 | 共执行测试用例1条<br />未发现bug。 |

##  4.2   性能测试

| 测试步骤                                                     | 测试结果                           |
| :------------------------------------------------------------ | :---------------------------------- |
| 2.创建包含VARCHAR(n)，CHARACTER VARYING(n)，VARCHAR2(n)，NVARCHAR(n)，TEXT，CLOB几种字符串字段的表并插入尾部不含空格及单个空格、多个空格数据；<br />2.查询数据并记录查询时间；<br />3.去除插件后再次执行查询语句并记录查询时间并与有插件查询时间进行对比。 | 共执行测试用例1条<br />未发现bug。 |

## 4.3   资料测试

| 测试步骤                                   |                                                     |
| :------------------------------------------ | :--------------------------------------------------- |
| 1.确认资料描述是否准确无误，示例是否正确。 | 共执行测试用例1条<br />发现1个bug，回归验收已通过。 |

## 4.4   测试执行统计数据

| 版本名称                      | 测试用例数 | 用例执行结果            | 发现问题单数 |
| :----------------------------- | :---------- | :----------------------- | :------------ |
| openGauss3.0.0 build 451ed9c5 | 57         | Passed:55<br />Failed:2 | 2            |
| openGauss3.0.0 build 038d63d6 | 57         | Passed:57<br />Failed:0 | 0            |

累计发现缺陷单2个，全部解决并已回归通过。

缺陷单共2个，修改代码量为11.8kloc， 缺陷密度为0.17个/kloc

## 4.5   后续测试建议

1.CHAR(n)定长字符串是否与VARCHAR(n)等字符类型表现一致

# 5     附件

```
openGauss=# DROP TABLE if exists test;
NOTICE:  table "test" does not exists, skipping
DROP TABLE
openGauss=# CREATE TABLE test(c1 VARCHAR(10));
CREATE TABLE
openGauss=# INSERT INTO test VALUES ('1'),('1    ');
INSERT 0 2
openGauss=# SELECT * FROM test where c1='1';
  c1
------
 1
 1
(2 rows)
```