![avatar](../../images/openGauss.png)

版权所有 © 2022  openGauss社区
 您对“本文档”的复制、使用、修改及分发受知识共享(Creative Commons)署名—相同方式共享4.0国际公共许可协议(以下简称“CC BY-SA 4.0”)的约束。为了方便用户理解，您可以通过访问https://creativecommons.org/licenses/by-sa/4.0/ 了解CC BY-SA 4.0的概要 (但不是替代)。CC BY-SA 4.0的完整协议内容您可以访问如下网址获取：https://creativecommons.org/licenses/by-sa/4.0/legalcode。

修订记录

| 日期       | 修订   版本 | 修改描述                 | 作者         |
| ---------- | ----------- | ------------------------ | ------------ |
| 2022-08-15 | 1.0         | 测试报告初稿完成         | shuai_lei666 |
| 2022-08-30 | 1.1         | 根据评审意见修改测试报告 | shuai_lei666 |

 关键词： 

dolphin插件，条件类型函数，兼容B库，mysql

摘要：

本文档主要介绍openGauss在兼容B库且有dolphin插件的情形下，实现兼容mysql五个条件类型函数coalesce()、gs_interval()、isnull()、ifnull()、strcmp()。其中，coalesce()函数返回参数列表中第一个非null的参数值；gs_interval(N,N1...Na...)函数返N1到Na的个数，Na表示第一个大于N的参数；ifnull()函数返回第一个参数，若第一个参数为空，返回第二个参数；isnul()函数用于判断参数是否为null，参数为null返回1，否则返回0；strcmp(str1,str2)函数比较两个字符串，两个字符串相等返回0，str1小于str2返回-1，否则返回1。

# 1     特性概述

openGauss在兼容B库情形下，安装dolphin插件，可以实现对mysql的coalesce()、interval、isnull()、ifnull()、strcmp()五个条件类型函数的兼容，其函数功能及执行结果与mysql侧一致。

# 2     特性测试信息

本节描述被测对象的版本信息和测试的时间及测试轮次，包括依赖的硬件。

| 版本名称                       | 测试起始时间 | 测试结束时间 |
| ------------------------------ | ------------ | ------------ |
| mysql 5.7                      | 2022-06-20   | 2022-06-25   |
| openGauss 3.0.0 build b410c303 | 2022-06-20   | 2022-06-25   |
| dolphin 1.0                    | 2022-06-20   | 2022-06-25   |

描述特性测试的环境信息

| 环境信息 | 配置信息                                                     | 备注 |
| -------- | ------------------------------------------------------------ | ---- |
| 虚拟机   | CPU：Intel(R) Xeon(R) CPU E5-2680 v3 @ 2.50GHz 8核<br />内存：32GB<br />硬盘：100G<br />OS：CentOS Linux release 7.6.1810 (Core) |      |

# 3     测试结论概述

## 3.1   测试整体结论

openGauss兼容mysql条件类型函数共计执行用例176条，主要覆盖了功能测试、性能测试及资料测试。功能测试覆盖有效及无效的入参情形、结合其他函数及运算符、sql语句、各种类型的表及自定义函数、存储过程等进行运算并校验输出结果，与mysql执行结果进行比对。性能测试覆盖函数直接select200万次和函数查询表中200万行数据。资料测试覆盖校验资料的描述及示例的执行结果。累计发现问题单6个，2个非问题取消，3个问题已解决并回归通过，1个经plugin sig组评审不予修改。

| 测试活动 | 活动评价                                                     |
| -------- | ------------------------------------------------------------ |
| 功能测试 | 编译库、编译插件，执行结果符合预期，通过                     |
| 功能测试 | om安装库、安装插件，执行结果符合预期，通过                   |
| 功能测试 | 有效及无效入参测试，通过                                     |
| 功能测试 | 在常用sql语句、常用类型表中的输出结果测试，通过              |
| 功能测试 | 结合常用函数及运算符进行运算测试，通过                       |
| 功能测试 | 在自定义存储过程、自定义函数中的输出结果测试，通过           |
| 功能测试 | 函数名作为关键字、对象名使用测试，通过                       |
| 性能测试 | 函数在select语句中执行200万次，使用函数查询表中数据，不通过（经plugin sig组评审不予修改） |
| 资料测试 | 资料描述准确，示例的执行结果正确，通过                       |

## 3.2   约束说明

1. mysql使用5.7版本
2. openGauss需使用兼容B库且有dolphin插件
3. ifnull函数，第一个参数为null，第二个参数为二进制或布尔类型时，函数返回结果与mysql返回结果不一致
4. coalesce函数的参数为字符串，且字符串中包含字母、符号、汉字时，函数返回结果与mysql返回结果不一致

## 3.3   遗留问题分析

### 3.3.1  遗留问题影响以及规避措施

| 问题单号 | 问题描述 | 问题级别 | 问题影响和规避措施 | 当前状态 |
| -------- | -------- | -------- | ------------------ | -------- |
| N/A      |          |          |                    |          |

### 3.3.2  问题统计

|        | 问题总数 | 严重 | 主要 | 次要 | 不重要 |
| ------ | -------- | ---- | ---- | ---- | ------ |
| 数目   | 6        | 0    | 0    | 6    | 0      |
| 百分比 | 100%     | 0    | 0    | 100% | 0      |

### 3.3.3  问题单汇总

| 序号 | issue号                                                      | 问题级别 | 问题简述                                             | 问题状态 |
| ---- | ------------------------------------------------------------ | -------- | ---------------------------------------------------- | -------- |
| 1    | [I5E0YN](https://gitee.com/opengauss/Plugin/issues/I5E0YN?from=project-issue) | 次要     | gs_interval函数参数为timestamp类型时报错             | 已验收   |
| 2    | [I5E369](https://gitee.com/opengauss/Plugin/issues/I5E369?from=project-issue) | 次要     | gs_interval函数参数为空格时报错                      | 已验收   |
| 3    | [I5E479](https://gitee.com/opengauss/Plugin/issues/I5E479?from=project-issue) | 次要     | gs_interval等5个函数select执行200万次，执行时间过长  | 已取消   |
| 4    | [I5FHJ0](https://gitee.com/opengauss/Plugin/issues/I5FHJ0?from=project-issue) | 次要     | ifnull等4个条件类型函数在插件仓里没有说明文档        | 已验收   |
| 5    | [I5E2UH](https://gitee.com/opengauss/Plugin/issues/I5E2UH?from=project-issue) | 次要     | coalesce函数部分结果返回错误                         | 已取消   |
| 6    | [I5E2XF](https://gitee.com/opengauss/Plugin/issues/I5E2XF?from=project-issue) | 次要     | ifnull函数参数为二进制类型和布尔类型时，部分结果报错 | 已取消   |

# 4     测试执行

## 4.1   测试执行步骤

### 4.1.1 编译库及插件执行测试

| 测试步骤                                                     | 测试结果                                                     |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| 1. 编译安装openGauss数据库<br />2. 编译dolphin插件<br />3. 创建兼容B库并安装dolphin插件 <br />4. 执行用例 | 编译库及插件成功，共执行176条用例，<br />共发现6个bug，3条现已修复且验收通过，3条非问题已取消 |

#### 4.1.1.1 函数有效及无效入参测试

| 测试步骤                                                     | 测试结果                                                     |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| 1. 在兼容B库并安装dolphin插件的环境 <br />2. 以有效及无效参数作为输入测试函数执行结果 | 执行20条用例，发现4个bug<br />2条现已修复且验收通过，2条经sig组评审作为非问题取消，<br />1.ifnull函数如果确定最终结果类型是text，参数是二进制和布尔类型转为text预期报错，经评审不修改openGauss ifnull的实现<br />2.coalesce函数第一个参数是unkown类型，最终会确定为int4，将字符串转为int4，结果与mysql不一致，经评审不予修改 |

#### 4.1.1.2 函数在常用SQL语句及表类型中的输出结果测试

| 测试步骤                                                     | 测试结果                        |
| ------------------------------------------------------------ | ------------------------------- |
| 1. 在兼容B库并安装dolphin插件的环境 <br />2. 列举常用SQL语句及常见表类型测试函数输出结果 | 执行121条用例，执行结果符合预期 |

#### 4.1.1.3 结合其他常用函数测试及运算符输出结果测试

| 测试步骤                                                     | 测试结果                       |
| ------------------------------------------------------------ | ------------------------------ |
| 1. 在兼容B库并安装dolphin插件的环境 <br />2. 结合其他常用函数及运算符测试输出结果 | 执行15条用例，执行结果符合预期 |

#### 4.1.1.4 函数在自定义函数及存储过程中的输出结果测试

| 测试步骤                                                     | 测试结果                       |
| ------------------------------------------------------------ | ------------------------------ |
| 1. 在兼容B库并安装dolphin插件的环境 <br />2. 测试函数在自定义函数及存储过程中的输出结果 | 执行10条用例，执行结果符合预期 |

#### 4.1.1.5 函数在select语句中执行200万次，查询表中200万条数据的输出结果测试

| 测试步骤                                                     | 测试结果                                                     |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| 1. 在兼容B库并安装dolphin插件的环境 <br />2. 测试函数在select语句中执行200万次，查询表中200万条数据的输出结果 | 执行10条用例，发现1个bug，经plugin sig组评审，同意不再优化函数性能。<br />coalesce/ifnull/isnull的性能和openGauss原本的条件函数NVL性能一致。gs_interval/strcmp耗时主要在字符串格式化上，openGauss其他类似功能函数也是主要耗时在字符串格式化上。 |

#### 4.1.1.6 函数在文档中的说明是否准确，示例的执行结果正确

| 测试步骤                                                  | 测试结果                       |
| --------------------------------------------------------- | ------------------------------ |
| 1. 测试函数在文档中的说明是否准确，示例的执行结果是否正确 | 发现1个bug，现已修复且验收通过 |

## 4.2   测试执行统计数据

| 版本名称                       | 测试用例数 | 用例执行结果                  | 发现问题单数 |
| ------------------------------ | ---------- | ----------------------------- | ------------ |
| openGauss 3.0.0 build b410c303 | 176        | Passed：156  <br />Failed：20 | 6            |
| openGauss 3.0.0 build fc5f028b | 176        | Passed：176  <br />Failed：0  | 0            |

数据说明

1. 累计发现问题单6个，3个已解决并回归通过，2个非问题取消，1个经plugin sig组评审不予修改
2. 缺陷密度：3(缺陷个数) / 7.954(代码行数) = 0.37(个/kloc)

## 4.3   后续测试建议

1. coalesce函数参数为字符串时，部分返回结果与mysql不一致，是否影响其他函数执行结果
2. 问题单函数性能暂未达标，经plugin sig组评审不予修改，建议后续进行测试

# 5     附件

## 5.1  strcmp()函数执行结果示例

```sql
yat=# select strcmp('abc','abc');
 strcmp
--------
      0
(1 row)

yat=# select strcmp('abd','abc');
 strcmp
--------
      1
(1 row)

yat=# select strcmp('abb','abc');
 strcmp
--------
     -1
(1 row)
```
