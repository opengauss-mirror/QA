                                                ![avatar](../../images/openGauss.png) 

版权所有 © 2022  openGauss社区
 您对“本文档”的复制、使用、修改及分发受知识共享(Creative Commons)署名—相同方式共享4.0国际公共许可协议(以下简称“CC BY-SA 4.0”)的约束。为了方便用户理解，您可以通过访问https://creativecommons.org/licenses/by-sa/4.0/ 了解CC BY-SA 4.0的概要 (但不是替代)。CC BY-SA 4.0的完整协议内容您可以访问如下网址获取：https://creativecommons.org/licenses/by-sa/4.0/legalcode。

修订记录

| 日期       | 修订   版本 | 修改描述             | 作者        |
| ---------- | ----------- | -------------------- | ----------- |
| 2022-08-18 | 1.0         | 特性测试报告初稿完成 | chengjiaqi1 |
| 2022-08-24 | 2.0         | 根据评审意见修改报告 | chengjiaqi1 |

 关键词： 

openGauss支持在线reindex索引

摘要：

本文档主要对openGauss支持在线reindex重建索引进行测试，并给出测试报告。

缩略语清单：

| 缩略语 | 英文全名 | 中文解释 |
| ------ | -------- | -------- |
| 无     |          |          |

# 1 特性概述

openGauss支持在线reindex重建索引，支持对索引，数据表以及数据库在线重建索引，重建过程中不阻塞业务。具体支持重建索引的索引类型可为普通索引，不可用索引，非法索引，local分区索引，臃肿索引等，支持重建索引的表类型可为行存表，分区表，segment表，根据执行结果返回的信息判断是否重建成功。

# 2 特性测试信息

本节描述被测对象的版本信息和测试的时间及测试轮次。

| 版本名称                       | 测试起始时间 | 测试结束时间 |
| ------------------------------ | ------------ | ------------ |
| openGauss 3.0.0 build 3d018a7e | 2022-08-15   | 2022-08-18   |
| openGauss 3.0.0 build 2c221dae | 2022-08-18   | 2022-08-24   |

描述特性测试的环境信息

| 环境信息 | 配置信息                                                     | 备注 |
| -------- | ------------------------------------------------------------ | ---- |
| 虚拟机   | CPU：Intel(R) Xeon(R) Gold 6266C CPU @ 3.00GHz<br />内存：16GB<br />硬盘：320G<br />OS：openEuler release 20.03 (LTS-SP1) |      |

# 3  测试结论概述

## 3.1 测试整体结论

openGauss支持在线reindex重建索引语法共计执行用例71条，主要覆盖功能测试，可靠性测试，资料测试。功能测试主要覆盖针对不同类型的数据表重建索引、针对不同类型的索引重建索引、针对数据库重建索引，事务中执行在线reindex以及在线/非在线reindex是否阻塞业务几个方面进行验证。可靠性测试主要验证发生死锁的几种场景与发生死锁后索引是否重建成功进行测试。资料测试主要确保描述合理，约束点覆盖全面以及示例正确。累计发现缺陷单2个，回归通过，无遗留风险。

| 测试活动   | 活动评价                                                     |
| ---------- | ------------------------------------------------------------ |
| 功能测试   | 针对不同类型的数据表进行重建索引进行测试，通过               |
| 功能测试   | 针对不同类型的索引进行重建索引进行测试，通过                 |
| 功能测试   | 针对数据库进行重建索引进行测试，通过                         |
| 功能测试   | 针对在线/非在线reindex是否阻塞业务进行测试，通过             |
| 功能测试   | 针对事务中执行在线reindex进行测试，通过                      |
| 可靠性测试 | 针对验证发生死锁的几种场景与发生死锁后索引能否重建成功进行验证测试，通过 |
| 资料测试   | 资料叙述准确无误，示例正确，通过                             |

## 3.2 约束说明

1. openGauss支持在线reindex重建索引不支持重建系统表，列存表，临时表，ustore表与全局分区索引。

2. openGauss支持在线reindex重建索引不支持在事务中执行。

3. 不可用索引和非法索引只能以重建索引的方式进行重建，通过重建表/数据库无法重建。

4. reindex system concurrently 不会做任何操作，因为不支持在线重建系统表索引。

5. 以下几种场景会引发死锁：

   ​	5.1 两个会话对同一个表重建concurrently 索引，会引起死锁问题；

   ​	5.2 两个会话，一个对表重建concurrently 索引，一个drop table，会引起死锁问题；

   ​	5.3 将事务隔离级别设置成可重复读（默认为读已提交），起两个会话，会话1起事务对表a执行写入操作，不提交，会话2对表b重 建concurrently 索 引，		 在会话1事务未提交之前，会话2会一直被阻塞；

   ​	5.4 三个会话，会话1先起事务对表a加锁，不提交，会话2接着对表a执行写入操作，会话3接着对表b重建concurrently  索引，在会话1事务未提交之前，会		  话3会一直被阻塞。

   产生死锁后，原本索引可重建成功，但有可能会生成一个失效索引，需用户手动删除。

## 3.3  遗留问题分析

### 3.3.1 遗留问题影响以及规避措施

| 问题单号 | 问题描述 | 问题级别 | 问题影响和规避措施 | 当前状态 |
| -------- | -------- | -------- | ------------------ | -------- |
| NA       |          |          |                    |          |

### 3.3.2 问题统计

|        | 问题总数 | 严重 | 主要 | 次要 | 不重要 |
| ------ | -------- | ---- | ---- | ---- | ------ |
| 数目   | 2        | 0    | 1    | 1    | 0      |
| 百分比 | 100%     | 0    | 50%  | 50%  | 0      |

### 3.3.3 问题单汇总

| 序号 | issue号                                                      | 问题级别 | 问题简述                            | 问题状态 |
| ---- | ------------------------------------------------------------ | -------- | ----------------------------------- | -------- |
| 1    | [I5MWVX](https://gitee.com/opengauss/openGauss-server/issues/I5MWVX) | 主要     | 在线reindex无法重建不可用分区表索引 | 已验收   |
| 2    | [I5MWS5](https://gitee.com/opengauss/docs/issues/I5MWS5)     | 次要     | REINEX资料对产生死锁场景描述不合理  | 已验收   |



# 4 测试执行

## 4.1 功能测试

#### 4.1.1 针对不同类型的数据表进行重建索引测试

| 测试步骤                                                     | 测试结果                       |
| ------------------------------------------------------------ | ------------------------------ |
| 1.创建数据表并插入数据<br>2.为表创建索引<br>3.执行reindex table concurrently  表名 对表重建索引，<br/>根据返回结果判断是否重建成功 | 执行19条用例，执行结果符合预期 |

#### 4.1.2 针对不同类型的索引进行重建索引测试

| 测试步骤                                                     | 测试结果                                   |
| ------------------------------------------------------------ | ------------------------------------------ |
| 1.创建数据表并插入数据<br/>2.为表创建索引<br/>3.执行reindex index concurrently  索引名 重建索引，根据返回结果判断是否重建成功 | 执行15条用例，发现1个bug，回归验收已通过。 |

#### 4.1.3 针对数据库进行重建索引进行测试

| 测试步骤：                                                   | 测试结果                      |
| ------------------------------------------------------------ | ----------------------------- |
| 1.新建数据库<br />2.新建数据库中创建不同类型数据表/索引 <br>3.执行reindex database concurrently  数据库名 <br/>对数据库重建索引，根据返回结果判断是否重建成功 | 执行7条用例，执行结果符合预期 |

#### 4.1.4 针对在线/非在线reindex是否阻塞业务进行测试

| 测试步骤                                                     | 测试结果                       |
| ------------------------------------------------------------ | ------------------------------ |
| 1.创建数据表并插入数据<br>2.为表创建索引<br>3.执行在线/非在线reindex命令，根据返回结果判断是否重建成功 | 执行16条用例，执行结果符合预期 |

#### 4.1.5 针对事务中执行在线reindex进行测试

| 测试步骤                                                     | 测试结果                      |
| ------------------------------------------------------------ | ----------------------------- |
| 1.开启事务 <br />2.执行在线reindex命令，根据返回结果判断是否重建成功 | 执行6条用例，执行结果符合预期 |

### 4.2 可靠性测试

#### 4.2.1 针对验证发生死锁的几种场景与发生死锁后索引能否重建成功进行验证测试

| 测试步骤：                                                 | 测试结果                      |
| ---------------------------------------------------------- | ----------------------------- |
| 1.分别验证发生死锁的几种场景，根据返回结果判断是否重建成功 | 执行8条用例，执行结果符合预期 |

### 4.3 资料测试

| 测试步骤                   | 测试结果                     |
| -------------------------- | ---------------------------- |
| 资料描述准确无误，示例正确 | 发现1个bug，回归验收已通过。 |

### 4.4 测试执行统计数据

| 版本名称                       | 测试用例数 | 用例执行结果              | 发现问题单数 |
| ------------------------------ | ---------- | ------------------------- | ------------ |
| openGauss 3.0.0 build 3d018a7e | 71         | Passed：69<br />Failed：2 | 2            |
| openGauss 3.0.0 build 2c221dae | 71         | Passed：71<br />Failed：0 | 0            |

数据说明

1.  openGauss 3.0.0 build 3d018a7e版本测试过程中共发现2个bug，其中1个主要，1个次要，在openGauss 3.0.0 build 2c221dae版本回归通过。缺陷密度为2（缺陷个数）/3.982k（代码行数）=0.5（个/kloc）。

### 4.5 后续测试建议

无

## 5 附件

无
