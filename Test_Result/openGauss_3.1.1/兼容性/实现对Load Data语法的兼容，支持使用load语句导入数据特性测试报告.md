![avatar](../../../images/openGauss.png)

版权所有 © 2022  openGauss社区
 您对“本文档”的复制、使用、修改及分发受知识共享(Creative Commons)署名—相同方式共享4.0国际公共许可协议(以下简称“CC BY-SA 4.0”)的约束。为了方便用户理解，您可以通过访问https://creativecommons.org/licenses/by-sa/4.0/ 了解CC BY-SA 4.0的概要 (但不是替代)。CC BY-SA 4.0的完整协议内容您可以访问如下网址获取：https://creativecommons.org/licenses/by-sa/4.0/legalcode。

修订记录

|    日期    | 修订版本 |         修改描述         |   作者    |
| :--------: | :------: | :----------------------: | :-------: |
| 2022-01-04 |   1.0    |   特性测试报告初稿完成   | zhanghang |
| 2022-01-04 |   1.1    | 根据检视意见修改测试报告 | zhanghang |
| 2022-01-04 |   1.2    | 根据评审意见修改测试报告 | zhanghang |

 关键词： load、插件dolphin

 摘要：

本文档主要基于插件dolphin实现对Load Data语法的兼容，支持使用load语句导入数据，实现从文件拷贝数据到表的功能进行测试，并给出最终测试结论。 

缩略语清单：

| 缩略语 | 英文全名 | 中文解释 |
| :----- | :------- | -------- |
| NA     |          |          |

# 1     特性概述

基于插件dolphin，openGauss在兼容B模式下实现对Load Data语法的兼容，支持使用load语句导入数据，该语法功能及执行结果与M\*侧基本一致。

# 2     特性测试信息

| 版本名称                       | 测试起始时间 | 测试结束时间 |
| ------------------------------ | ------------ | ------------ |
| M* 5.7                         | 2022-12-05   | 2022-12-21   |
| openGauss 3.1.0 build 0d771b43 | 2022-12-05   | 2022-12-20   |
| openGauss 3.1.0 build f6cd9da2 | 2022-12-20   | 2022-12-21   |
| dolphin 1.0                    | 2022-12-05   | 2022-12-21   |

| 环境信息 | 配置信息                                                 | 备注 |
| :------: | :----------------------------------------------------------- | ---- |
|  虚拟机  | CPU：Intel(R) Xeon(R) Gold 6278C CPU @ 2.60GHz<br />内存：31GB<br />硬盘：100GB<br />OS：CentOS Linux release 7.6.1810 (Core) |      |

# 3     测试结论概述

## 3.1   测试整体结论

实现对Load Data语法的兼容，支持使用load语句导入数据共计执行用例88条，主要覆盖了功能测试和资料测试，功能测试覆盖对load语句的replace、设置字符集、分隔符等参数有效性进行验证，对行存表、分区表、行存临时表、触发器等场景进行验证，对导入的数据类型、导入数据文件的路径合法性、用户类型及权限、文件格式等进行验证。资料测试覆盖校验资料的描述是否正确，示例的执行结果是否成功。累计发现问题单5个，5个问题已解决并回归通过，无遗留风险，整体质量良好。

| 测试活动 | 活动评价                                                     |
| -------- | :----------------------------------------------------------- |
| 功能测试 | 对load语句的replace、设置字符集、分隔符等参数有效性进行验证，通过 |
| 功能测试 | 对行存表、分区表、行存临时表、触发器等场景进行验证，通过     |
| 功能测试 | 对导入的数据类型、导入数据文件的路径合法性、用户类型及权限、文件格式等进行验证，通过 |
| 资料测试 | 资料描述完整准确，示例执行结果正确，整体质量良好             |

## 3.2   约束说明

- M*使用5.7版本。
- openGauss需使用兼容B库且有dolphin插件。
- 只能用于表，不能用于视图。
- 不支持列存表和外表。
- 需要插入的表的insert权限, replace选项还需要表的delete权限。
- 如果声明了一个字段列表，LOAD将只在文件和表之间拷贝已声明字段的数据。如果表中有任何不在字段列表里的字段，将为那些字段插入缺省值。
- 声明的数据源文件，服务器必须可以访问该文件。
- 如果数据文件的任意行包含比预期多或者少的字段，dolphin.sql_mode为严格模式时将抛出一个错误，宽松模式时缺少的字段将插入NULL,如果字段有NOT NULL约束则会插入类型基础值。
- `\N`为NULL，如果要输入实际数据值`\N` ，使用`\\N`。

## 3.3   遗留问题分析

### 3.3.1 遗留问题影响以及规避措施

| 问题单号 | 问题描述 | 问题级别 | 问题影响和规避措施 | 当前状态 |
| -------- | -------- | -------- | ------------------ | -------- |
| NA       |          |          |                    |          |

### 3.3.2 问题统计

|             | 问题总数 | 严重 | 主要 | 次要 | 不重要 |
| :---------: | :------: | :--: | :--: | :--: | :----: |
|  数目 (个)  |    5     |  0   |  0   |  4   |   1    |
| 百分比  (%) |   100%   |  0   |  0   | 80%  |  20%   |

### 3.3.3 问题详情

| 序号 | issue号                                                      | 问题级别 | 问题简述                                                     | 问题状态 |
| :--: | ------------------------------------------------------------ | :------: | ------------------------------------------------------------ | :------: |
|  1   | [I64KCM](https://e.gitee.com/opengaussorg/issues/list?issue=I64KCM) |   次要   | load data infile导入字段为为数字类型时，导入空字段值结果与预期不符 |  已验收  |
|  2   | [I64KDL](https://e.gitee.com/opengaussorg/issues/list?issue=I64KDL) |   次要   | load data infile导入值含\N时，结果与预期不符                 |  已验收  |
|  3   | [I6529U](https://e.gitee.com/opengaussorg/issues/list?issue=I6529U) |   次要   | escaped by 'char'参数未生效                                  |  已验收  |
|  4   | [I66V0C](https://e.gitee.com/opengaussorg/issues/list?issue=I66V0C) |  不重要  | 建议修改对字段分隔符取值范围的约束描述                       |  已验收  |
|  5   | [I6510F](https://e.gitee.com/opengaussorg/issues/list?issue=I6510F) |   次要   | load data infile资料中对escaped by 'char'参数的介绍不是很清晰；对copy的描述建议删除或修改为对相同功能的loda data infile的描述 |  已验收  |

# 4     测试执行

## 4.1   测试执行统计数据

### 4.1.1  对load语句的replace、设置字符集、分隔符等参数有效性进行验证

| 测试步骤                                                     | 测试结果                                     |
| ------------------------------------------------------------ | -------------------------------------------- |
| 1. 创建兼容B库并加载dolphin插件 <br />2. 对语法的replace、设置字符集、分隔符等参数有效性进行验证 | 执行60条用例，发现4个bug，现已修复且验收通过 |

### 4.1.2  对行存表、分区表、行存临时表、触发器等场景进行验证

| 测试步骤                                                     | 测试结果                |
| ------------------------------------------------------------ | ----------------------- |
| 1. 创建兼容B库并加载dolphin插件 <br />2. 对行存表、分区表、行存临时表、触发器等场景进行验证 | 执行10条用例，未发现bug |

### 4.1.3  对导入的数据类型、导入数据文件的路径合法性、用户类型及权限、文件格式等进行验证

| 测试步骤                                                     | 测试结果                |
| ------------------------------------------------------------ | ----------------------- |
| 1.创建兼容B库并加载dolphin插件 <br />2.对导入的数据类型、导入数据文件的路径合法性、用户类型及权限、文件格式等进行验证 | 执行18条用例，未发现bug |

## 4.2   资料测试

| 测试步骤                                   | 测试结果                       |
| ------------------------------------------ | ------------------------------ |
| 资料的描述是否正确，示例的执行结果是否成功 | 发现1个bug，现已修复且验收通过 |

## 4.3   测试执行统计数据

| 版本名称                       | 测试用例数 | 用例执行结果               | 发现问题 |
| ------------------------------ | ---------- | -------------------------- | -------- |
| openGauss 3.1.0 build 0d771b43 | 88         | Passed：79<br />Failed：9  | 5        |
| openGauss 3.1.0 build f6cd9da2 | 88         | Passed：88 <br />Failed：0 | 0        |

数据项说明：

- 累计发现缺陷单5个，其中4个功能缺陷，1个资料缺陷，均已解决且回归通过
- 失败用例已在后续问题修复后，回归issue执行通过
- 缺陷密度：4个(缺陷个数)/1.307kloc(代码行数)=3.1(个/kloc)

## 4.4 后续测试建议

无

# 5     附件

## 5.1  执行结果示例

```sql
--前置条件：新建文件/data/load_data_0048.txt，内容如下：
aaa,ac*ac*ac 
bbb,bc&bc&bc 
ccc,cccccc 
ddd,dcdcdc

--step1:建表,expect:成功
test_yat=# drop table if exists t_load_data_table_0048;
NOTICE:  table "t_load_data_table_0048" does not exist, skipping
DROP TABLE
test_yat=# create table t_load_data_table_0048(
test_yat(# c_01 text,
test_yat(# c_02 varchar(50));
CREATE TABLE
test_yat=# select * from t_load_data_table_0048;
 c_01 | c_02
------+------
(0 rows)

--step2:不指定参数lines,expect:成功 
test_yat=# load data infile '/data/load_data_0048.txt'into table t_load_data_table_0048 
test_yat-# fields terminated by ',' enclosed by ''''; 
COPY 4 
test_yat=# select * from t_load_data_table_0048;
c_01 | c_02
------+---------- 
aaa | ac*ac*ac 
bbb | bc&bc&bc 
ccc | cccccc 
ddd | dcdcdc 
(4 rows)
```

