![avatar](../../../images/openGauss.png)

版权所有 © 2022  openGauss社区
 您对“本文档”的复制、使用、修改及分发受知识共享(Creative Commons)署名—相同方式共享4.0国际公共许可协议(以下简称“CC BY-SA 4.0”)的约束。为了方便用户理解，您可以通过访问https://creativecommons.org/licenses/by-sa/4.0/ 了解CC BY-SA 4.0的概要 (但不是替代)。CC BY-SA 4.0的完整协议内容您可以访问如下网址获取：https://creativecommons.org/licenses/by-sa/4.0/legalcode。

修订记录

| 日期       | 修订版本 | 修改描述                 | 作者     |
| ---------- | -------- | ------------------------ | -------- |
| 2022-12-25 | 1.0      | 特性测试报告初稿完成     | songjing |
| 2023-01-11 | 1.1      | 根据评审意见修改测试报告 | songjing |

 关键词： autocommit

摘要：

本文档主要介绍openGauss在兼容B库下支持set autocommit = 0关闭自动提交进行的测试，并给出测试结论。

缩略语清单：

| 缩略语 | 英文全名 | 中文解释 |
| ------ | -------- | -------- |
| N/A    |          |          |

# 1 特性概述

该特性主要用于openGauss兼容M*数据库set autocommit = 0;的方法关闭自动提交。通过将autocommit置为false，就可以关闭自动提交，让openGauss在当前会话中的语句都放在事务块中，用户手动执行commit或者rollback时，才能进行提交或回滚。

# 2 特性测试信息

| 版本名称                       | 测试起始时间 | 测试结束时间 |
| ------------------------------ | ------------ | ------------ |
| openGauss 3.1.0 build e3e241a6 | 2022-12-02   | 2022-12-08   |
| openGauss 3.1.0 build c72e49f5 | 2022-12-26   | 2022-12-26   |

| 环境信息 | 配置信息                                                     | 备注 |
| -------- | ------------------------------------------------------------ | ---- |
| 虚拟机   | CPU：Intel(R) Xeon(R) Gold 6278C CPU @ 2.60GHz<br />内存：32GB<br />硬盘：100GB<br />OS：CentoOS Linux release 7.6.1810 (Core) |      |

# 3  测试结论概述

## 3.1 测试整体结论

openGauss支持关闭自动提交特性，共计执行用例52条，主要覆盖了功能测试、升级测试和资料测试。功能测试主要覆盖设置autocommit参数值的方式，验证关闭自动提交后手动提交和回滚数据，结合设置事务特性、保存点、两阶段事务进行测试，验证关闭自动提交后原先在事务中不支持的语句不能执行，autocommit的值由false置为true会提交之前的事务和自身；升级测试主要验证升级后支持该特性且功能正常；资料测试覆盖资料描述是否准确及示例是否正确执行。累计发现缺陷2个，均已修复且回归通过，无遗留风险，整体质量良好。

| 测试活动 | 活动评价                                                     |
| -------- | ------------------------------------------------------------ |
| 功能测试 | 仅在B兼容模式下能修改autocommit为false，GUC参数设置方式三设置autocommit参数成功 |
| 功能测试 | 关闭自动提交后手动提交和回滚事务成功                         |
| 功能测试 | 关闭自动提交结合事务特性、保存点、两阶段事务进行测试，通过   |
| 功能测试 | 关闭自动提交后，基本语句功能正常，原先事务中不支持的语句不能执行，通过 |
| 功能测试 | autocommit由false置为true会提交前面的事务和自身，通过        |
| 升级测试 | 升级后支持该特性且功能正常，通过                             |
| 资料测试 | 资料描述是否准确、约束覆盖是否全面以及示例是否正确，通过     |

## 3.2 约束说明

1.  仅在B兼容模式下能够修改为false 

2.  autocommit为userset类型参数，使用GUC参数设置中的方式三设置：

```sql
  set autocommit to value;
  alter database dbname set autocommit to value;
  alter user username set autocommit to value;
```

## 3.3  遗留问题分析

### 3.3.1 遗留问题影响以及规避措施

| 问题单号 | 问题描述 | 问题级别 | 问题影响和规避措施 | 当前状态 |
| -------- | -------- | -------- | ------------------ | -------- |
| N/A      |          |          |                    |          |

### 3.3.2 问题统计

|        | 问题总数 | 严重 | 主要 | 次要 | 不重要 |
| ------ | -------- | ---- | ---- | ---- | ------ |
| 数目   | 2        | 0    | 1    | 1    | 0      |
| 百分比 | 100%     | 0    | 50%  | 50%  | 0      |

### 3.3.3 问题单汇总

| 序号 | issue号                                                      | 问题级别 | 问题简述                                                     | 问题状态 |
| ---- | ------------------------------------------------------------ | -------- | ------------------------------------------------------------ | -------- |
| 1    | [I64L8Q](https://gitee.com/opengauss/openGauss-server/issues/I64L8Q?from=project-issue) | 次要     | 事务中设置autocommit=0回滚，返回WARNING并重连会话            | 已验收   |
| 2    | [I661UI](https://gitee.com/opengauss/openGauss-server/issues/I661UI?from=project-issue) | 主要     | 关闭自动提交后执行事务块，第一条语句报错，后续语句执行成功，提交成功 | 已验收   |

# 4 测试执行

## 4.1 功能测试

#### 4.1.1 设置autocommit=0

| 测试步骤                                                     | 测试结果                                   |
| ------------------------------------------------------------ | ------------------------------------------ |
| 1.兼容B库和非兼容B库设置关闭自动提交<br/>2.使用4种GUC参数设置方式设置autocommit<br/>3.事务中设置autocommit | 执行11条用例，发现1个bug，已修复且验收通过 |

#### 4.1.2 关闭自动提交后手动提交和回滚事务

| 测试步骤                                                     | 测试结果                                  |
| ------------------------------------------------------------ | ----------------------------------------- |
| 1.关闭自动提交，正常执行事务，提交/回滚，另一个会话查询数据<br/>2.关闭自动提交，事务块中有语句报错，提交/回滚，另一个会话查询数据 | 执行6条用例，发现1个bug，已修复且验收通过 |

#### 4.1.3 关闭自动提交结合事务特性、保存点、两阶段事务进行测试

| 测试步骤：                                                   | 测试结果                              |
| ------------------------------------------------------------ | ------------------------------------- |
| 1.关闭自动提交结合设置事务特性测试<br/>2.关闭自动提交后，设置、回滚、释放保存点<br/>3.关闭自动提交后，准备、提交事务 | 执行11条用例，未发现bug，结果符合预期 |

#### 4.1.4 关闭自动提交后，基本语句功能正常，原先事务中不支持的语句不能执行

| 测试步骤：                                                   | 测试结果                              |
| ------------------------------------------------------------ | ------------------------------------- |
| 1.关闭自动提交后，执行基本sql语句<br/>2.执行原先事务中不支持的语句 | 执行21条用例，未发现bug，结果符合预期 |

### 4.1.5 autocommit由false设置为true，提交前面事务和自身

| 测试步骤：                                                | 测试结果                             |
| --------------------------------------------------------- | ------------------------------------ |
| 1.关闭自动提交，执行事务，set autocommit = 1;开启自动提交 | 执行2条用例，未发现bug，结果符合预期 |

## 4.2  升级测试

| 测试步骤：                                                   | 测试结果                             |
| ------------------------------------------------------------ | ------------------------------------ |
| 1.安装3.0.0版本数据库（无本特性）<br/>2.升级数据库到包含本特性的数据库版本，提交升级<br/>3.设置autocommit=0，执行语句，提交/回滚，新开会话查询 | 执行1条用例，未发现bug，结果符合预期 |

## 4.3  资料测试

| 测试步骤：                                           | 测试结果                |
| ---------------------------------------------------- | ----------------------- |
| 1.资料描述是否准确、约束覆盖是否全面以及示例是否正确 | 未发现bug，结果符合预期 |

## 4.4 测试执行统计数据

| 版本名称                       | 测试用例数 | 用例执行结果             | 发现问题单数 |
| ------------------------------ | ---------- | ------------------------ | ------------ |
| openGauss 3.1.0 build e3e241a6 | 52         | Passed：50<br/>Failed：2 | 2            |
| openGauss 3.1.0 build c72e49f5 | 8          | Passed：8<br/>Failed：0  | 0            |

数据说明

1.  测试过程中共发现2个bug，2个问题单均已修复且回归通过
2.  缺陷密度：2个(缺陷个数)/0.420kloc(代码行数)=4.76(个/kloc)

## 4.5 后续测试建议

无

# 5 附件 

## 5.1 示例

```sql
--开启会话1，创建兼容B库，切换到B库
openGauss=# create database testdb dbcompatibility 'B';
CREATE DATABASE
openGauss=# \c testdb

--查询autocommit
testdb=# show autocommit;
 autocommit
------------
 on
(1 row)

--关闭自动提交
testdb=# set autocommit = 0;
SET
testdb=# show autocommit;
 autocommit
------------
 off
(1 row)

--建表插入1条数据
testdb=# create table t_test(c_int int, c_varchar varchar(20));
CREATE TABLE
testdb=# insert into t_test values(190, 'test');
INSERT 0 1

--开启会话2查询
testdb=# select * from t_test;
ERROR:  relation "t_test" does not exist on dn_6001
LINE 1: select * from t_test;
                      ^
--会话1提交
testdb=# commit;
COMMIT

--会话2再次查询
testdb=# select * from t_test;
 c_int | c_varchar
-------+-----------
   190 | test
(1 row)

--会话1更新表中数据，回滚
testdb=# update t_test set c_varchar = 'new' where c_int = 190;
UPDATE 1
testdb=# select * from t_test;
 c_int | c_varchar
-------+-----------
   190 | new
(1 row)

testdb=# rollback;
ROLLBACK
testdb=# select * from t_test;
 c_int | c_varchar
-------+-----------
   190 | test
(1 row)

--删除表，开启自动提交
testdb=# drop table t_test;
DROP TABLE
testdb=# set autocommit to on;
SET
testdb=# show autocommit;
 autocommit
------------
 on
(1 row)

--会话2查询系统表，t_test表已被删除，autocommit由false置为true提交前面语句和自身
testdb=# select schemaname, tablename from pg_tables where tablename = 't_test';
 schemaname | tablename
------------+-----------
(0 rows)
```

