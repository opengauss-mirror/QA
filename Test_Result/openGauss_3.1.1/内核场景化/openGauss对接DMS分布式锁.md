![avatar](../../images/openGauss.png)

版权所有 © 2022  openGauss社区
 您对“本文档”的复制、使用、修改及分发受知识共享(Creative Commons)署名—相同方式共享4.0国际公共许可协议(以下简称“CC BY-SA 4.0”)的约束。为了方便用户理解，您可以通过访问https://creativecommons.org/licenses/by-sa/4.0/ 了解CC BY-SA 4.0的概要 (但不是替代)。CC BY-SA 4.0的完整协议内容您可以访问如下网址获取：https://creativecommons.org/licenses/by-sa/4.0/legalcode。

修订记录

| 日期       | 修订   版本 | 修改描述             | 作者       |
| :--------- | ----------- | -------------------- | ---------- |
| 2022-12-23 | 1.0         | 特性测试报告初稿完成 | chengyao25 |

 关键词： 

DMS分布式锁，X锁，S锁，共享存储

摘要：

本文档主要针对主备共享存储模式下使用DMS的分布式锁能力，关闭共享存储模式为正常主备结构可正常使用，在共享存储模式下，主机获取X锁，备机获取S锁，两锁互斥，主备互换、主备节点异常、主备节点恢复等操作后，主备获取锁正常，对以上的功能进行功能、可靠性、性能测试，并对相关DMS分布式锁的资料进行测试。

缩略语清单：

| 缩略语 | 英文全名                   | 中文解释       |
| ------ | -------------------------- | -------------- |
| DMS    | Distributed Memory Service | 分布式内存服务 |

# 1     特性概述

改造openGauss现有的本地锁机制，基于DMS分布式锁解决共享存储场景下表级锁失效带来的多节点DDL并发问题，openGauss新增适配DMS分布式锁接口，并在当前的表级锁加锁、释放锁的过程中增加分布式锁加锁、释放锁。关闭共享存储模式下，使用原有本地锁机制。开启共享存储模式，对同一对象操作在主机上获取X锁后，二次获取X锁，备机获取S锁产生互斥。主备切换，主备节点异常、主备节点恢复等操作后DMS分布式锁获取X，S锁成功。

# 2     特性测试信息

| 版本名称                       | 测试起始时间 | 测试结束时间 |
| ------------------------------ | ------------ | ------------ |
| openGauss 3.1.0 build 448e8551 | 2022-11-26   | 2022-11-30   |
| openGauss 3.1.0 build f23a81e7 | 2022-12-05   | 2022-12-07   |
| openGauss 3.1.0 build 41c3b97d | 2022-12-09   | 2022-12-13   |

| 环境信息 | 硬件配置信息                                                 | 备注 |
| -------- | ------------------------------------------------------------ | ---- |
| 虚拟机   | Intel(R) Xeon(R) Gold 6266C CPU @ 3.00GHz 4核<br/>内存：32GB<br/>硬盘：300G<br/>OS：openEuler release 20.03 (LTS) |      |

# 3     测试结论概述

## 3.1   测试整体结论

openGauss适配DMS分布式锁共计执行用例77条，主要覆盖功能测试，节点故障测试，性能测试。功能测试包含关闭DMS分布式锁状态下本地锁机制正常；开启DMS分布式锁，主机获取X锁，备机获取S锁，X锁与S锁互斥，X锁与X锁产生互斥；对主备节点互换、备升主、主备故障、主备故障后重启等，主机获取X锁，备机获取S锁成功，X锁与S锁互斥功能正常；在关闭与开启DMS下进行TPCC测试正常；关于DMS分布式锁相关资料描述无异常。测试过程中发现问题3个，1个问题已验收，1个已完成待转测，1个非问题已取消。

| 测试活动 | 活动评价                                                     |
| :------- | ------------------------------------------------------------ |
| 功能测试 | 关闭DMS分布式锁功能，本地锁机制正常使用无异常，测试与预期结果一致 |
| 功能测试 | 开启DMS分布式锁，对不同对象DDL操作添加上分布式锁，获取X锁与S锁，X锁与S锁互斥，测试达到预期结果 |
| 功能测试 | 锁超时验证，获取X锁/S锁后，获取S锁/X锁等待设置超时时间后合理提示报错信息，测试达到预期结果 |
| 故障测试 | 优先获取X锁/S锁，主备节点互换，节点停止，节点重启等操作，X锁与S锁释放，重新拉起数据库，主备节点获取X锁与S锁无异常，X锁与S锁互斥功能正常，测试达到预期结果 |
| 故障测试 | 对不同表对象进行查询与修改操作，产生死锁状态，主动cancel一事务,另一个事务执行成功，测试达到预期结果 |
| 性能测试 | 开启DMS分布式锁与关闭DMS分布式锁状态下，进行TPCC性能测试，测试结果达到预期结果 |
| 资料测试 | 资料描述准确，操作步骤清晰无误，整体质量良好                 |

## 3.2   约束说明

1. DMS分布式锁只有在资源池化参数 ss_enable_dms=on时，该特性才能生效。
2. DMS分布式锁当前不支持死锁检测。

## 3.3   遗留问题分析

### 3.3.1 遗留问题影响以及规避措施

| 问题单号 | 问题描述 | 问题级别 | 问题影响及规避措施 | 当前状态 |
| -------- | -------- | -------- | :----------------- | -------- |
| NA       |          |          |                    |          |

### 3.3.2 问题统计

|        | 问题总数 | 严重 | 主要 | 次要 | 不重要 |
| ------ | -------- | ---- | ---- | ---- | ------ |
| 数目   | 3     | 1   | 1    | 1  | 0      |
| 百分比 | 100% | 33% | 33% | 34% | 0%     |

###  3.3.3 问题单汇总

| issue号                                                      | 问题级别 | 问题简述                                                     | 问题状态 |
| ------------------------------------------------------------ | -------- | ------------------------------------------------------------ | -------- |
| [I642AE](https://gitee.com/opengauss/openGauss-server/issues/I642AE?from=project-issue) | 次要     | 锁等待超时，主机获取X锁后备机获取S锁冲突，等待超时时间后，备节点处于等待中 | 已验收   |
| [I63P6E](https://gitee.com/opengauss/openGauss-server/issues/I63P6E?from=project-issue) | 主要     | dms分布式锁下进行X锁与S锁超时验证时，产生core                | 已完成   |
| [I64653](https://gitee.com/opengauss/openGauss-server/issues/I64653?from=project-issue) | 严重     | 主节点获取X锁后，stop主节点后，重启主节点失败                | 已取消   |

# 4     测试执行

## 4.1 测试执行步骤

###  4.1.1 关闭DMS分布式锁功能，本地锁机制正常使用

| 测试步骤：                                                   | 测试结果                         |
| ------------------------------------------------------------ | -------------------------------- |
| 1.设置ss_enable_dms为off<br/>2.重启数据库<br/>3.获取本地锁并查看锁视图 | 共执行11条用例，执行结果符合预期 |

### 4.1.2 开启DMS分布式锁功能，对不同对象DDL操作，获取X锁与S锁，存在互斥

| 测试步骤：                                                   | 测试结果                         |
| ------------------------------------------------------------ | -------------------------------- |
| 1.创建测试对象<br/>2.在主机上开启事务1进行DDL操作获取X锁，开启事务2获取X锁,事务2执行阻塞<br/>3.在主机上开启事务1进行DDL操作获取X锁，备机开启事务2获取S锁，事务2执行阻塞<br/>4.备机开启事务1获取S锁，主机开启事务2获取X锁阻塞 | 共执行49条用例，执行结果符合预期 |

### 4.1.3 锁超时验证，优先获取X锁/S锁，在获取S锁/X锁阻塞，等待超时时间后报错提示超时

| 测试步骤：                                                   | 测试结果                                      |
| ------------------------------------------------------------ | --------------------------------------------- |
| 1. 设置锁超时参数<br/>2. 创建测试表<br/>3.开启事务1获取X锁/S锁，开启事务2获取S锁/X锁，等待超时时间报错并提供提示信息 | 共执行1条用例，发现2个bug，现已修复且验收通过 |

### 4.1.4 主备切换、备机failover、主备故障恢复后，DMS分布式锁不受影响，使用正常

| 测试步骤：                                                   | 测试结果                         |
| ------------------------------------------------------------ | -------------------------------- |
| 1. 创建测试对象，获取X锁/S锁<br/>2. 进行主备切换、备机failover、主备故障恢复操作<br/>3.重新获取X锁与S锁正常，X锁与X锁、X锁与S锁互斥 | 共执行11条用例，执行结果符合预期 |

### 4.1.5 用户在使用时主动 cancel或退出数据库场景

| 测试步骤：                                                   | 测试结果                      |
| :----------------------------------------------------------- | ----------------------------- |
| 1. 创建不同的测试对象<br/>2. 测试开启事务1获取X锁/S锁，事务2获取S锁/X锁阻塞，事务1数据库退出，事务2执行成功<br/>3. 测试开启事务1对象1获取X锁，开启事务2对象2获取S锁，同时事务2获取对象1S锁，事务1获取对象2S锁，事务1,2阻塞，主动cancle任意事务，另一事务执行成功 | 执行3条用例，执行结果符合预期 |

### 4.1.6 开启与关闭DMS分布式锁，进行TPCC测试

| 测试步骤：                                                   | 测试结果                      |
| ------------------------------------------------------------ | ----------------------------- |
| 1.安装TPCC测试工具<br/>2.在DMS分布式锁开启与关闭状态下运行TPCC<br/>3.观察对比测试数据 | 执行1条用例，执行结果符合预期 |

## 4.2  测试执行统计数据

| 版本名称                       | 测试用例数 | 用例执行结果             | 发现问题单数 |
| ------------------------------ | ---------- | ------------------------ | ------------ |
| openGauss 3.1.0 build 448e8551 | 66         | Passed：65  Failed : 2   | 2            |
| openGauss 3.1.0 build f23a81e7 | 10         | Passed : 10   Failed : 1 | 1            |
| openGauss 3.1.0 build 41c3b97d | 76         | passed：76 Failed：0     | 0            |

*数据项说明：*

1.openGauss 3.1.0 build 448e8551版本测试时发现2个问题。

2.openGauss 3.1.0 build f23a81e7版本测试时发现1个问题。

3.openGauss 3.1.0 build 41c3b97d版本回归两个问题单，回归通过，1个问题单非问题，已取消。

3.缺陷密度为 2(缺陷个数)/0.137k(代码行数)=14.59(个/kloc)。

## 4.3   后续测试建议

1.支持分布式锁死锁检测。

2.分布式锁状态视图开发，可以通过视图查看当前分布式锁的状态。

3.支持多写方案。

# 5     附件

无

 



 

 
