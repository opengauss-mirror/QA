![输入图片说明](../../../image.png)

版权所有 © 2022  openGauss社区
 您对“本文档”的复制、使用、修改及分发受知识共享(Creative Commons)署名—相同方式共享4.0国际公共许可协议(以下简称“CC BY-SA 4.0”)的约束。为了方便用户理解，您可以通过访问https://creativecommons.org/licenses/by-sa/4.0/ 了解CC BY-SA 4.0的概要 (但不是替代)。CC BY-SA 4.0的完整协议内容您可以访问如下网址获取：https://creativecommons.org/licenses/by-sa/4.0/legalcode。

修订记录

| 日期     | 修订   版本 | 修改描述             | 作者      |
| :------- | ----------- | -------------------- | --------- |
| 2023-1-3 | 1.0         | 特性测试报告初稿完成 | baixiaoli |
| 2023-1-11 | 2.0        | 根据评审意见修改报告 | baixiaoli |

 关键词： 

一主多备，多节点写入，libpq协议，转发

摘要：

本文档为openGauss一主多备架构下，支持备机执行DDL语句和DML语句、执行事务语句和批量插入功能的测试报告。

缩略语清单：

| 缩略语 | 英文全名 | 中文解释 |
| ------ | -------- | -------- |
| 无     |          |          |

# 1     特性概述

本特性主要利用libpq协议来创建和销毁备机与主机的连接通道，在备机通过转发管理器统一拦截从应用发出的消息报文，按照报文协议和执行语句共同决定是否转发给主机，只读查询在备机本地执行，DDL语句、DML语句、事务和批量插入等语句转发给主机执行，同时将主机的执行结果转发给应用，另外，启动事务会将所有SQL语句无条件转发给主机，包括只读语句。

# 2     特性测试信息

| 版本名称                       | 测试起始时间 | 测试结束时间 |
| ------------------------------ | ------------ | ------------ |
| openGauss 3.1.0 build 9d9fd46e | 2022-12-14   | 2022-12-17   |
| openGauss 3.1.0 build 05d7b74e | 2022-12-19   | 2022-12-23   |
| openGauss 3.1.0 build 02f5afd2 | 2023-01-03   | 2023-01-03   |

| 环境信息 | 硬件配置信息                                                 | 备注 |
| -------- | ------------------------------------------------------------ | ---- |
| 虚拟机   | Intel(R) Xeon(R) Gold 6266C CPU @ 3.00GHz<br/>内存：32GB<br/>硬盘：ssd<br/>OS：openEuler release 20.03 (LTS-SPI) |      |

# 3     测试结论概述

## 3.1   测试整体结论

openGaus支持多节点写入共计执行用例67条，主要覆盖功能测试，可靠性测试，稳定性测试和资料测试。功能测试包含guc参数测试，包含简单查询、简单写入及异常写入、批量插入、扩展查询、扩展写入、事务执行、set语句、copy命令和预备语句执行等场景测试；可靠性测试包含磁盘故障和网络故障测试；备机进行1小时TPCC稳定性测试；关于多节点写入相关资料描述无异常。测试过程中发现问题2个，均已回归通过。

| 测试活动   | 活动评价                                          |
| :--------- | :------------------------------------------------ |
| 功能测试   | guc参数测试，测试与预期结果一致                   |
| 功能测试   | 简单查询场景测试，测试达到预期结果                |
| 功能测试   | 简单写入及异常写入场景测试，测试达到预期结果      |
| 功能测试   | 非事务下批量插入场景测试，测试达到预期结果        |
| 功能测试   | 扩展查询场景测试，测试达到预期结果                |
| 功能测试   | 扩展写入场景测试，测试达到预期结果                |
| 功能测试   | 简单事务和扩展事务执行场景测试，测试达到预期结果  |
| 功能测试   | set语句、copy命令和预备语句测试，测试达到预期结果 |
| 可靠性测试 | 磁盘故障和网络故障测试，测试达到预期结果          |
| 稳定性测试 | 备机进行1小时TPCC稳定性测试，测试达到预期结果     |
| 资料测试   | 资料描述准确，操作步骤清晰无误，整体质量良好      |

## 3.2   约束说明

1. 只有在参数 enable_remote_excute=on时，该特性才能生效。
2. 应用端使用官方驱动或gsql访问数据库，非标准的驱动可能导致连接异常。
3. 本特性使用replication通道连接主备通信，并复用了连接相关的超时配置参数，永不超时可能导致连接阻塞和泄露。
4. 本特性不支持两阶段事务。

## 3.3   遗留问题分析

### 3.3.1 遗留问题影响以及规避措施

| 问题单号 | 问题描述 | 问题级别 | 问题影响及规避措施 | 当前状态 |
| -------- | -------- | -------- | :----------------- | -------- |
| 无       |          |          |                    |          |

### 3.3.2 问题统计

|        | 问题总数 | 严重 | 主要 | 次要 | 不重要 |
| ------ | -------- | ---- | ---- | ---- | ------ |
| 数目   | 2    | 0  | 1    | 1  | 0      |
| 百分比 | 100% | 0% | 50% | 50% | 0%     |

###  3.3.3 问题单汇总

| issue号                                                      | 问题级别 | 问题简述                                                     | 问题状态 |
| ------------------------------------------------------------ | -------- | ------------------------------------------------------------ | -------- |
| [I66K97](https://gitee.com/opengauss/openGauss-server/issues/I66K97) | 次要     | 执行插入语句后libpqsw转发标记未关闭，导致之后的所有select查询语句也会转发到主机执行 | 已验收   |
| [I66SCV](https://gitee.com/opengauss/openGauss-server/issues/I66SCV) | 主要     | 开启多节点写入功能，备机执行create table ... as query语句失败报错 | 已验收   |

# 4     测试执行

## 4.1 测试执行步骤

###  4.1.1功能测试

#### 4.1.1.1guc参数测试

| 测试步骤：                                                   | 测试结果                        |
| ------------------------------------------------------------ | ------------------------------- |
| 1.分别使用guc方式和alter system set方式设置<br/> enable_remote_excute参数的不同取值<br/>2.重启数据库<br/>3.查看参数设置成功 | 共执行2条用例，执行结果符合预期 |

#### 4.1.1.2简单查询场景测试

| 测试步骤：                                                   | 测试结果                        |
| ------------------------------------------------------------ | ------------------------------- |
| 1.设置 enable_remote_excute=on，重启数据库<br/>2.在主机创建表<br/>3.gsql连接备机在非事务下、在存储过程中、在匿名块中执行只读查询及异常查询测试<br/>4.查看日志记录 | 共执行4条用例，执行结果符合预期 |

#### 4.1.1.3 简单写入及异常写入场景测试

| 测试步骤：                                                   | 测试结果                                |
| ------------------------------------------------------------ | --------------------------------------- |
| 1. 设置 enable_remote_excute=on，重启数据库<br/>2.gsql连接备机非事务下、在存储过程、函数、匿名块、触发器中<br/>执行DDL语句和DML语句及异常写入测试<br/>3.查看日志记录 | 共执行20条用例，发现2个问题，且回归通过 |

#### 4.1.1.4 非事务下批量插入场景测试

| 测试步骤：                                                   | 测试结果                        |
| ------------------------------------------------------------ | ------------------------------- |
| 1. 设置 enable_remote_excute=on，重启数据库<br/>2.gsql连接备机在非事务下执行批量插入操作<br/>3.查看日志记录 | 共执行3条用例，执行结果符合预期 |

#### 4.1.1.5 扩展查询场景测试

| 测试步骤：                                                   | 测试结果                      |
| :----------------------------------------------------------- | ----------------------------- |
| 1. 设置 enable_remote_excute=on，重启数据库<br/>2.在主机创建表<br/>3. jdbc连接备机执行只读查询以及在存储过程、函数、匿名块中执行查询<br/>4.查看日志记录 | 执行3条用例，执行结果符合预期 |

#### 4.1.1.6 扩展写入场景测试

| 测试步骤：                                                   | 测试结果                       |
| ------------------------------------------------------------ | ------------------------------ |
| 1.设置 enable_remote_excute=on，重启数据库<br/>2.jdbc连接备机非事务下、在存储过程、函数、匿名块、触发器中<br/>执行DDL语句、DML语句、批量插入操作及异常写入测试<br/>3.查看日志记录 | 执行10条用例，执行结果符合预期 |

#### 4.1.1.7简单事务和扩展事务执行场景测试

| 测试步骤：                                                   | 测试结果                       |
| ------------------------------------------------------------ | ------------------------------ |
| 1.设置 enable_remote_excute=on，重启数据库<br/>2.分别使用gsql和jdbc连接备机在事务中执行只读查询、<br/>执行DDL和DML语句、批量插入、调用函数和存储过程<br/>3.查看日志记录 | 执行13条用例，执行结果符合预期 |

#### 4.1.1.8 set语句、copy命令和预备语句测试

| 测试步骤：                                                   | 测试结果                      |
| ------------------------------------------------------------ | ----------------------------- |
| 1.设置 enable_remote_excute=on，重启数据库<br/>2.备机执行set语句、copy命令和预备语句<br/>3.查看日志记录 | 执行6条用例，执行结果符合预期 |

### 4.1.2可靠性测试

#### 4.1.2.1 磁盘故障和网络故障测试

| 测试步骤：                                                   | 测试结果                      |
| ------------------------------------------------------------ | ----------------------------- |
| 1.设置 enable_remote_excute=on，重启数据库<br/>2.备机在执行写操作的同时注入磁盘故障和网络故障<br/>3.查看日志记录 | 执行5条用例，执行结果符合预期 |

### 4.1.3 稳定性测试

#### 4.1.3.1 备机进行1小时TPCC稳定性测试

| 测试步骤：                                                   | 测试结果                      |
| ------------------------------------------------------------ | ----------------------------- |
| 1.设置 enable_remote_excute=on，重启数据库<br/>2.备机进行1小时TPCC<br/>3.观察测试数据及数据库状态 | 执行1条用例，执行结果符合预期 |

### 4.1.4资料测试

| 测试步骤：                                               | 测试结果         |
| -------------------------------------------------------- | ---------------- |
| 1.检查资料描述是否准确、约束覆盖是否全面以及示例是否正确 | 检查结果符合预期 |

## 4.2  测试执行统计数据

| 版本名称                       | 测试用例数 | 用例执行结果             | 发现问题单数 |
| ------------------------------ | ---------- | ------------------------ | ------------ |
| openGauss 3.1.0 build 9d9fd46e | 37       | Passed : 36  Failed : 1 | 1           |
| openGauss 3.1.0 build 05d7b74e | 67       | Passed : 66   Failed : 1 | 1            |
| openGauss 3.1.0 build 02f5afd2 | 2      | passed : 2     Failed : 0 | 0            |

*数据项说明：*

1.openGauss 3.1.0 build 9d9fd46e版本测试时发现1个问题。

2.openGauss 3.1.0 build 05d7b74e版本测试时发现1个问题。

3.openGauss 3.1.0 build 02f5afd2版本回归2个问题单，回归通过。

4.缺陷密度为 2(缺陷个数)/1.45k(代码行数)=1.38(个/kloc)。

## 4.3   后续测试建议

建议后续进行7*24小时的长稳测试，观察数据库有无异常。

# 5     附件

无