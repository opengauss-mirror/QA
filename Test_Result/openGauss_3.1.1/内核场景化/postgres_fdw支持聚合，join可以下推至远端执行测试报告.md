![avatar](../../../images/openGauss.png)

版权所有 © 2022  openGauss社区
 您对“本文档”的复制、使用、修改及分发受知识共享(Creative Commons)署名—相同方式共享4.0国际公共许可协议(以下简称“CC BY-SA 4.0”)的约束。为了方便用户理解，您可以通过访问https://creativecommons.org/licenses/by-sa/4.0/ 了解CC BY-SA 4.0的概要 (但不是替代)。CC BY-SA 4.0的完整协议内容您可以访问如下网址获取：https://creativecommons.org/licenses/by-sa/4.0/legalcode。

修订记录

| 日期       | 修订   版本 | 修改描述             | 作者        |
| ---------- | ----------- | -------------------- | ----------- |
| 2022-12-20 | 1.0         | 特性测试报告初稿完成 | chengjiaqi1 |

 关键词： 

外表，postgres_fdw，join、agg、sort、limit、rowmark，下推

摘要：

本文档主要介绍openGauss在进行外表查询时支持将join、agg、sort、limit、rowmark操作下推到远端执行以及新增guc参数show_foreign_remote_plan，支持在explain中查询remote sql的执行计划。

缩略语清单：

| 缩略语 | 英文全名 | 中文解释 |
| ------ | -------- | -------- |
| 无     |          |          |

# 1 特性概述

openGauss实现对postgres_fdw（postgres foreign data wrap）的功能增强，支持join，NON-SPJ(agg，sort，limit，lockrows)算子的下推执行，即针对外表，将包含此5种算子的运算推至远端执行，以提升查询性能。本地可根据explain查询sql执行计划，返回内容含远端remote sql可观察到具体的远端运算执行过程。同时新增guc参数show_foreign_remote_plan，支持打印explain返回的remote sql的详细执行计划。

# 2 特性测试信息

本节描述被测对象的版本信息和测试的时间及测试轮次。

| 版本名称                       | 测试起始时间 | 测试结束时间 |
| ------------------------------ | ------------ | ------------ |
| openGauss 3.1.0 build 41c3b9d7 | 2022-12-02   | 2022-12-09   |
| openGauss 3.1.0 build 3cfbff94 | 2022-12-09   | 2022-12-13   |

描述特性测试的环境信息

| 环境信息      | 配置信息                                                     | 备注 |
| ------------- | ------------------------------------------------------------ | ---- |
| x86+OpenEuler | CPU：Intel(R) Xeon(R) Gold 6266C CPU @ 3.00GHz<br />内存：16GB<br />硬盘：320G<br />OS：openEuler release 20.03 (LTS-SP1) |      |

# 3 测试结论概述

## 3.1 测试整体结论

 postgres_fdw支持聚合，join可以下推至远端执行共计执行用例43条，主要覆盖功能测试，资料测试。功能测试覆盖对不同类型数据表进行下推验证、对不同join类型进行下推验证，对外表和基表用户权限的校验，对join连接使用where条件的下推校验，对join连接不支持下推的DML类型的反向验证，对含NON-SPJ(agg，sort，limit，lockrows)算子的下推验证，对不支持下推算子类型的反向验证，对表达式的下推验证，对带where/having条件的NON-SPJ算子的下推验证，对参数show_foreign_remote_plan功能的验证以及对prepare中使用join/NON-SPJ算子的下推验证。资料测试主要确保资料描述合理，约束点覆盖全面以及示例正确。累计发现缺陷单1个，回归通过，无遗留风险。

| 测试活动 | 活动评价                                                    |
| -------- | ----------------------------------------------------------- |
| 功能测试 | 对不同类型数据表进行下推验证，通过                          |
| 功能测试 | 对不同join类型进行下推验证，通过                            |
| 功能测试 | 对外表和基表用户权限的校验，通过                            |
| 功能测试 | 对join连接使用where条件的下推校验，通过                     |
| 功能测试 | 对join连接不支持下推的DML类型的反向验证，通过               |
| 功能测试 | 对含NON-SPJ(agg，sort，limit，lockrows)算子的下推验证，通过 |
| 功能测试 | 对不支持下推算子类型的反向验证，通过                        |
| 功能测试 | 对表达式的下推验证，通过                                    |
| 功能测试 | 对带where/having条件的NON-SPJ算子的下推验证，通过           |
| 功能测试 | 对参数show_foreign_remote_plan功能的验证，通过              |
| 功能测试 | 对prepare中使用join/NON-SPJ算子的下推验证，通过             |
| 资料测试 | 资料叙述准确无误，示例正确，通过                            |

## 3.2 约束说明

1. 目前仅支持下推的类型有join，NON-SPJ(agg，sort，limit，lockrows)算子；
2. 针对NON-SPJ算子，目前不支持下推的类型有Windows函数，distinct，含grouping set的agg算子，setup集合以及不支持query_dop=2时的下推；
3. join连接的下推含where条件时，如果where条件中包含不满足下推要求的本地条件（如含易变函数random(),含limit算子），整体下推失败；
4. join连接必须是外表之间的连接，基表和基表或者基表和外表连接均无法下推；
5. 是否下推是通过比较计算两种方式的代价值决定的，针对列存表和分区表，由于它们执行下推后的估算的代价值要远大于本地执行的代价值，因此列存表和分区表不会自动执行下推操作，可通过设置参数enable_hashjoin=off，enable_mergejoin=off，enable_nestloop=off使其实现强制下推；
6. join连接不支持对含update，delete，for update的sql语句进行下推。

## 3.3 遗留问题分析

### 3.3.1 遗留问题影响以及规避措施

| 问题单号 | 问题描述 | 问题级别 | 问题影响和规避措施 | 当前状态 |
| -------- | -------- | -------- | ------------------ | -------- |
| NA       |          |          |                    |          |

### 3.3.2 问题统计

|        | 问题总数 | 严重 | 主要 | 次要 | 不重要 |
| ------ | -------- | ---- | ---- | ---- | ------ |
| 数目   | 1        | 0    | 1    | 0    | 0      |
| 百分比 | 100%     | 0    | 100% | 0    | 0      |

### 3.3.3 问题单汇总

| 序号 | issue号                                                      | 问题级别 | 问题简述                                   | 问题状态 |
| ---- | ------------------------------------------------------------ | -------- | ------------------------------------------ | -------- |
| 1    | [I65HAL](https://gitee.com/opengauss/openGauss-server/issues/I65HAL) | 主要     | 向外表插数据，回显插入成功，实际表中没数据 | 已验收   |



# 4 测试执行

## 4.1 功能测试

### 4.1.1.1 对不同类型数据表进行下推验证

| 测试步骤                                                     | 测试结果                                         |
| ------------------------------------------------------------ | ------------------------------------------------ |
| 1. 创建extension扩展，外部服务器，用户映射与schema<br>2. 创建不同类型本地表做为基表<br>3. 创建外表<br>4. 向外表插入数据<br>5. explain查看sql语句执行计划,根据返回结果判断sql语句是否下推成功 | 执行15条用例，发现1个bug，已提单，回归验收已通过 |

### 4.1.1.2 对不同join类型进行下推验证

| 测试步骤                                                     | 测试结果                      |
| ------------------------------------------------------------ | ----------------------------- |
| 1. 创建extension扩展，外部服务器，用户映射与schema<br/>2. 创建本地表做为基表<br/>3. 创建外表<br/>4. 向外表插入数据<br/>5. sql语句使用不同的join连接，explain查看执行计划，根据返回结果判断sql语句是否下推成功 | 执行6条用例，执行结果符合预期 |

### 4.1.1.3 对外表和基表用户权限的校验

| 测试步骤                                                     | 测试结果                      |
| ------------------------------------------------------------ | ----------------------------- |
| 1. 创建extension扩展，外部服务器，用户映射与schema<br/>2. 创建用户<br>3. 两种情况，本地表和外表的 owner非同一用户以及外表的owner非同一用户<br>4. 向外表插入数据<br/>5. explain查看sql语句执行计划,根据返回结果判断sql语句是否下推成功 | 执行2条用例，执行结果符合预期 |

### 4.1.1.4 对join连接使用where条件的下推校验

| 测试步骤                                                     | 测试结果                      |
| ------------------------------------------------------------ | ----------------------------- |
| 1. 创建extension扩展，外部服务器，用户映射与schema<br/>2. 创建本地表做为基表<br/>3. 创建外表<br/>4. 向外表插入数据<br/>5. sql语句使用where条件，分别包含和不包含本地条件，explain查看执行计划，<br>根据返回结果判断sql语句是否下推成功 | 执行2条用例，执行结果符合预期 |

### 4.1.1.5 对join连接不支持下推的DML类型的反向验证

| 测试步骤                                                     | 测试结果                      |
| ------------------------------------------------------------ | ----------------------------- |
| 1. 创建extension扩展，外部服务器，用户映射与schema<br/>2. 创建本地表做为基表<br/>3. 创建外表<br/>4. 向外表插入数据<br/>5. sql语句使用join连接不支持的DML类型（update，delete，for update），explain查看执行计划，<br>根据返回结果判断sql语句是否下推成功 | 执行3条用例，执行结果符合预期 |

### 4.1.1.5 对含NON-SPJ(agg，sort，limit，lockrows)算子的下推验证

| 测试步骤                                                     | 测试结果                      |
| ------------------------------------------------------------ | ----------------------------- |
| 1. 创建extension扩展，外部服务器，用户映射与schema<br/>2. 创建本地表做为基表<br/>3. 创建外表<br/>4. 向外表插入数据<br/>5. sql语句使用不同的NON-SPJ(agg，sort，limit，lockrows)算子，explain查看执行计划，<br>根据返回结果判断sql语句是否下推成功 | 执行4条用例，执行结果符合预期 |

### 4.1.1.6 对不支持下推算子类型的反向验证

| 测试步骤                                                     | 测试结果                      |
| ------------------------------------------------------------ | ----------------------------- |
| 1. 创建extension扩展，外部服务器，用户映射与schema<br/>2. 创建本地表做为基表<br/>3. 创建外表<br/>4. 向外表插入数据<br/>5. sql语句使用不支持下推的NON-SPJ算子，explain查看执行计划，根据返回结果判断sql语句是否下推成功 | 执行5条用例，执行结果符合预期 |

### 4.1.1.7 对表达式的下推验证

| 测试步骤                                                     | 测试结果                      |
| ------------------------------------------------------------ | ----------------------------- |
| 1. 创建extension扩展，外部服务器，用户映射与schema<br/>2. 创建本地表做为基表<br/>3. 创建外表<br/>4. 向外表插入数据<br/>5. sql语句使用表达式，explain查看执行计划，根据返回结果判断sql语句是否下推成功 | 执行2条用例，执行结果符合预期 |

### 4.1.1.8 对带where/having条件的NON-SPJ算子的下推验证

| 测试步骤：                                                   | 测试结果                      |
| ------------------------------------------------------------ | ----------------------------- |
| 1. 创建extension扩展，外部服务器，用户映射与schema<br/>2. 创建本地表做为基表<br/>3. 创建外表<br/>4. 向外表插入数据<br/>5. sql语句使用where/having条件，explain查看执行计划，根据返回结果判断sql语句是否下推成功 | 执行2条用例，执行结果符合预期 |

### 4.1.1.9 对参数show_foreign_remote_plan功能的验证

| 测试步骤                                                     | 测试结果                      |
| ------------------------------------------------------------ | ----------------------------- |
| 1. 创建extension扩展，外部服务器，用户映射与schema<br/>2. 创建本地表做为基表<br/>3. 创建外表<br/>4. 向外表插入数据<br/>5. 开启参数show_foreign_remote_plan，explain查看sql语句执行计划,根据返回结果判断sql语句<br>是否下推成功以及是否打印remote sql执行计划 | 执行1条用例，执行结果符合预期 |

### 4.1.1.10 对prepare中使用join/NON-SPJ算子的下推验证

| 测试步骤                                                     | 测试结果                      |
| ------------------------------------------------------------ | ----------------------------- |
| 1. 创建extension扩展，外部服务器，用户映射与schema<br/>2. 创建本地表做为基表<br/>3. 创建外表<br/>4. 向外表插入数据<br/>5. 创建prepare语句，包含join/NON-SPJ算子，explain查看prepare语句执行计划,根据返回结果判断是否下推成功 | 执行1条用例，执行结果符合预期 |

## 4.2 资料测试

| 测试步骤                                 | 测试结果 |
| ---------------------------------------- | -------- |
| 资料描述合理，约束点覆盖全面以及示例正确 | 通过     |

## 4.3 测试执行统计数据

| 版本名称                       | 测试用例数 | 用例执行结果              | 发现问题单数 |
| ------------------------------ | ---------- | ------------------------- | ------------ |
| openGauss 3.1.0 build 41c3b9d7 | 43         | Passed：42<br />Failed：1 | 1            |
| openGauss 3.1.0 build 3cfbff94 | 43         | Passed：43<br />Failed：0 | 0            |

数据说明

1.  openGauss 3.1.0 build 41c3b9d7版本测试过程中共发现1个主要个bug，在openGauss 3.1.0 build 3cfbff94版本回归通过。缺陷密度为1（缺陷个数）/36.77k（代码行数）=0.03（个/kloc）

## 4.4 后续测试建议

无

# 5 附件

无
