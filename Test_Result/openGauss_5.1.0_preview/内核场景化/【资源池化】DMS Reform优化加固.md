![avatar](../../../images/openGauss.png)

版权所有 © 2023  openGauss社区
您对“本文档”的复制、使用、修改及分发受知识共享(Creative Commons)署名—相同方式共享4.0国际公共许可协议(以下简称“CC BY-SA 4.0”)的约束。为了方便用户理解，您可以通过访问https://creativecommons.org/licenses/by-sa/4.0/ 了解CC BY-SA 4.0的概要 (但不是替代)。CC BY-SA 4.0的完整协议内容您可以访问如下网址获取：https://creativecommons.org/licenses/by-sa/4.0/legalcode。

修订记录

| 日期      | 修订   版本 | 修改描述     | 作者       |
| --------- | ----------- | ------------ | ---------- |
| 2023-7-5  | 1.0         | 特性测试初稿 | lichunlong |
| 2023-7-22 | 1.1         | 特性二轮测试 | lichunlong |

 关键词： DMS，reform

 

摘要：DMS优化加固点测试。

 

缩略语清单：

| 缩略语 | 英文全名 | 中文解释 |
| ------ | -------- | -------- |
| NA     |          |          |

# 1     特性概述

 reform，在共享存储架构下，当一个稳定集群出现异常，例如有节点重启，有节点被踢出集群，有节点加入等，DBMS需要处理这一情况，进行一系列的动作，将集群从一个不稳定状态转变成一个稳定状态。这个过程，在共享存储架构下称之为reform。

在openGauss共享存储架构下，针对一些reform过程中遇到的问题，做了一下优化：新节点（备机）加入集群reform流程优化，缩短reform时间，在flush_copy、recovery阶段出现允许淘汰特殊标签页面，增加异常退出分支，failover限制原主参加，在线failover 停止业务线程步骤前移，减少RTO时间，拦截reform过程中无效页面请求，以保证reform能正常快速的完成。

针对数据不一致的问题，做了DMS页面交互协议优化，DRC按需回收优化。



# 2     特性测试信息

本节描述被测对象的版本信息和测试的时间及测试轮次，包括依赖的硬件。

| 版本名称                       | 测试起始时间 | 测试结束时间 |
| ------------------------------ | ------------ | ------------ |
| openGauss 5.1.0 build a74b7333 | 2023-6-19    | 2023-6-25    |
| openGauss 5.1.0 build 8b7d6d6e | 2023-7-21    | 2023-6-22    |

描述特性测试的硬件环境信息

| 环境信息      | 配置信息                                                     | 备注 |
| ------------- | ------------------------------------------------------------ | ---- |
| ARM+openEuler | CPU：Kunpeng 920 7260 2p 128核<br />内存：24*32GB<br />硬盘：NVME 3T * 4<br />OS：openEuler release 20.03 (LTS)<br />文件系统：XFS<br />网卡：10GE |      |

# 3     测试结论概述

## 3.1   测试整体结论

DMS Refor优化加工功执行用例53条，主要覆盖了功能测试，发现问题3个，已解决2个，回归通过，无遗留风险，整体质量一般。

| 测试活动   | 活动评价                                                     |
| ---------- | ------------------------------------------------------------ |
| 功能测试   | 针对新节点（备机）加入集群reform流程优化，确认新节点加入成功以及reform流程正确，测试通过。 |
| 功能测试   | 针对flush_copy、recovery阶段出现允许淘汰特殊标签页面，测试通过。 |
| 功能测试   | 针对flush_copy、recovery阶段增加异常退出分支，确认在reform进入flush_copy、recovery阶段时出现故障，集群也可以恢复正常，测试通过。 |
| 功能测试   | 维护pmState，确认在reform动作完成后，startup线程才退出，测试通过。 |
| 功能测试   | 针对failover限制原主参加，确认原主进程拉起或停止的情况下，failover都成功完成，测试通过。 |
| 功能测试   | 在线failover 停止业务线程步骤前移，确认reform过程中清理业务在rebuild阶段之前，测试通过。 |
| 功能测试   | 拦截reform过程中无效页面请求，测试通过。                     |
| 可靠性测试 | DMS页面交互协议优化测试，确认在正常情况以及故障情况下，reform完成后，主备数据保持一致，测试通过。 |
| 长稳测试   | 主机执行tpcc读写业务，备机执行度业务，确认drc持续回收，测试通过。 |

## 3.2   约束说明

1. 仅支持资源池化部署方式

## 3.3   遗留问题分析

### 3.3.1 遗留问题影响以及规避措施

| 问题单号                                                     | 问题描述                                                     | 问题级别 | 当前状态 |
| ------------------------------------------------------------ | ------------------------------------------------------------ | -------- | -------- |
| [I7IMMH](https://e.gitee.com/opengaussorg/dashboard?issue=I7IMMH) | 主机执行tpcc读写备机纯读，踢出主机，拉起主机，备机发生coredump | 主要     | 待办的   |

### 3.3.2 问题统计

|        | 问题总数 | 严重 | 主要 | 次要 | 不重要 |
| ------ | -------- | ---- | ---- | ---- | ------ |
| 数目   | 2        | 1    | 2    | 0    | 0      |
| 百分比 | 100      | 33%  | 67%  | 0    | 0      |

### 3.3.3 问题单汇总

| 序号 | issue号                                                      | 问题级别 | 问题简述                                                     | 问题状态 |
| ---- | ------------------------------------------------------------ | -------- | ------------------------------------------------------------ | -------- |
| 1    | [I7GU0W](https://e.gitee.com/opengaussorg/dashboard?issue=I7GU0W) | 严重     | 主机执行tpcc读写备机纯读，踢出主机，拉起主机，集群恢复失败   | 已回归   |
| 2    | [I7I77E](https://e.gitee.com/opengaussorg/dashboard?issue=I7I77E) | 主要     | 主备failover之后，原主执行switchover -a,新主发生coredump     | 已回归   |
| 3    | [I7IMMH](https://e.gitee.com/opengaussorg/dashboard?issue=I7IMMH) | 主要     | 主机执行tpcc读写备机纯读，踢出主机，拉起主机，备机发生coredump | 待回归   |



# 4     测试执行

## 4.1   功能测试

| 测试步骤                                                     | 测试结果                                      |
| ------------------------------------------------------------ | --------------------------------------------- |
| 1. 针对DMS reform过程优化点进行测试，并观察日志结果和集群状态。 | 共执行29条用例<br />发现问题3个，已验证通过。 |
| 2. 针对DRC页面协议优化，DRC按需回收记性测试，并观察日志、集群状态以及数据一致性。 | 共执行24条用例<br />未发现问题，验证通过      |

测试执行用例53个，缺陷为 3个，代码量为1.9kloc，缺陷密度 1.57个/kloc。

## 4.2   后续测试建议

无

# 5     附件

无

 



 

 
