![avatar](../../../images/openGauss.png)

版权所有 © 2023  openGauss社区
您对“本文档”的复制、使用、修改及分发受知识共享(Creative Commons)署名—相同方式共享4.0国际公共许可协议(以下简称“CC BY-SA 4.0”)的约束。为了方便用户理解，您可以通过访问https://creativecommons.org/licenses/by-sa/4.0/ 了解CC BY-SA 4.0的概要 (但不是替代)。CC BY-SA 4.0的完整协议内容您可以访问如下网址获取：https://creativecommons.org/licenses/by-sa/4.0/legalcode。

修订记录

| 日期      | 修订   版本 | 修改描述 | 作者       |
| --------- | ----------- | -------- | ---------- |
| 2023-8-20 | 1.0         | 初稿完成 | peilinqian |
|           |             |          |            |

关键词： 子事务 事务回滚

 

摘要：本文档主要验证包含多个子事务的事务并发回滚、提交，子事务并发释放回滚等场景下，功能正常且性能提升，并给出测试结论。

 

缩略语清单：

| 缩略语 | 英文全名 | 中文解释 |
| ------ | -------- | -------- |
| NA     |          |          |

# 1     特性概述

本需求对子事务回滚流程复用group优化，当事务结束或者子事务回滚流程中请求ProcArrayLock锁失败时共用同一个group，由group的leader负责请求ProcArrayLock并统一清理group各成员的子事务信息。避免在高并发场景下，大量子事务同时回滚时，所有backend分别请求ProcArrayLock，缓解锁竞争带来的性能问题和事务提交由于请求不到锁被阻塞的问题。

# 2     特性测试信息

| 版本名称                       | 测试起始时间 | 测试结束时间 |
| ------------------------------ | ------------ | ------------ |
| openGauss 5.1.0 build fd7e64df | 2023-8-11    | 2023-8-16    |
|                                |              |              |

| 环境信息 | 配置信息                                                     | 备注 |
| -------- | ------------------------------------------------------------ | ---- |
| 物理机   | CPU：Kunpeng 920-4826 2p 96核<br />内存：224GB<br />硬盘：100GB<br />OS：openEuler release 20.03（LTS） |      |



# 3     测试结论概述

## 3.1   测试整体结论

共计执行20个用例，主要覆盖了功能测试、可靠性测试、性能测试，目前发现commit、rollback组合场景下，commit性能下降，开发正在打桩调试是否是问题，待解决，整体质量良好；

| 测试活动   | 活动评价                                                     |
| ---------- | ------------------------------------------------------------ |
| 功能测试   | 验证多并发带子事务正常rollback、commit、abort，包含子事务中子事务rollback及release；多并发不带带子事务正常rollback、commit、abort等不同场景下事务功能正常，数据库功能正常。测试结论：通过 |
| 可靠性测试 | 高并发进行大量带子事务的事务，过程中kill并发进程后再次进行高并发事务提交或者回滚，数据库功能正常，且保障事务ACID正确。测试结论：通过 |
| 性能测试   | (1) 1000并发commit + 1000并发rollback，且每个事务内200个子事务<br />(2) 1000并发rollback，每个事务内200个子事务<br />(3) 1000并发commit，每个事务内200个子事务；<br />以上3个场景在优化前后版本进行比对测试。(1)(2)场景下，rollback及commit性能提升，耗时缩短。(3)场景性能与历史版本持平。<br />测试结论：场景(1)存在问题，commit性能较优化前下降。待开发打桩调试验证是否正常。 |

## 3.2   约束说明

（1）本特性用于优化子事务并发回滚时，对于ProcArrayLock的锁竞争问题，对于同一事务内多个子事务的串行回滚没有优化。

（2）本特性对于子事务并发提交流程没有优化，在存在大量子事务并发提交/回滚的场景中，通过优化子事务回滚流程的锁竞争问题，减少子事务回滚对事务提交的影响。

## 3.3   遗留问题分析

### 3.3.1 遗留问题影响以及规避措施

无

### 3.3.2 问题统计

|        | 问题总数 | 严重 | 主要 | 次要 | 不重要 |
| ------ | -------- | ---- | ---- | ---- | ------ |
| 数目   | 0        | 0    | 0    | 0    | 0      |
| 百分比 | 100%     | 0%   | 0%   | 0%   | 0%     |

### 问题单汇总

| 序号 | issue号 | 问题级别 | 问题简述 | 问题状态 |
| ---- | ------- | -------- | -------- | -------- |
|      |         |          |          |          |

# 4     测试执行

## 4.1   测试执行统计数据

| 版本名称                       | 测试用例数 | 用例执行结果          | 发现问题单数 |
| ------------------------------ | ---------- | --------------------- | ------------ |
| openGauss 5.1.0 build fd7e64df | 20         | Passed：19  Block ：1 | 0            |
|                                |            |                       |              |

*数据项说明：*

- 首轮测试用例执行20个，性能测试阻塞，rollback+commit场景下commit性能下降；
- 本需求缺陷密度为0(缺陷个数)/0.191k(代码行数)=0(个/kloc)。

## 4.2   后续测试建议

无

# 5     附件

## 5.1 性能测试说明

**测试版本：**

优化前版本 gsql (openGauss 5.1.0 build 8b7d6d6e) compiled at 2023-07-19 00:10:28 commit 0 last mr

优化后版本 gsql (openGauss 5.1.0 build fd7e64df) compiled at 2023-07-26 11:32:47 commit 0 last mr

**（1）ProcArrayLock锁系统event时间统计结果：**

3种性能测试场景各执行3次，排除概率情况影响测试结果。

结论：根据系统视图wait_events统计结果，如下测试场景下，有rollback场景，总体耗时平均提升100%，仅有commit场景，总体耗时概率提升或者降低，但是浮动范围不大，因为commit场景不在本次需求优化范围内，属于正常偏差。

| 测试场景                                              | 优化前ProcArrayLock wait次数 | 优化前ProcArrayLock total_wait_time(微秒) | 优化后ProcArrayLock wait次数 | 优化后ProcArrayLock total_wait_time(微秒) | 总体ProcArrayLock wait耗时减少 |
| ----------------------------------------------------- | ---------------------------- | ----------------------------------------- | ---------------------------- | ----------------------------------------- | ------------------------------ |
| 1000并发commit 1000并发rollback 每个事务内200个子事务 | 180719                       | 1627363528                                | 3842                         | 62827                                     | 100.00%                        |
|                                                       | 187599                       | 1569638932                                | 5105                         | 79036                                     | 100.00%                        |
|                                                       | 167759                       | 1699106980                                | 4475                         | 75443                                     | 100.00%                        |
| 1000并发rollback 每个事务内200个子事务                | 185155                       | 1592869074                                | 4154                         | 33905                                     | 100.00%                        |
|                                                       | 184595                       | 1557582260                                | 3469                         | 33297                                     | 100.00%                        |
|                                                       | 199659                       | 1494740530                                | 3841                         | 34590                                     | 100.00%                        |
| 1000并发commit 每个事务内200个子事务                  | 272                          | 10816                                     | 373                          | 9312                                      | 13.91%                         |
|                                                       | 296                          | 8972                                      | 330                          | 10706                                     | -19.33%                        |
|                                                       | 310                          | 10190                                     | 272                          | 10320                                     | -1.28%                         |

**（2）整体commit、rollback耗时情况统计**

3种性能测试场景各执行3次，排除概率情况影响测试结果。

结论：统计commit+rollback场景性能整体提升，但是commit单独统计性能稳定下降，需要定位具体原因。全部rollback性能提升，全部commit性能概率提升或者下降，属于合理范围。

| 测试场景                                              | 优化前commit平均耗时(微秒) | 优化后commit平均耗时(微秒) | commit平均耗时减少 | 优化前rollback平均耗时(微秒) | 优化后rollback平均耗时(微秒) | rollback平均耗时减少 | commit+rollback平均耗时减少 |
| ----------------------------------------------------- | -------------------------- | -------------------------- | ------------------ | ---------------------------- | ---------------------------- | -------------------- | --------------------------- |
| 1000并发commit 1000并发rollback 每个事务内200个子事务 | 188.005                    | 316.02                     | -68.09%            | 1722.329                     | 382.092                      | 77.82%               | 63.46%                      |
|                                                       | 200.236                    | 362.644                    | -81.11%            | 1680.502                     | 397.079                      | 76.37%               | 59.61%                      |
|                                                       | 201.321                    | 379.341                    | -88.43%            | 1799.727                     | 409.659                      | 77.24%               | 60.57%                      |
| 1000并发rollback 每个事务内200个子事务                |                            |                            |                    | 1648.692                     | 521.476                      | 68.37%               |                             |
|                                                       |                            |                            |                    | 1621.179                     | 590.952                      | 63.55%               |                             |
|                                                       |                            |                            |                    | 1579.566                     | 562.464                      | 64.39%               |                             |
| 1000并发commit 每个事务内200个子事务                  | 149.993                    | 142.367                    | 5.08%              |                              |                              |                      |                             |
|                                                       | 145.928                    | 152.264                    | -4.34%             |                              |                              |                      |                             |
|                                                       | 150.17                     | 154.379                    | -2.80%             |                              |                              |                      |                             |