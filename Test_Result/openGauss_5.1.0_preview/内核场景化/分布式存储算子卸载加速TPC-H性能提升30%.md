![avatar](../../../images/openGauss.png)

版权所有 © 2023  openGauss社区
 您对“本文档”的复制、使用、修改及分发受知识共享(Creative Commons)署名—相同方式共享4.0国际公共许可协议(以下简称“CC BY-SA 4.0”)的约束。为了方便用户理解，您可以通过访问https://creativecommons.org/licenses/by-sa/4.0/ 了解CC BY-SA 4.0的概要 (但不是替代)。CC BY-SA 4.0的完整协议内容您可以访问如下网址获取：https://creativecommons.org/licenses/by-sa/4.0/legalcode。

修订记录

| 日期     | 修订   版本 | 修改描述     | 作者    |
| -------- | ----------- | ------------ | ------- |
| 2023-7-6 | 1.0         | 测试报告初版 | haomeng |

关键词：算子卸载，NdpPlugin，LibSmartScan

摘要：本文档主要验证基于NdpPlugin插件的方式提供数据库内核算子卸载功能，主要面向OLAP查询场景，应用无感知；在不改变原有的执行计划及算子相关信息的情况下实现数据的处理逻辑。

 

缩略语清单：

| 缩略语 | 英文全名     | 中文解释                 |
| ------ | ------------ | ------------------------ |
| NDP    | ndpplugin    | 用于算子下推的计算侧插件 |
|        | LibSmartScan | 用于算子下推的存储侧服务 |

# 1     特性概述

使用共享存储带来弹性、可靠性的好处，但是和本地盘单机比较性能会下降较多，主要是网络IO和分布式存储自身带来的延迟，尤其对于大规模查询buffer pool无法缓存的场景，大量的数据需要从存储节点搬运到计算节点，这些批量数据经过滤后大部分场景有效数据内容占比非常少，耗费大量的无用网络IO时间，性能较差。通过算子卸载将过滤卸载到存储侧执行，过滤掉不需要的数据，这样可以减少网络通信数据量，提升端到端的查询性能；对于不进行过滤的场景，会继续执行原生流程，业务对此无感知。



# 2     特性测试信息

| 版本名称                       | 测试起始时间 | 测试结束时间 |
| ------------------------------ | ------------ | ------------ |
| openGauss 5.1.0 build 13b420e4 | 2023-5-25    | 2023-5-29    |
| openGauss 5.1.0 build 68d1772f | 2023-5-30    | 2023-6-2     |
| openGauss 5.1.0 build dfa9d924 | 2023-6-6     | 2023-6-12    |
| openGauss 5.1.0 build a74b7333 | 2023-6-13    | 2023-6-28    |

| 环境信息                              | 配置信息                                                     | 备注             |
| ------------------------------------- | ------------------------------------------------------------ | ---------------- |
| 客户端<br />TaiShan 200 (Model 2280)  | CPU：2288H V5<br />内存：256GB<br />OS：openEuler release 20.03 (LTS)<br />网卡：2\*25GE | 一主一备集群环境 |
| 服务端<br />Taishan 200（Model 2280） | CPU：Kunpeng 920<br />内存：256GB<br />数据盘：2\*3.2TB NVME SSD<br />文件系统：EXT4<br />网卡：2\*25GE | 计算侧三个节点   |

| 软件名称  | 软件版本                                                     | 备注 |
| --------- | ------------------------------------------------------------ | ---- |
| openGauss | openGauss 5.1.0 build 13b420e4<br />openGauss 5.1.0 build 68d1772f<br />openGauss 5.1.0 build dfa9d924<br />openGauss 5.1.0 build a74b7333 |      |

   

# 3     测试结论概述

## 3.1   测试整体结论

共计执行363个用例，主要覆盖了功能测试、性能测试；发现问题12个，已解决12个，回归通过，无遗留风险，整体质量良好；

| 测试活动 | 活动评价                                                     |
| -------- | ------------------------------------------------------------ |
| 功能测试 | （1）NdpPlugin插件使能，通过配置文件参数使能，加载NdpPlugin插件、通过插件卸载算子查询，测试NdpPlugin插件正常使能/关闭场景下的数据库查询功能，LibSmartScan进程启动、关闭场景；<br />（2）白名单测试，支持Agg、SeqScan+Filter的逻辑在存储节点上运行，所有给予白名单的查询，算子识别下推则卸载对应特性返回查询结果，算子不识别下推则通过原生返回查询结果；<br />（3）Agg测试，对查询数据添加avg、count、max、min等聚合条件，并将结果返回；<br />（4）SeqScan测试，选取多列、单列的值，所有数据表的值，返回查询结果； |
| 性能测试 | （1）22条TPC-H语句端到端性能测试，通过客户端/计算节点执行22条TPC-H SQL语句，查看执行时间，需要观察算子下推特性开启、不同query_dop的性能对比，测试结果为性能提升47.6%，满足性能提升30%的基准要求。 |

## 3.2   约束说明

（1）通过NdpPlugin插件的方式提供数据库内核算子卸载功能；

（2）计算侧依赖ceph集群环境&LibSmartScan服务实现算子下推；

（3）决定适合算子卸载的场景只有收益/可以卸载的场景才进行卸载，不能算子卸载的场景按照内核原有流程执行；

## 3.3   遗留问题分析

### 3.3.1 遗留问题影响以及规避措施

| 问题单号 | 问题描述 | 问题级别 | 问题影响和规避措施 | 当前状态 |
| -------- | -------- | -------- | ------------------ | -------- |
| N/A      |          |          |                    |          |

### 3.3.2 问题统计

|        | 问题总数 | 严重 | 主要 | 次要 | 不重要 |
| ------ | -------- | ---- | ---- | ---- | ------ |
| 数目   | 12       | 0    | 11   | 1    | 0      |
| 百分比 | 100%     | 0%   | 92%  | 8%   | 0%     |

### 3.3.3 问题单汇总

| 序号 | issue号 | 问题级别 | 问题简述                                                     | 问题状态 |
| ---- | ------- | -------- | ------------------------------------------------------------ | -------- |
| 1    | I7G8S1  | 主要     | 【测试类型：插件功能】【测试版本：5.1.0】开启NDP场景，tpch性能测试，Q3执行阻塞 | 已验收   |
| 2    | I7CWOD  | 主要     | 【测试类型：插件功能】【测试版本：5.1.0】设置query_dop为8，执行tpcc相关语句，开启/关闭NDP，查询结果不一致 | 已验收   |
| 3    | I7C2IL  | 主要     | 【测试类型：插件功能】【测试版本：5.1.0】设置算子多并行，开启NDP，执行计划中无ndp下推关键信息 | 已验收   |
| 4    | I7BXT4  | 主要     | 【测试类型：插件功能】【测试版本：5.1.0】开启NDP，执行tpcc大表查询sql，rpc响应异常 | 已验收   |
| 5    | I7BCD3  | 主要     | 【测试类型：插件功能】【测试版本：5.1.0】开启NDP，update更新表数据后，查询表数据总量不一致 | 已验收   |
| 6    | I7ASQ7  | 主要     | 【测试类型：插件功能】【测试版本：5.1.0】设置query_dop为16，执行tpch相关语句，开启NDP与未开启NDP，查询结果不一致 | 已验收   |
| 7    | I79YZQ  | 主要     | 【测试类型：插件功能】【测试版本：5.1.0】执行tpch-Q14语句，开启NDP与未开启NDP，查询结果不一致 | 已验收   |
| 8    | I79HRL  | 主要     | 【测试类型：插件功能】【测试版本：5.1.0】开启NDP，创建二级分区表，未做下推处理 | 已验收   |
| 9    | I7BXA3  | 次要     | 【测试类型：插件功能】【测试版本：5.1.0】开启NDP，执行tpcc相关大表查询sql，打印大量warning信息 | 已验收   |
| 10   | I795R1  | 主要     | 【测试类型：插件功能】【测试版本：5.1.0】开启NDP，大数据量下对表进行count(*)查询，存储侧LibSmartScan退出产生core | 已验收   |
| 11   | I78EWD  | 主要     | 【测试类型：插件功能】【测试版本：5.1.0】LibSmartScan进程退出，开启NDP与未开启NDP情况下，查询结果性能差异较大 | 已验收   |
| 12   | I77X31  | 主要     | 【测试类型：插件功能】【测试版本：5.1.0】打开NDP，执行tpch-Q1查询语句，db崩溃退出 | 已验收   |

# 4     测试执行

## 4.1   测试执行统计数据

| 版本名称                       | 测试用例数 | 用例执行结果          | 发现问题单数 |
| ------------------------------ | ---------- | --------------------- | ------------ |
| openGauss 5.1.0 build 13b420e4 | 208        | Passed：204 Failed：4 | 4            |
| openGauss 5.1.0 build 68d1772f | 90         | Passed：85 Failed：5  | 5            |
| openGauss 5.1.0 build dfa9d924 | 39         | Passed：37 Failed：2  | 2            |
| openGauss 5.1.0 build a74b7333 | 26         | Passed：25 Failed：1  | 1            |

**数据项说明：**

- 测试用例数：到本测试活动结束时，所有可用测试用例数；
- 发现问题单数：本测试活动功能用例总共发现的问题单数；
- 用例执行结果：第一、二、三轮测试全量执行，第四轮回归问题单；
- 缺陷密度：12(缺陷个数)/7.119kloc(代码行数)=1.68(个/kloc)

## 4.2   后续测试建议

无

# 5     附件

## 5.1   特性新增参数

- ndpplugin.enable_ndp： 是否开启算子下推；
- shared_preload_libraries：新增参数 "ndpplugin"；
- ndpplugin.pushdown_min_blocks：限制下推页面数阈值；
- ndpplugin.ndp_port：存储侧libsmartscan进程监听的端口号；

## 5.2  特性新增视图

* pushdown_statistics：查询下推基础统计信息。





 

 
