

![avatar](../../../images/openGauss.png)

版权所有 © 2023  openGauss社区
 您对“本文档”的复制、使用、修改及分发受知识共享(Creative Commons)署名—相同方式共享4.0国际公共许可协议(以下简称“CC BY-SA 4.0”)的约束。为了方便用户理解，您可以通过访问https://creativecommons.org/licenses/by-sa/4.0/ 了解CC BY-SA 4.0的概要 (但不是替代)。CC BY-SA 4.0的完整协议内容您可以访问如下网址获取：https://creativecommons.org/licenses/by-sa/4.0/legalcode。

修订记录

| 日期      | 修订版本 | 修改描述     | 作者                                        |
| --------- | -------- | ------------ | ------------------------------------------- |
| 2023-9-20 | 1.0      | 测试报告初版 | haomeng/lixin/lichunlong/chenziyang/liutong |
|           |          |              |                                             |



# 1 概述

openGauss5.1.0版本在基于主备共享存储的HA部署形态基础上，提供多种特性优化，进一步满足客户在降低存储容量即成本的前提下提升安全可用性。本文针对共享存储的单集群部署方式，从新需求、继承功能、可靠性、性能、稳定性等方面进行测试，并给出测试结论。



# 2 测试版本说明

| 版本名称                       | 测试起始时间 | 测试结束时间 |
| ------------------------------ | ------------ | ------------ |
| openGauss 5.1.0 build 13b420e4 | 2023-6-26    | 2023-7-6     |
| openGauss 5.1.0 build a74b7333 | 2023-6-19    | 2023-6-25    |
| openGauss 5.1.0 build 8b7d6d6e | 2023-7-21    | 2023-7-22    |
| openGauss 5.1.0 build d974792e | 2023-8-23    | 2023-8-30    |
| openGauss 5.1.0 build fb14e5a6 | 2023-8-31    | 2023-9-7     |
| openGauss 5.1.0 build a2484b7b | 2023-9-8     | 2023-9-15    |
|                                |              |              |

测试环境信息

| 环境信息                              | 配置信息                                                     | 备注     |
| ------------------------------------- | ------------------------------------------------------------ | -------- |
| 客户端<br />OceanStore DeviceManager  |                                                              | 管控平台 |
| 服务端<br />Taishan 200（Model 2280） | CPU：Kunpeng 920/128c<br />内存：256GB<br />文件系统：EXT4<br />网卡：2\*10000GE<br />磁阵：单卷组500G*4 |          |

   

# 3 版本测试结论概述

共完成了6轮系统测试+2轮集成验证测试：其中前三轮主要关注集成功能测试，四五六轮重点关注新特性的验收，最后两轮进行集成测试，同时对关键性能数据进行摸底测试。从功能测试、可靠性、压力长稳、数据一致性、资料等维度进行了验收测试，全量自动化+手工测试用例 2.8W+，累计执行率达到100% 。openGauss 5.1.0版本资源池化特性共发现问题166个，有效问题129个，压力场景下可能存在可靠性问题。



# 4 版本详细测试结论

本章节针对总体测试策略计划的测试内容，给出详细的测试结论。

## 4.1 特性测试结论

### 4.1.1 继承特性评价

SQL继承功能主要为基本功能、工具的使用，覆盖数据库对象及数据库的增删改查，GUC参数的设置，AI特性、兼容特性、关键字、函数及存储过程、系统表与系统视图、数据库安全、系统内部工具、服务端工具等，覆盖用例2.7W+，均自动化连跑通过。

| 序号 | 特性名称     | 特性质量评估 | 备注              |
| ---- | ------------ | ------------ | ----------------- |
| 1    | AI特性       | 绿灯         | 共测试129个用例   |
| 2    | 兼容性       | 绿灯         | 共测试54个用例    |
| 3    | GUC参数      | 绿灯         | 共测试97个用例    |
| 4    | 存储过程     | 绿灯         | 共测试762个用例   |
| 5    | 安全         | 绿灯         | 共测试47个用例    |
| 6    | 基础SQL      | 绿灯         | 共测试5110个用例  |
| 7    | 关键字       | 绿灯         | 共测试21486个用例 |
| 8    | 系统内部工具 | 绿灯         | 共测试50个用例    |
| 9    | 备份恢复     | 绿灯         | 共测试3个用例     |



### 4.1.2 新需求评价

#### 4.1.1.1 【资源池化】Xlog按需回放

**【测试情况】**

| 版本名称                       | 测试起始时间 | 测试结束时间 |
| ------------------------------ | ------------ | ------------ |
| openGauss 5.1.0 build 13b420e4 | 2023-6-26    | 2023-7-6     |
| openGauss 5.1.0 build eee4dd51 | 2023-8-9    | 2023-8-11     |
| openGauss 5.1.0 build fb44126a | 2023-8-28    | 2023-9-6     |

| 硬件型号      | 硬件配置信息                                                 |
| ------------- | ------------------------------------------------------------ |
| ARM+openEuler | CPU：Kunpeng 920 7260 2p 128核<br />内存：24*32GB<br />硬盘：NVME 3T * 4<br />OS：openEuler release 20.03 (LTS)<br />网卡：10000GE<br />磁阵：单卷500G |

| 编号   | 特性名称                 | 测试情况说明                                                 | 约束依赖说明                                                 | 遗留问题单 | 特性质量评估 | 备注 |
| ------ | ------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ | ---------- | ------------ | ---- |
| I6UI0H | 【资源池化】Xlog按需回放 | 支持XLog按需回放特特性攻击执行用例47条，主要覆盖功能测试和性能测试。功能测试主要为参数测试、failover测试、数据一致性测试以及升级测试，参数测试正常赋值和异常赋值情况下特性功能正常；failover测试在主机故障后，保证failover成功，以及按需回放功能正常；数据一致性测试对比并行回放与按需回放后的文件checksum是否一致；升级测试完成就地升级和灰度升级，并且升级后按需回放功能可以正常使用。性能测试在一主一备部署，主机在30并发、TPCC负载25WtpmC实现RTO<10秒，达到需求标准50%。本次测试发现问题8个，已解决8个，均回归通过，此特性在某些可靠性场景下可能存在问题，由于实际应用复杂，测试场景无法完全模拟。 | 共享存储模式下生效，需打开极致RTO，开启ss_enable_ondemand_recovery,配置合理ss_ondemand_recovery_mem_size；在按需回放阶段，switchover不响应；在构建阶段和按需回放阶段，不允许原主加入集群；待回放日志超过配置的按需回放内存大小，将回退至原来极致RTO进行回放，能够正常完成恢复，但无法保证RTO要求；不支持回放DDL相关日志，如果回放阶段查到该类日志，将回退至原来的极致RTO，能够正常完成恢复，但无法保证RTO要求； | 无         | 黄灯         |      |

**【遗留问题】**

无



#### 4.1.1.2 【资源池化】DMS reform优化加固

**【测试情况】**

| 版本名称 | 测试起始时间 | 测试结束时间 |
| -------- | ------------ | ------------ |
| openGauss 5.1.0 build a74b7333| 2023-6-19  | 2023-6-25 |
| openGauss 5.1.0 build 8b7d6d6e| 2023-7-21  | 2023-7-22 |

| 环境信息      | 硬件配置                                                     | 备注 |
| ------------- | ------------------------------------------------------------ | ---- |
| ARM+openEuler | CPU：Kunpeng 920 7260 2p 128核<br />内存：24*32GB<br />硬盘：NVME 3T * 4<br />OS：openEuler release 20.03 (LTS)<br />网卡：10000GE<br />磁阵：单卷500G |      |

| 编号   | 特性名称                       | 测试情况说明                                                 | 约束依赖说明       | 遗留问题单 | 特性质量评估 | 备注 |
| ------ | ------------------------------ | ------------------------------------------------------------ | ------------------ | ---------- | ------------ | ---- |
| I73F5G | 【资源池化】DMS reform优化加固 | DMS Refomr优化加固执行用例53条，主要为功能测试，覆盖了reform过程优化以及DMS页面交互协议优化。针对reform过程优化测试新节点加入成功以及reform流程正确，在flush_copy、recovery阶段出现允许淘汰特殊标签页面，维护pmState，确认在reform动作完成后，startup线程才退出，确认reform过程中清理业务在rebuild阶段之前，并且拦截reform过程中无效页面请求；针对DMS页面交互协议优化，确认正常情况以及故障情况下，reform完成后，主备数据保持一致，并且在主机和备机上执行长稳测试，确认DRC在持续回收。本次测试发现问题3个，均已解决，并且回归通过，无遗留风险，整体质量良好。 | 仅支持共享存储模式 | 无         | 绿灯         |      |

**【遗留问题】**

无



#### 4.1.1.3 【资源池化】资源池化备机获取快照逻辑优化特性

**【测试情况】**

| 版本名称                       | 测试起始时间 | 测试结束时间 |
| ------------------------------ | ------------ | ------------ |
| openGauss 5.1.0 build 299b7684 | 2023-08-18   | 2023-08-28   |
| openGauss 5.1.0 build 321133e2 | 2023-09-06   | 2023-09-07   |

| 环境信息      | 配置信息                                                     |
| ------------- | ------------------------------------------------------------ |
| ARM+openEuler | CPU：Kunpeng 920 7260 2p 128核<br />内存：24*32GB<br />硬盘：NVME 3T * 4<br />OS：openEuler release 20.03 (LTS)<br />网卡：10000GE<br />磁阵：单卷500G |

| 编号   | 特性名称                                     | 测试情况说明                                                 | 约束依赖说明                                                 | 遗留问题单 | 特性质量评估 | 备注 |
| ------ | -------------------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ | ---------- | ------------ | ---- |
| I7IMBD | 【资源池化】资源池化备机获取快照逻辑优化特性 | 共设计16个测试用例，主要包含ss_enable_bcast_snapshot参数的测试、验证主备快照一致等功能测试，打开及关闭ss_enable_bcast_snapshot对比性能测试，以及可靠性测试、资料测试等。未发现问题，整体质量良好。 | 开启该参数，会提升备机读性能，当集群中节点数比较少时，对主机性能也不会有太大影响，但是当集群中节点数量较多，比如超过3个，主机由于广播的节点数量变多会有性能影响；当某一个备机网络不通或故障时，会阻塞主机的事务提交。建议在读多写少的场景中选择开启该参数，提升备机读的性能。 | 无         | 绿灯         |      |

**【遗留问题】**

无



## 4.2 兼容性测试结论

### 4.2.1 升级兼容性

此版本为新特性版本，暂不支持从其他版本升级到此版本。



## 4.3 专项测试结论

### 4.3.1 可靠可用性测试结论

#### 4.3.1.1 测试信息

| 版本名称                       | 测试起始时间 | 测试结束时间 |
| ------------------------------ | ------------ | ------------ |
| openGauss 5.1.0 build 02c4a13d | 2023-08-02   | 2023-08-09   |
| openGauss 5.1.0 build 299b7684 | 2023-08-17   | 2023-08-22   |
| openGauss 5.1.0 build d974792e | 2023-08-23   | 2023-08-31   |
| openGauss 5.1.0 build 321133e2 | 2023-09-01   | 2023-09-06   |
| openGauss 5.1.0 build a2484b7b | 2023-09-07   | 2023-09-12   |
| openGauss 5.1.0 build 8aa3c760 | 2023-09-13   | 2023-09-20   |

| 类型 | CPU  | 内存  | 磁阵        | 操作系统                      | 组网方式 |
| ---- | ---- | ----- | ----------- | ----------------------------- | -------- |
| X86  | 64   | 188GB | 单卷组1TB   | openEuler release 20.03 (LTS) | 一主一备 |
| ARM  | 128  | 765GB | 单卷组500GB | openEuler release 20.03 (LTS) | 一主两备 |

#### 4.3.1.2 整体测试结论

openGauss 5.1.0 版本可靠性测试共计测试6个版本，在x86+openEuler/ARM+openEuler环境下共计执行288个用例及多个复杂切换场景，测试用例累计执行率100%，测试发现问题30+，部分已优化闭环，大压力下仍存在可靠性问题。

#### 4.3.1.3 测试场景

覆盖故障模式库中所有场景

| 二级故障     | 三级故障               | 注入方法      |
| ------------ | ---------------------- | ------------- |
| 单实例故障   | cms故障可拉起，主/备   | kill          |
|              | dss故障可拉起，主/备   | kill          |
|              | dss故障不可拉起，主/备 | mv/stop       |
|              | dn故障可拉起，主/备    | kill          |
|              | dn故障不可拉起，主/备  | mv/stop       |
|              | cms/dss/dn僵死，主/备  | kill -19      |
| 多实例故障   | 多数派故障             | mv/kill/stop  |
|              | 少数派故障             | mv/kill/stop  |
|              | 集群重启               | stop && start |
| 配置文件错误 | postgresql.conf        | 手动配置错误  |
|              | cm_resource.json       | 手动配置错误  |
| 网络故障     | 主节点网络故障         | cfe           |
|              | 备节点网络故障         | cfe           |
| reform       | 多节点多次switchover   | switchover    |
|              | 多节点多次failover     | mv/kill/stop  |
| switchover   | 降备过程原主故障       | mv/kill/stop  |
|              | 降备过程新主故障       | mv/kill/stop  |
|              | 升主过程新主dn故障     | mv/kill/stop  |
|              | 升主过程原主dn故障     | mv/kill/stop  |
|              | 升主过程新主dss故障    | mv/kill/stop  |
|              | 升主过程原主dss故障    | mv/kill/stop  |
|              | 升主过程新主网络故障   | cfe           |
|              | 升主过程原主网络故障   | cfe           |
| failover     | 升主过程dn再故障       | mv/kill/stop  |
|              | 升主过程dss再故障      | mv/kill/stop  |
|              | 升主过程网络故障       | cfe           |



### 4.3.2 性能测试结论

**【测试情况】**

| 版本名称                       | 测试起始时间 | 测试结束时间 |
| ------------------------------ | ------------ | ------------ |
| openGauss 5.1.0 build 8aa3c760 | 2023-09-13   | 2023-09-13   |

| 类型 | CPU  | 内存  | 磁阵      | 操作系统                      | 组网方式 |
| ---- | ---- | ----- | --------- | ----------------------------- | -------- |
| ARM  | 128  | 765GB | 单卷组1TB | openEuler release 20.03 (LTS) | 一主一备 |

| Domain   | 场景                                                         |
| -------- | ------------------------------------------------------------ |
| sysbench | 单表6400w，256并发，主节点读写，备节点空载，单节点20min， TPS：2.8w |
|          | 单表6400w，256并发，主节点读写，备节点只读，单节点20min<br>主节点TPS：2.3w，备节点TPS：3.6w |

**【测试结果说明】**

(1)  本次性能测试实在实验室网络环境下，搭建测试环境并进行的性能测试，网络条件较稳定，不考虑现网与实验室的网络条件差异；

(2)  本次测试工具模拟压力场景，代表的仅是已知业务模型，没有特殊业务场景，不代表现网复杂场景下的实际处理能力；

(3)  本次测试是在固定网络、物料、软件版本等配套的前提下进行，若实际环境与本次测试存在不同，请自行评估性能差异。

**【遗留问题】**

无



### 4.3.3 压力长稳测试结论

**【测试情况】**

| 版本名称                       | 测试起始时间 | 测试结束时间 |
| ------------------------------ | ------------ | ------------ |
| openGauss 5.1.0 build 24ebc36b | 2023-09-16   | 2023-09-19   |
| openGauss 5.1.0 build fa0f975f | 2023-09-21   | 2023-09-28   |

| 平台 | CPU  | 内存  | 磁阵      | 操作系统                      | 组网方式 |
| ---- | ---- | ----- | --------- | ----------------------------- | -------- |
| ARM  | 128  | 756GB | 单卷组1TB | openEuler release 20.03 (LTS) | 一主一备 |

| Domain | 场景                                                         | 关键参数配置                                                 | 时长  |
| ------ | ------------------------------------------------------------ | ------------------------------------------------------------ | ----- |
| tpcc   | 1000w数据量<br>主节点800并发读写+一致性<br>备节点200并发只读+一致性 | update_lockwait_timeout=10min<br>lockwait_timeout=10min<br>dms_control.sh脚本中禁用start&clean | 7*24H |

**【测试结论】**

一主一备部署形态下，使用tpcc 1000仓，主节点800并发读写+备节点200并发只读/一致性脚本进行稳定性测试，运行周期为7\*24H，目前已运行7\*24H，无锁超时，数据一致性校验暂未通过。

**【遗留问题】**

无



### 4.3.4 资料测试结论

对资源池化也行相关资料的正确性、易用性、完整性、语言描述书面化等进行测试，对于示例和命令进行了有效性测试。发现的问题均已解决，满足版本出口标准。



# 5 附件

 

 ## 5.1 附件1：遗留问题列表
| 问题单号       | I812QX                                                       |
| -------------- | ------------------------------------------------------------ |
| 问题简述       | tpcc建仓过程中kill主节点gaussdb进程，节点状态一直卡在unknown |
| 问题级别       | 次要                                                         |
| 问题分析与对策 | api所在的客户端进程退出时候，某个客户端api所在的线程的链接的session上设置了vg_latch的spinlock_t类型的lock。dss服务端在发现api所在的客户端链接断链的时候，需要session上做vg_latch等latch信息的清理。清理过程是断链事件触发从线程池里分配线程处理。断链事件跟新建联事件是可并发的。清理latch的过程是按照链接即session级别处理的。清理过程需要获取并独占vg_latch的lock。 |
| 规避措施       | 如果发生，会导致集群状态异常，需要手动重启恢复集群。         |
| 备注           |                                                              |

| 问题单号       | I7THQ6                                                       |
| -------------- | ------------------------------------------------------------ |
| 问题简述       | 资源池化在线failover失败导致RTO超时                          |
| 问题级别       | 不重要                                                       |
| 问题分析与对策 | 其中发生两轮failover，第一轮在线failover进行了30s然后失败，第二轮重启failover成功，耗时近30s，耗时长有主要因素1）在线failover的失败，且耗时30s。因为在线failover需要将业务线程全部退出，如果30s对应业务线程没有退出，则认为线程无法退出，在线failover失败；因素2）重启failover，因为重启，本身需要完成一系列初始化动作，以及reform重新组织工作，也增加了近10s的耗时 |
| 规避措施       | 当前想避免在线failover失败的话，需要备机没有对应的业务       |
| 备注           | 1、不影响集群功能，在线failover失败后还有重启failover，集群还会恢复正常。<br>2、当前备机只有进程卡在DMS的页面请求中，无法响应信号才会无法退出，如果没有的话，业务线程可以正常退出 |

| 问题单号       | I8314Z                                                       |
| -------------- | ------------------------------------------------------------ |
| 问题简述       | 扫表查询调用到GetMultiXactIdMembers，长时间没有返回结        |
| 问题级别       | 次要                                                         |
| 问题分析与对策 | 备机的扫描查询，主机会处理会调用到GetMultiXactIdMembers ，除此之外主机侧其中大量的业务线程也调用GetMultiXactIdMembers ，在这个函数中会请求MultiXactMemberControlLock，这个锁是全局，只有一个，但是每个线程都在请求就会排队，其中部分线程会反复请求，造成业务进行也会变慢。同样的DMS的消息处理线程调用到该函数，同样会卡住。因为消息处理线程不工作，造成其他消息无法处理，影响其他场景。 |
| 规避措施       | 暂无消减或规避措施                                           |
| 备注           | 后续解决方案：方向：避免DMS消息处理线程因为该场景卡住，影响其他流程 |

## 5.2 附件2：其他专项测试报告

暂无