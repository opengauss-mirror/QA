![avatar](../../../images/openGauss.png)

版权所有 © 2023  openGauss社区
您对“本文档”的复制、使用、修改及分发受知识共享(Creative Commons)署名—相同方式共享4.0国际公共许可协议(以下简称“CC BY-SA 4.0”)的约束。为了方便用户理解，您可以通过访问https://creativecommons.org/licenses/by-sa/4.0/ 了解CC BY-SA 4.0的概要 (但不是替代)。CC BY-SA 4.0的完整协议内容您可以访问如下网址获取：https://creativecommons.org/licenses/by-sa/4.0/legalcode。

修订记录

| 日期     | 修订   版本 | 修改描述 | 作者       |
| -------- | ----------- | -------- | ---------- |
| 2023-7-7 | 1.0         | 初稿完成 | peilinqian |
|          |             |          |            |

关键词：大页内存

 

摘要：本文档主要验证shared_buffer按大页内存分配后，数据库功能、可靠性方面表现是否正常，性能在openEuler 22.03 OS 2P鲲鹏机器上是否达成150W tpmc，并给出测试结论。

 

缩略语清单：

| 缩略语 | 英文全名 | 中文解释 |
| ------ | -------- | -------- |
| NA     |          |          |

# 1     特性概述

操作系统页表所需空间会随着运行环境总内存的增加而增加。在数百GB级别的内存环境中，使用4K的内存页将导致数据库进程页表空间变大，同时TLB miss的概率增加，这将拖慢数据库的查询速度，并且浪费主存空间。为避免大内存运行环境下系统内存页过小导致性能下降，openGauss引入大页内存功能。当配置文件的enable_huge_pages设置为on时，openGauss数据库在启动时将从操作系统预分配的大页内存中创建共享内存。

# 2     特性测试信息

| 版本名称                       | 测试起始时间 | 测试结束时间 |
| ------------------------------ | ------------ | ------------ |
| openGauss 5.1.0 build a74b7333 | 2023-6-19    | 2023-6-21    |
| openGauss 5.1.0 build ad27d72a | 2023-6-28    | 2023-6-30    |

**功能环境**：

| 环境信息 | 配置信息                                                     | 备注         |
| -------- | ------------------------------------------------------------ | ------------ |
| 虚拟机   | CPU：Intel(R) Xeon(R) Gold 6278C CPU @ 2.60GHz<br />内存：16GB<br />硬盘：100GB<br />OS：CentoOS Linux release 7.6.1810 (Core) | 一主两备部署 |
| 虚拟机   | CPU：Intel(R) Xeon(R) platinum 8365HC CPU@ 3.00GHz<br />内存：8GB<br />硬盘：100GB<br />OS：openEuler release 22.03 LTS | 一主一备部署 |

**性能环境**

| 环境信息                                       | 配置信息                                                     | 备注                |
| ---------------------------------------------- | ------------------------------------------------------------ | ------------------- |
| ARM+openEuler 2P<br />TaiShan 200 (Model 2280) | CPU：Kunpeng 920 7260 2p 128核<br />内存：31*32GB<br />硬盘：NVME 3T * 4<br />OS：openEuler release 22.03 (LTS)<br />文件系统：XFS<br />网卡：10GE | openGauss数据库节点 |
| ARM+openEuler 2P<br />TaiShan 200 (Model 2280) | CPU：Kunpeng 920 7260 2p 128核<br />内存：24*32GB<br />硬盘：NVME 3T * 4<br />OS：openEuler release 20.03 (LTS)<br />文件系统：XFS<br />网卡：10GE | tpcc节点            |

# 3     测试结论概述

## 3.1   测试整体结论

共计执行10个用例，主要覆盖了功能测试、可靠性测试、性能测试，发现issue4个，已验收通过3个，待办1个（openEuler22.03操作系统，大页内存2M场景下，性能无法达到150w），目前无法解决，整体质量一般；

| 测试活动   | 活动评价                                                     |
| ---------- | ------------------------------------------------------------ |
| 功能测试   | 不同操作系统x86centos、x86openeuler、armopeneuler<br />验证新增两个参数enable_huge_pages、huge_page_size设置，包括：正常配置生效，异常配置正确报错、主备不同配置等场景；发现issue3个，均验收通过；测试结论：通过 |
| 可靠性测试 | 验证有业务压力场景下，kill数据库进程再启动，大页内存回收重分配功能正常；测试结论：通过 |
| 性能测试   | 基于2P鲲鹏openEuler 22.03 OS验证大页内存设置2M，达成150W tpmC目标；发现issue1个，暂时未解决；测试结论：不通过 |
| 资料测试   | 大页内存相关参数说明、整体配置指导等说明准确清晰。测试结论：通过 |

## 3.2   约束说明

（1）操作系统配置限制：首先系统支持大页内存，并且配置具体大页内存数量、数据库进程用户配置使用大页内存权限；具体查询配置方法参照5 附件的资料链接。

（2）数据库参数enable_huge_pages配置为on开启大页内存；

（3）数据库参数huge_page_size默认配置时使用系统默认大页内存；其他配置时只能配置具体系统支持的大页内存大小，且配置值需要与约束（1）配置的大页内存数量的大页内存一致，否则配置后无法启动数据库。

## 3.3   遗留问题分析

### 3.3.1 遗留问题影响以及规避措施

| 问题单号                                                     | 问题描述                                                     | 问题级别 | 问题影响和规避措施                 | 当前状态 |
| ------------------------------------------------------------ | ------------------------------------------------------------ | -------- | ---------------------------------- | -------- |
| [I7J4EM](https://e.gitee.com/opengaussorg/projects/492431/bugs/table?issue=I7J4EM) | 【测试类型：性能】【测试版本：5.1.0】 openEuler22.03操作系统，大页内存2M场景下，性能无法达到150w | 主要     | 开启大页内存，性能无法达到需求预期 | 打开     |

### 3.3.2 问题统计

|        | 问题总数 | 严重 | 主要 | 次要 | 不重要 |
| ------ | -------- | ---- | ---- | ---- | ------ |
| 数目   | 4        | 0    | 2    | 1    | 1      |
| 百分比 | 100%     | 0%   | 50%  | 25%  | 25%    |

### 问题单汇总

| 序号 | issue号                                                      | 问题级别 | 问题简述                                                     | 问题状态 |
| ---- | ------------------------------------------------------------ | -------- | ------------------------------------------------------------ | -------- |
| 1    | [I7F9OX](https://e.gitee.com/opengaussorg/projects/492431/bugs/table?issue=I7F9OX) | 不重要   | 【测试类型：资料】【测试版本：5.1.0】 大页内存相关参数huge_page_size取值范围描述不准确，默认单位未描述 | 已验收   |
| 2    | [I7EQF9](https://e.gitee.com/opengaussorg/projects/492431/bugs/table?issue=I7EQF9) | 主要     | 【测试类型：工具功能】【测试版本：5.1.0】 x86centos系统，大页内存开启，配置huge_page_size为非系统支持的大页大小，重启集群，未正常抛错 | 已验收   |
| 3    | [I7FA2U](https://e.gitee.com/opengaussorg/projects/492431/bugs/table?issue=I7FA2U) | 次要     | 【测试类型：工具功能】【测试版本：5.1.0】 大页内存相关参数设置后，目前备机自动同步主机的参数设置情况，应该根据节点内存等实际情况单独配置生效，允许主备配置不同； | 已验收   |
| 4    | [I7J4EM](https://e.gitee.com/opengaussorg/projects/492431/bugs/table?issue=I7J4EM) | 主要     | 【测试类型：性能】【测试版本：5.1.0】 openEuler22.03操作系统，大页内存2M场景下，性能无法达到150w | 待办的   |



# 4     测试执行

## 4.1   测试执行统计数据

| 版本名称                       | 测试用例数 | 用例执行结果         | 发现问题单数 |
| ------------------------------ | ---------- | -------------------- | ------------ |
| openGauss 5.1.0 build a74b7333 | 8          | Passed：5  Failed：3 | 3            |
| openGauss 5.1.0 build ad27d72a | 10         | Passed：9  Failed：1 | 1            |

*数据项说明：*

- 首轮测试用例执行8个，不通过3个，第二轮执行用例10个（包含首轮用例，回归缺陷用例3个），不通过1个；详情见缺陷问题单汇总；
- 本需求缺陷密度为4(缺陷个数)/0.275k(代码行数)=14.54(个/kloc)。

## 4.2   后续测试建议

无

# 5     附件

新增大页内存资料

https://docs.opengauss.org/zh/docs/latest/docs/DatabaseReference/%E5%A4%A7%E9%A1%B5%E5%86%85%E5%AD%98.html

 

 
