![输入图片说明](../../../image.png)

版权所有 © 2023  openGauss社区
 您对“本文档”的复制、使用、修改及分发受知识共享(Creative Commons)署名—相同方式共享4.0国际公共许可协议(以下简称“CC BY-SA 4.0”)的约束。为了方便用户理解，您可以通过访问https://creativecommons.org/licenses/by-sa/4.0/ 了解CC BY-SA 4.0的概要 (但不是替代)。CC BY-SA 4.0的完整协议内容您可以访问如下网址获取：https://creativecommons.org/licenses/by-sa/4.0/legalcode。

修订记录

| 日期      | 修订   版本 | 修改描述             | 作者     |
| :-------- | ----------- | -------------------- | -------- |
| 2023-8-29 | 1.0         | 特性测试报告初稿完成 | songjing |

 关键词： 发布订阅，冲突事务

摘要：

本文档描述发布订阅发生主键或唯一键冲突时对冲突解决能力进行的测试，并给出测试结论。

缩略语清单：

| 缩略语 | 英文全名 | 中文解释 |
| ------ | -------- | -------- |
| 无     |          |          |

# 1 特性概述

需求来源于中移在线客户，存在两个或两个以上可写的集群，也就是订阅端也存在数据写入，因此回放发布端同步过来的数据时，可能会产生主键或唯一键的错误，中断复制链路。期望能尽可能由数据库来自动处理冲突，节省人力投入，同时提供手段方法处理冲突。 

* 添加冲突处理的GUC参数subscription_conflict_resolution，控制遇到冲突时的处理动作
* 增加冲突时的打印信息，包括复制源名称、冲突事务的commit_lsn和具体冲突数据
* 增加语法alter subscription sub_name set (skiplsn=XXX)，跳过冲突事务commit_lsn

# 2 特性测试信息

| 版本名称                       | 测试起始时间 | 测试结束时间 |
| ------------------------------ | ------------ | ------------ |
| openGauss 5.1.0 build 5762b67e | 2023-8-24    | 2023-8-28    |
| openGauss 5.1.0 build 321133e2 | 2023-9-11    | 2023-9-11    |

| 环境信息 | 硬件配置信息                                                 | 备注  |
| -------- | ------------------------------------------------------------ | ----- |
| 虚拟机   | Intel(R) Xeon(R) Gold 6226C CPU @ 3.00GHz<br/>内存：15GB<br/>硬盘：100GB<br/>OS：openEuler release 20.03 (LTS-SPI) | 集群1 |
| 虚拟机   | Intel(R) Xeon(R) Gold 6278C CPU @ 2.60GHz<br/>内存：31GB<br/>硬盘：100GB<br/>OS：CentOS release 7.9.2009  (Core) | 集群2 |

# 3 测试结论概述

## 3.1 测试整体结论

发布订阅支持冲突解决共计执行用例37条，主要覆盖功能测试，升级测试和资料测试。功能测试包含GUC参数subscription_conflict_resolution取值验证，新增禁用订阅和跳过冲突事务语法测试，发生数据冲突后是否按设置的处理方式解决冲突测试；升级测试验证升级后支持本特性，回滚升级能正常执行；资料测试验证特性描述是否准确，示例正确等。测试发现缺陷1个，已修复且回归通过，整体质量良好。

| 测试活动 | 活动评价                                                     |
| :------- | :----------------------------------------------------------- |
| 功能测试 | GUC参数subscription_conflict_resolution取值验证，通过        |
| 功能测试 | subscription_conflict_resolution设置不同值，构造数据冲突场景，查看订阅端的处理情况，通过 |
| 功能测试 | 禁用订阅测试，通过                                           |
| 功能测试 | 订阅端跳过事务测试，通过                                     |
| 功能测试 | 发生数据冲突，解决冲突时，主备failover、switchover后数据是否同步，通过 |
| 升级测试 | 5.0.0升级到最新版本，验证特性功能正常，通过                  |
| 资料测试 | 资料描述准确，约束覆盖全面，整体质量良好                     |

## 3.2 约束说明

1. 当同步的新数据存在多个索引冲突时，仅判断第一个冲突的索引，即日志打印时仅打印第一个冲突的数据，同时应用远端的情况下由于剩余索引冲突导致应用失败。
2. alter subscription skip 跳过的是整个事务，而不是事务中的单个操作。

## 3.3 遗留问题分析

### 3.3.1 遗留问题影响以及规避措施

| 问题单号 | 问题描述 | 问题级别 | 问题影响及规避措施 | 当前状态 |
| -------- | -------- | -------- | :----------------- | -------- |
| 无       |          |          |                    |          |

### 3.3.2 问题统计

|        | 问题总数 | 严重 | 主要 | 次要 | 不重要 |
| ------ | -------- | ---- | ---- | ---- | ------ |
| 数目   | 1  | 0  | 0 | 1   | 0      |
| 百分比 | 100% | 0% | 0% | 100% | 0%     |

###  3.3.3 问题单汇总

| issue号                                                      | 问题级别 | 问题简述                                                     | 问题状态 |
| ------------------------------------------------------------ | -------- | ------------------------------------------------------------ | -------- |
| [I7WJ21](https://gitee.com/opengauss/openGauss-server/issues/I7WJ21?from=project-issue) | 次要     | 禁用订阅，更新数据，获取并跳过commit_lsn，激活订阅，偶现跳过的数据仍被同步 | 待办的   |

# 4 测试执行

## 4.1 测试执行步骤

###  4.1.1 功能测试

#### 4.1.1.1 GUC参数subscription_conflict_resolution取值验证

| 测试步骤：                                                   | 测试结果                        |
| ------------------------------------------------------------ | ------------------------------- |
| 1.使用gs_guc set/reload、alter system set 方式设置参数值验证<br/>2.取值符合取值范围error/keep_local/apply_remote<br/>3.取非法值验证 | 共执行3条用例，执行结果符合预期 |

#### 4.1.1.2 subscription_conflict_resolution设置不同值，构造数据冲突场景，查看订阅端的参数处理情况

| 测试步骤：                                                   | 测试结果                         |
| ------------------------------------------------------------ | -------------------------------- |
| 1. 设置subscription_conflict_resolution=error<br/>2.发布端订阅端执行事务，构造主键、唯一键、非空约束冲突场景，查看日志信息是否打印冲突数据、commit_lsn等信息<br/>3.跳过冲突的commit_lsn，查询订阅数据是否同步<br/>4.分别设置subscription_conflict_resolution=keep_local、apply_remote<br />5.发布端订阅端执行事务构造主键、唯一键、非空约束冲突，多个订阅者订阅同一个发布，双向订阅相同表等冲突场景<br/>6.查看日志打印是否正确，冲突数据是否保留本地或应用远端<br/>7.双向订阅相同表，两个集群设置不同冲突处理方式，开启事务更新表数据，查询表数据，是否按照设定的参数值处理冲突 | 共执行18条用例，执行结果符合预期 |

#### 4.1.1.3 禁用订阅测试

| 测试步骤：                                                   | 测试结果                      |
| ------------------------------------------------------------ | ----------------------------- |
| 1.创建表，创建发布订阅，发布端更新表数据，订阅端查询表<br/>2.alter subscription sub_name disable;禁用订阅，提示是否正常，发布端更新数据，订阅查询数据是否同步<br/>3.激活订阅，查询数据是否同步<br/>4.禁用数据冲突造成复制停止的订阅，查看日志是否停止报错，跳过冲突数据，激活订阅，验证数据是否同步<br/>5.数据同步过程中禁用订阅 | 执行4条用例，执行结果符合预期 |

#### 4.1.1.4 订阅跳过事务测试

| 测试步骤：                                                   | 测试结果                      |
| ------------------------------------------------------------ | ----------------------------- |
| 1.禁用订阅，获取发布端事务的commit_lsn，在订阅端通过alter subscription set (skiplsn=commit_lsn);设置skiplsn，再激活订阅，查看该事务是否被跳过<br/>2.构造冲突数据，查看日志获取commit_lsn，跳过冲突事务，查看订阅数据是否同步<br/>3.跳过冲突事务之前或之后的commit_lsn，查看冲突是否解决 | 执行4条用例，执行结果符合预期 |

#### 4.1.1.5 执行大量事务包含大量冲突数据，主备切换和集群重启后冲突解决正常执行

| 测试步骤：                                                   | 测试结果                      |
| ------------------------------------------------------------ | ----------------------------- |
| 1.分别设置subscription_conflict_resolution为keep_local和apply_remote<br/>2.创建表和发布订阅，订阅端插入数据，发布端执行大量事务插入数据，包含冲突数据<br/>3.发布端和订阅端分别主备切换、集群重启，查询订阅端表数据是否同步 | 执行8条用例，执行结果符合预期 |

###  4.1.3 升级测试

| 测试步骤：                                                   | 测试结果         |
| ------------------------------------------------------------ | ---------------- |
| 1.安装5.0.0版本数据库<br/>2.升级到最新版本<br/>3.查询subscription_conflict_resolution参数值，查询系统表pg_subscription是否新增字段skiplsn<br/>4.创建发布订阅，构造数据冲突，跳过冲突，查询数据是否更新<br/>5.回滚升级 | 执行结果符合预期 |

### 4.1.4 资料测试

| 测试步骤：                                               | 测试结果         |
| -------------------------------------------------------- | ---------------- |
| 1.检查资料描述是否准确、约束覆盖是否全面以及示例是否正确 | 检查结果符合预期 |

## 4.2 测试执行统计数据

| 版本名称                       | 测试用例数 | 用例执行结果             | 发现问题单数 |
| ------------------------------ | ---------- | ------------------------ | ------------ |
| openGauss 5.1.0 build 5762b67e | 37   | Passed : 35  Failed : 2 | 1           |
| openGauss 5.1.0 build 321133e2 | 2 | Passed : 2  Failed : 0 | 0 |

*数据项说明：*

1.测试过程中共发现1个缺陷，已验收

2.缺陷密度为 1(缺陷个数)/1.235k(代码行数)=0.81(个/kloc)。

## 4.3 后续测试建议

无

# 5 附件

无