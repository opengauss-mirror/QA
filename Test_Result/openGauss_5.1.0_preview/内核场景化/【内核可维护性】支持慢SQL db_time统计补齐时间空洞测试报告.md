![avatar](../../../images/openGauss.png)

版权所有 © 2023  openGauss社区
您对“本文档”的复制、使用、修改及分发受知识共享(Creative Commons)署名—相同方式共享4.0国际公共许可协议(以下简称“CC BY-SA 4.0”)的约束。为了方便用户理解，您可以通过访问https://creativecommons.org/licenses/by-sa/4.0/ 了解CC BY-SA 4.0的概要 (但不是替代)。CC BY-SA 4.0的完整协议内容您可以访问如下网址获取：https://creativecommons.org/licenses/by-sa/4.0/legalcode。

修订记录

| 日期      | 修订   版本 | 修改描述     | 作者       |
| --------- | ----------- | ------------ | ---------- |
| 2023-9-20 | 1.0         | 特性测试初稿 | lichunlong |

 关键词： 

 db_time

摘要：

 重构统计SQL调用链时间统计过程和方法

缩略语清单：

| 缩略语 | 英文全名 | 中文解释 |
| ------ | -------- | -------- |
| NA     |          |          |

# 1     特性概述

本特性主要实现sql执行过程分阶段细化，并且统计各阶段的耗时，解决sql执行耗时db_time和子项差异较大的问题。本次测试主要通过gsql和jdbc工具连接数据库主机或备机，测试DDL、DML和DCL语法sql在事务或者非事务中执行，包含PBE和sql bybpass场景，对比总耗时db_time和各子项之和的差异不能大于10%。

# 2     特性测试信息

测试版本

| 版本名称                       | 测试起始时间 | 测试结束时间 |
| ------------------------------ | ------------ | ------------ |
| openGauss 5.1.0 build e923404c | 2023-9-1     | 2023-9-8     |

环境信息

| 环境信息 | 配置信息                                                     | 备注 |
| -------- | ------------------------------------------------------------ | ---- |
| 虚拟机   | CPU：Intel(R) Xeon(R) Gold 6266C CPU @ 3.00GHz 8核<br />内存：16GB<br />硬盘：100G<br />OS：openEuler 20.03 (LTS-SP1) x86 |      |
| 物理机   | CPU：Kunpeng 920 7260 2p 128核<br />内存：24*32GB<br />硬盘：NVME 3T * 4<br />OS：openEuler release 20.03 (LTS)<br />文件系统：XFS<br />网卡：10GE |      |

# 3     测试结论概述

## 3.1   测试整体结论

支持慢SQL db_time统计不起时间空洞特性测试活动中，共计执行用例95条，主要涉及功能测试、性能测试、长稳测试以及文档验证，测试未发现与该特性相关的问题，整体质量良好。

| 测试活动 | 活动评价                                                     |
| -------- | ------------------------------------------------------------ |
| 功能测试 | 针对DDL、DML、DCL语句在各种情况下执行耗时统计准确，确认总耗时与子时间之和的误差不超过10% |
| 性能测试 | 通过TPCC性能测试验证该特性是否会引起性能下降。               |
| 长稳测试 | 通过7*24小时tpcc长稳测试，确认测试中sql执行总时间和子时间之和的误差不超过10%，且观察内存使用稳定，不存在内存泄漏情况。 |
| 资料测试 | 验证资料中与本特性相关的修改合理正确。                       |

## 3.2   约束说明

无

## 3.3   遗留问题分析

### 3.3.1 遗留问题影响以及规避措施

| 问题单号 | 问题描述 | 问题级别 | 问题影响和规避措施 | 当前状态 |
| -------- | -------- | -------- | ------------------ | -------- |
| NA       |          |          |                    |          |

### 3.3.2 问题统计

|        | 问题总数 | 严重 | 主要 | 次要 | 不重要 |
| ------ | -------- | ---- | ---- | ---- | ------ |
| 数目   | 0        | 0    | 0    | 0    | 0      |
| 百分比 | 100      | 0    | 0    | 0    | 0      |

### 3.3.3 问题单汇总

| 序号 | issue号 | 问题级别 | 问题简述 | 问题状态 |
| ---- | ------- | -------- | -------- | -------- |
| NA   |         |          |          |          |

# 4     测试执行 

## 4.1  功能测试

| 测试步骤                                                     | 测试结果                       |
| ------------------------------------------------------------ | ------------------------------ |
| 1. 在主机和备机上通过gsql和jdbc工具测试DDL、DML和DCL语法sql在事务或者非事务中执行，验证sql执行总时间和子时间之和的误差不超过10%；<br/>2. 测试主备switchover/failover之后，执行sql总时间与子时间之和的误差不超过10%；<br/>3. 测试PBE和sql by pass场景中sql执行总时间和子时间之和的误差不超过10%。 | 执行测试用例96条<br />测试通过 |

## 4.2 性能测试

| 测试步骤                                                     | 测试结果                  |
| ------------------------------------------------------------ | ------------------------- |
| 1. 在高性能环境上执行tpcc 1000仓数据性能测试，性能达到150WtpmC。 | 执行用例1条<br />测试通过 |

## 4.3 长稳测试

| 测试步骤                                                     | 测试结果                  |
| ------------------------------------------------------------ | ------------------------- |
| 1. 执行tpcc 7*24小时长稳测试，测试过程中查看业务sql总时间与子时间之间的误差不超过10%；内存不会泄漏。 | 执行用例1条<br />测试通过 |

## 4.4 资料验证

| 测试步骤                                  | 测试结果 |
| ----------------------------------------- | -------- |
| 1. 验证资料中与本特性涉及的修改正确合理。 | 测试通过 |

## 4.5 测试执行统计数据

| 版本名称                       | 测试用例数 | 用例执行结果            | 发现问题单 |
| ------------------------------ | ---------- | ----------------------- | ---------- |
| openGauss 5.1.0 build e923404c | 98         | Passed:98<br />Failed:0 | 0          |

缺陷单共计0个，2.76kloc，缺陷密度为0个/kloc。

# 5     附件

 各种时间消耗信息，主要分为以下类型： 

- DB_TIME：作业在多核下的有效时间花销。
- EXECUTION_TIME：执行器内的时间花销。
- PARSE_TIME：SQL解析的时间花销。
- PLAN_TIME：生成Plan的时间花销。
- REWRITE_TIME：SQL重写的时间花销。
- PL_EXECUTION_TIME：plpgsql（存储过程）执行的时间花销。
- PL_COMPILATION_TIME：plpgsql（存储过程）编译的时间花销。
- NET_SEND_TIME：网络上的时间花销。
- DATA_IO_TIME：IO的时间花销。
- SRT1_Q: Q报文执行的耗时
- SRT2_SIMPLE_QUERY: exec_simple_query执行耗时
- SRT3_ANALYZE_REWRITE: pg_analyze_and_rewrite执行耗时
- SRT4_PLAN_QUERY: pg_plan_queries执行耗时
- SRT5_LIGHT_QUERY: exec_query_through_light_proxy执行耗时
- SRT6_P：P报文执行的耗时
- SRT7_B：B报文执行的耗时
- SRT8_E：E报文执行的耗时
- SRT9_D：D报文执行的耗时
- SRT10_S：S报文执行的耗时
- SRT11_C：C报文执行的耗时
- SRT12_U：U报文执行的耗时
- SRT13_BEFORE_QUERY：进入下一次报文处理前的耗时
- SRT14_AFTER_QUERY: 完成报文处理后的耗时
- RTT_UNKNOWN: 未知时间消耗，可能是session切换耗时。

 

 
