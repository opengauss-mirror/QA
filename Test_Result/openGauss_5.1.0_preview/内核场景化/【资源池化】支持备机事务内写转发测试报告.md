![输入图片说明](../../../image.png)

版权所有 © 2023  openGauss社区
 您对“本文档”的复制、使用、修改及分发受知识共享(Creative Commons)署名—相同方式共享4.0国际公共许可协议(以下简称“CC BY-SA 4.0”)的约束。为了方便用户理解，您可以通过访问https://creativecommons.org/licenses/by-sa/4.0/ 了解CC BY-SA 4.0的概要 (但不是替代)。CC BY-SA 4.0的完整协议内容您可以访问如下网址获取：https://creativecommons.org/licenses/by-sa/4.0/legalcode。

修订记录

| 日期      | 修订   版本 | 修改描述             | 作者     |
| :-------- | ----------- | -------------------- | -------- |
| 2023-7-5  | 1.0         | 特性测试报告初稿完成 | songjing |
| 2023-7-12 | 2.0         | 根据评审意见修改报告 | songjing |

 关键词： 

资源池化，备机，多节点写，libpq协议，写转发

摘要：

本文档为openGauss资源池化一主多备架构下，开启多节点写，备机可以执行DDL语句和DML语句等写操作、事务内写请求转发到主机执行进行的测试并给出测试结论。

缩略语清单：

| 缩略语 | 英文全名 | 中文解释 |
| ------ | -------- | -------- |
| 无     |          |          |

# 1 特性概述

本特性基于openGauss的多写特性和资源池化架构，利用libpq协议来创建和销毁备机与主机的连接通道， 在备机通过转发管理器统一拦截从应用发出的消息报文，按照报文协议和执行语句共同决定是否转发给主机，只读查询在备机本地执行，DDL语句、DML语句、事务等语句转发给主机执行，同时将主机的执行结果转发给应用，另外， 备节点支持将事务内的写操作转发到主节点处理 ，读操作留在备机本地执行。 

# 2 特性测试信息

| 版本名称                       | 测试起始时间 | 测试结束时间 |
| ------------------------------ | ------------ | ------------ |
| openGauss 5.1.0 build a74b7333 | 2023-6-19    | 2022-6-27    |
| openGauss 5.1.0 build af596cf1 | 2023-7-5     | 2023-7-5     |

| 环境信息 | 硬件配置信息                                                 | 备注 |
| -------- | ------------------------------------------------------------ | ---- |
| 虚拟机   | Intel(R) Xeon(R) Gold E5-2690 v3 @ 2.60GHz<br/>内存：251GB<br/>硬盘：6T<br/>OS：openEuler release 20.03 (LTS-SPI) |      |

# 3 测试结论概述

## 3.1 测试整体结论

资源池化备机支持事务内写转发共计执行用例81条，主要覆盖功能测试，可靠性测试、稳定性测试和资料测试。功能测试包含分别使用gsql和jdbc连接数据库在事务内外执行DDL、DML等读写操作验证语句是否转发到主机执行；可靠性测试包含磁盘故障和网络故障测试；备机运行24小时tpcc稳定性测试；测试发现问题3个，均已回归通过，无遗留风险，整体质量良好。

| 测试活动   | 活动评价                                                 |
| :--------- | :------------------------------------------------------- |
| 功能测试   | gsql连接数据库，执行DDL、DML等读写操作测试，通过         |
| 功能测试   | jdbc连接数据库，执行DDL、DML等读写操作测试，通过         |
| 功能测试   | gsql连接数据库，事务內执行读、写、读写操作场景测试，通过 |
| 功能测试   | jdbc连接数据库，事务內执行读、写、读写操作场景测试，通过 |
| 可靠性测试 | 磁盘故障和网络故障测试，符合预期                         |
| 稳定性测试 | 备机运行24小时tpcc                                       |
| 资料测试   | 资料描述准确，约束覆盖全面，整体质量良好                 |

## 3.2 约束说明

1. 参数enable_remote_excute=on时，该特性才能生效
3. 不支持备机事务內执行DDL语句、lock table、truncate table
4. 如果备机事务內包含子事务，那么事务內的读也会转发到主机

## 3.3 遗留问题分析

### 3.3.1 遗留问题影响以及规避措施

| 问题单号 | 问题描述 | 问题级别 | 问题影响及规避措施 | 当前状态 |
| -------- | -------- | -------- | :----------------- | -------- |
| 无       |          |          |                    |          |

### 3.3.2 问题统计

|        | 问题总数 | 严重 | 主要 | 次要 | 不重要 |
| ------ | -------- | ---- | ---- | ---- | ------ |
| 数目   | 3   | 0  | 1   | 2    | 0      |
| 百分比 | 100% | 0% | 33% | 67% | 0%     |

###  3.3.3 问题单汇总

| issue号                                                      | 问题级别 | 问题简述                                                     | 问题状态 |
| ------------------------------------------------------------ | -------- | ------------------------------------------------------------ | -------- |
| [I7EYB8](https://gitee.com/opengauss/openGauss-server/issues/I7EYB8?from=project-issue) | 次要     | 开启多节点写，备机执行移动游标语句报错                       | 已验收   |
| [I7EY45](https://gitee.com/opengauss/openGauss-server/issues/I7E45?from=project-issue) | 主要     | 开启多节点写，备机事务中执行表数据增删改查产生core           | 已验收   |
| [I7GFCV](https://gitee.com/opengauss/openGauss-server/issues/I7GFCV?from=project-issue) | 次要     | 备机执行事务有语句执行失败，提交成功，报错语句未转发到主机执行 | 已验收   |

# 4 测试执行

## 4.1 测试执行步骤

###  4.1.1 功能测试

#### 4.1.1.1 gsql连接备机，执行DDL、DML等读写操作测试

| 测试步骤：                                                   | 测试结果                         |
| ------------------------------------------------------------ | -------------------------------- |
| 1.设置 enable_remote_excute=on，重启数据库<br/>2.gsql连接备机执行DDL、DML语句、存储过程、函数、匿名块、触发器等语句和异常读写场景测试<br/>4.查看日志记录，写语句是否转发到主机执行 | 共执行30条用例，执行结果符合预期 |

#### 4.1.1.2 jdbc连接备机，执行DDL、DML等读写操作测试

| 测试步骤：                                                   | 测试结果                         |
| ------------------------------------------------------------ | -------------------------------- |
| 1. 设置 enable_remote_excute=on，重启数据库<br/>2.jdbc连接备机执行DDL、DML语句、存储过程、函数、匿名块、触发器等语句和异常读写场景测试<br/>3.查看日志记录，写语句是否转发到主机执行 | 共执行13条用例，执行结果符合预期 |

#### 4.1.1.3 gsql连接备机，事务內执行读、写、读写操作场景测试

| 测试步骤：                                                   | 测试结果                              |
| ------------------------------------------------------------ | ------------------------------------- |
| 1.设置 enable_remote_excute=on，重启数据库<br/>2.gsql连接备机在事务中执行只读查询、DDL、DML语句、子事务及异常场景测试<br/>3.查看日志记录，写语句是否转发到主机执行，报错语句记录 | 执行26条用例，发现2个问题，且回归通过 |

#### 4.1.1.4 jdbc连接备机，事务內执行读、写、读写操作场景测试

| 测试步骤：                                                   | 测试结果                      |
| ------------------------------------------------------------ | ----------------------------- |
| 1.设置 enable_remote_excute=on，重启数据库<br/>2.gsql连接备机在事务中执行只读查询、DDL、DML语句和异常场景等<br/>3.查看日志记录，写语句是否转发到主机执行 | 执行6条用例，执行结果符合预期 |

### 4.1.2 可靠性测试

| 测试步骤：                                                   | 测试结果                      |
| ------------------------------------------------------------ | ----------------------------- |
| 1.设置 enable_remote_excute=on，重启数据库<br/>2.备机在执行写操作的同时注入磁盘故障和网络故障<br/>3.查看日志记录<br/>4.观察测试数据及数据库状态 | 执行5条用例，执行结果符合预期 |

###  4.1.3 稳定性测试

| 测试步骤：                                                   | 测试结果                      |
| ------------------------------------------------------------ | ----------------------------- |
| 1.设置 enable_remote_excute=on<br/>2.备机进行24小时TPCC<br/>3.观察测试数据及数据库状态 | 执行1条用例，执行结果符合预期 |

### 4.1.4 资料测试

| 测试步骤：                                               | 测试结果         |
| -------------------------------------------------------- | ---------------- |
| 1.检查资料描述是否准确、约束覆盖是否全面以及示例是否正确 | 检查结果符合预期 |

## 4.2 测试执行统计数据

| 版本名称                       | 测试用例数 | 用例执行结果             | 发现问题单数 |
| ------------------------------ | ---------- | ------------------------ | ------------ |
| openGauss 5.1.0 build a74b7333 | 81    | Passed : 74  Failed : 7 | 3           |
| openGauss 5.1.0 build af596cf1 | 7       | Passed : 7   Failed : 0 | 0            |

*数据项说明：*

1.测试过程中共发现3个缺陷，已修复且验收通过

2.缺陷密度为 3(缺陷个数)/0.662k(代码行数)=4.531(个/kloc)。

## 4.3 后续测试建议

无

# 5 附件

无