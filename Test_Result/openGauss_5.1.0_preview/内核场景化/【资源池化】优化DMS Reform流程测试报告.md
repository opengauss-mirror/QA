![输入图片说明](../../../image.png)

版权所有 © 2023  openGauss社区
 您对“本文档”的复制、使用、修改及分发受知识共享(Creative Commons)署名—相同方式共享4.0国际公共许可协议(以下简称“CC BY-SA 4.0”)的约束。为了方便用户理解，您可以通过访问https://creativecommons.org/licenses/by-sa/4.0/ 了解CC BY-SA 4.0的概要 (但不是替代)。CC BY-SA 4.0的完整协议内容您可以访问如下网址获取：https://creativecommons.org/licenses/by-sa/4.0/legalcode。

修订记录

| 日期      | 修订   版本 | 修改描述             | 作者     |
| :-------- | ----------- | -------------------- | -------- |
| 2023-7-5  | 1.0         | 特性测试报告初稿完成 | songjing |
| 2023-7-12 | 2.0         | 根据评审意见修改报告 | songjing |

 关键词： 

资源池化，DMS，Reform

摘要：

本文档为openGauss资源池化架构下，优化DMS reform流程的测试报告。

缩略语清单：

| 缩略语 | 英文全名                     | 中文解释                |
| ------ | ---------------------------- | ----------------------- |
| CM     | Cluster Management           | 集群管理软件            |
| DMS    | Distributed Memory Service   | 分布式内存服务          |
| DRC    | Distributed Resource Catalog | DMS内部的分布式资源目录 |

# 1 特性概述

在openGauss资源池化架构下，当集群出现异常，集群节点会根据CM提供的信息组织一轮reform，让集群从异常情况转变成稳定运行。reform流程主要包含DMS侧通信线程其连接的管理，DMS侧DRC的维护，DB侧数据的恢复。在这过程中DMS侧的步骤由一个线程执行，耗时较长，因此引入并行框架，由多个线程共同执行，加快reform执行速度。

# 2 特性测试信息

| 版本名称                       | 测试起始时间 | 测试结束时间 |
| ------------------------------ | ------------ | ------------ |
| openGauss 5.1.0 build 338028e0 | 2023-5-11    | 2023-5-22    |
| openGauss 5.1.0 build a74b7333 | 2023-6-19    | 2023-6-19    |
| openGauss 5.1.0 build af596cf1 | 2023-7-5     | 2023-7-5     |

| 硬件型号      | 硬件配置信息                                                 | 备注 |
| ------------- | ------------------------------------------------------------ | ---- |
| ARM+openEuler | CPU : Kunpeng-920<br/>内存：765GB<br/>硬盘：4.2T<br/>OS：openEuler release 20.03 (LTS)<br/>文件系统：XFS |      |

# 3 测试结论概述

## 3.1 测试整体结论

优化DMS reform流程共计执行用例192条，主要覆盖功能测试，可靠性测试，性能、稳定性测试和资料测试。功能测试包含新增GUC参数设置测试，开启reform并行后reform时间验证；可靠性测试复用执行现有资源池化可靠性用例，性能测试为比对开启与关闭reform并行对性能无影响；开启reform并行后7*24小时稳定性测试。测试发现问题4个，均已回归通过，无遗留风险，整体质量良好。

| 测试活动   | 活动评价                                                     |
| :--------- | :----------------------------------------------------------- |
| 功能测试   | 新增GUC参数测试，通过                                        |
| 功能测试   | 开启reform并行，无业务压力，reform-recovery时间小于9秒测试，通过 |
| 功能测试   | 开启reform并行，50W tpmc场景下，reform-recovery时间小于9秒测试，通过 |
| 功能测试   | 50W tpmc场景下，内存池大小、reform并行度及有效页面数对RTO影响，通过 |
| 功能测试   | 开启极致RTO和reform并行开关，集群reform时间测试              |
| 功能测试   | 开启reform并行不影响分布式锁验证，复用分布式锁用例，通过     |
| 可靠性测试 | 开启reform并行，复用执行资源池化可靠性用例，通过             |
| 性能测试   | 开启与关闭reform并行性能比对，通过 |
| 稳定性测试 | 开启reform并行，运行7*24小时tpcc，通过 |
| 资料测试   | 资料描述准确，约束覆盖全面，整体质量良好                     |

## 3.2 约束说明

1. 资源池化架构下支持本特性

## 3.3 遗留问题分析

### 3.3.1 遗留问题影响以及规避措施

| 问题单号 | 问题描述 | 问题级别 | 问题影响及规避措施 | 当前状态 |
| -------- | -------- | -------- | :----------------- | -------- |
| 无       |          |          |                    |          |

### 3.3.2 问题统计

|        | 问题总数 | 严重 | 主要 | 次要 | 不重要 |
| ------ | -------- | ---- | ---- | ---- | ------ |
| 数目   | 4   | 0  | 0  | 4   | 0      |
| 百分比 | 100% | 0% | 0% | 100% | 0%     |

###  3.3.3 问题单汇总

| issue号                                                      | 问题级别 | 问题简述                                                     | 问题状态 |
| ------------------------------------------------------------ | -------- | ------------------------------------------------------------ | -------- |
| [I765E4](https://gitee.com/opengauss/openGauss-server/issues/I765E4?from=project-issue) | 次要     | 开启reform并行，主机执行业务过程中cm_ctl stop主机，备机failover成功，reform-recovery时间>9秒，dms_reform_start耗时6秒 | 已验收   |
| [I77BPF](https://gitee.com/opengauss/openGauss-server/issues/I77BPF?from=project-issue) | 主要     | 开启reform并行，主备机执行业务过程中cm命令重启备机，stop对应reform阶段超过9s，dms_reform_drc_clean_parallel步骤耗时长 | 已验收   |
| [I78PJL](https://gitee.com/opengauss/openGauss-server/issues/I78PJL?from=project-issue) | 次要     | 主节点dss_home路径失效或mv dssserver二进制，kill -9 dssserver 集群无法产生新主，状态异常 | 已验收   |
| [I7FARF](https://gitee.com/opengauss/openGauss-server/issues/I7FARF?from=project-issue) | 次要     | 资源池化的函数ss_buffer_ctrl()在传统数据库执行导致数据库coredump | 已验收   |

# 4 测试执行

## 4.1 测试执行步骤

###  4.1.1 功能测试

#### 4.1.1.1 新增GUC参数测试

| 测试步骤：                                           | 测试结果                |
| ---------------------------------------------------- | ----------------------- |
| 1.参数ss_parallel_thread_count取值测试，修改方式测试 | 共执行5条用例，符合预期 |

#### 4.1.1.2 开启reform并行，无业务压力，reform-recovery时间小于9秒测试

| 测试步骤：                                                   | 测试结果                |
| ------------------------------------------------------------ | ----------------------- |
| 1.设置ss_parallel_thread_count=16，shared_buffers=350GB<br/>2.无业务压力情况下，主备重启、switchover、failover、踢出/加入节点使集群发生reform<br/>3.执行tpcc ，50W tpmc时，主备重启、failover、踢出/加入节点<br/>4.查看DMS日志，reform剔除recovery阶段的时间小于9秒 | 共执行3条用例，符合预期 |

#### 4.1.1.3 开启reform并行，50W tpmc场景下，reform-recovery时间小于9秒测试

| 测试步骤：                                                   | 测试结果                                      |
| ------------------------------------------------------------ | --------------------------------------------- |
| 1.设置ss_parallel_thread_count=16，shared_buffers=350GB<br/>2.执行tpcc，50W tpmc时主备重启、failover、踢出/加入节点使集群发生reform<br/>3.4.查看DMS日志，reform剔除recovery阶段的时间小于9秒 | 共执行18条用例，发现缺陷2个，已修复且回归通过 |

#### 4.1.1.4 50W tpmc场景下，内存池大小、reform并行度及有效页面数对RTO影响

| 测试步骤：                                                   | 测试结果                 |
| ------------------------------------------------------------ | ------------------------ |
| 1.设置ss_parallel_thread_count=16，shared_buffers分别设置为64GB、128GB和350GB<br/>2.执行tpcc，50W tpmc时主备重启、failover<br/>3.查看DMS日志，对比不同内存池大小reform时间，均小于9秒<br/>4.设置shared_buffers=350GB，ss_parallel_thread_count分别设置为2、16和64<br/>5.执行步骤2和3<br/>6.设置ss_parallel_thread_count=16，shared_buffers=350GB<br/>7.执行tpcc增加主或备机有效页面，重启主/备、failover、备机加入使集群发生reform，查看reform时间<br/> | 共执行11条用例，符合预期 |

#### 4.1.1.5 开启极致RTO和reform并行，reform时间测试

| 测试步骤：                                                   | 测试结果                |
| ------------------------------------------------------------ | ----------------------- |
| 1.开启极致RTO，设置ss_parallel_thread_count=16，shared_buffers=350GB<br/>2.执行tpcc，50W tpmc时重启主备、failover、踢出备机<br/>3.查看DMS日志，reform除去recovery阶段的时间小于9秒 | 共执行3条用例，符合预期 |

#### 4.1.1.6 开启reform并行不影响分布式锁验证

| 测试步骤：                                                   | 测试结果                 |
| ------------------------------------------------------------ | ------------------------ |
| 1.设置ss_parallel_thread_count=16，shared_buffers=350GB<br/>2.复用DMS分布式锁用例，主备持有分布式锁时集群reform场景 | 共执行10条用例，符合预期 |

### 4.1.2 可靠性测试

| 测试步骤：                                                   | 测试结果                                     |
| ------------------------------------------------------------ | -------------------------------------------- |
| 1.设置ss_parallel_thread_count=16，shared_buffers=350GB<br/>2.执行现有资源池化可靠性用例<br/>3.查看DMS日志reform时间 | 执行141条用例，发现问题2个，已修复且回归通过 |

### 4.1.3 性能测试

| 测试步骤：                                                   | 测试结果                  |
| ------------------------------------------------------------ | ------------------------- |
| 1.分别关闭和开启reform并行时执行tpcc性能测试，比对结果，预期开启reform并行不影响性能| 执行1条用例，符合预期结果 |

### 4.1.4 稳定性测试

| 测试步骤：                                                   | 测试结果                  |
| ------------------------------------------------------------ | ------------------------- |
| 1.开启reform并行，运行7*24h tpcc稳定性测试，查看数据库状态和数据一致| 符合预期结果 |

### 4.1.5 资料测试

| 测试步骤：                                               | 测试结果         |
| -------------------------------------------------------- | ---------------- |
| 1.检查资料描述是否准确、约束覆盖是否全面以及示例是否正确 | 检查结果符合预期 |

## 4.2 测试执行统计数据

| 版本名称                       | 测试用例数 | 用例执行结果             | 发现问题单数 |
| ------------------------------ | ---------- | ------------------------ | ------------ |
| openGauss 5.1.0 build 338028e0 | 192 | Passed : 160  Failed : 32 | 4           |
| openGauss 5.1.0 build a74b7333 | 12      | Passed : 12  Failed : 0 | 0            |
| openGauss 5.1.0 build af596cf1 | 20 | Passed : 20  Failed : 0 | 0 |

*数据项说明：*

1.测试过程中共发现4个缺陷，已修复且验收通过

2.缺陷密度为 4(缺陷个数)/0.405k(代码行数)=9.877(个/kloc)

## 4.3 后续测试建议

无

# 5 附件

无