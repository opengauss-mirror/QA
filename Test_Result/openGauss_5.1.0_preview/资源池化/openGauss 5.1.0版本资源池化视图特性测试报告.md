![avatar](../../../images/openGauss.png)

版权所有 © 2023  openGauss社区
您对“本文档”的复制、使用、修改及分发受知识共享(Creative Commons)署名—相同方式共享4.0国际公共许可协议(以下简称“CC BY-SA 4.0”)的约束。为了方便用户理解，您可以通过访问https://creativecommons.org/licenses/by-sa/4.0/ 了解CC BY-SA 4.0的概要 (但不是替代)。CC BY-SA 4.0的完整协议内容您可以访问如下网址获取：https://creativecommons.org/licenses/by-sa/4.0/legalcode。

修订记录

| 日期      | 修订   版本 | 修改描述                                         | 作者        |
| --------- | ----------- | ------------------------------------------------ | ----------- |
| 2023.9.20 | 1.0         | 资源池化新增视图测试报告第1版                    | xingbin.she |
| 2023.9.21 | 2.0         | 补充reform测试场景、补充3.0.3到5.1.0升级路径测试 | xingbin.she |
| 2023.9.25 | 3.0         | 删除MES等待事件的相关测试内容                    | xingbin.she |

 关键词： 

 资源池化，页面分布信息，节点reform信息，DSS IO统计，功能测试，升级兼容性测试

摘要：

 本文档主要介绍测试openGauss 5.1.0版本新增资源池化视图特性，主要包括新增查询指定页面分布信息、节点reform信息、DSS IO统计三个视图的功能测试和升级兼容性测试，测试了不同场景下各新增视图的功能，最后给出测试结论。

缩略语清单：

| 缩略语 | 英文全名 | 中文解释 |
| ------ | -------- | -------- |
|        |          |          |
|        |          |          |

# 1     特性概述

该特性的目的是补齐资源池化架构下的视图与等待事件，支持查询指定页面的分布信息，支持查询节点的reform信息，支持对DSS I/O活动进行监控。

# 2     特性测试信息

特性测试软件版本信息。

| 版本名称                                                     | 测试起始时间 | 测试结束时间 |
| ------------------------------------------------------------ | ------------ | ------------ |
| openGauss 5.1.0 build a07d57c3 (B20)                         | 2023-09-20   | 2023-09-20   |
| openGauss 5.1.0 build d7cb7b39 (自行编译) （页面分布信息）   | 2023-09-20   | 2023-09-20   |
| openGauss 5.1.0 build 15a2bebe (自行编译) （节点reform信息问题修复） | 2023-09-20   | 2023-09-20   |
| openGauss 5.1.0 build 3115c025 (自行编译) （升级兼容性测试） | 2023-09-21   | 2023-09-21   |

环境硬件信息。

| 环境信息 | 配置信息                                                     | 备注                           |
| -------- | ------------------------------------------------------------ | ------------------------------ |
| 虚拟机   | CPU：Intel Xeon Processor (Icelake) @ 2.0GHz  16核<br />内存：32GB<br />硬盘：100GB * 3 + 300MB * 2<br />OS：openEuler_x86 20.03<br />存储：enmoTech - zStorage | 功能测试，一主一备共享存储部署 |
| 虚拟机   | CPU：Intel Xeon Processor (Icelake) @ 2.0GHz  16核<br />内存：32GB<br />硬盘：100GB <br />OS：openEuler_x86 20.03 | 升级兼容性测试，单机部署       |

# 3     测试结论概述

## 3.1   测试整体结论

本测试共设计17个测试用例，主要包括不同场景下页面分布信息、节点reform信息和DSS IO统计信息的查询功能测试，版本升级兼容性测试，覆盖路径：5.0.0 --> 5.1.0和3.0.3 --> 5.1.0。测试发现1个问题，已修复并测试回归通过，整体质量良好。

| 测试活动       | 活动评价                                                     |
| -------------- | ------------------------------------------------------------ |
| 功能测试       | 测试不同场景下根据表名+文件名+block号查询给定页面的分布信息功能 |
| 功能测试       | 测试不同场景下查询节点reform信息功能                         |
| 功能测试       | 测试不同场景下查询DSS IO等待事件功能                         |
| 升级兼容性测试 | 测试openGauss从3.0.3、5.0.0版本升级到5.1.0，数据库服务正常运行，且新增视图功能正常 |
| 资料测试       | 新增视图相关资料描述清晰、示例正确                           |

## 3.2   约束说明

1.   本特性的功能测试依赖共享存储方式部署，仅在共享存储方式部署下提供有效查询输出，普通方式部署无有效信息输出
2.   资源池化不支持从5.0.0升级至5.1.0，因此本特性的升级兼容性测试仅在普通方式部署下验证升级的兼容性，以及升级后数据库运行状态，不验证升级后视图的正常查询功能

## 3.3   遗留问题分析

### 3.3.1 遗留问题影响以及规避措施

| 问题单号 | 问题描述 | 问题级别 | 问题影响和规避措施 | 当前状态 |
| -------- | -------- | -------- | ------------------ | -------- |
| NA       |          |          |                    |          |

### 3.3.2 问题统计

|        | 问题总数 | 严重 | 主要 | 次要 | 不重要 |
| ------ | -------- | ---- | ---- | ---- | ------ |
| 数目   | 1        | 0    | 0    | 1    | 0      |
| 百分比 | 100%     | 0    | 0    | 100% | 0      |

### 3.3.3 问题汇总

| 序号 | issue号 | 级别 | 问题描述                                              | 状态   |
| ---- | ------- | ---- | ----------------------------------------------------- | ------ |
| 1    | I831CS  | 次要 | [资源池化] 查询节点reform信息输出行数与期望行数不一致 | 已验收 |

# 4     测试执行

## 4.1   测试执行步骤

### 4.1.1 查询页面分布信息

#### 前置条件

已创建段页式表`tb`，并向表中插入一条记录。

#### case 1：集群重启后立即查询

| 测试步骤                                                     | 预期结果                 | 测试结果 |
| ------------------------------------------------------------ | ------------------------ | -------- |
| 1. 关闭集群：cm_ctl stop<br />2. 启动集群：cm_ctl start<br />3. 在主节点连接数据库并查询指定页面分布信息：`gsql -d postgres -p 12300 -c "select * from query_page_distribution_info('tb', 0, 0);"` | 集群中没有给定页面的信息 | 测试通过 |

#### case 2：集群重启后备节点查询

| 测试步骤                                                     | 预期结果          | 测试结果 |
| ------------------------------------------------------------ | ----------------- | -------- |
| 1. 备节点查询表数据：`gsql -d postgres -p 12300 -c "select * from tb;"`<br />2. 在主节点连接数据库并查询指定页面分布信息：`gsql -d postgres -p 12300 -c "select * from query_page_distribution_info('tb', 0, 0);"` | 备机成为页面owner | 测试通过 |

#### case 3：备节点查询后主节点向表中写入数据

| 测试步骤                                                     | 预期结果                                         | 测试结果 |
| ------------------------------------------------------------ | ------------------------------------------------ | -------- |
| 1. 主节点向表中写入数据：`gsql -p 12300 -d postgres -c "insert into tb select * from tb;"`<br />2. 在主节点连接数据库并查询指定页面分布信息：`gsql -d postgres -p 12300 -c "select * from query_page_distribution_info('tb', 0, 0);"` | 主节点成为页面owner，持有X锁，备机不持有页面副本 | 测试通过 |

#### case 4：主节点写数据后备节点查询数据

| 测试步骤                                                     | 预期结果                                     | 测试结果 |
| ------------------------------------------------------------ | -------------------------------------------- | -------- |
| 1. 备节点查询数据：`gsql -d postgres -p 12300 -c "select * from tb;"`<br />2. 在主节点连接数据库并查询指定页面分布信息：`gsql -d postgres -p 12300 -c "select * from query_page_distribution_info('tb', 0, 0);"` | 主节点为页面owner，持有S锁，备机持有页面副本 | 测试通过 |

#### case 5：主节点写数据后立即查询

| 测试步骤                                                     | 预期结果                                                     | 测试结果 |
| ------------------------------------------------------------ | ------------------------------------------------------------ | -------- |
| 1. 在主节点连接数据库，写入数据并立即查询页面分布信息：`gsql -d postgres -p 12300 -c "insert into tb select * from tb; select * from query_page_distribution_info('tb', 0, 0);"` | 主节点为页面owner，持有X锁，mem_lsn大于disk_lsn，内存中的页面是脏页 | 测试通过 |



### 4.1.2 查询节点reform信息

#### 前置条件

集群两节点部署并正常运行

#### cese 1：有节点退出集群

| 测试步骤                                                     | 预期结果                                        | 测试结果 |
| ------------------------------------------------------------ | ----------------------------------------------- | -------- |
| 1. 手动关闭备节点：cm_ctl stop -n 2<br />2. 主节点连接数据库并查询节点reform信息：`gsql -p 12300 -d postgres -c "select * from query_node_reform_info();" ` | 集群发生normal reform，节点1稳定，节点2退出集群 | 测试通过 |

#### case 2：有节点加入集群

| 测试步骤                                                     | 预期结果                                        | 测试结果 |
| ------------------------------------------------------------ | ----------------------------------------------- | -------- |
| 1. 手动启动备节点：cm_ctl start -n 2<br />2. 主节点连接数据库并查询节点reform信息：`gsql -p 12300 -d postgres -c "select * from query_node_reform_info();" ` | 集群发生normal reform，节点1稳定，节点2加入集群 | 测试通过 |

#### case 3：集群发生failover

| 测试步骤                                                     | 预期结果                                           | 测试结果 |
| ------------------------------------------------------------ | -------------------------------------------------- | -------- |
| 1. 手动关闭主节点：cm_ctl start -n 1<br />2. 在新的主节点连接数据库并查询节点reform信息：`gsql -p 12300 -d postgres -c "select * from query_node_reform_info();" ` | 集群发生failover，节点1退出，节点2稳定并成为主节点 | 测试通过 |

#### case 4：集群发生switchover

| 测试步骤                                                     | 预期结果                               | 测试结果 |
| ------------------------------------------------------------ | -------------------------------------- | -------- |
| 1. 手动关闭集群：cm_ctl stop<br />2. 手动启动集群：cm_ctl start<br />3. 手动进行switchover：cm_ctl switchover -n 2 -D /data/opengauss/data/dn1<br />4. 在新的主节点连接数据库并查询节点reform信息：`gsql -p 12300 -d postgres -c "select * from query_node_reform_info();" ` | 集群发生switchover，节点1和节点2均稳定 | 测试通过 |

#### case 5：备节点数据库实例进程异常退出

| 测试步骤                                                     | 预期结果                                        | 测试结果 |
| ------------------------------------------------------------ | ----------------------------------------------- | -------- |
| 1. 修改节点2上的gaussdb二进制文件名：mv gaussdb gaussdb_bak<br />2. 手动kill数据库实例进程<br />3. 查询集群状态：cm_ctl query -Cvi<br />4. 在新的主节点连接数据库并查询节点reform信息：`gsql -p 12300 -d postgres -c "select * from query_node_reform_info();" ` | 集群发生normal reform，节点1稳定，节点2退出集群 | 测试通过 |

#### case 6：备节点dssserver进程异常退出

| 测试步骤                                                     | 预期结果                                        | 测试结果 |
| ------------------------------------------------------------ | ----------------------------------------------- | -------- |
| 1. 修改节点2上的dssserver二进制文件名：mv dssserver dssserver_bak<br />2. 手动kill dssserver进程<br />3. 查询集群状态：cm_ctl query -Cvi<br />4. 在新的主节点连接数据库并查询节点reform信息：`gsql -p 12300 -d postgres -c "select * from query_node_reform_info();" ` | 集群发生normal reform，节点1稳定，节点2退出集群 | 测试通过 |

#### case 7：主节点数据库实例进程异常退出

| 测试步骤                                                     | 预期结果                                               | 测试结果 |
| ------------------------------------------------------------ | ------------------------------------------------------ | -------- |
| 1. 修改节点1上的gaussdb二进制文件名：mv gaussdb gaussdb_bak<br />2. 手动kill数据库实例进程<br />3. 查询集群状态：cm_ctl query -Cvi<br />4. 在新的主节点连接数据库并查询节点reform信息：`gsql -p 12300 -d postgres -c "select * from query_node_reform_info();" ` | 集群发生failover，节点1退出集群，节点2稳定并成为主节点 | 测试通过 |

#### case 8：主节点dssserver进程异常退出

| 测试步骤                                                     | 预期结果                                               | 测试结果 |
| ------------------------------------------------------------ | ------------------------------------------------------ | -------- |
| 1. 修改节点1上的dssserver二进制文件名：mv dssserver dssserver_bak<br />2. 手动kill dssserver进程<br />3. 查询集群状态：cm_ctl query -Cvi<br />4. 在新的主节点连接数据库并查询节点reform信息：`gsql -p 12300 -d postgres -c "select * from query_node_reform_info();" ` | 集群发生failover，节点1退出集群，节点2稳定并成为主节点 | 测试通过 |



### 4.1.3 查询DSS IO统计信息

#### case 1：主节点写入大量数据

| 测试步骤                                                     | 预期结果                           | 测试结果 |
| ------------------------------------------------------------ | ---------------------------------- | -------- |
| 1. 窗口1连接数据库并向表中插入大量数据：`gsql -p 12300 -d postgres -c "insert into tb1 values (generate_series(0, 199999), 'asdrghouierghoyusefgasofuyfsgaeoisrf', 'wsrghbsdrgfoiuaygrfouwydrsfgqbsoruygrgf' ,'qwrgfohqwrsfgyboqiusyrgfouwqerygfbweodrugygred');"`<br />2. 窗口2连接数据库并查询指定时间间隔内的DSS IO信息：`gsql -p 12300 -d postgres -c "select * from dss_io_stat(2);"` | 数据库服务在给定时间内产生数据写入 | 测试通过 |

#### case 2：主节点查询数据

| 测试步骤                                                     | 预期结果                           | 测试结果 |
| ------------------------------------------------------------ | ---------------------------------- | -------- |
| 1. 窗口1连接数据库并向表中查询大量数据：  `gsql -p 12300 -d postgres -c "select * from tb1;"`<br />2. 窗口2连接数据库并查询指定时间间隔内的DSS IO信息：`gsql -p 12300 -d postgres -c "select * from dss_io_stat(2);"` | 数据库服务在给定时间内产生数据读取 | 测试通过 |



### 4.1.4  升级兼容性测试

#### case 1：3.0.3升级到5.1.0

| 测试步骤                                                     | 预期结果                                                   | 测试结果 |
| ------------------------------------------------------------ | ---------------------------------------------------------- | -------- |
| 1. OM安装3.0.3<br />2. 连接数据库，创建测试表，并向表中插入数据：`gsql -p 33315 -d postgres -c "create table tb(version text); insert into tb select version();"`<br />3. 在5.1.0版本安装包目录下执行预安装：`./gs_preinstall -G nom -U nom -X /data/omm/config.xml`<br />4. 在安装用户下执行升级命令：`gs_upgradectl -t auto-upgrade -X /data/nombin/config.xml`<br />5. 连接数据库并查询版本信息：`gsql -p 33315 -d postgres -c "select version();"`<br />6. 查询页面分布信息：`gsql -d postgres -p 33315 -c "select * from query_page_distribution_info('tb', 0, 0);"`<br />7. 查询节点reform信息：`gsql -p 33315 -d postgres -c "select * from query_node_reform_info();"`<br />8. 查询DSS IO统计信息：`gsql -p 33315 -d postgres -c "select * from dss_io_stat(2);"` | 数据库能够从3.0.3升级到5.1.0，并且新增视图查询结果符合预期 | 测试通过 |

#### case 2：5.0.0升级到5.1.0

| 测试步骤                                                     | 预期结果                                                   | 测试结果 |
| ------------------------------------------------------------ | ---------------------------------------------------------- | -------- |
| 1. OM安装5.0.0<br />2. 连接数据库，创建测试表，并向表中插入数据：`gsql -p 33315 -d postgres -c "create table tb(version text); insert into tb select version();"`<br />3. 在5.1.0版本安装包目录下执行预安装：`./gs_preinstall -G nom -U nom -X /data/omm/config.xml`<br />4. 在安装用户下执行升级命令：`gs_upgradectl -t auto-upgrade -X /data/nombin/config.xml`<br />5. 连接数据库并查询版本信息：`gsql -p 33315 -d postgres -c "select version();"`<br />6. 查询页面分布信息：`gsql -d postgres -p 33315 -c "select * from query_page_distribution_info('tb', 0, 0);"`<br />7. 查询节点reform信息：`gsql -p 33315 -d postgres -c "select * from query_node_reform_info();"`<br />8. 查询DSS IO统计信息：`gsql -p 33315 -d postgres -c "select * from dss_io_stat(2);"` | 数据库能够从5.0.0升级到5.1.0，并且新增视图查询结果符合预期 | 测试通过 |



## 4.2   测试执行统计数据

| 版本信息                                                     | 测试用例数目 | 测试用例执行结果  | 发现问题数 |
| ------------------------------------------------------------ | ------------ | ----------------- | ---------- |
| openGauss 5.1.0 build a07d57c3 (B20)                         | 12           | 通过：11  失败：1 | 1          |
| openGauss 5.1.0 build d7cb7b39 (自行编译) （页面分布信息）   | 6            | 通过：6  失败：0  | 0          |
| openGauss 5.1.0 build 15a2bebe (自行编译) （节点reform信息问题修复） | 8            | 通过：8  失败：0  | 0          |
| openGauss 5.1.0 build 3115c025 (自行编译)  （升级兼容性测试） | 2            | 通过：2  失败：0  | 0          |

***数据说明***

*   累计发现问题1个，已修复，PR链接：https://gitee.com/opengauss/openGauss-server/pulls/4163
*   转测版本B20未合入查询页面分布信息，仅执行节点reform信息查询、DSS IO统计信息查询相关测试
*   d7cb7b39 版本仅执行页面分布信息功能测试和升级兼容性测试
*   15a2bebe 版本修复B20版本中发现的问题
*   3115c025 版本用于验证升级兼容性问题

## 4.3 后续测试建议

无

# 5     附件

无

 

 
