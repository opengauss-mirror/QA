![avatar](../../../images/openGauss.png)

版权所有 © 2023  openGauss社区
 您对“本文档”的复制、使用、修改及分发受知识共享(Creative Commons)署名—相同方式共享4.0国际公共许可协议(以下简称“CC BY-SA 4.0”)的约束。为了方便用户理解，您可以通过访问https://creativecommons.org/licenses/by-sa/4.0/ 了解CC BY-SA 4.0的概要 (但不是替代)。CC BY-SA 4.0的完整协议内容您可以访问如下网址获取：https://creativecommons.org/licenses/by-sa/4.0/legalcode。

修订记录

| 日期      | 修订   版本 | 修改描述           | 作者        |
| :-------- | ----------- | ------------------ | ----------- |
| 2023-9-26 | 1.0         | 特性测试报告初稿完 | yangyixiang |

 关键词： 

debezium、反向全量迁移

摘要：

本文档主要介绍基于debezium+kafka，实现openGauss数据库全量数据迁移M*数据库，并给出最终测试结论。 

缩略语清单：

| 缩略语 | 英文全名 | 中文解释 |
| ------ | -------- | -------- |
| 无     |          |          |

# 1     特性概述

反向迁移基于debezium实现openGauss到M*的全量迁移，性能满足300m/s，对数据导出到文件，再用copy语法迁移到openGauss之前，对文件按表做精细化管理，不占用过多磁盘空间，同时考虑数据校验复用此数据文件。

# 2     特性测试信息

| 版本名称                       | 测试起始时间 | 测试结束时间 |
| ------------------------------ | ------------ | ------------ |
| mysql 5.7.35<br/>openGauss 5.1.0 build 8b7d6d6e<br/>debezium 5.0.0 | 2023-7-27 | 2023-8-31 |
| mysql 5.7.35<br/>openGauss 5.1.0 build 31025cde<br/>debezium 5.0.0 | 2023-9-1   | 2023-9-21 |
| mysql 5.7.35<br/>openGauss 5.1.0 build 9daa6dba<br/>debezium 5.0.0 | 2023-9-22 | 2023-9-25 |

| 硬件型号   | 硬件配置信息                                                 | 备注 |
| ---------- | ------------------------------------------------------------ | ---- |
| x86+centOS | Intel(R) Xeon(R) Gold 6278C CPU @ 2.60GHz 8核<br/>内存：31GB<br/>硬盘：724G<br/>OS：CentOS Linux release 7.6.1908 (Core) |      |

# 3     测试结论概述

## 3.1   测试整体结论

反向迁移支持全量迁移特性，共计执行84条用例，主要覆盖了功能测试和资料测试。功能测试覆盖验证迁移不同数据类型，验证迁移数据的有序性、一致性，验证迁移工具配置文件参数有效性，验证反向全量迁移与反向增量迁移是否正常衔接，验证进度上报文件准确性。可靠性测试覆盖迁移中注入故障、kill迁移相关进程后日志中是否正常执行或反馈相关异常，停止数据库或迁移进程后再启动，迁移是否可以断点续传。资料测试覆盖资料的描述与实际的功能是否一致，是否可按照示例正确执行校验。累计发现有效缺陷单6个，5个缺陷已解决且回归通过，1个缺陷未解决，整体质量良好。

| 测试活动   | 活动评价                                                     |
| ---------- | :----------------------------------------------------------- |
| 功能测试   | 反向全量迁移是否正常迁移不同数据类型的数据。测试通过。       |
| 功能测试   | 反向全量迁移的数据迁移前后的顺序是否一致。测试通过。         |
| 功能测试   | 反向全量迁移进度上报文件准确性验证。测试通过。               |
| 功能测试   | 反向全量迁移配置文件参数有效性验证。测试通过。               |
| 功能测试   | 反向全量迁移与反向增量迁移的衔接验证。测试通过。             |
| 可靠性测试 | 迁移过程中注入故障、kill迁移相关进程，迁移是否正常执行或反馈相关异常。测试通过。 |
| 可靠性测试 | 迁移过程中停止数据库或迁移进程后再启动，迁移是否可以断点续传。测试通过。 |
| 性能测试   | 反向全量迁移性能是否达到300m/s。测试不通过。                 |
| 资料测试   | 资料对于新增加的功能描述准确，与实际功能保持一致，可按照示例正常执行。测试通过。 |

## 3.2   约束说明

- 仅支持从openGauss数据库复制全量数据迁移到M*数据库
- M*5.7及以上版本
- M*参数设置：需开启local_infile = 1;
- 先执行反向全量迁移，再执行反向增量迁移
- openGauss库为B库

## 3.3   遗留问题分析

### 3.3.1 遗留问题影响以及规避措施

| 问题单号 | 问题描述 | 问题级别 | 问题影响和规避措施 | 当前状态 |
| :------ | :------ | :------ | :---------------- | :------ |
|    [I7U5ZX](https://gitee.com/opengauss/debezium/issues/I7U5ZX?from=project-issue)    | 反向全量迁移，迁移性能达不到300m/s | 次要 | 迁移性能不达标，待下个版本解决 | 测试中 |

### 3.3.2 问题统计

|        | 问题总数 | 严重 | 主要 | 次要 | 不重要 |
| ------ | -------- | ---- | ---- | ---- | ------ |
| 数目   | 6    | 0    | 0  | 6 | 0      |
| 百分比 | 100%         | 0%   | 0% | 100% | 0%     |

###  3.3.3 问题单汇总

| 序号 | issue号                                                      | 问题级别 | 问题简述                                                     | 问题状态 |
| ---- | ------------------------------------------------------------ | -------- | ------------------------------------------------------------ | -------- |
| 1    | [I7U68A](https://gitee.com/opengauss/debezium/issues/I7U68A?from=project-issue) | 次要     | 反向全量迁移断点续传参数配置为默认值，日志中仍报错参数无效   | 已验收   |
| 2    | [I7U5ZX](https://gitee.com/opengauss/debezium/issues/I7U5ZX?from=project-issue) | 次要     | 反向全量迁移，迁移性能达不到300m/s                           | 测试中   |
| 3    | [I7TN04](https://gitee.com/opengauss/debezium/issues/I7TN04?from=project-issue) | 次要     | 反向全量迁移中停止sink端数据库后，再次启动数据库，无法断点续传 | 已验收   |
| 4    | [I7Q0OK](https://gitee.com/opengauss/debezium/issues/I7Q0OK?from=project-issue) | 次要     | 表包含json类型与二进制类型，反向全量迁移报错                 | 已验收   |
| 5    | [I7PH8X](https://gitee.com/opengauss/debezium/issues/I7PH8X?from=project-issue) | 次要     | 反向全量迁移，未生成sink端迁移进度文件，source端迁移进度文件显示内容不准确 | 已验收   |
| 6    | [I7OJ04](https://gitee.com/opengauss/debezium/issues/I7OJ04?from=project-issue) | 次要     | 反向全量迁移，配置文件大小参数后启动source端报错，配置schema映射后未过滤无效schema | 已验收   |

# 4     测试执行

## 4.1 测试执行步骤

###  4.1.1 迁移不同数据类型，验证迁移数据的有序性、一致性，验证与反向增量迁移的衔接

| 测试步骤：                                                   | 测试结果                                     |
| ------------------------------------------------------------ | -------------------------------------------- |
| 1. M*侧与openGauss侧建表，openGauss侧插入数据，开启反向全量迁移，查看数据是否迁移成功。数据类型覆盖浮点与整数类型、字符类型、日期时间类型、二进制类型、集合类型、位类型、json类型、布尔类型。<br/>2. 反向全量迁移数据后，启动数据校验，查看校验结果中两侧表数据是否一致。随机抽样两侧表数据，查看数据是否一致。<br/>3. 反向全量迁移结束后开启反向增量迁移，验证增量迁移是否可以迁移数据。 | 执行10条用例，发现1个bug，现已修复且验收通过 |

### 4.1.2 进度上报文件准确性验证

| 测试步骤：                                                   | 测试结果                                    |
| ------------------------------------------------------------ | ------------------------------------------- |
| 1. M*侧与openGauss侧建表，openGauss侧插入数据，开启反向全量迁移。查看source端进度上报文件中表数据大小、表名称、表数据量（行数）、表所在模式（schema）、迁移状态、迁移的表数量是否均正确显示。查看sink端进度上报文件中迁移表的名称、迁移百分比、迁移状态、总记录数、数据总大小、迁移的时间、迁移的速率是否正确显示。 | 执行2条用例，发现1个bug，现已修复且验收通过 |

### 4.1.3 反向全量迁移配置文件参数有效性验证

| 测试步骤：                                                   | 测试结果                                     |
| ------------------------------------------------------------ | -------------------------------------------- |
| 1. 参数source端文件写入位置、文件夹大小控制、文件大小划分配置、sink端是否删除文件、是否上报迁移进度、日志生产起始点文件输出路径、迁移进度上报时间间隔、迁移进度文件输出路径、断点记录kafka消息topic参数、从kafka读取断点topic的最大重试次数、kafka服务器地址、断点记录kafka的条数限制、断点记录kafka的时间限制配置为合法值时，验证参数是否有效。参数配置为非法值时，验证日志中是否合理报错。 | 执行60条用例，发现2个bug，现已修复且验收通过 |

### 4.1.4 可靠性验证

| 测试步骤：                                                   | 测试结果                                     |
| ------------------------------------------------------------ | -------------------------------------------- |
| 1. 迁移过程中注入磁盘满故障、注入CPU使用率80%故障、注入网络故障、kill数据库进程、kill source端进程、kill sink端进程，查看迁移是否正常执行或反馈相关异常<br/>2. 迁移过程中停止sink端数据库或sink端迁移进程后再启动，查看迁移是否可以断点续传。 | 执行11条用例，发现1个bug，现已修复且验收通过 |

### 4.1.5 性能测试

| 测试步骤：                                                   | 测试结果                          |
| ------------------------------------------------------------ | --------------------------------- |
| 1. M*侧与openGauss侧建表10张，openGauss侧插入数据每张表500万条数据以上，开启反向全量迁移，查看性能是否达到300m/s。 | 执行1条用例，发现1个bug，尚未修复 |

### 4.1.6 资料测试

| 测试步骤：                                                   | 测试结果  |
| ------------------------------------------------------------ | --------- |
| 1. 验证资料对于新增加的功能描述是否准确，与实际功能是否保持一致，是否可按照示例正常执行。 | 未发现bug |

## 4.2  测试执行统计数据

| 版本名称                                                     | 测试用例数 | 用例执行结果             | 发现问题单数 |
| ------------------------------------------------------------ | ---------- | ------------------------ | ------------ |
| mysql 5.7.35<br/>openGauss 5.1.0 build 8b7d6d6e<br/>debezium 5.0.0 | 47         | Passed：43<br>Failed：4  | 5            |
| mysql 5.7.35<br/>openGauss 5.1.0 build 31025cde<br/>debezium 5.0.0 | 79         | Passed：77<br>Failed：2  | 1            |
| mysql 5.7.35<br/>openGauss 5.1.0 build 9daa6dba<br/>debezium 5.0.0 | 84         | Passed：84<br/>Failed：0 | 0            |

*数据项说明：*

* 累计发现缺陷单6个，5个缺陷均已解决且回归通过，1个缺陷未解决
* 缺陷密度为6个(缺陷个数)/4.77kloc(代码行数)=1.26(个/kloc)

## 4.3   后续测试建议

验证10张表，每张表500万行数据以上，反向全量迁移性能是否达到300m/s

# 5     附件

无