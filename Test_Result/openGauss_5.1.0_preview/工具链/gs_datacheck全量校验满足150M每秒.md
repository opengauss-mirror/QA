![avatar](../../../images/openGauss.png)

版权所有 © 2022  openGauss社区
 您对“本文档”的复制、使用、修改及分发受知识共享(Creative Commons)署名—相同方式共享4.0国际公共许可协议(以下简称“CC BY-SA 4.0”)的约束。为了方便用户理解，您可以通过访问https://creativecommons.org/licenses/by-sa/4.0/ 了解CC BY-SA 4.0的概要 (但不是替代)。CC BY-SA 4.0的完整协议内容您可以访问如下网址获取：https://creativecommons.org/licenses/by-sa/4.0/legalcode。

修订记录

| 日期       | 修订   版本 | 修改描述 | 作者     |
| ---------- | ----------- | -------- | -------- |
| 2023.06.08 | V1.0        | 初稿     | lihongji |
|            |             |          |          |

 关键词： 

M*、chameleon、openGauss、gs_datachecker、kafka、全量校验性能、150MB/s

 摘要：

本文档内容为验证在使用chameleon工具从M*数据库向openGauss数据库进行全量迁移后，使用gs_datachecker校验工具进行全量数据校验，校验速率满足150MB/s。

缩略语清单：

| 缩略语 | 英文全名 | 中文解释 |
| ------ | -------- | -------- |
| NA     |          |          |

# 1     特性概述

gs_datachecker校验工具全量数据校验，校验速率满足150MB/s。

# 2     特性测试信息

被测对象的版本信息：

| 版本名称                       | 测试起始时间 | 测试结束时间 |
| ------------------------------ | :----------- | ------------ |
| openGauss 5.1.0 build 68d1772f | 2023-05-26   | 2023-06-29   |
| M* 5.7.27                      | 2022-05-26   | 2023-06-29   |
| chameleon 5.0.0                | 2022-05-26   | 2023-06-29   |
| jdk 11.0.16                    | 2022-05-26   | 2023-06-29   |
| kafka 2.13-2.8.11              | 2022-05-26   | 2023-06-29   |
| gs_datachecker master          | 2022-05-26   | 2023-06-29   |

硬件环境信息：

| 硬件型号                 | 硬件配置信息                                                 | 备注                     |
| ------------------------ | ------------------------------------------------------------ | ------------------------ |
| TaiShan 200 (Model 2280) | Architecture：aarch64<br />CPU：kunpeng-920 2600MHz <br />内存：1021GB<br />硬盘：7.3TB<br />OS：openEuler release 20.03 (LTS) | openGauss 及宿端抽取服务 |
| TaiShan 200 (Model 2280) | Architecture：aarch64<br />CPU：kunpeng-920  2600MHz<br />内存：765GB<br />硬盘：3.0TB<br />OS：openEuler release 20.03 (LTS-SP1) | M* 及源端抽取服务        |
| TaiShan 200 (Model 2280) | Architecture：aarch64<br />CPU：kunpeng-920 2600MHz<br />内存：765GB<br />硬盘：7.3TB<br />OS：openEuler release 20.03 (LTS-SP1) | kafka及数据校验服务      |

# 3     测试结论概述

## 3.1   测试整体结论

​      基于sysbench初始表结构，表数量、数据总量、每张表数据条数测试范围分别为1至500张表、1GB至196GB、1万至1亿条。gs_datachecker全量校验速度满足150MB/s特性，共执行用例45个，合计提3个问题单。性能均未达到150M/S，整体质量一般。

## 3.2   约束说明

1. M* 5.7.27数据存储分盘
2. openGauss侧的目标库为兼容B库，除初始用户外的数据库用户均有复制权。
3. 表须含主键
4. 仅对数据的差异性及表字段名称的差异性进行数据校验，不对表结构及字段类型的差异性做校验


## 3.3   遗留问题分析

### 3.3.1 遗留问题影响以及规避措施

| 问题单号 | 问题描述 | 问题级别 | 问题影响和规避措施 | 当前状态 |
| -------- | -------- | -------- | ------------------ | -------- |
| NA       |          |          |                    |          |

### 3.3.2 问题统计

|        | 问题总数 |  严重  | 主要 | 次要  | 不重要 |
| ------ | :------: | :----: | :--: | :---: | :----: |
| 数目   |    3     |   0    |  2   |   1   |   0    |
| 百分比 |   100%   | 66.67% |  0%  | 33.3% |   0%   |

### 3.3.3 问题单汇总

| 序号 | issue号                                                      | 级别 | 问题简述                                                     | 状态   |
| ---- | ------------------------------------------------------------ | ---- | ------------------------------------------------------------ | ------ |
| 1    | [I79TWK](https://gitee.com/opengauss/openGauss-tools-datachecker-performance/issues/I79TWK?from=project-issue) | 次要 | 全量数据校验速率满足150M/S：验证60张表，单表总行数10w，当宿端openGauss多表的时候，校验结果文件failed.log未生成，没有相应提示 | 已完成 |
| 2    | [I7ABZ0](https://gitee.com/opengauss/openGauss-tools-datachecker-performance/issues/I7ABZ0?from=project-issue) | 主要 | 全量数据校验速率满足150M/S：10张表，每张表1亿数据。源端M*、宿端openGauss抽取服务报错 | 已完成 |
| 3    | [I79DCH](https://gitee.com/opengauss/openGauss-tools-datachecker-performance/issues/I79DCH?from=project-issue) | 主要 | 全量数据校验速率满足150M/S：10张表，每张表50万数据。校验速率达不到150M/S | 待办的 |

# 4     测试执行

## 4.1   测试执行步骤

1. sysbench批量创造数据，表结构采用sysbench默认表结构

3. 使用chameleon工具进行全量数据迁移

   ```shell
   chameleon drop_replica_schema --config default --debug
   chameleon create_replica_schema --config default --debug
   chameleon add_source --config default --source m* --debug
   chameleon init_replica --config default --source m* --debug
   ```

4. 查看M*待校验的表数据总量

5. 启动M*、openGauss抽取服务及数据校验服务

6. 迁移速度 = 总Size / 校验耗时，其中总Size是M*待校验的所有表Size之和，校验耗时取自校验服务的cost time时间

7. 查看生成的结果文件准确性

## 4.2   性能场景

### 4.2.1  总数据量不变

<center> 表1  总数据量约1GB平均校验速率（sysbench初始表结构）
</center>

| 场景 | 场景描述                                       | 平均校验速度(MB/S) | 校验结果 |
| :--: | :--------------------------------------------- | :----------------: | :------: |
|  1   | 10张表，数据条数50万，数据总量约1076MB         |       63.30        |   准确   |
|  2   | 50张表，每张表数据条数10万，数据总量约1077MB   |       63.37        |   准确   |
|  3   | 100张表，每张表数据条数5万，数据总量约1151MB   |       63.97        |   准确   |
|  4   | 200张表，每张表数据条数2.5万，数据总量约1103MB |       40.85        |   准确   |
|  5   | 250张表，每张表数据条数2万，数据总量约1128MB   |       35.27        |   准确   |
|  6   | 500张表，每张表数据条数1万，数据总量约1257MB   |       22.46        |   准确   |

### 4.2.2  单表总记录不变

<center> 表2  单表数据条数10万平均校验速率（sysbench初始表结构）
</center>

| 场景 | 场景描述                                      | 平均校验速度(MB/S) | 校验结果 |
| ---- | --------------------------------------------- | ------------------ | -------- |
| 1    | 10张表，每张表数据条数10万，数据总量约215MB   | 35.91              | 准确     |
| 2    | 20张表，每张表数据条数10万，数据总量约430MB   | 47.88              | 准确     |
| 3    | 30张表，每张表数据条数10万，数据总量约646MB   | 53.86              | 准确     |
| 4    | 40张表，每张表数据条数10万，数据总量约861MB   | 57.45              | 准确     |
| 5    | 50张表，每张表数据条数10万，数据总量约1077MB  | 71.82              | 准确     |
| 6    | 60张表，每张表数据条数10万，数据总量约1292MB  | 64.64              | 准确     |
| 7    | 70张表，每张表数据条数10万，数据总量约1508MB  | 71.82              | 准确     |
| 8    | 80张表，每张表数据条数10万，数据总量约1723MB  | 68.95              | 准确     |
| 9    | 90张表，每张表数据条数10万，数据总量约1939MB  | 71.82              | 准确     |
| 10   | 100张表，每张表数据条数10万，数据总量约2154MB | 79.80              | 准确     |



### 4.2.3  表数量不变

<center> 表3  10张表平均校验速率（sysbench初始表结构）
</center>

| 场景 | 场景描述                                       | 平均校验速度(MB/S) | 校验结果 |
| ---- | ---------------------------------------------- | ------------------ | -------- |
| 1    | 10张表，每张表数据条数50万，数据总量约1076MB   | 59.79              | 准确     |
| 2    | 10张表，每张表数据条数100万，数据总量约2147MB  | 69.25              | 准确     |
| 3    | 10张表，每张表数据条数150万，数据总量约3217MB  | 78.48              | 准确     |
| 4    | 10张表，每张表数据条数200万，数据总量约4250MB  | 69.68              | 准确     |
| 5    | 10张表，每张表数据条数250万，数据总量约5336MB  | 69.30              | 准确     |
| 6    | 10张表，每张表数据条数300万，数据总量约6203MB  | 61.41              | 准确     |
| 7    | 10张表，每张表数据条数350万，数据总量约7510MB  | 60.52              | 准确     |
| 8    | 10张表，每张表数据条数400万，数据总量约8509MB  | 61.89              | 准确     |
| 9    | 10张表，每张表数据条数450万，数据总量约9389MB  | 60.78              | 准确     |
| 10   | 10张表，每张表数据条数500万，数据总量约10513MB | 58.52              | 准确     |

### 4.2.4  对标chameleon迁移工具数据

| 场景 |                  场景描述                   | 平均校验速度(MB/S) | 校验结果 |
| :--: | :-----------------------------------------: | :----------------: | :------: |
|  1   | 10张表，每张表数据条数1亿，数据总量201598MB |    抽取服务报错    |    /     |

<center>
</center>

### 4.2.3 资料测试

| 测试步骤：                     | 测试结果  |
| ------------------------------ | --------- |
| 1. 使用方法描述<br>2. 示例测试 | 未发现bug |

## 4.3   测试结果

### 4.3.1 测试结果分析

​       本次测试中，基于sysbench的表结构初始模型，gs_datachecker数据全量校验性能不满足150MB/s。

### 4.3.2 测试数据统计

| 版本名称                       | 测试用例数 | 用例执行结果           | 发现问题单数    |
| ------------------------------ | :--------- | :--------------------- | --------------- |
| openGauss 5.1.0 build 68d1772f | 45         | Passed:9<br/>Failed:36 | 3(存在共性问题) |



数据说明：

1. gs_datachecker全量校验满足150M/S测试共计45条用例，执行通过9条，共计发现3个bug
2. 缺陷密度为3(缺陷个数)/0.138k(代码行数)=21.73(个/kloc)

## 4.4   后续测试建议

暂无

# 5     附件

## 5.1 校验速率计算

校验速率 =  源端(MySQL)数据库大小 / 校验时间

源端数据库大小：select concat(round(sum(data_length/1024/1024),2),'MB') as data from information_schema.tables where table_schema='databasename';

校验时间：在校验服务日志check.log日志中打印cost time作为时间统计
