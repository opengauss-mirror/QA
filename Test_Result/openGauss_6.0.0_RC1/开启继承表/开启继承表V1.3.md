版权所有 © 2023  openGauss社区
您对“本文档”的复制、使用、修改及分发受知识共享(Creative Commons)署名—相同方式共享4.0国际公共许可协议(以下简称“CC BY-SA 4.0”)的约束。为了方便用户理解，您可以通过访问https://creativecommons.org/licenses/by-sa/4.0/ 了解CC BY-SA 4.0的概要 (但不是替代)。CC BY-SA 4.0的完整协议内容您可以访问如下网址获取：https://creativecommons.org/licenses/by-sa/4.0/legalcode。

修订记录

| 日期          | 修订   版本 | 修改描述               | 作者 |
| ------------- | ----------- | ---------------------- | ---- |
| 2024年2月7日  | 1.0         | 测试报告初次编写       | 杨健 |
| 2024年2月21日 | 1.1         | 增加测试项             | 杨健 |
| 2024年3月13日 | 1.2         | 验收缺陷后修改测试报告 | 杨健 |
| 2024年3月20日 | 1.3         | 评审后补充测试点       | 杨健 |

关键词： 

继承、表结构、表数据、表约束、多表、并发、表基础操作

摘要：

 对OpenGauss新增需求“开启继承表”进行功能测试

# 1     特性概述

后台启用继承表相关功能，包括：

（1）子表可以完全继承父表结构

（2）子表可以继承多个父表

（3）可以进行次级继承

（4）多个父表的字段相同时会进行融合，不同则会抛出错误

（5）子表可以在继承父表结构的基础上添加字段

（6）可以通过guc参数: sql_inheritance（默认为on）控制父表的操作是否可以访问子表。sql_inheritance为on时父表可以查询包含子表在内的所有数据，否则父表的只能查询/更新自己

（7）子表只能查询自己的数据

（8）使用ONLY的话，父表只能查询自己的数据

（9）子表不使用including all只会继承父表的非空、默认值和检查三种约束

（10）子表使用including all才可以继承唯一、主键、外键约束

（11）临时表可以继承临时表和普通表，普通表不能继承临时表

（12）存在子表的时候是不能删除父表的

（13）用cascade删除父表时，子表也会被删除

（14）可以使用no inherit命令来解除继承关系

（15）继承表功能和B库的多表更新/删除功能冲突，不可以在B库建继承表。

（16）列存不支持继承表，分区表不支持继承表，外表不支持继承表。

（17）表访问权限并不会被自动继承

（18）支持like father语句，它让子表拥有父表的同名字段，但不依赖父表。

# 2     特性测试信息

本节描述被测对象的版本信息和测试的时间及测试轮次，包括依赖的硬件。

| 版本名称 | 测试轮次 | 测试起始时间  | 测试结束时间  |
| -------- | -------- | ------------- | ------------- |
| 5.1.1    | 第一轮   | 2024年1月25日 | 2024年2月5日  |
| 5.1.1    | 第二轮   | 2024年2月6日  | 2024年2月21日 |
| 5.1.1    | 第三轮   | 2024年3月18日 | 2024年3月20日 |

描述特性测试的硬件环境信息

| 环境信息 | 配置信息                        | 备注 |
| -------- | ------------------------------- | ---- |
| CPU      | 8核                             | 无   |
| 操作系统 | Kylin Linux Advanced Server V10 | 无   |
| 内存     | 16G                             | 无   |
| 磁盘     | 128G                            | 无   |

# 3     测试结论概述

## 3.1   测试整体结论

开启继承表功能，共执行97个用例，主要覆盖操作使用继承表的功能测试，累计发现缺陷4个，4个缺陷已解决且验收通过，整体质量良好。

| 测试活动                           | 活动评价                                                     |
| ---------------------------------- | :----------------------------------------------------------- |
| 给普通表添加继承关系               | 测试使用alter table语法给普通表添加继承关系，且添加继承关系后子表父表表现正常，测试通过。 |
| 将继承表取消继承                   | 测试使用alter语法将继承表取消继承关系，且取消继承后父表子表都表现正常，测试通过。 |
| 继承表行数估算测试                 | 测试对继承表进行analyze后，explain可以对行数进行估算，测试通过。 |
| 创建继承表为列存表                 | 测试继承表不支持列存，可以正常抛出异常，测试通过。           |
| 创建继承表为外表                   | 测试继承表不支持外表，可以正常抛出异常，测试通过。           |
| 继承表使用压缩                     | 测试继承表支持使用压缩，且父表子表表现正常，测试通过。       |
| 继承表的约束继承测试               | 测试继承表的约束在继承中表现是否正常，测试通过。             |
| 继承表关于数据的测试               | 测试继承表的数据在在继承中表现是否正常，测试通过。           |
| 继承表删除父表测试                 | 测试对父表进行删除，父表和子表的表现是否正常，测试通过。     |
| 继承表关于索引的测试               | 测试继承表中的索引表现是否正常，测试通过。                   |
| 多表继承测试                       | 测试多表继承中，属性的合并以及继承关系是否正常，测试通过。   |
| 分区表继承测试                     | 测试继承表不支持分区表，可以正常抛出异常，测试通过。         |
| 继承表权限测试                     | 测试继承表权限并不会被自动继承，测试通过。                   |
| 次级继承表测试                     | 测试继承表支持进行次级继承，且表现正常，测试通过。           |
| 继承表段页式存储测试               | 测试继承表支持段页式存储，且表现正常，测试通过。             |
| 继承表相关参数sql_inheritance测试  | 测试继承表在sql_inheritance参数开关状态下表现都符合预期，测试通过。 |
| 继承表的表结构测试                 | 测试继承表的表结构在继承中表现正常，测试通过。               |
| 临时表的继承测试                   | 测试继承表支持临时表，且表现正常，测试通过。                 |
| 继承表更新约束测试                 | 测试继承表中进行更新约束，且表现符合预期，测试通过。         |
| 继承表改动数据的测试               | 测试继承表中增删改查数据的表现是否正常，测试通过。           |
| 继承表改动表结构的测试             | 测试对继承表进行表结构的修改表现正常，测试通过。             |
| 继承表支持ustore                   | 测试继承表支持ustore，且表现正常，测试通过。                 |
| 继承表vacuum测试                   | 测试继承表的vacuum操作表现正常，测试通过。                   |
| 继承表有关视图的测试               | 测试对继承表创建视图，且对此视图的操作表现正常，测试通过。   |
| 继承表有关物化视图的测试           | 测试对继承表创建物化视图，且对物化视图操作表现正常，测试通过。 |
| 继承表并发相关测试                 | 测试对继承表的父表和子表并发操作表现正常，测试通过。         |
| 兼容mysql的b库不支持继承表功能     | 测试兼容mysql的B库不支持继承表功能，且正确抛出异常，测试通过。 |
| 测试继承表在发布订阅中的相关表现   | 测试继承表在发布订阅功能中的表现是否正常，测试通过           |
| 测试通过存储过程进行相关继承表操作 | 测试存储过程中使用继承表的表现是否正常，测试通过             |
| 测试通过函数进行相关继承表操作     | 测试函数中使用继承表的表现是否正常，测试通过                 |
| 测试继承表进行跨用户操作的相关表现 | 测试跨用户操作继承表，对其他用户创建的继承表的数据和结构进行操作，验证表现是否正常，测试通过 |
| 测试继承表指定表空间的相关表现     | 测试指定在相同表空间和不同表空间中的父表和子表是否表现正常，测试通过 |
| 对继承表进行稳定性测试             | 测试对继承表进行24h的tpcc稳定性测试，稳定运行没有问题，测试通过 |
| 测试继承表的逻辑备份恢复           | 测试对继承表进行逻辑备份恢复，表现正常，测试通过             |
| 对继承表功能涉及的资料进行验证     | 测试帮助文档描述内容是否正确清晰，测试通过                   |

## 3.2   约束说明

列存不支持继承表，分区表不支持继承表，外表不支持继承表，B库不支持继承表

## 3.3   遗留问题分析

### 3.3.1 遗留问题影响以及规避措施

无遗留问题。

### 3.3.2 问题统计

|        | 问题总数 | 严重 | 主要 | 次要 | 不重要 |
| ------ | -------- | ---- | ---- | ---- | ------ |
| 数目   | 4        | 3    | 1    | 0    | 0      |
| 百分比 | 100%     | 75%  | 25%  | 0%   | 0%     |

###  3.3.3 问题单汇总

| 序号 | issue号 | 问题级别 | 问题简述                                  | 问题状态 |
| ---- | ------- | -------- | ----------------------------------------- | -------- |
| 1    | I92CD6  | 严重     | 次级继承10w张表递归查询太多次造成堆栈溢出 | 验收通过 |
| 2    | I92CBN  | 严重     | 远程执行对继承表的delete操作导致挂库      | 验收通过 |
| 3    | I92ARP  | 严重     | 并发更新父表和子表数据导致挂库            | 验收通过 |
| 4    | I92AII  | 主要     | 在兼容mysql的b库中可以修改普通表为继承表  | 验收通过 |

# 4     测试执行

## 4.1 测试执行步骤

### 4.1.1 给普通表添加继承关系  

| 测试步骤：                                                   | 测试结果               |
| ------------------------------------------------------------ | ---------------------- |
| 1. 使用yat工具自动化执行测试用例，测试使用alter table语法给普通表添加继承关系，验证表数据、表结构和表约束继承正常，并测试表结构不兼容的异常情况可以正常抛出错误 | 执行4条用例，未发现bug |

### 4.1.2 将继承表取消继承

| 测试步骤：                                                   | 测试结果               |
| ------------------------------------------------------------ | ---------------------- |
| 1. 使用yat工具自动化执行测试用例，测试使用alter语法将继承表取消继承关系后，修改表结构和约束不再级联改变，已存在数据不会改变，父表不能再查到子表数据，删除父表不再级联删除子表；进行异常测试对非继承表解除继承可以正确抛出错误 | 执行5条用例，未发现bug |

### 4.1.3 继承表行数估算测试

| 测试步骤：                                                   | 测试结果               |
| ------------------------------------------------------------ | ---------------------- |
| 1. 手动执行测试用例，测试对继承表进行analyze后，explain可以对行数进行估算 | 执行1条用例，未发现bug |

### 4.1.4 创建继承表为列存表

| 测试步骤：                                                   | 测试结果               |
| ------------------------------------------------------------ | ---------------------- |
| 1. 使用yat工具自动化执行测试用例，测试继承表不支持列存，可以正常抛出异常 | 执行1条用例，未发现bug |

### 4.1.5 创建继承表为外表

| 测试步骤：                                                   | 测试结果               |
| ------------------------------------------------------------ | ---------------------- |
| 1. 使用yat工具自动化执行测试用例，测试继承表不支持外表，可以正常抛出异常 | 执行1条用例，未发现bug |

### 4.1.6 继承表使用压缩 

| 测试步骤：                                                   | 测试结果               |
| ------------------------------------------------------------ | ---------------------- |
| 1. 使用yat工具自动化执行测试用例，测试继承表支持使用压缩，创建继承表时可以使用压缩功能 | 执行1条用例，未发现bug |

### 4.1.7 继承表的约束继承测试

| 测试步骤：                                                   | 测试结果               |
| ------------------------------------------------------------ | ---------------------- |
| 1. 使用yat工具自动化执行测试用例，测试继承表的约束在继承中表现，不指定including all，只继承非空，默认值和检查约束；指定including all，可以额外继承其他约束 | 执行1条用例，未发现bug |

### 4.1.8 继承表关于数据的测试

| 测试步骤：                                                   | 测试结果               |
| ------------------------------------------------------------ | ---------------------- |
| 1. 使用yat工具自动化执行测试用例，测试继承表的数据在在继承中表现，父表可以查看全部数据，子表只可查看自身数据；是否使用only的测试；sql_inheritance为on和off时查看父表数据的表现 | 执行3条用例，未发现bug |

### 4.1.9 继承表删除父表测试

| 测试步骤：                                                   | 测试结果               |
| ------------------------------------------------------------ | ---------------------- |
| 1. 使用yat工具自动化执行测试用例，测试对父表进行删除，父表和子表的表现是否正常，分别测试是否使用cascade关键字 | 执行2条用例，未发现bug |

### 4.1.10 继承表关于索引的测试

| 测试步骤：                                                   | 测试结果               |
| ------------------------------------------------------------ | ---------------------- |
| 1. 使用yat工具自动化执行测试用例，测试继承表中的索引表现，分别测试对父表和子表的索引操作 | 执行2条用例，未发现bug |

### 4.1.11 多表继承测试

| 测试步骤：                                                   | 测试结果               |
| ------------------------------------------------------------ | ---------------------- |
| 1. 使用yat工具自动化执行测试用例，测试支持多表继承，验证子表拥有所有父表的字段，同一个字段名出现在多个父表中会进行融合，子表会继承所有父表的非空约束和检查约束，异常情况：想要融合的字段数据类型不同时会正确抛出错误 | 执行5条用例，未发现bug |

### 4.1.12 分区表继承测试

| 测试步骤：                                                   | 测试结果               |
| ------------------------------------------------------------ | ---------------------- |
| 1. 使用yat工具自动化执行测试用例，测试继承表不支持分区表，分别测试子表和父表为分区表的情况，可以正常抛出异常， | 执行3条用例，未发现bug |

### 4.1.13 继承表权限测试

| 测试步骤：                                                   | 测试结果               |
| ------------------------------------------------------------ | ---------------------- |
| 1. 使用yat工具自动化执行测试用例，测试继承表访问权限并不会被自动继承，没有父表权限，有子表权限，可以访问子表数据，不能访问父表数据，合理报错；没有子表权限，有父表权限，可以访问父表数据，不能访问子表数据，合理报错 | 执行2条用例，未发现bug |

### 4.1.14 次级继承表测试

| 测试步骤：                                                   | 测试结果                          |
| ------------------------------------------------------------ | --------------------------------- |
| 1. 使用yat工具自动化执行测试用例，测试继承表支持进行次级继承，验证表结构继承正常，表约束继承正常，表数据继承正常，验证次级继承大量表后递归查询表现是否正常 | 执行2条用例，发现1个bug，验收通过 |

### 4.1.15 继承表段页式存储测试

| 测试步骤：                                                   | 测试结果               |
| ------------------------------------------------------------ | ---------------------- |
| 1. 使用yat工具自动化执行测试用例，测试继承表支持段页式存储，但不能和like子句连用，验证表结构继承正常，表约束继承正常，表数据继承正常 | 执行1条用例，未发现bug |

### 4.1.16 继承表相关参数sql_inheritance测试

| 测试步骤：                                                   | 测试结果               |
| ------------------------------------------------------------ | ---------------------- |
| 1. 使用yat工具自动化执行测试用例，测试继承表在sql_inheritance参数开关状态下表现都符合预期 | 执行2条用例，未发现bug |

### 4.1.17 继承表的表结构测试

| 测试步骤：                                                   | 测试结果               |
| ------------------------------------------------------------ | ---------------------- |
| 1. 使用yat工具自动化执行测试用例，测试继承表的表结构在继承中表现正常，子表不添加新字段，完全继承父表结构；继承父表结构的基础上添加子表字段；创建子表的独立字段与父表字段名字相同，类型相同，此字段合并；创建子表的独立字段与父表字段名字相同，类型不同，正确抛出错误 | 执行4条用例，未发现bug |

### 4.1.18 临时表的继承测试

| 测试步骤：                                                   | 测试结果               |
| ------------------------------------------------------------ | ---------------------- |
| 1. 使用yat工具自动化执行测试用例，测试继承表支持临时表，且表现正常，临时表可以是普通表的子表；临时表可以继承临时表；临时表不能是普通表的父表，正确抛出错误 | 执行3条用例，未发现bug |

### 4.1.19 继承表更新约束测试

| 测试步骤：                                                   | 测试结果                |
| ------------------------------------------------------------ | ----------------------- |
| 1. 使用yat工具自动化执行测试用例，测试继承表中进行更新约束，分别测试是否使用including all两种情况，验证对约束的增加修改删除表现是否正常 | 执行12条用例，未发现bug |

### 4.1.20 继承表改动数据的测试

| 测试步骤：                                                   | 测试结果                          |
| ------------------------------------------------------------ | --------------------------------- |
| 1. 使用yat工具自动化执行测试用例，测试继承表中增删改查数据的表现是否正常，分别对父表和子表的数据进行增删改查，验证其表现正确 | 执行6条用例，发现1条bug，验收通过 |

### 4.1.21 继承表改动表结构的测试

| 测试步骤：                                                   | 测试结果               |
| ------------------------------------------------------------ | ---------------------- |
| 1. 使用yat工具自动化执行测试用例，测试对继承表进行表结构的修改表现正常，验证在是否使用like子句的两种情况，对父表和子表分别进行表结构修改：增加字段，删除字段，修改字段 | 执行9条用例，未发现bug |

### 4.1.22 继承表支持ustore

| 测试步骤：                                                   | 测试结果               |
| ------------------------------------------------------------ | ---------------------- |
| 1. 使用yat工具自动化执行测试用例，测试继承表支持ustore，创建继承表使用ustore，且操作表现正常 | 执行1条用例，未发现bug |

### 4.1.23 继承表vacuum测试

| 测试步骤：                                                   | 测试结果               |
| ------------------------------------------------------------ | ---------------------- |
| 1. 使用yat工具自动化执行测试用例，测试继承表的vacuum操作表现正常，创建继承表进行vacuum full操作 | 执行1条用例，未发现bug |

### 4.1.24 继承表有关视图的测试 

| 测试步骤：                                                   | 测试结果               |
| ------------------------------------------------------------ | ---------------------- |
| 1. 使用yat工具自动化执行测试用例，分别测试对父表和子表创建视图，且对此视图的操作表现正常 | 执行2条用例，未发现bug |

### 4.1.25 继承表有关物化视图的测试

| 测试步骤：                                                   | 测试结果               |
| ------------------------------------------------------------ | ---------------------- |
| 1. 使用yat工具自动化执行测试用例，分别测试对父表和子表创建物化视图，且对此视图的操作表现正常 | 执行2条用例，未发现bug |

### 4.1.26 继承表并发相关测试

| 测试步骤：                                                   | 测试结果                          |
| ------------------------------------------------------------ | --------------------------------- |
| 1. 手动执行测试用例，测试对继承表的父表和子表进行并发操作，显性开启session对数据进行更新或删除操作不提交，去对其父表或子表进行操作相同数据的操作，在新操作等待时提交原来session操作 | 执行4条用例，发现1条bug，验收通过 |

### 4.1.27 兼容mysql的b库不支持继承表功能

| 测试步骤：                                                   | 测试结果                          |
| ------------------------------------------------------------ | --------------------------------- |
| 1. 使用yat工具自动化执行测试用例，测试兼容mysql的B库不支持继承表功能，且正确抛出异常，创建一个兼容mysql的B库，连接此库的gsql创建继承表应失败，也不能添加继承关系 | 执行2条用例，发现1条bug，验收通过 |

### 4.1.28 测试继承表在发布订阅中的相关表现

| 测试步骤：                                                   | 测试结果               |
| ------------------------------------------------------------ | ---------------------- |
| 1. 手动执行测试用例，创建发布订阅，在发布库和订阅库分别创建继承表和都创建继承表，测试通过父表更新子表表现是否正常 | 执行3条用例，未发现bug |

### 4.1.29 测试通过存储过程进行相关继承表操作

| 测试步骤：                                                   | 测试结果               |
| ------------------------------------------------------------ | ---------------------- |
| 1. 使用yat工具自动化执行测试用例，测试通过存储过程创建继承表，并通过存储过程对数据和结构进行操作，验证父表子表都表现正常，操作能正常执行 | 执行3条用例，未发现bug |

### 4.1.30 测试通过函数进行相关继承表操作

| 测试步骤：                                                   | 测试结果               |
| ------------------------------------------------------------ | ---------------------- |
| 1. 使用yat工具自动化执行测试用例，测试通过函数创建继承表，并通过函数对数据和结构进行操作，验证父表子表都表现正常，操作能正常执行 | 执行3条用例，未发现bug |

### 4.1.31 测试继承表进行跨用户操作的相关表现

| 测试步骤：                                                   | 测试结果               |
| ------------------------------------------------------------ | ---------------------- |
| 1. 使用yat工具自动化执行测试用例，测试跨用户操作继承表，相同用户创建父表和子表和不同用户创建父表和子表，对继承表的数据和结构进行操作，验证父表和子表都表现正常 | 执行4条用例，未发现bug |

### 4.1.32 测试继承表指定表空间的相关表现

| 测试步骤：                                                   | 测试结果               |
| ------------------------------------------------------------ | ---------------------- |
| 1. 使用yat工具自动化执行测试用例，测试创建继承表时指定相同表空间和不同表空间，验证继承表的基本功能表现无问题 | 执行2条用例，未发现bug |

### 4.1.33 对继承表进行稳定性测试

| 测试步骤：                                                   | 测试结果               |
| ------------------------------------------------------------ | ---------------------- |
| 1. 手动执行测试用例，将tpcc测试的建表语句修改为创建继承表，进行24h的稳定性测试，平稳运行未出现问题 | 执行1条用例，未发现bug |

### 4.1.34 测试继承表的逻辑备份恢复

| 测试步骤：                                              | 测试结果               |
| ------------------------------------------------------- | ---------------------- |
| 1. 手动执行测试用例，测试继承表的逻辑备份恢复，表现正常 | 执行2条用例，未发现bug |

### 4.1.35 对资料验证

| 测试步骤：                                        | 测试结果  |
| ------------------------------------------------- | --------- |
| 1. 对文档描述功能和介绍进行检查，验证描述是否正确 | 未发现bug |



## 4.2   测试执行统计数据

*本节内容根据测试用例及实际执行情况进行特性整体测试的统计，可根据第二章的测试轮次分开进行统计说明。*

| 版本名称 | 测试用例数 | 用例执行结果       | 发现问题单数 |
| -------- | ---------- | ------------------ | ------------ |
| 5.1.1    | 99         | 执行成功且符合预期 | 4            |

*数据项说明：*

- 累计发现缺陷4个，4个已解决并验收通过。


- 缺陷密度为4个(缺陷个数)/1kloc(代码行数)=4(个/kloc)

## 4.3   后续测试建议

无

# 5     附件

需求：https://e.gitee.com/opengaussorg/issues/list?issue=I6TP6U

开发自验结果：https://e.gitee.com/opengaussorg/repos/opengauss/openGauss-server/pulls/3325

功能说明：https://e.gitee.com/opengaussorg/repos/opengauss/docs/pulls/6070


