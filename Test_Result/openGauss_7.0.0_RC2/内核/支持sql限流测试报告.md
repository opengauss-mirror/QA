![avatar](../../images/openGauss.png)

版权所有 © 2024  openGauss社区
 您对“本文档”的复制、使用、修改及分发受知识共享(Creative Commons)署名—相同方式共享4.0国际公共许可协议(以下简称“CC BY-SA 4.0”)的约束。为了方便用户理解，您可以通过访问[*https://creativecommons.org/licenses/by-sa/4.0/*](https://creativecommons.org/licenses/by-sa/4.0/) 了解CC BY-SA 4.0的概要 (但不是替代)。CC BY-SA 4.0的完整协议内容您可以访问如下网址获取：[*https://creativecommons.org/licenses/by-sa/4.0/legalcode*](https://creativecommons.org/licenses/by-sa/4.0/legalcode)。

修订记录

| 日期      | 修订版本 | 修改描述    | 作者   |
| --------- | -------- | ----------- | ------ |
| 2025/6/10 | 1.0.0    | 支持sql限流 | 姚雨驰 |

[TOC]

**Keywords 关键词**：sql限流

**Abstract 摘要**：本次测试围绕sql限流特性新增的guc参数、系统表、系统函数进行测试，主要包括支持限流规则的创建、删除、查询、修改，支持限流规则在主备节点生效的功能。本次测试发现问题6个，开发质量良好。

**缩略语清单： **

| 缩略语 | 英文全名 | 中文解释 |
| ------ | -------- | -------- |
|        |          |          |


# 1 概述

本报告是支持sql限流特性测试报告，主要测试版本为openGauss7.0.0-RC2.B008

# 2 测试版本说明

## 2.1 测试版本信息

###   2.1.1 被测版本

| 版本名称       | 软件包名称                                    | 测试起始时间 | 测试结束时间 | 测试人员 |
| -------------- | --------------------------------------------- | ------------ | ------------ | -------- |
| 7.0.0-RC2 B008 | openGauss-All-7.0.0-RC2-CentOS7-x86_64.tar.gz | 2025-5-29    | 2025-6-10    | 1        |

## 2.2 测试环境描述

###  2.2.1 环境硬件信息

| 硬件型号                             | 硬件配置信息                                                 | 备注 |
| ------------------------------------ | ------------------------------------------------------------ | ---- |
| CentOS Linux release 7.9.2009 (Core) | CPU：Intel(R) Xeon(R) Gold 6266C CPU @ 3.00GHz<br />内存：50G<br />硬盘：200G<br />OS：CentOS x86<br /> |      |

# 3 版本概要测试结论、关键风险和规避措施

## 3.1 测试结论总结

sql限流特性完成了功能测试，完成了资料测试、完成了升级测试，需求100%实现，被测特性的测试用例的累计执行覆盖率达到100%，发现问题6个，没有遗留问题，开发质量良好

## 3.2 约束说明

*给出本特性相关的约束说明*

1.用户需要具有sysadmin权限

2.guc参数enable_sql_limit = on

## 3.3 关键风险和规避措施

无

# 4 版本详细测试结论

## 4.1 特性测试结论

###   4.1.1 新需求质量评价

| 特性        | 特性价值评估                                      | 应用说明及关键约束假设依赖                                   | 关键遗留事项如缺陷等 | 测试整体覆盖情况                 | 特性质量评估               | 主要风险 |
| ----------- | ------------------------------------------------- | ------------------------------------------------------------ | -------------------- | -------------------------------- | -------------------------- | -------- |
| 支持sql限流 | 本特性能够限制异常SQL的并发数，让正常业务得到保障 | 1.用户需要具有sysadmin权限</br>2.guc参数enable_sql_limit = on | 无                   | 覆盖功能测试，升级测试，资料测试 | <font color=green>▮</font> | 无       |

## 4.2 产品质量属性目标(DFX)测试结论

###  4.2.1 性能测试结论

无

###  4.2.2 可靠性测试结论

无

###  4.2.3 安全&隐私保护测试结论

无

### 4.2.4 可服务性测试结论

无

### 4.2.5 生命周期管理测试结论

无

### 4.2.6 韧性测试结论

无

###  4.2.7 兼容性测试结论

无

###  4.2.8 升级测试结论

*按照测试策略中制定的升级路径及具体版本号（包括补丁），给出验证结论。（如本测试阶段涉及则填写）*

| 测试步骤                                                     | 升级路径                | 测试结果 |
| ------------------------------------------------------------ | ----------------------- | -------- |
| 1、升级数据库</br>2、设置参数</br>3、验证系统表和系统函数是否存在 | 6.0.0 -> 7.0.0-RC2 B008 | 通过     |
| 1、升级后回滚</br>2、设置参数</br>3、验证系统表和系统函数是否存在 | 6.0.0 -> 7.0.0-RC2 B008 | 通过     |
| 1、升级后提交</br>2、设置参数</br>3、验证系统表和系统函数是否存在 | 6.0.0 -> 7.0.0-RC2 B008 | 通过     |

## 4.3 资料测试结论

| 序号 | 测试章节                                                     | 测试结论     |
| ---- | ------------------------------------------------------------ | ------------ |
| 1    | 文档地图>数据库参考>系统表和系统视图>系统表>GS_SQL_LIMIT     | 整体质量良好 |
| 2    | 文档地图>SQL参考>函数与操作符>系统管理函数>SQL防火墙系统函数 | 整体质量良好 |

# 5 测试对象质量评估

##  5.1 覆盖率分析

本次测试的测试主要覆盖功能测试，升级测试，资料测试，覆盖率实现100%。

##  5.2 缺陷统计和分析

###   5.2.1 缺陷统计

|        | 问题总数 | 严重 | 主要 | 次要 | 不重要 |
| ------ | -------- | ---- | ---- | ---- | ------ |
| 数目   | 6        | 0    | 0    | 6    | 0      |
| 百分比 | 100%     | 0    | 0    | 100% | 0      |

###   5.2.2 缺陷列表

| 问题单号                                                     | 问题描述                                                     | 问题级别 | 当前状态 |
| ------------------------------------------------------------ | ------------------------------------------------------------ | -------- | -------- |
| [7145](https://gitcode.com/opengauss/openGauss-server/issues/7145) | 偶现sql_limit无法创建，实际sql_limit只有6条，报错sql_limit count一直增加到36679 | 次要     | 已验收   |
| [7140](https://gitcode.com/opengauss/openGauss-server/issues/7140) | 创建sql_limit时，设置start_time为当前时间+1分钟，规则在指定时间任然不生效 | 次要     | 已验收   |
| [7139](https://gitcode.com/opengauss/openGauss-server/issues/7139) | unique_sql_id相同重复创建sql_limit部分成功，部分失败         | 次要     | 已验收   |
| [7136](https://gitcode.com/opengauss/openGauss-server/issues/7136) | 创建sql_limit时设置work_node=2，在主机使用gs_select_sql_limit查询规则，查询结果异常is_valid=true | 次要     | 已验收   |
| [7125](https://gitcode.com/opengauss/openGauss-server/issues/7125) | 先创建sql_limit指定不存在的用户，后创建用户，再执行被限流的sql，sql_limit不生效 | 次要     | 已验收   |
| [7123](https://gitcode.com/opengauss/openGauss-server/issues/7123) | 主备集群环境创建sql_limit时，work_node设置为0，主机生效，备机不生效 | 次要     | 已验收   |

# 6 测试过程评估

##  6.1 测试策略回顾

| 编号 | 特性    | 验证策略 | 是否按照测试策略执行 |
| ---- | ------- | -------- | -------------------- |
| 1    | sql限流 | 功能测试 | YES                  |
| 2    | sql限流 | 升级测试 | YES                  |
| 3    | sql限流 | 资料测试 | YES                  |

##  6.2 测试设计评估

| 编号 | 测试点修改说明                      | 修改原因     | 是否影响测试质量 |
| ---- | ----------------------------------- | ------------ | ---------------- |
|      | 对查询系统表的sql进行限流，限流失败 | 开发设计变更 | 否               |
|      | 对事务控制语句进行限流，限流失败    | 开发设计变更 | 否               |

##  6.3 测试执行评估

###  6.3.1 测试执行统计数据

| 版本名称       | 工作量投入(人天) | 测试用例数 | 用例执行数 | 发现缺陷数 | 代码量（KLOC） | 缺陷密度 |
| -------------- | ---------------- | ---------- | ---------- | ---------- | -------------- | -------- |
| 7.0.0-RC2 B008 | 9                | 120        | 120        | 6          | 3.091          | 1.94     |

###  6.3.2 测试用例执行结果统计数据

|        | 计划测试用例数 | 实际测试的用例数 | Passed | Failed | Blocked | Unavailable | 执行率 | 执行通过率 |
| ------ | -------------- | ---------------- | ------ | ------ | ------- | ----------- | ------ | ---------- |
| 第一轮 | 120            | 120              | 111    | 6      | 0       | 3           | 100%   | 92.5%      |

# 7 附件

##  7.1 附件1：遗留问题列表

无

##  7.2 附件2：特性相关PR

代码pr：

[【PR模版】:sql防火墙-openGauss-server-GitCode](https://gitcode.com/opengauss/openGauss-server/pull/7717)

[修改sql防火墙系统函数执行权限-openGauss-server-GitCode](https://gitcode.com/opengauss/openGauss-server/pull/7786)

资料pr：

[增加sql防火墙guc参数-docs-GitCode](https://gitcode.com/opengauss/docs/pull/7727)

[sql防火墙文档-docs-GitCode](https://gitcode.com/opengauss/docs/pull/7606/diffs)

用例归档：

[测试用例-TestPlan](https://devcloud.cn-east-3.huaweicloud.com/cloudtestportal/project/03669bfd256c444bbfda6d7fb8b83bb2/testcase?branch_id=vb2100010cof2bn7)

![image-20250610173220737](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20250610173220737.png)
