![avatar](../../../images/openGauss.png)

版权所有 © 2024  openGauss社区
 您对“本文档”的复制、使用、修改及分发受知识共享(Creative Commons)署名—相同方式共享4.0国际公共许可协议(以下简称“CC BY-SA 4.0”)的约束。为了方便用户理解，您可以通过访问[*https://creativecommons.org/licenses/by-sa/4.0/*](https://creativecommons.org/licenses/by-sa/4.0/) 了解CC BY-SA 4.0的概要 (但不是替代)。CC BY-SA 4.0的完整协议内容您可以访问如下网址获取：[*https://creativecommons.org/licenses/by-sa/4.0/legalcode*](https://creativecommons.org/licenses/by-sa/4.0/legalcode)。

修订记录

| 日期      | 修订版本 | 修改描述         | 作者  |
| --------- | -------- | ---------------- | ----- |
| 2025.5.23 | v1.0     | 测试报告初稿     | lixin |
| 2025.5.29 | v2.0     | 补充性能测试结果 | lixin |

**Keywords 关键词**：ubtree、pcr

**Abstract 摘要**：主要测试ubtree索引，包含功能测试、可靠性测试及性能测试，整体质量良好。

**缩略语清单：**

| 缩略语 | 英文全名 | 中文解释 |
| ------ | -------- | -------- |
| 无     |          |          |


# 1 概述

本报告主要测试ubtree索引相关基础功能，索引类型支持pcr，校验ubtree空间回收，测试ubtree恢复，事务隔离级别下多会话查询，索引空间优化及其他特性耦合测试等，包含功能测试、可靠性测试及性能测试，输出测试用例123个，执行测试共2轮，发现issue共8个，均已修复并回归通过，无遗留问题，整体质量良好。

# 2 测试版本说明

## 2.1 测试版本信息

###   2.1.1 被测版本

| 版本名称                | 软件包名称 | 测试起始时间 | 测试结束时间 | 测试人员 |
| ----------------------- | ---------- | ------------ | ------------ | -------- |
| openGauss 7.0.0-RC2 B005/B006 | openGauss  | 2025-5-06   | 2025-5-23   | lixin    |
| openGauss 7.0.0-RC2 B007 | openGauss | 2025-5-28 | 2025-5-29 | lixin |

###  2.1.2 配套测试的版本

| 版本名称   | 配套版本 | 版本说明 |
| ---------- | -------- | -------- |
| RackServer | 1.0.0    |          |

## 2.2 测试环境描述

###  2.2.1 环境硬件信息

| 环境信息 | 硬件配置信息                                                 | 备注 |
| -------- | ------------------------------------------------------------ | ---- |
| 物理机   | Kunpeng 920 320核<br/>内存：2TB<br/>硬盘：5.8TB<br/>OS：EulerOS release 2.0 (SP3) |      |

# 3 版本概要测试结论、关键风险和规避措施

本次特性主要测试ubtree索引历史版本基于UNDO管理，ubtree页面支持PCR，支持全局CR Pool，根据不同情况选择采用RCR或PCR实现一致性构建，及索引空间优化是否提升20%，主要包含功能测试、可靠性测试及性能测试，输出测试用例123个，执行测试共2轮，发现issue共8个，均已修复并回归通过，无遗留问题，整体质量良好。

# 4 版本详细测试结论

## 4.1 特性测试结论

###   4.1.1 新需求质量评价

| 特性           | 特性价值评估                                                 | 应用说明及关键约束假设依赖 | 关键遗留事项如缺陷等 | 测试整体覆盖情况 | 特性质量评估               | 主要风险 |
| -------------- | ------------------------------------------------------------ | -------------------------- | -------------------- | ---------------- | -------------------------- | -------- |
| Ubtree索引增强 | 解决索引历史版本、数据混合存储，索引每行保存事务信息导致索引存储空间膨胀问题，支撑金融场景空间利用率提升；解决开启闪回，索引空间膨胀，导致数据库性能降级不可用问题，通过堆表页级一致性读支撑互联网场景快速闪回。 | 不支持lite                 | 无                   | 100%             | <font color=green>▮</font> | 无       |

*特性质量评估说明*：

<font color=red><font color=red>●</font></font>： *表示特性不稳定，风险高*

<font color=yellow><font color=yellow>▲</font></font>： *表示特性基本可用，遗留少量问题*

<font color=green>▮</font>： *表示特性质量良好*

## 4.2 产品质量属性目标(DFX)测试结论

###  4.2.1 性能测试结论

该特性对性能要求为：索引空间优化20%（加速比1.2）。测试结果如下，汇总加速比1.2以上，性能达标。

| 测试步骤                                                     | 测试结果           |
| ------------------------------------------------------------ | ------------------ |
| 1.ustore表，ubtree索引分别指定pcr和rcr，执行tpcc，单机1000仓696并发，主备345并发，执行过程中\di+查看索引占用空间<br />2.汇总结果，rcr类型索引占用空间大小 / pcr类型索引占用空间大小 | 1.成功<br />2.性能达标，加速比为1.2以上 |

各query详细数据如下:

| 环境 | 索引名               | rcr类型索引占用空间大小（MB） | pcr类型索引占用空间大小（MB） | 加速比（RCR/PCR） |
| ---- | -------------------- | ----------------------------- | ----------------------------- | ----------------- |
| 单机 | bmsql_customer_idx   | 924                           | 1166                          | 1.26              |
|      | bmsql_district_idx   | 0.28125                       | 0.3671875                     | 1.31              |
|      | bmsql_item_idx       | 2.25                          | 3.0703125                     | 1.36              |
|      | bmsql_new_order_idx  | 469                           | 585                           | 1.25              |
|      | bmsql_oorder_idx     | 1246                          | 1588                          | 1.27              |
|      | bmsql_order_line_idx | 16384                         | 19456                         | 1.19              |
|      | bmsql_stock_idx      | 3075                          | 3881                          | 1.26              |
|      | bmsql_warehouse_idx  | 0.0859375                     | 0.09375                       | 1.09              |
| 汇总 |                      | 22100.61719                   | 26679.53125                   | 1.21              |
| 主备 | bmsql_customer_idx   | 924924                        | 11661166                      | 1.26              |
|      | bmsql_district_idx   | 0.281250.28125                | 0.36718750.3671875            | 1.31              |
|      | bmsql_item_idx       | 2.252.25                      | 3.07031253.0703125            | 1.36              |
|      | bmsql_new_order_idx  | 279460                        | 361591                        | 1.29              |
|      | bmsql_oorder_idx     | 9971237                       | 12441605                      | 1.25              |
|      | bmsql_order_line_idx | 947412288                     | 1228815360                    | 1.30              |
|      | bmsql_stock_idx      | 21962196                      | 30163016                      | 1.37              |
|      | bmsql_warehouse_idx  | 0.08593750.0859375            | 0.093750.09375                | 1.09              |
| 汇总 |                      | 13872.61719                   | 18078.53125                   | 1.30              |


###  4.2.3 安全&隐私保护测试结论

无

### 4.2.4 可服务性测试结论

无

### 4.2.5 生命周期管理测试结论

无

### 4.2.6 可靠性测试结论

主要测试事务未提交时主机故障等，数据库重启后，数据是否能恢复到事务开始之前等场景。

###  4.2.7 兼容性测试结论

无

###  4.2.8 升级测试结论

从无该特性版本升级至该特性所在版本，升级成功；升级后数据库，支持ubtree指定pcr，测试通过。

## 4.3 资料测试结论

| 序号 | 测试章节                                                     | 测试结论 |
| ---- | ------------------------------------------------------------ | -------- |
| 1    | [CREATE INDEX](https://docs.opengauss.org/zh/docs/latest/docs/SQLReference/CREATE-INDEX.html) | 测试通过 |
| 2    | [其它选项](https://docs.opengauss.org/zh/docs/latest/docs/DatabaseReference/%E5%85%B6%E5%AE%83%E9%80%89%E9%A1%B9.html) | 测试通过 |

# 5 测试对象质量评估

##  5.1 覆盖率分析

已覆盖测试根据场景选择使用RCR或PCR, 校验enable_default_pcr_index参数设置生效，ubtree相关基础功能测试（包括ubtree索引创建、删除、插入、更新、查询、alter/reindex ubtree、事务中回滚/提交，及已有ubtree用例249个覆盖rcr/pcr执行），校验ubtree空间回收、恢复，事务隔离级别下多会话查询等功能场景测试，覆盖事务未提交时故障恢复等可靠性测试，及索引空间优化提升测试。

##  5.2 缺陷统计和分析

###   5.2.1 缺陷统计

|        | 问题总数 | 严重 | 主要 | 次要  | 不重要 |
| ------ | -------- | ---- | ---- | ----- | ------ |
| 数目   | 8        | 0    | 2    | 3     | 3      |
| 百分比 | 100%     | 0%   | 25%  | 37.5% | 37.5%  |

###   5.2.2 缺陷列表

| 问题单号                                                     | 问题描述                                                     | 问题级别 | 当前状态 |
| ------------------------------------------------------------ | ------------------------------------------------------------ | -------- | -------- |
| [7067](https://gitcode.com/opengauss/openGauss-server/issues/7067) | 【测试类型：SQL功能】【测试版本：7.0.0-RC2】使用ustore表并创建ubtree索引（PCR），准备数据过程中数据库宕机 | 主要     | 已验收   |
| [6887](https://gitcode.com/opengauss/docs/issues/6887)       | 【测试类型：资料】【测试版本：7.0.0-RC2】ubtree索引不支持修改index_type，社区文档应有明确约束说明 | 不重要   | 已验收   |
| [7019](https://gitcode.com/opengauss/openGauss-server/issues/7019) | 【测试类型：SQL功能】【测试版本：7.0.0-RC2】轻量版不支持pcr所有，代码及资料需统一修改 | 次要     | 已验收   |
| [6948](https://gitcode.com/opengauss/openGauss-server/issues/6948) | 【测试类型：SQL功能】【测试版本：7.0.0】普通表创建索引指定PCR，不应创建成功 | 次要     | 已验收   |
| [6879](https://gitcode.com/opengauss/docs/issues/6879)       | 【测试类型：资料】【测试版本：7.0.0-RC2】社区无ubtree索引增强需求相关文档 | 不重要   | 已验收   |
| [6985](https://gitcode.com/opengauss/openGauss-server/issues/6985) | 【测试类型：SQL功能】【测试版本：7.0.0-RC2】pcr类型索引，通过alter index set/reset修改index_type后，查询报错 | 次要     | 已验收   |
| [6955](https://gitcode.com/opengauss/openGauss-server/issues/6955) | 【测试类型：SQL功能】【测试版本：7.0.0】主备环境，建表及索引，设置enable_default_pcr_index失败，备机core | 主要     | 已验收   |
| [6963](https://gitcode.com/opengauss/openGauss-server/issues/6963) | 【测试类型：SQL功能】【测试版本：7.0.0】创建索引指定pcr，表类型及索引类型显示顺序，期待与rcr保持一致 | 不重要   | 已取消   |

# 6 测试过程评估

##  6.1 测试策略回顾

| 编号 | 特性           | 验证策略                                                     | 是否按照测试策略执行 |
| ---- | -------------- | ------------------------------------------------------------ | -------------------- |
| 1    | ubtree索引增强 | 测试根据场景选择使用RCR或PCR, 校验enable_default_pcr_index参数设置生效，ubtree相关基础功能测试（包括ubtree索引创建、删除、插入、更新、查询、alter/reindex ubtree、事务中回滚/提交，及已有ubtree用例249个覆盖rcr/pcr执行），校验ubtree空间回收、恢复，事务隔离级别下多会话查询等功能场景测试，覆盖事务未提交时故障恢复等可靠性测试，及索引空间优化提升测试 | YES                  |

##  6.2 测试设计评估

已评审并归档Testplan，归档地址详见附件

##  6.3 测试执行评估

###  6.3.1 测试执行统计数据

| 版本名称                      | 工作量投入(人天) | 测试用例数 | 用例执行数 | 发现缺陷数 | 代码量 | 缺陷密度 |
| ----------------------------- | ---------------- | ---------- | ---------- | ---------- | ------ | -------- |
| openGauss 7.0.0-RC2 B005/B006 | 12               | 123        | 119        | 4          | 18.106 | 0.22     |
| openGauss 7.0.0-RC2 B007      | 2                | 7          | 7          | 1          | 18.106 | 0.06     |

本次测试共发现8个issue，其中2个资料单，1个非问题取消，均已修复并回归通过，缺陷密度为5/18.106k=0.28，整体质量良好。

###  6.3.2 测试用例执行结果统计数据

| 总测试用例数 | 实际测试的用例数 | Passed | Failed | Blocked | Unavailable | 执行率 | 执行通过率 |
| ------------ | ---------------- | ------ | ------ | ------- | ----------- | ------ | ---------- |
| 123          | 119              | 114    | 3      | 0       | 2           | 100%   | 96%        |
| 7            | 7                | 7      | 0      | 0       | 0           | 100%   | 100%       |

本次测试共输出测试用例123个，执行测试共2轮，发现8个issue，其中2个资料单，1个非问题取消，均已修复并回归通过，无遗留问题，整体质量良好。

# 7 附件

##  7.1 附件1：遗留问题列表

无

##  7.2 附件2：特性相关PR

特性代码pr：

https://gitcode.com/opengauss/openGauss-server/pull/7442

https://gitcode.com/opengauss/openGauss-server/pull/7580

资料pr：

https://gitcode.com/opengauss/docs/pull/7647

测试设计：https://devcloud.cn-east-3.huaweicloud.com/testmind/project/03669bfd256c444bbfda6d7fb8b83bb2/testmind/mindmap?mindId=00cd33a92c6049f1928f170c665eca42&hideDevcloudHead=true

测试用例：testplan _ openGauss7.0.0 RC2_ 内核 _ Ubtree索引增强

https://devcloud.cn-east-3.huaweicloud.com/cloudtestportal/project/03669bfd256c444bbfda6d7fb8b83bb2/testcase?branch_id=vb2100010cof2bn7



