![avatar](../../../images/openGauss.png)

版权所有 © 2025 openGauss社区
 您对“本文档”的复制、使用、修改及分发受知识共享(Creative Commons)署名—相同方式共享4.0国际公共许可协议(以下简称“CC BY-SA 4.0”)的约束。为了方便用户理解，您可以通过访问https://creativecommons.org/licenses/by-sa/4.0/ 了解CC BY-SA 4.0的概要 (但不是替代)。CC BY-SA 4.0的完整协议内容您可以访问如下网址获取：https://creativecommons.org/licenses/by-sa/4.0/legalcode。

修订记录

| 日期      | 修订版本 | 修改描述                                                 | 作者    |
| --------- | -------- | -------------------------------------------------------- | ------- |
| 2025.7.28 | 1.0      | HTAP行列融合列存数据内存共享性能提升需求测试报告初稿完成 | liutong |

[TOC]

关键词：TPC-H、共享内存、HTAP、性能

摘要：

本文对openGauss 7.0.0-RC2版本HTAP行列融合列存数据内存共享性能提升需求测试情况进行详细说明，并给出最终测试结论。

缩略语清单：

| 缩略语 | 英文全名 | 中文解释 |
| ------ | -------- | -------- |
|        |          |          |

# 1     概述

本特性通过共享内存的方式运行资源池化数据库，执行HTAP行列转换，并在灵衢环境2节点场景下进行1T数据量的TPC-H测试。需求要求全共享内存场景对比全本地内存场景整体性能提升10%，即全本地内存场景执行时间除以全共享内存场景执行时间＞1.1，实际测试的性能提升结果为19.83%，可以满足用户需求。

# 2     特性测试信息

## 2.1 测试版本信息

###   2.1.1 被测版本

本节描述被测对象的版本信息和测试的时间及测试轮次，包括依赖的硬件。

| 版本名称                 | 测试起始时间 | 测试结束时间 |
| ------------------------ | ------------ | ------------ |
| openGauss 7.0.0-RC2 B015 | 2025-7-10    | 2025-7-16    |
| openGauss 7.0.0-RC2 B016 | 2025-7-17    | 2025-7-23    |
| openGauss 7.0.0-RC2 B017 | 2025-7-24    | 2025-7-28    |

## 2.2 测试环境描述

###  2.2.1 环境硬件信息

硬件环境信息：

| 硬件型号      | 硬件配置信息                                                 | 备注 |
| ------------- | ------------------------------------------------------------ | ---- |
| ARM+openEuler | CPU：Kunpeng-920 7280Z 320核<br />内存：2T<br />硬盘：NVME 7T<br />OS：EulerOS 2.0 (SP13)<br />文件系统：ext4<br />网卡：RDMA NetWork Controller (rev 30) |      |

### 2.2.2 虚拟化平台

不涉及

### 2.2.3 软件版本

| 软件      | 版本       | 版本说明                              |
| :-------- | :--------- | :------------------------------------ |
| EulerOS   | 2.0 (SP13) | /                                     |
| openGauss | 7.0.0-RC2  | openGauss 7.0.0-RC2 24.03 aarch64版本 |

# 3     测试结论概述

## 3.1   测试整体结论

需求共计执行32个用例，主要覆盖了共享内存下资源池化数据执行HTAP的基础功能测试、故障测试、可靠性测试、升级测试和性能测试场景，共发现1个问题单，整体质量良好。

| 测试活动                                                     | 活动评价                                                     |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| 参数配置测试                                                 | 可以使用gs_guc set、alter system set和修改postgresql.conf三种方式对参数max_imcs_cache、ss_max_imcs_cache、ss_htap_cluster_map、lmemfabric_client_path、spqplugin.enable_spq、spqplugin.cluster_map、enable_imcsscan进行设置。参数有明确的取值范围，值设置错误时数据库启动失败并报错，设置正确则参数正常生效，数据库可以正常启动，对应的功能可以正常使用，符合预期。 |
| 内存视图新增字段测试                                         | 内存字段新增ss_imstore_max_shared_memory和ss_imcstored_used_shared_memory，通过select * from gs_total_memory_detail;可以看到新增字段及字段对应的值，且字段对应的值基本符合实际测试过程中的情况。但是有时候可能统计有问题，字段对应的值出现负数，已提单。 |
| 全本地内存场景下HTAP行列转换功能测试                         | 在本地内存下对HTAP行列转换进行基础功能测试，包括全表转换和部分列转换，行列转换前后数据是否一致、行列转换后执行基础增删改查语句后结果是否正确、不同schema同名表的全表转换数据是否正常、行列转换后查看视图数据是否正确、对行列转换后的数据执行函数或存储过程后结果是否正确等测试，结果均符合预期。 |
| 全共享内存场景下HTAP行列转换功能测试                         | 在共享内存下对HTAP行列转换进行基础功能测试，包括全表转换和部分列转换，行列转换前后数据是否一致、行列转换后执行基础增删改查语句后结果是否正确、不同schema同名表的全表转换数据是否正常、行列转换后查看视图数据是否正确、对行列转换后的数据执行函数或存储过程后结果是否正确等测试，结果均符合预期。 |
| 多机并行（SPQ）列缓存查询功能测试                            | 执行全表转换和部分列转换等场景，比较执行前后数据是否一致，对查询语句进行explain，发现执行列转换的查询语句的explain结果中确实出现了SPQCStore Scan，说明有调用到列扫相关计划。 |
| 可靠性测试                                                   | 需要转换的数据量超过共享内存时正常报错，重启环境后可以执行成功。 |
| 升级测试                                                     | 升级之后新增参数可以正常使用，适配新增的内存视图字段，其余功能正常。 |
| HTAP行列融合资源池化场景下全共享内存场景对比全本地内存场景整体性能提升测试 | 本特性通过共享内存的方式运行资源池化数据库，执行HTAP行列转换，并在灵衢环境2节点场景下进行1T数据量的TPC-H测试。需求要求全共享内存场景对比全本地内存场景整体性能提升10%，即全本地内存场景执行时间除以全共享内存场景执行时间＞1.1，实际测试的性能提升结果为19.83%，可以满足用户需求。 |

### 

## 3.2   约束说明

（1）本报告中的各场景测试结果中的处理时间，指的是openGauss的处理时间，不包含其他第三方业务的处理时间；

（2）本次性能测试是在实验室网络环境下，搭建测试环境并进行的性能测试，网络条件较稳定，不考虑现网与实验室的网络条件差异；

（3）本报告中，使用TPC-H测试标准进行测试，代表的仅是已知业务模型，没有特殊业务场景，不能代表在现网复杂场景下的实际处理能力；

（4）本次测试是在固定的网络、物料、软件版本等配套的前提下进行的，如果实际环境与本次测试存在不同，请自行评估性能差异，本次测试环境具体情况，请参考第二章节。

## 3.3 关键风险和规避措施

无

# 4 版本详细测试结论

## 4.1 特性测试结论

###   4.1.1 新需求质量评价

| 特性                                                        | 特性价值评估                                                 | 应用说明及关键约束假设依赖 | 关键遗留事项如缺陷等 | 测试整体覆盖情况                                             | 特性质量评估                | 主要风险 |
| ----------------------------------------------------------- | ------------------------------------------------------------ | -------------------------- | -------------------- | ------------------------------------------------------------ | --------------------------- | -------- |
| openGauss 7.0.0-RC2版本HTAP行列融合列存数据内存共享性能提升 | 该特性主要对HTAP行列融合场景下的性能通过共享内存的方式进行优化，全共享内存场景对比全本地内存场景整体性能提升近20%，用户可以明显感受到性能提升。 | 见3.2                      | 无                   | 覆盖了共享内存下资源池化数据执行HTAP的基础功能测试、故障测试、可靠性测试、升级测试和性能测试场景 | <font color=yellow>▲</font> | 无       |

*特性质量评估说明*：

<font color=red><font color=red>●</font></font>： *表示特性不稳定，风险高*

<font color=yellow><font color=yellow>▲</font></font>： *表示特性基本可用，遗留少量问题*

<font color=green>▮</font>： *表示特性质量良好*

## 4.2 产品质量属性目标(DFX)测试结论

###  4.2.1 性能测试结论

本特性通过共享内存的方式运行资源池化数据库，在灵衢环境2节点场景下进行1T数据量的TPC-H测试。需求要求全共享内存场景对比全本地内存场景整体性能提升10%，即全本地内存场景整体执行时间除以全共享内存场景整体执行时间＞1.1，实际测试的性能提升结果为19.83%，可以满足用户需求。

TPC-H测试结果：

|      | 全本地内存耗时平均值（单位：s） | 全共享内存耗时平均值（单位：s） | 性能提升比例 |
| ---- | ------------------------------- | ------------------------------- | ------------ |
| Q1   | 140.921                         | 141.5685                        | -0.46%       |
| Q2   | 34.8015                         | 10.8775                         | 219.94%      |
| Q3   | 62.6475                         | 53.966                          | 16.09%       |
| Q4   | 132.339                         | 121.4865                        | 8.93%        |
| Q5   | 110.454                         | 96.092                          | 14.95%       |
| Q6   | 6.8565                          | 7.7165                          | -11.14%      |
| Q7   | 54.3245                         | 29.9105                         | 81.62%       |
| Q8   | 26.402                          | 25.4345                         | 3.80%        |
| Q9   | 293.7645                        | 246.6015                        | 19.13%       |
| Q10  | 131.527                         | 38.3135                         | 243.29%      |
| Q11  | 9.6895                          | 6.115                           | 58.45%       |
| Q12  | 28.758                          | 25.7445                         | 11.71%       |
| Q13  | 20.7985                         | 16.8465                         | 23.46%       |
| Q14  | 7.8365                          | 7.8185                          | 0.23%        |
| Q15  | 13.2675                         | 13.391                          | -0.92%       |
| Q16  | 35.9215                         | 48.192                          | -25.46%      |
| Q17  | 163.124                         | 291.9965                        | -44.13%      |
| Q18  | 263.908                         | 215.146                         | 22.66%       |
| Q19  | 26.7205                         | 27.614                          | -3.24%       |
| Q20  | 55.5365                         | 34.4185                         | 61.36%       |
| Q21  | 417.5955                        | 236.0475                        | 76.91%       |
| Q22  | 45.3345                         | 42.6675                         | 6.25%        |
| 总计 | 2082.528                        | 1737.9645                       | 19.83%       |

###  4.2.2 可靠性测试结论

本特性对实际行列转换数据量大于共享内存的场景进行了可靠性测试，结果符合期望。

| 测试活动                                                   | 活动评价                                                     |
| ---------------------------------------------------------- | ------------------------------------------------------------ |
| 实际行列转换数据量大于共享内存                             | 正常报错out of memory，重启环境后调大共享内存再执行成功。    |
| 使用共享内存转换成功的场景下，通过大量修改导致共享内存耗尽 | 此时增量数据会存在主节点中，无法写入共享内存，内存膨胀到达瓶颈后内部日志报错共享内存不足，查询表时也报错共享内存不足 |

###  4.2.3 安全&隐私保护测试结论

不涉及

### 4.2.4 可服务性测试结论

不涉及

### 4.2.5 生命周期管理测试结论

不涉及

### 4.2.6 韧性测试结论

不涉及

###  4.2.7 兼容性测试结论

不涉及

###  4.2.8 升级测试结论

本特性对openGauss数据库执行了升级测试，结果符合期望。

| 测试活动                     | 活动评价                                                     |
| ---------------------------- | ------------------------------------------------------------ |
| 7.0.0-RC1升级到7.0.0-RC2版本 | 升级之后新增参数可以正常使用，适配新增的内存视图字段，其余功能正常，结果符合期望。 |

## 4.3 资料测试结论

| 序号 | 测试章节                                                     | 测试结论     |
| ---- | ------------------------------------------------------------ | ------------ |
| 1    | https://docs.opengauss.org/zh/docs/latest/docs/AboutopenGauss/%E8%A1%8C%E5%88%97%E8%9E%8D%E5%90%88.html | 整体质量良好 |

# 5 测试对象质量评估

##  5.1 覆盖率分析

本次测试主要覆盖了参数配置测试、本地内存和共享内存下资源池化数据执行HTAP的基础功能测试、共享内存和本地内存场景的性能测试、共享内存溢出的故障测试、资料测试等模块。

##  5.2 缺陷统计和分析

###   5.2.1 缺陷统计

|        | 问题总数 | 严重 | 主要 | 次要 | 不重要 |
| ------ | -------- | ---- | ---- | ---- | ------ |
| 数目   | 1        | 0    | 0    | 1    | 0      |
| 百分比 | 100%     | 0%   | 0%   | 100% | 0%     |

###   5.2.2 缺陷列表

| 序号 | issue号                                                    | 问题级别 | 问题简述                                                     | 问题状态 |
| ---- | ---------------------------------------------------------- | -------- | ------------------------------------------------------------ | -------- |
| 1    | https://gitcode.com/opengauss/openGauss-server/issues/7310 | 次要     | 【测试类型：工具功能】【测试版本：7.0.0-RC2】HTAP共享内存统计存在问题 | 待办的   |

# 6 测试过程评估

##  6.1 测试策略回顾

| 编号 | 特性         | 验证策略                                                     | 是否按照测试策略执行 |
| ---- | ------------ | ------------------------------------------------------------ | -------------------- |
| 1    | 参数配置测试 | 通过几种不同的修改方式对涉及到的相关参数进行修改，验证修改是否成功，参数值设置错误时数据库启动失败并报错，设置正确则参数正常生效，数据库可以正常启动，对应的功能可以正常使用，符合预期。 | YES                  |
| 2    | 功能测试     | 对本地内存和共享内存下资源池化数据执行HTAP的基础功能进行了测试，各种类型和场景的行列转换数据基本前后一致，且对行列转换的数据进行操作时，显示结果正常。 | YES                  |
| 3    | 性能测试     | 对参数添加前后以及参数调优之后的场景进行tpch性能测试，验证参数的添加与修改对性能的提升真实有效。 | YES                  |
| 4    | 故障测试     | 资源池化数据执行HTAP时故意资源耗尽，报错符合期望。           | YES                  |
| 5    | 升级测试     | 升级之后新增参数可以正常使用，适配新增的内存视图字段，其余功能正常，结果符合期望。 | YES                  |
| 6    | 资料测试     | 整体质量良好，用户可以通过资料使用HTAP功能。                 | YES                  |

##  6.2 测试设计评估

| 编号 | 测试点修改说明 | 修改原因 | 是否影响测试质量 |
| ---- | -------------- | -------- | ---------------- |
| na   |                |          |                  |

##  6.3 测试执行评估

###  6.3.1 测试执行统计数据

| 版本名称                 | 工作量投入(人天) | 测试用例数 | 用例执行数 | 发现缺陷数 | 代码量（KLOC） | 缺陷密度 |
| ------------------------ | ---------------- | ---------- | ---------- | ---------- | -------------- | -------- |
| openGauss 7.0.0-RC2 B015 | 4                | 32         | 20         | 1          | 5.241          | 0.1908   |
| openGauss 7.0.0-RC2 B016 | 4                | 32         | 31         | 1          | 5.241          | 0.1908   |
| openGauss 7.0.0-RC2 B017 | 3                | 32         | 32         | 1          | 5.241          | 0.1908   |

备注：

HTAP行列融合列存数据内存共享性能提升需求测试需求缺陷密度：1/5.241k=0.1908(个/kloc)，整体质量良好。

###  6.3.2 测试用例执行结果统计数据

|        | 计划测试用例数 | 实际测试的用例数 | Passed | Failed | Blocked | Unavailable | 执行率 | 执行通过率 |
| ------ | -------------- | ---------------- | ------ | ------ | ------- | ----------- | ------ | ---------- |
| 第一轮 | 32             | 20               | 19     | 1      | 0       | 0           | 62.5%  | 59.38%     |
| 第二轮 | 32             | 31               | 30     | 1      | 0       | 0           | 96.88% | 93.75%     |
| 第三轮 | 32             | 32               | 31     | 1      | 0       | 0           | 100%   | 96.88%     |

# 7 附件

##  7.1 附件1：遗留问题列表

| 序号 | issue号                                                    | 问题级别 | 问题简述                                                     | 问题状态 |
| ---- | ---------------------------------------------------------- | -------- | ------------------------------------------------------------ | -------- |
| 1    | https://gitcode.com/opengauss/openGauss-server/issues/7310 | 次要     | 【测试类型：工具功能】【测试版本：7.0.0-RC2】HTAP共享内存统计存在问题 | 待办的   |

##  7.2 附件2：特性相关PR

需求链接：

https://gitcode.com/opengauss/org-issue/issues/22

代码合入链接：

https://gitcode.com/opengauss/openGauss-server/pull/8074

https://gitcode.com/opengauss/openGauss-server/pull/8014

https://gitcode.com/opengauss/Plugin/pull/2153

https://gitcode.com/opengauss/openGauss-server/pull/7911

https://gitcode.com/opengauss/DMS/pull/699

测试设计：

https://devcloud.cn-east-3.huaweicloud.com/testmind/project/03669bfd256c444bbfda6d7fb8b83bb2/testmind/mindmap?mindId=15c358cb1db049b68a1ca0e623002b7b&hideDevcloudHead=true

测试用例：

https://devcloud.cn-east-3.huaweicloud.com/cloudtestportal/project/03669bfd256c444bbfda6d7fb8b83bb2/testcase?branch_id=vb2100010cof2bn7

资料:

https://docs.opengauss.org/zh/docs/latest/docs/AboutopenGauss/%E8%A1%8C%E5%88%97%E8%9E%8D%E5%90%88.html





 

 
