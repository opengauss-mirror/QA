![avatar](../../images/openGauss.png)

版权所有 © 2024  openGauss社区
 您对“本文档”的复制、使用、修改及分发受知识共享(Creative Commons)署名—相同方式共享4.0国际公共许可协议(以下简称“CC BY-SA 4.0”)的约束。为了方便用户理解，您可以通过访问[*https://creativecommons.org/licenses/by-sa/4.0/*](https://creativecommons.org/licenses/by-sa/4.0/) 了解CC BY-SA 4.0的概要 (但不是替代)。CC BY-SA 4.0的完整协议内容您可以访问如下网址获取：[*https://creativecommons.org/licenses/by-sa/4.0/legalcode*](https://creativecommons.org/licenses/by-sa/4.0/legalcode)。

修订记录

| 日期      | 修订版本 | 修改描述         | 作者   |
| --------- | -------- | ---------------- | ------ |
| 2025.7.27 | 1.0      | 特性报告初稿完成 | 王恬静 |

[TOC]

**Keywords 关键词**：ivfflat、npu

**Abstract 摘要**：本报告主要为对npu加速ivfflat-npu的构建与查询基础功能以及性能的测试，包括功能测试、性能测试、可靠性测试和资料测试，整体质量良好。

**缩略语清单： **

| 缩略语 | 英文全名 | 中文解释 |
| ------ | -------- | -------- |
| N/A    |          |          |


# 1 概述

本报告主要为对npu加速ivfflat-npu的构建与查询基础功能以及性能的测试，包括功能测试、性能测试、可靠性测试和资料测试，整体质量良好。

# 2 测试版本说明

## 2.1 测试版本信息

###   2.1.1 被测版本

| 版本名称                | 软件包名称                                  | 测试起始时间 | 测试结束时间 | 测试人员 |
| ----------------------- | ------------------------------------------- | ------------ | ------------ | -------- |
| openGauss7.0.0-RC2.B012 | openGauss-Lite-Docker-7.0.0-RC2-aarch64.tar | 2025.6.25    | 2025.7.18    | 王恬静   |

## 2.2 测试环境描述

###  2.2.1 环境硬件信息

| 环境信息 | 硬件配置信息                                                 | 备注 |
| -------- | ------------------------------------------------------------ | ---- |
| 虚拟机   | CPU：鲲鹏920B<br />NPU:  昇腾910B4 <br />内存：2T<br />硬盘：2T<br />OS：CentOS arm |      |

# 3 版本概要测试结论、关键风险和规避措施

## 3.1 测试结论总结

本报告主要为对npu加速ivfflat-npu的构建与查询基础功能以及性能的测试，包括功能测试、性能测试、可靠性测试和资料测试。测试共执行两轮，执行测试用例64个，发现2个issue，均已验收，整体质量良好。

## 3.2 约束说明

IVFFLAT-NPU特性暂时只支持IVFFLAT索引。
IVFFLAT-NPU特性暂时只支持vector数据类型，在其他向量数据类型会导致执行失败。
IVFFLAT-NPU特性暂时只支持910B系列NPU。
IVFFLAT-NPU 特性仅支持在已安装 CANN 架构的容器环境中运行。
继承IVFFLAT原有约束。

# 4 版本详细测试结论

## 4.1 特性测试结论

###   4.1.1 新需求质量评价

| 特性                                                         | 特性价值评估                                 | 应用说明及关键约束假设依赖 | 关键遗留事项如缺陷等 | 测试整体覆盖情况                             | 特性质量评估               | 主要风险 |
| ------------------------------------------------------------ | -------------------------------------------- | -------------------------- | -------------------- | -------------------------------------------- | -------------------------- | -------- |
| 基于昇腾NPU MATMUL算子加速IVF-FLAT索引检索流程，索引构建效率提升1.x需求测试设计 | 本特性结合NPU加速ivfflat索引的构建与查询性能 | 详见3.2章节描述            | 无                   | 包括功能测试、性能测试、可靠性测试和资料测试 | <font color=green>▮</font> | 无       |

*特性质量评估说明*：

<font color=red><font color=red>●</font></font>： *表示特性不稳定，风险高*

<font color=yellow><font color=yellow>▲</font></font>： *表示特性基本可用，遗留少量问题*

<font color=green>▮</font>： *表示特性质量良好*

## 4.2 产品质量属性目标(DFX)测试结论

###  4.2.1 性能测试结论

*按照总体测试策略中对产品质量属性目标分析和执行策略，完成相应质量属性目标评估；总体测试策略中有要求但验证未执行的需给出说明。（如本测试阶段涉及则填写）下表仅供参考，不作为强制输出方式*

| 测试步骤                                                     | 测试结果                                                     |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| 1、使用annbenchmark工具分别测试cpu和npu在单并发和多并发下的性能 | 满足索引构建效率提升1.x的性能指标                            |
| 2、使用vectordbbench工具测试cpu和npu的性能                   | cpu的qps为4.717，cpuqps为19.422，满足索引构建效率提升1.x的性能指标 |

###  4.2.2 可靠性测试结论

| 测试步骤                           | 测试结果                                 |
| ---------------------------------- | ---------------------------------------- |
| 向量索引构建过程中，ctrl+C终止执行 | 合理报错，索引未创建                     |
| 向量索引构建过程中，kill数据库     | 合理报错，索引未创建                     |
| 向量索引构建过程中，stop数据库     | 合理报错，索引未创建                     |
| 向量索引构建过程中，restart数据库  | 合理报错，索引未创建，重启后正常创建索引 |

## 4.3 资料测试结论

*按照总体测试策略中制定的兼资料测试策略，给出验证结论。（如本测试阶段涉及则填写）*

*如下表格所示。下表仅供参考，不作为强制输出方式*

| 序号 | 测试章节                                                     | 测试结论               |
| ---- | ------------------------------------------------------------ | ---------------------- |
| 1    | [文档地图](https://docs.opengauss.org/zh/)[向量数据库](https://docs.opengauss.org/zh/docs/latest/docs/DataVec/DataVec-Overview.html)[向量存储引擎](https://docs.opengauss.org/zh/docs/latest/docs/DataVec/DataVec-architecture.html)IVFFLAT-NPU | 资料描述清晰，示例准确 |
|      |                                                              |                        |

# 5 测试对象质量评估

##  5.1 覆盖率分析

##  5.2 缺陷统计和分析

###   5.2.1 缺陷统计

|        | 问题总数 | 严重 | 主要 | 次要 | 不重要 |
| ------ | -------- | ---- | ---- | ---- | ------ |
| 数目   | 2        | 0    | 0    | 0    | 2      |
| 百分比 | 100%     | 0    | 0    | 0    | 100%   |

###   5.2.2 缺陷列表

| 问题单号 | 问题描述                                                     | 问题级别 | 当前状态 |
| -------- | ------------------------------------------------------------ | -------- | -------- |
| #6936    | 【测试类型：资料】【测试版本：7.0.0-RC2】【IVFFLAT-NPU】参数cache_data_on_npu说明有误 | 不重要   | 已验收   |
| #6943    | 【测试类型：资料】【测试版本：7.0.0-RC2】【IVFFLAT-NPU】DataVec向量引擎参数跳转链接失效 | 不重要   | 已验收   |

# 6 测试过程评估

##  6.1 测试策略回顾

| 编号 | 特性       | 验证策略                                                     | 是否按照测试策略执行 |
| ---- | ---------- | ------------------------------------------------------------ | -------------------- |
| 1    | 功能测试   | 测试了npu相关参数的设置、ivfflat索引的构建和查询等相关基础功能 | YES                  |
| 2    | 可靠性测试 | 1、向量索引构建过程中，ctrl+C终止执行；<br/>2、向量索引构建过程中，kill数据库；<br/>3、向量索引构建过程中，stop数据库；<br/>4、向量索引构建过程中，restart数据库 | YES                  |
| 3    | 性能测试   | 使用annbenchmark工具分别测试cpu和npu在但并发和多并发下的性能、使用vectordbbench工具测试cpu和npu的性能 | YES                  |

##  6.3 测试执行评估

###  6.3.1 测试执行统计数据

| 版本名称                | 工作量投入(人天) | 测试用例数 | 用例执行数 | 发现缺陷数 | 代码量（KLOC） | 缺陷密度 |
| ----------------------- | ---------------- | ---------- | ---------- | ---------- | -------------- | -------- |
| openGauss7.0.0-RC2.B012 | 17               | 62         | 62         | 2（资料）  | 2.3k           | 0        |

*数据项说明：*

- *版本名称--每个转测版本名称，例如openGauss 6.0.0 B016*
- *工作量投入--与本活动相关的所有工作量投入，包括测试计划、方案、用例、脚本、执行等所有与本测试相关的活动所花的投入，单位“人天”；不包括以前已经统计的投入，不包括开局、用户支援等非测试相关投入；*
- *测试用例数--到本测试活动结束时，本测试活动中所有可用测试用例数；*
- *执行用例数--在本测试活动中执行测试用例数，含手工和自动化用例，多次重复执行同一用例计算为1个；*
- *发现缺陷数--本测试活动总共发现的缺陷数（不含无效问题单数）。*
- 代码量--pr中统计的实际代码量
- *缺陷密度--缺陷个数/代码行数*

###  6.3.2 测试用例执行结果统计数据

|        | 计划测试用例数 | 实际测试的用例数 | Passed | Failed | Blocked | Unavailable | 执行率 | 执行通过率 |
| ------ | -------------- | ---------------- | ------ | ------ | ------- | ----------- | ------ | ---------- |
| 第一轮 | 60             | 60               | 60     | 0      | 0       | 0           | 100%   | 100%       |
| 第二轮 | 2              | 2                | 2      | 0      | 0       | 0           | 100%   | 100%       |
| ...    |                |                  |        |        |         |             |        |            |

*其中：*

*Passed 用例执行成功*

*Failed 用例全部或部分执行结果未通过或者测试执行过程中遇到其他与本用例无关的失效事件*

*Blocked由于产品本身的问题导致用例不可执行*

*Unavailable由于软件本身以外，如环境、工具、物料、时间、人力资源等因素导致用例未执行*

# 7 附件

##  7.1 附件1：遗留问题列表

无

##  7.2 附件2：特性相关PR

需求pr：

https://gitcode.com/opengauss/openGauss-server/pull/7903

资料pr：

https://gitcode.com/opengauss/docs/pull/7762

测试设计：

https://devcloud.cn-east-3.huaweicloud.com/testmind/project/03669bfd256c444bbfda6d7fb8b83bb2/testmind/mindmap?mindId=843719bb81294f06b654fdbd3482f29c&hideDevcloudHead=true

