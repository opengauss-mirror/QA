![avatar](../../images/openGauss.png)

版权所有 © 2024  openGauss社区
 您对“本文档”的复制、使用、修改及分发受知识共享(Creative Commons)署名—相同方式共享4.0国际公共许可协议(以下简称“CC BY-SA 4.0”)的约束。为了方便用户理解，您可以通过访问[*https://creativecommons.org/licenses/by-sa/4.0/*](https://creativecommons.org/licenses/by-sa/4.0/) 了解CC BY-SA 4.0的概要 (但不是替代)。CC BY-SA 4.0的完整协议内容您可以访问如下网址获取：[*https://creativecommons.org/licenses/by-sa/4.0/legalcode*](https://creativecommons.org/licenses/by-sa/4.0/legalcode)。

修订记录

| 日期     | 修订版本 | 修改描述 | 作者   |
| -------- | -------- | -------- | ------ |
| 2024.9.1 | V1.0     |          | 吕林涛 |

[TOC]

**Keywords 关键词**：慢SQL，统计执行计划，记录级别

**Abstract 摘要**：本文档是对默认开启慢SQL统计执行计划特性测试说明，包括对在数据库中使用默认统计慢SQL配置track_stmt_stat_level为‘OFF,L0’时，当查询SQL用时大于log_min_duration_statement时，测试该慢SQL的查询计划是否被记录到statement_history系统表中。同时对慢SQL配置track_stmt_stat_level为其他级别、数据库安装版本（极简版，企业版）、数据库兼容性、和是否手动中断进行组合测试。

**缩略语清单： **

| 缩略语 | 英文全名 | 中文解释 |
| ------ | -------- | -------- |
|        |          |          |


# 1 概述

该特性源于对慢SQL分析的诉求。分析慢SQL时，执行计划相关信息是非常重要的。本特性之前的慢SQL记录机制是：track_stmt_stat_level设置为'OFF,L1'或者'OFF,L2'，且SQL执行时间大于log_min_duration_statement配置值，慢SQL及其执行计划回记录到statement_history表中。但是track_stmt_stat_level的默认值是'OFF,L0'，所以默认不会记录。本特性实现了track_stmt_stat_level为'OFF,L0'时，SQL执行时间大于log_min_duration_statement时，记录下该SQL的执行计划，方便分析慢SQL。针对该特性设计以下测试场景：

（1）track_stmt_stat_level='L0,OFF'时，组合数据库单机、一主两备，是否手动中断场景，测试是否记录执行计划

（2）track_stmt_stat_level='OFF,L0'时，组合数据库单机、一主两备，是否手动中断场景，测试是否记录执行计划

（3）track_stmt_stat_level='OFF,L1'时，组合数据库单机、一主两备，是否手动中断场景，测试是否记录执行计划

（4）track_stmt_stat_level='L0,L0'时，组合数据库单机、一主两备，是否手动中断场景，测试是否记录执行计划

# 2 测试版本说明

## 2.1 测试版本信息

###   2.1.1 被测版本

| 版本名称             | 软件包名称 | 测试起始时间 | 测试结束时间 | 测试人员 |
| -------------------- | ---------- | ------------ | ------------ | -------- |
| openGauss 6.0.0 B025 |            | 2024.8.1     | 2024.8.8    | 吕林涛   |
| openGauss 6.0.0 B026 |            | 2024.8.15     | 2024.8.22    | 吕林涛   |

###  2.1.2 配套测试的版本

| 版本名称 | 配套版本 | 版本说明 |
| -------- | -------- | -------- |
| 无       |          |          |

## 2.2 测试环境描述

###  2.2.1 环境硬件信息

| 环境信息 | 硬件型号       | 硬件配置信息                                                 | 备注 |
| -------- | -------------- | ------------------------------------------------------------ | ---- |
| 虚拟机   | CentOS 7.9 x86 | CPU：Intel(R) Xeon(R) Gold 6161 CPU @ 2.20GHz<br />内存：15G<br />硬盘：300G<br />OS：CentOS Linux release 7.6.1810 (Core)<br />文件系统：d5737695-18ab-4fd0-953a-342340e04006<br />网卡：eth0 |      |



# 3 版本概要测试结论、关键风险和规避措施

## 3.1 测试结论总结

支持慢SQL统计默认开启执行计划统计特性，共计执行测试用例35个，主要覆盖功能测试，资料测试和性能测试。测试执行覆盖率达到100%。在功能测试中，通过手动执行用例，发现一个问题，经与开发沟通为查询走SQL bypass逻辑时没有相关执行计划，结论为非问题。在资料测试中，相关资料均已补充完整。在性能测试中，在开启统计慢SQL相关配置后，整体性能下降在5%以内，符合预期，整体质量良好。

## 3.2 约束说明

不涉及

## 3.3 关键风险和规避措施

无

# 4 版本详细测试结论

## 4.1 特性测试结论

###   4.1.1 新需求质量评价

| 特性                              | 特性价值评估                                                 | 应用说明及关键约束假设依赖 | 关键遗留事项如缺陷等 | 测试整体覆盖情况                     | 特性质量评估               | 主要风险 |
| --------------------------------- | ------------------------------------------------------------ | -------------------------- | -------------------- | ------------------------------------ | -------------------------- | -------- |
| 支持慢SQL统计默认开启执行计划统计 | 本特性实现了在track_stmt_stat_level为OFF,L0时，记录下大于log_min_duration_statement的SQL执行计划，方便定位慢SQL，提高分析效率 | 详见3.2章节                | 无                   | 功能测试、兼容性测试、性能、资料测试 | <font color=green>▮</font> | 无       |

## 4.2 产品质量属性目标(DFX)测试结论

###  4.2.1 性能测试结论

本特性涉及默认配置开启后，统计了执行计划，对整体性能可能有所影响。在此进行开启参数后对数据库整体的性能测试，测试步骤为配置生产参数后对log_min_duration_statement分别设置为1s和20ms进行性能测试。

| 测试步骤                                                     | 测试结果                   |
| ------------------------------------------------------------ | -------------------------- |
| log_min_duration_statement设置为1s，配置相关生产参数后tpcc值为48.5w。log_min_duration_statement设置为20ms，配置相关生产参数后tpcc值为49.2w。 | 性能未见明显下降，符合预期 |

###  4.2.2 可靠性测试结论

无

###  4.2.3 安全&隐私保护测试结论

无

### 4.2.4 可服务性测试结论

无

### 4.2.5 生命周期管理测试结论

无

### 4.2.6 韧性测试结论

无

###  4.2.7 兼容性测试结论

针对数据库支持的多种兼容性，在A、B、PG兼容性下进行相应的功能测试

| 测试步骤                                                     | 测试结果 |
| ------------------------------------------------------------ | -------- |
| 开启相关配置，在A、B、PG库中执行相应SQL查询语句，测试大于log_min_duration_statement的是否被记录到执行计划 | 符合预期 |

###  4.2.8 升级测试结论

无

## 4.3 资料测试结论

| 序号 | 测试章节                                             | 测试结论                 |
| ---- | ---------------------------------------------------- | ------------------------ |
| 1    | 数据库参考>系统表和系统视图>系统表>STATEMENT_HISTORY | 整体质量良好，未发现问题 |
| 2    | SQL参考>Schema>DBE_PERF Schema>Query                 | 整体质量良好，未发现问题 |

# 5 测试对象质量评估

本特性测试主要从功能，特性交互等方面测试，主要通过边界值以及等价类的测试涉及方法对这些特性验证功能与需求相符，异常情况下也有相应报错。在不同的track_stmt_stat_level的配置下，组合数据库安装方式，数据库兼容性和是否手动中断，验证是否记录查询计划。

##  5.1 覆盖率分析

##  5.2 缺陷统计和分析

###   5.2.1 缺陷统计

|        | 问题总数 | 严重 | 主要 | 次要 | 不重要 |
| ------ | -------- | ---- | ---- | ---- | ------ |
| 数目   | 0        | 0    | 0    | 0    | 0      |
| 百分比 | 100%     | 0%   | 0%   | 0%   | 0%     |

###   5.2.2 缺陷列表

无

# 6 测试过程评估

##  6.1 测试策略回顾

| 编号 | 特性     | 验证策略                                                     | 是否按照测试策略执行 |
| ---- | -------- | ------------------------------------------------------------ | -------------------- |
| 1    | 功能测试 | 配置track_stmt_stat_level='L0,OFF'，该配置为统计全量SQL，相应的查询计划可以被记录 | YES                  |
| 2    | 功能测试 | 配置track_stmt_stat_level='OFF,L0'，该配置为统计慢SQL，组合相应的log_min_duration_statement边界值，大于边界值的查询计划可以被记录 | YES                  |
| 3    | 功能测试 | 配置track_stmt_stat_level='OFF,L1'，该配置为统计慢SQL，组合相应的log_min_duration_statement边界值，大于边界值的查询计划可以被记录 | YES                  |
| 4    | 功能测试 | 配合数据库安装方式，不同的兼容性数据库，是否中断，大于边界值的查询计划可以被记录 | YES                  |

##  6.2 测试设计评估

无

##  6.3 测试执行评估

###  6.3.1 测试执行统计数据

| 版本名称             | 工作量投入(人天) | 测试用例数 | 用例执行数 | 发现缺陷数 | 代码量（KLOC） | 缺陷密度 |
| -------------------- | ---------------- | ---------- | ---------- | ---------- | -------------- | -------- |
| openGauss 6.0.0 B025 | 12               | 34         | 34         | 0          | 0.185          | 0        |
| openGauss 6.0.0 B026 | 1                | 1          | 1          | 0          |                | 0        |

###  6.3.2 测试用例执行结果统计数据

|        | 计划测试用例数 | 实际测试的用例数 | Passed | Failed | Blocked | Unavailable | 执行率 | 执行通过率 |
| ------ | -------------- | ---------------- | ------ | ------ | ------- | ----------- | ------ | ---------- |
| 第一轮 | 20             | 20               | 20     | 0      | 0       | 0           | 100%   | 100%       |
| 第二轮 | 15             | 15               | 15     | 0      | 0       | 0           | 100%   | 100%       |

# 7 附件

##  7.1 附件1：遗留问题列表

无

##  7.2 附件2：特性相关PR

1.源代码PR

https://gitee.com/opengauss/openGauss-server/pulls/5800

2.资料PR

https://gitee.com/opengauss/docs/pulls/6563

