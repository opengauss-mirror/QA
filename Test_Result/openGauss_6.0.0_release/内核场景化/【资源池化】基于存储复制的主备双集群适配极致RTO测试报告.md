![avatar](../../../images/openGauss.png)

版权所有 © 2023  openGauss社区
 您对“本文档”的复制、使用、修改及分发受知识共享(Creative Commons)署名—相同方式共享4.0国际公共许可协议(以下简称“CC BY-SA 4.0”)的约束。为了方便用户理解，您可以通过访问https://creativecommons.org/licenses/by-sa/4.0/ 了解CC BY-SA 4.0的概要 (但不是替代)。CC BY-SA 4.0的完整协议内容您可以访问如下网址获取：https://creativecommons.org/licenses/by-sa/4.0/legalcode。

修订记录

| 日期     | 修订   版本 | 修改描述     | 作者    |
| -------- | ----------- | ------------ | ------- |
| 2024-3-20 | 1.0         | 测试报告初版 | songjing |
| 2024-3-30 | 1.1 | 1. 补充测试备集群对不同数据库对象增删改回放的正确性<br/>2. 更改RTO时间的计算方式并重新测试 | songjing |

关键词：极致RTO，存储复制，双集群

摘要：本文档主要描述基于存储复制的资源池化双集群支持极致RTO的测试过程，并给出测试结论。


缩略语清单：

| 缩略语 | 英文全名     | 中文解释                 |
| ------ | ------------ | ------------------------ |
| RTO | Recovery Time Objective | 恢复时间目标 |

# 1  特性概述

资源池化双集群系统在长时间运行后，并行回放模式下备集群上会出现日志累积，当主集群故障后，备集群升主时数据恢复需要较长时间，影响系统可用性，因此需要备集群可开启极致RTO开关，使备集群能够快速回放日志，减少数据的恢复时间，提高集群的可用性，同时满足30W tpmC场景下RTO<20s。

# 2  特性测试信息

| 版本名称                       | 测试起始时间 | 测试结束时间 |
| ------------------------------ | ------------ | ------------ |
| openGauss 6.0.0 build 0cd970a8 | 2024-3-8 | 2024-3-15 |
| openGauss 6.0.0 build 28fc03da | 2024-3-21   | 2024-3-30 |

| 环境信息                              | 配置信息                                                     | 备注       |
| ------------------------------------- | ------------------------------------------------------------ | ---------- |
| 服务端<br />Taishan 200（Model 2280） | CPU：Kunpeng 920<br />内存：1TB<br />磁阵：单卷组500GB*4<br />文件系统：EXT4<br />网卡：2\*25GE<br />OS：openEuler release 20.03 (LTS) | 主备双集群 |

# 3  测试结论概述

## 3.1  测试整体结论

基于存储复制的双集群支持极致RTO特性共计执行31个用例，主要覆盖了功能测试、稳定性、性能测试和资料测试；发现问题2个，已全部修复并回归通过，整体质量良好 。

| 测试活动   | 活动评价                                                     |
| ---------- | ------------------------------------------------------------ |
| 功能测试   | (1) 主备集群可成功配置极致RTO参数，主集群正常运行业务，备集群不支持读<br />(2) 主备集群配置极致RTO参数，主集群运行业务，备集群回放正常，主集群发生故障，备集群failover升主成功，新主集群内各节点数据一致<br />(3) 开启极致RTO，集群内主备切换正常，重启后正常使用，主备集群数据一致<br />(4) 开启极致RTO，备集群failover重入等一些异常场景 |
| 稳定性测试 | 主备集群配置极致RTO参数，导入500仓tpcc数据，主集群执行160并发读写2*24h，主备集群状态正常，备集群回放正常，测试通过 |
| 性能测试   | tpc-C 1000仓数据，30WtpmC 场景下，RTO<20s，测试通过          |

## 3.2  约束说明

（1）本特性适用于基于存储复制的资源池化双集群场景

（2） 开启极致RTO，设置hot_standby=off，备集群不支持读，对主集群所有节点无影响 

（3）性能目标中的RTO时间指执行failover成功升主的时间，不包括DeviceManager上的操作时间

## 3.3  遗留问题分析

### 3.3.1  遗留问题影响以及规避措施

| 问题单号 | 问题描述 | 问题级别 | 问题影响和规避措施 | 当前状态 |
| -------- | -------- | -------- | ------------------ | -------- |
| N/A      |          |          |                    |          |

### 3.3.2  问题统计

|        | 问题总数 | 严重 | 主要 | 次要 | 不重要 |
| ------ | -------- | ---- | ---- | ---- | ------ |
| 数目   | 2        | 0    | 0    | 1    | 1      |
| 百分比 | 100%     | 0%   | 0%   | 50%  | 50%    |

### 3.3.3  问题单汇总

| 序号 | issue号                                                      | 问题级别 | 问题简述                                                     | 问题状态 |
| ---- | ------------------------------------------------------------ | -------- | ------------------------------------------------------------ | -------- |
| 1    | [I97QR0](https://gitee.com/opengauss/openGauss-server/issues/I97QR0?from=project-issue) | 次要     | 【测试类型：功能测试】【测试版本：6.0.0】【资源池化】备集群开启极致RTO，从备可以使用gsql连接 | 已验收   |
| 2    | [I9BMK2](https://gitee.com/opengauss/openGauss-server/issues/I9BMK2?from=project-issue) | 不重要   | 【测试类型：资料】【测试版本：6.0.0】极致RTO特性相关资料描述有误 | 已验收   |

# 4  测试执行

## 4.1  测试执行步骤

### 4.1.1  功能测试

#### 4.1.1.1  主备集群配置RTO参数，备集群回放数据正常

| 测试步骤                                                     | 测试结果                                   |
| ------------------------------------------------------------ | ------------------------------------------ |
| 1. 主集群配置RTO参数，主机创建修改删除数据库、表空间、模式、表、视图、索引、函数/存储过程、自定义类型等数据库对象，备集群可回放同步<br/>2. 备集群配置RTO参数，连接备集群各节点失败，主集群运行业务，备集群回放正常<br/>3.主备集群内主备切换正常（备集群内failover） | 执行用例5个，发现问题1个，已修复并回归通过 |

#### 4.1.1.2  备集群配置极致RTO参数，备集群升主集群

| 测试步骤                                                     | 测试结果               |
| ------------------------------------------------------------ | ---------------------- |
| 1. 主集群空载/运行业务过程中stop集群/kill集群进程等构造主集群故障<br/>2. 分裂同步关系，取消从资源保护，主从切换<br/>3. 备集群首备执行gs_ctl  failover -D $PGDATA 命令升主集群<br/>4.新主集群运行业务 | 执行用例12个，符合预期 |

#### 4.1.1.3  开启极致RTO，主备集群数据一致校验

| 测试步骤                                                     | 测试结果              |
| ------------------------------------------------------------ | --------------------- |
| 1.主集群运行业务过程中多次反复卡住gaussdb进程/主备切换等操作，备集群关闭极致RTO，查询主备集群数据一致<br />2.主集群运行业务过程中，备集群内failover，节点重启，集群重启等操作，gs_ctl query查询数据同步后关闭极致RTO，查询主备集群数据 | 执行用例3个，符合预期 |

#### 4.1.1.4  开启极致RTO，备集群failover一些异常场景

| 测试步骤                                                     | 测试结果              |
| ------------------------------------------------------------ | --------------------- |
| 1.failove过程中，kill failover进程/主备节点gaussdb/cm/dssserver进程，节点重启等 | 执行用例4个，符合预期 |

### 4.1.2  稳定性测

| 测试步骤                                                     | 测试结果              |
| ------------------------------------------------------------ | --------------------- |
| 1.安装主备双集群，设置极致RTO参数<br />2.导入500仓tpc-C数据，主机160并发执行读写，备机20并发读，运行2*24h<br />3.关闭备集群极致RTO，查询主备集群数据是否一致 | 执行用例1个，符合预期 |

### 4.1.3  性能测试

| 测试步骤                                                     | 测试结果                     |
| ------------------------------------------------------------ | ---------------------------- |
| 1.安装主备双集群，设置极致RTO参数和其他调优guc参数<br />2.连接主集群主机导入1000仓tpc-C数据，设置并发数在30W tpmC 场景下运行30min-1h<br />3.kill主集群gaussdb进程或stop主集群，登录devicemanager分裂同步关系，取消从资源保护，主从切换<br />4.备集群修改参数：gs_ssh -c"dsscmd setcfg -n CLUSTER_RUN_MODE -v cluster_primary";cm_ctl set --param --agent -k ss_double_cluster_mode=1;cm_ctl reload --param --agent，首备执行failover升主，查询集群状态正常，可正常连接数据库执行业务<br/>以最后一次测试为例：<br/>(1) failover时间1.02s<br/>(2) 业务期间主机xlog生成速度66.616 M/s，备集群平均回放速度66.620 M/s，主集群故障时备集群剩6.59 M日志待回放，回放所需时间0.098s<br/>(3) 备集群修改参数命令耗时3s，计算出RTO时间约为4.1s，符合预期 | 执行用例6个，符合预期RTO<20s |

## 4.2  测试执行统计数据

| 版本名称                       | 测试用例数 | 用例执行结果         | 发现问题单数 |
| ------------------------------ | ---------- | -------------------- | ------------ |
| openGauss 6.0.0 build 0cd970a8 | 30         | Passed：30 Failed：3 | 1            |
| openGauss 6.0.0 build 28fc03da | 31         | Passed：31 Failed：0 | 0            |

**数据项说明：**

- 测试用例数：到本测试活动结束时，所有可用测试用例数；
- 发现问题单数：本测试活动功能用例总共发现的问题单数2个，1个为资料问题，不计入缺陷密度；
- 用例执行结果：第一轮全量执行用例，第二轮测试补充1个用例、回归问题单和全量执行；
- 缺陷密度：1(缺陷个数)/1kloc(代码行数)=1(个/kloc)

## 4.3  后续测试建议

无

# 5  附件

## 5.1  特性相关pr

https://e.gitee.com/opengaussorg/repos/opengauss/openGauss-server/pulls/4705

https://e.gitee.com/opengaussorg/repos/opengauss/openGauss-server/pulls/4910

https://e.gitee.com/opengaussorg/repos/opengauss/docs/pulls/6253

