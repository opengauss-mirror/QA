![avatar](../../../images/openGauss.png)

版权所有 © 2023  openGauss社区
 您对“本文档”的复制、使用、修改及分发受知识共享(Creative Commons)署名—相同方式共享4.0国际公共许可协议(以下简称“CC BY-SA 4.0”)的约束。为了方便用户理解，您可以通过访问https://creativecommons.org/licenses/by-sa/4.0/ 了解CC BY-SA 4.0的概要 (但不是替代)。CC BY-SA 4.0的完整协议内容您可以访问如下网址获取：https://creativecommons.org/licenses/by-sa/4.0/legalcode。

修订记录

| 日期     | 修订   版本 | 修改描述     | 作者    |
| -------- | ----------- | ------------ | ------- |
| 2024-2-21 | 1.0         | 测试报告初版 | songjing |

关键词：堆表，线性扫描，预读

摘要：本文档主要描述堆表支持预读，一次读取多个页面，加速vacuum和顺序扫描功能的测试过程，并给出测试结论。


缩略语清单：

| 缩略语 | 英文全名     | 中文解释                 |
| ------ | ------------ | ------------------------ |
|     |     |  |



# 1 特性概述

本特性主要对已有的块读入机制进行增强，将单块读改为多块连续预读，在原有基础上减少磁盘IO，提高缓冲区命中率，适用场景为大数据量的堆表线性扫描。



# 2 特性测试信息

| 版本名称                       | 测试起始时间 | 测试结束时间 |
| ------------------------------ | ------------ | ------------ |
| openGauss 6.0.0 build 4614510e | 2024-1-19 | 2024-1-25  |
| openGauss 6.0.0 build 64d22482 | 2024-2-4 | 2024-2-4 |
| openGauss 6.0.0 build b8fc2278 | 2024-2-20    | 2024-2-21 |

| 环境信息                              | 配置信息                                                     | 备注          |
| ------------------------------------- | ------------------------------------------------------------ | ------------- |
| 服务端<br />Taishan 200（Model 2280） | CPU：Kunpeng 920<br />内存：765GB<br />硬盘：3TB<br />OS：openEuler release 20.03 (LTS) | 单机/一主两备 |

   

# 3 测试结论概述

## 3.1 测试整体结论

堆表支持预读特性共计执行29个用例，主要覆盖了功能测试、稳定性、性能测试、升级测试和资料测试；发现问题3个，已全部修复并回归通过，整体质量良好 。

| 测试活动   | 活动评价                                                     |
| ---------- | ------------------------------------------------------------ |
| 功能测试   | 1. 新增参数heap_bulk_read_size、heap_bulk_read_size取值和设置方式验证<br />2. 开启预读，线性扫描不同类型的表、视图，执行结果与不开启预读的一致，vacuum执行成功 |
| 稳定性测试 | 1. 开启预读功能，执行tpcc读写业务12小时，期间执行多次vacuum操作，预期运行稳定结果无误 |
| 性能测试   | 1. 对比开启和关闭预读场景下的堆表线性扫描时间和vacuum时间，预期开启预读性能提升15%及以上<br />2. 开启和关闭预读运行tpcc性能测试，预期开启预读对原有的性能无劣化影响 |
| 升级测试   | 1. 3.0.5-master，5.0.0-master，升级后预读功能正常使用，回滚升级正常执行 |
| 资料测试   | 1.描述准确，示例正确，链接跳转正确                           |

## 3.2   约束说明

（1）本特性在资源池化部署下不生效。

（2）堆表线性扫描场景才有性能提升。

（3）列存表，段页式表，ustore表全表扫描不走预读块流程。

## 3.3   遗留问题分析

### 3.3.1  遗留问题影响以及规避措施

| 问题单号 | 问题描述 | 问题级别 | 问题影响和规避措施 | 当前状态 |
| -------- | -------- | -------- | ------------------ | -------- |
| N/A      |          |          |                    |          |

### 3.3.2  问题统计

|        | 问题总数 | 严重 | 主要 | 次要 | 不重要 |
| ------ | -------- | ---- | ---- | ---- | ------ |
| 数目   | 3        | 0    | 0    | 3    | 0      |
| 百分比 | 100%     | 0%   | 0%   | 100% | 0%     |

### 3.3.3  问题单汇总

| 序号 | issue号                                                      | 问题级别 | 问题简述                                                     | 问题状态 |
| ---- | ------------------------------------------------------------ | -------- | ------------------------------------------------------------ | -------- |
| 1    | [I8Y0AV](https://gitee.com/opengauss/openGauss-server/issues/I8Y0AV?from=project-issue) | 次要     | 【测试类型：工具功能】【测试版本：6.0.0】参数heap_bulk_read_size、vacuum_bulk_read_size无法使用gs_guc工具设置 | 已验收   |
| 2    | [I8Y6U4](https://gitee.com/opengauss/openGauss-server/issues/I8Y6U4?from=project-issue) | 次要     | 【测试类型：SQL功能】【测试版本：6.0.0】设置heap_bulk_read_size=8开启预读，段页式表全表扫描，数据库产生core | 已验收   |
| 3    | [I90E9K](https://gitee.com/opengauss/openGauss-server/issues/I90E9K?from=project-issue) | 次要     | 【测试类型：SQL功能】【测试版本：6.0.0】开启预读块功能，运行tpc-C读写过程中执行vacuum，数据库core | 已验收   |



# 4  测试执行

## 4.1  测试执行步骤

### 4.1.1  功能测试

#### 4.1.1.1  新增GUC参数取值和设置方式验证

| 测试步骤                                                     | 测试结果                                   |
| ------------------------------------------------------------ | ------------------------------------------ |
| 1. 参数heap_bulk_read_size、vacuum_bulk_read_size结合系统视图pg_settings进行取值验证<br/>2. 不同方式设置参数值验证 | 执行用例8个，发现1个问题，已修复且回归通过 |

#### 4.1.1.2  开启预读，查询表和视图

| 测试步骤                                                     | 测试结果                                    |
| ------------------------------------------------------------ | ------------------------------------------- |
| 1. 创建不同类型和大小的堆表，视图<br/>2.设置不同heap_bulk_read_size，线性扫描表和视图，同时查看日志打印，确认是否多块预读<br/>3. 非线性扫描计划查询表，不预读多个页面 | 执行用例14个，发现问题1个，已修复并回归通过 |

#### 4.1.1.3  开启预读，执行lazy vacuum操作

| 测试步骤                                                     | 测试结果                  |
| ------------------------------------------------------------ | ------------------------- |
| 1.创建表，insert/delete数据<br />2.设置不同vacuum_bulk_read_size，执行vacuum/vacuum analyze table成功 | 执行用例2个，结果符合预期 |

### 4.1.2  稳定性测试

| 测试步骤                                                     | 测试结果                                   |
| ------------------------------------------------------------ | ------------------------------------------ |
| 1.开启预读，tpcc 1000仓，800并发执行读写业务12小时，期间执行多次vacuumm操作，执行一致性脚本 | 执行用例1个，发现1个问题，已修复且回归通过 |

### 4.1.3 性能测试

| 测试步骤                                                     | 测试结果                                         |
| ------------------------------------------------------------ | ------------------------------------------------ |
| 1.构造50GB大小的堆表，设置不同heap_bulk_read_size，对堆表线性扫描，对比查询时间<br />2.设置不同vacuum_bulk_read_size，tpcc读写30w事务量后执行vacuum，对比时间<br />3.开启和关闭预读运行tpcc性能测试，预期开启预读对原有的性能无劣化影响 | 执行用例3个，开启预读查询和vacuum效率提升15%以上 |

### 4.1.4  升级测试

| 测试步骤                                                     | 测试结果                  |
| ------------------------------------------------------------ | ------------------------- |
| 1.安装3.0.5版本数据库，升级到master，验证预读功能，提交升级<br />2.安装5.0.0版本数据库，升级到master，验证预读功能，回滚升级 | 执行用例1个，结果符合预期 |

## 4.2  测试执行统计数据

| 版本名称                       | 测试用例数 | 用例执行结果         | 发现问题单数 |
| ------------------------------ | ---------- | -------------------- | ------------ |
| openGauss 6.0.0 build 4614510e | 29         | Passed：24 Failed：5 | 3            |
| openGauss 6.0.0 build 64d22482 | 3          | Passed：3 Failed：0  | 0            |
| openGauss 6.0.0 build b8fc2278 | 29         | Passed：29 Failed：0 | 0            |

**数据项说明：**

- 测试用例数：到本测试活动结束时，所有可用测试用例数；
- 发现问题单数：本测试活动功能用例总共发现的问题单数；
- 用例执行结果：第一轮测试全量执行，第二回归问题单，第三轮回归问题单和全量执行；
- 缺陷密度：3(缺陷个数)/0.872kloc(代码行数)=3.44(个/kloc)

## 4.2  后续测试建议

无

# 5  附件

无