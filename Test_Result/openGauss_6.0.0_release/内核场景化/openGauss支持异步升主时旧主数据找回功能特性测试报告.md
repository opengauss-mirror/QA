![avatar](../../../images/openGauss.png)

版权所有 © 2023  openGauss社区
 您对“本文档”的复制、使用、修改及分发受知识共享(Creative Commons)署名—相同方式共享4.0国际公共许可协议(以下简称“CC BY-SA 4.0”)的约束。为了方便用户理解，您可以通过访问https://creativecommons.org/licenses/by-sa/4.0/ 了解CC BY-SA 4.0的概要 (但不是替代)。CC BY-SA 4.0的完整协议内容您可以访问如下网址获取：https://creativecommons.org/licenses/by-sa/4.0/legalcode。

修订记录

| 日期      | 修订版本 | 修改描述         | 作者  |
| --------- | -------- | ---------------- | ----- |
| 2024/2/22 | 1.0      | 特性报告初稿完成 | lixin |
| 2024/3/11 | 1.1      | 增加问题单回归结果 | lixin |

关键词：gs_retrieve，逻辑复制，xlog、找回数据

摘要：本文档主要介绍openGauss支持异步备升主时旧主数据找回特性测试 ，主要包含gs_retrieve工具参数校验测试、gs_retrieve工具功能验证、pg_create_logical_replication_slot函数测试，及性能测试等，并给出最终测试结论。

缩略语清单：

| 缩略语    | 英文全名  | 中文解释          |
| --------- | --------- | ----------------- |
|NA |  | |

# 1     特性概述

在openGauss主备的架构下，主机异常宕机，需要异步备升主时，旧主可能存在已提交的事务未同步到异步备，gs_retrieve工具可以在旧主恢复之后，将未同步的数据通过逻辑解码的方式找回。

# 2     特性测试信息

| 版本名称                       | 测试起始时间 | 测试结束时间 |
| ------------------------------ | ------------ | ------------ |
| openGauss 6.0.0 build a73bec27 | 2024/2/22    | 2024/2/28    |
| openGauss 6.0.0 build ac5a43ad | 2024/2/29    | 2024/3/1     |

| 环境信息 | 配置信息                                                     | 备注          |
| -------- | ------------------------------------------------------------ | ------------- |
| 虚拟机   | Inter(R) Xeon(R) Gold 6278C CPU @ 2.60GHz 4核<br/>内存：8GB<br/>硬盘：220GB<br/>OS：openEuler release 20.03(LTS) | 安装openGauss |

# 3     测试结论概述

## 3.1   测试整体结论

共设计46个测试用例，主要包含gs_retrieve工具参数校验测试、gs_retrieve工具功能验证、pg_create_logical_replication_slot函数测试，及性能测试等。其中1个用例不适配，其余用例皆执行通过，未发现问题，整体质量好。

| 测试活动 | 活动评价                                                     |
| -------- | ------------------------------------------------------------ |
| 功能测试 | gs_retrieve工具参数校验测试                                  |
| 功能测试 | gs_retrieve工具功能验证                                      |
| 功能测试 | pg_create_logical_replication_slot函数测试                   |
| 性能测试 | tpcc/sysbench加压，统计使用gs_retrieve工具找回数据耗时，无性能指标 |
| 资料测试 | 官方文档已更新参数相关资料，描述清晰，示例正确               |

## 3.2   约束说明

- gs_retrieve工具仅支持在旧主所在机器上使用，新主可在不同机器。
- 旧主恢复之后建议将autovacuum设置为off，防止元数据的历史版本被回收清理。
- 解码范围内存在DDL的情况下，可能由于元数据的历史版本被清理而无法正常解码。通过force方式解码，可能会丢失数据。
- 继承原有逻辑解码的约束。

## 3.3   遗留问题分析

### 3.3.1 遗留问题影响以及规避措施

| 问题单号 | 问题描述 | 问题级别 | 问题影响和规避措施 | 当前状态 |
| -------- | -------- | -------- | ------------------ | -------- |
| NA       |          |          |                    |          |

### 3.3.2 问题统计

|        | 问题总数 | 严重 | 主要 | 次要 | 不重要 |
| ------ | -------- | ---- | ---- | ---- | ------ |
| 数目   | 1        | 0    | 0    | 0    | 1      |
| 百分比 | 100%       | 0%   | 0%   | 0%   | 100%     |

### 3.3.3 问题单汇总

| 序号 | issue号                                                      | 级别   | 问题简述                                                     | 状态   |
| ---- | ------------------------------------------------------------ | ------ | ------------------------------------------------------------ | ------ |
| 1    | [I954PM](https://gitee.com/opengauss/docs/issues/I954PM?from=project-issue) | 不重要 | 【测试类型：资料】【测试版本：6.0.0】gs_retrieve工具约束说明不全 | 已验收 |

# 4     测试执行

## 4.1 测试执行步骤

###  4.1.1 gs_retrieve工具参数校验测试

| 测试步骤                                                     | 测试结果                           |
| ------------------------------------------------------------ | ---------------------------------- |
| 1. 设置autovacuum=off、wal_level=logical、enable_slot_log=on等，创建用户并赋权，用户具有登录权限和流复制权限，且pg_hba文件中配置流复制认证规则<br />2. 构造主备日志同步差异，停主机模拟主机故障，异步备升主，拉起旧主，旧主上执行gs_retrieve工具，不同有效及无效参数值组合校验 | 执行20条用例，执行通过，未发现缺陷 |

### 4.1.2 gs_retrieve工具功能验证

| 测试步骤                                                     | 测试结果                           |
| ------------------------------------------------------------ | ---------------------------------- |
| 1. 设置autovacuum=off、wal_level=logical、enable_slot_log=on等，创建用户并赋权，用户具有登录权限和流复制权限，且pg_hba文件中配置流复制认证规则<br />2. 构造主备日志同步差异，主机业务分别覆盖行存压缩、ustore、段页式等表，覆盖存储过程、自定义函数、DDL语句等，及常见数据类型等<br />3. 停主机模拟主机故障，异步备升主，拉起旧主，旧主上执行gs_retrieve工具找回数据 | 执行9条用例，执行通过，未发现缺陷  |
| 1. 设置autovacuum=off、wal_level=logical、enable_slot_log=on等，创建用户并赋权，用户具有登录权限和流复制权限，且pg_hba文件中配置流复制认证规则<br />2. 分别构造主备不同日志同步差异场景、解码失败场景、解码时旧主继续执行业务/逻辑解码等场景，使用gs_retrieve找回数据 | 执行12条用例，执行通过，未发现缺陷 |

### 4.1.3 pg_create_logical_replication_slot函数测试

| 测试步骤                                                     | 测试结果                          |
| ------------------------------------------------------------ | --------------------------------- |
| 1. 设置autovacuum=off、wal_level=logical、enable_slot_log=on等，创建用户并赋权，用户具有登录权限和流复制权限，且pg_hba文件中配置流复制认证规则<br />2. 使用pg_create_logical_replication_slot创建逻辑复制槽，不同参数校验测试 | 执行2条用例，执行通过，未发现缺陷 |

### 4.1.4 gs_retrieve工具性能测试

| 测试步骤                                                     | 测试结果                          |
| ------------------------------------------------------------ | --------------------------------- |
| 1. 设置autovacuum=off、wal_level=logical、enable_slot_log=on等，创建用户并赋权，用户具有登录权限和流复制权限，且pg_hba文件中配置流复制认证规则<br />2. tpcc/sysbench加压，统计使用gs_retrieve工具找回数据耗时，无性能指标 | 执行2条用例，执行通过，未发现缺陷 |

## 4.2  测试执行统计数据

| 版本名称                       | 测试用例数 | 用例执行结果             | 发现问题单数 |
| ------------------------------ | ---------- | ------------------------ | ------------ |
| openGauss 6.0.0 build a73bec27 | 22 | Passed：22<br>Failed：0<br />Unavaliable：0 | 0      |
| openGauss 6.0.0 build ac5a43ad | 24 | Passed：23<br/>Failed：0<br />Unavaliable：1 | 0 |

*数据项说明：*

1.测试过程中未发现问题，资料单1个，不计入缺陷密度，缺陷密度为0(缺陷个数)/1.361k(代码行数)=0(个/kloc)

## 4.3   后续测试建议

无

# **5     附件**

无

****

