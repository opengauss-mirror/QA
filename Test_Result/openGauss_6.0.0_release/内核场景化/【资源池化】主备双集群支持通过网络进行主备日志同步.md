![avatar](../../../images/openGauss.png)

版权所有 © 2023  openGauss社区
 您对“本文档”的复制、使用、修改及分发受知识共享(Creative Commons)署名—相同方式共享4.0国际公共许可协议(以下简称“CC BY-SA 4.0”)的约束。为了方便用户理解，您可以通过访问https://creativecommons.org/licenses/by-sa/4.0/ 了解CC BY-SA 4.0的概要 (但不是替代)。CC BY-SA 4.0的完整协议内容您可以访问如下网址获取：https://creativecommons.org/licenses/by-sa/4.0/legalcode。

修订记录

| 日期      | 修订版本 | 修改描述     | 作者    |
| --------- | -------- | ------------ | ------- |
| 2024-3-22 | 1.0      | 测试报告初版 | haomeng |
|           |          |              |         |

关键词：资源池化，流复制，容灾

摘要：金融、银行业对数据的安全有着较高的要求，当生产中心发生断网、停电、火灾等情况下，需要保证数据的安全性以及服务的可用性，因此需要采用双集群的高可用方案。本文档主要验证测试了openGauss资源池化支持网络同步日志的容灾双集群。

 

缩略语清单：

| 缩略语 | 英文全名                    | 中文解释       |
| ------ | --------------------------- | -------------- |
| CM     | Cluster Manager             | 集群管理       |
| DMS    | Distributed Memory Service  | 分布式内存服务 |
| DSS    | Distributed Storage Service | 分布式存储服务 |

# 1     特性概述

​		金融、银行业对数据的安全有着较高的要求，当生产中心发生断网、停电、火灾等情况下，需要保证数据的安全性以及服务的可用性，因此需要采用双集群的高可用方案，在主集群出现故障的情况下，备集群的数据还具备能继续提供服务的能力。本特性的主要目的是基于openGauss集成DMS和DSS组件的前提下，支持网络双集群同步能力，即主集群具有一写多读能力的同时，若出现故障，备集群的数据还能继续提供服务，并且任意中心发生故障不影响数据一致性。



# 2     特性测试信息

| 版本名称                       | 测试起始时间 | 测试结束时间 |
| ------------------------------ | ------------ | ------------ |
| openGauss 6.0.0 build 4614510e | 2024-01-17   | 2024-01-23   |
| openGauss 6.0.0 build 84d3e26c | 2024-01-24   | 2024-01-30   |
| openGauss 6.0.0 build 6ac150e6 | 2024-01-31   | 2024-02-06   |
| openGauss 6.0.0 build b8fc2278 | 2024-02-08   | 2024-02-20   |
| openGauss 6.0.0 build a73bec27 | 2024-02-28   | 2024-03-07   |
| openGauss 6.0.0 build 10937281 | 2024-03-08   | 2024-03-13   |

| 环境信息                              | 配置信息                                                     | 备注      |
| ------------------------------------- | ------------------------------------------------------------ | --------- |
| 服务端<br />Taishan 200（Model 2280） | CPU：Kunpeng 920<br />内存：256GB<br />数据盘：2\*3.2TB NVME SSD<br />文件系统：EXT4<br />网卡：2\*25GE | 计算侧3+3 |
| 存储侧<br />OceanStore                | Dorado 18500 V6                                              |           |

   

# 3     测试结论概述

## 3.1   测试整体结论

共计执行66个用例，主要覆盖了功能测试、可靠性测试，性能&稳定性测试，资料测试；发现问题11个，已解决10个，回归通过，无遗留风险，整体质量一般，后续因特性融合场景，禁掉了部分功能，删减测试用例2个；

| 测试活动   | 活动评价                                                     |
| ---------- | ------------------------------------------------------------ |
| 功能测试   | （1）网络复制资源池化容灾双集群安装部署搭建流程；<br />（2）主备集群间支持全量build；<br />（3）主集群支持一写多读，备集群不支持写且各节点保持读一致性； |
| 可靠性测试 | （1）build重入以及build过程中实例、网络等其他异常；<br />（2）集群内切换，switchover和failover（包含主集群内切换和备集群内切换，当前备集群内切换只支持failover）；<br />（3）集群间切换，switchover和failover；<br />（4）集群间和集群内切换交互测试； |
| 性能测试   | 性能进行摸底测试，77w tpmc                                   |
| 稳定性测试 | 预置500仓数据，主集群读写，备集群只读，业务执行12H           |
| 资料测试   | 新增参数ss_stream_cluster，修改参数ss_double_cluster_mode，新增网络双集群部署流程 |

## 3.2   约束说明

（1）至少2+2计算节点；

（2）2套Dorado存储设备；

## 3.3   遗留问题分析

### 3.3.1 遗留问题影响以及规避措施

| 问题单号 | 问题描述 | 问题级别 | 问题影响和规避措施 | 当前状态 |
| -------- | -------- | -------- | ------------------ | -------- |
| N/A      |          |          |                    |          |

### 3.3.2 问题统计

|        | 问题总数 | 严重 | 主要 | 次要 | 不重要 |
| ------ | -------- | ---- | ---- | ---- | ------ |
| 数目   | 11       | 0    | 3    | 7    | 1      |
| 百分比 | 100%     | 0%   | 27%  | 64%  | 9%     |

### 3.3.3 问题单汇总

| 序号 | issue号 | 问题级别 | 问题简述                                                     | 问题状态 |
| ---- | ------- | -------- | ------------------------------------------------------------ | -------- |
| 1    | I8XJHK  | 主要     | 【资源池化】网络双集群部署，备集群build完成之后拉起失败，备集群写入文件导致页面损坏 | 已验收   |
| 2    | I8Y1IT  | 主要     | 【资源池化】网络双集群，主集群内failover后，新主节点执行业务阻塞，与备集群流复制关系异常 | 已验收   |
| 3    | I91RPL  | 次要     | 【资源池化】TPCC运行中进行网络隔离，备集群状态异常           | 已验收   |
| 4    | I94TAY  | 次要     | 【资源池化】网络双集群，主集群内failover之后被集群首备产生invalid max offset number的core | 已验收   |
| 5    | I94HXB  | 不重要   | 网络上集群新增参数ss_stream_cluster更新错误                  | 已验收   |
| 6    | I98EH5  | 次要     | 【资源池化】网络双集群，主集群执行读写业务，备集群首备WAL segment removed，报错Unknown error 2190 | 已验收   |

非本特性引入问题

| 序号 | issue号 | 问题级别 | 问题简述                                                     | 问题状态 |
| ---- | ------- | -------- | ------------------------------------------------------------ | -------- |
| 1    | I9245M  | 主要     | 【资源池化】网络双集群，主集群执行业务过程中备集群产生[SS redo] buffer should be found的core | 已验收   |
| 2    | I8ZMI4  | 次要     | 【资源池化】资源池化一主多备场景下，om方式安装后synchronous_standby_nams为非默认值，会影响网络容灾集群使用 | 已验收   |
| 3    | I97VGS  | 次要     | 【资源池化】资源池化双集群，集群间切换执行gs_ctl failover后原首备core，备集群可写状态下禁止写入 | 已验收   |
| 4    | I98WHG  | 次要     | 【资源池化】双集群中集群间切换之后，主集群内已开启的按需回放/实时构建特性在新备集群内不可用，导致新备集群首备coredump | 已验收   |
| 5    | I94H78  | 次要     | 【资源池化】debug版本，开启按需回放实时构建，failover build期间，备机core，关键字：MarkSegPageRedoChildPageDirty | 待办的   |



# 4     测试执行

## 4.1   测试执行统计数据

| 版本名称                       | 测试用例数 | 用例执行结果         | 发现问题单数 |
| ------------------------------ | ---------- | -------------------- | ------------ |
| openGauss 6.0.0 build 4614510e | 20         | Passed：22 Failed：1 | 1            |
| openGauss 6.0.0 build 84d3e26c | 15         | Passed：14 Failed：1 | 1            |
| openGauss 6.0.0 build 6ac150e6 | 10         | Passed：7 Failed：3  | 3            |
| openGauss 6.0.0 build b8fc2278 | 6          | Passed：6 Failed：0  | 0            |
| openGauss 6.0.0 build a73bec27 | 3          | Passed：1 Failed：2  | 2            |
| openGauss 6.0.0 build 10937281 | 12         | Passed：10 Failed：2 | 2            |

**数据项说明：**

- 测试用例数：到本测试活动结束时，所有可用测试用例数；
- 发现问题单数：本测试活动所有用例总共发现的问题单数；
- 用例执行结果：整体执行6个转测版本，涉及阻塞问题回归验收后再次进行后续测试；
- 缺陷密度为：4/1.3Kloc=3.0(个/Kloc)

## 4.2   后续测试建议

* 因测试周期及时间问题，后续所有测试场景需进行多次测试及大数据量加压测试；
* 针对实际业务场景，需要合理的调整某些数据库系统参数配置以达到合理的应用效果；



# 5     附件

## 5.1   特性新增参数

- ss_stream_cluster：控制是否开启资源池化网络双集群特性。
- ss_double_cluster_mode：资源池化双集群场景下数据库集群的启动方式。

## 5.2   特性相关PR

* https://e.gitee.com/opengaussorg/repos/opengauss/openGauss-server/pulls/4392
* https://e.gitee.com/opengaussorg/repos/opengauss/CM/pulls/172
* https://e.gitee.com/opengaussorg/repos/opengauss/docs/pulls/6108

