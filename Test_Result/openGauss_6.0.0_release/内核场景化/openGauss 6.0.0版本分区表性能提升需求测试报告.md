![avatar](../../../images/openGauss.png)

版权所有 © 2024  openGauss社区
 您对“本文档”的复制、使用、修改及分发受知识共享(Creative Commons)署名—相同方式共享4.0国际公共许可协议(以下简称“CC BY-SA 4.0”)的约束。为了方便用户理解，您可以通过访问https://creativecommons.org/licenses/by-sa/4.0/ 了解CC BY-SA 4.0的概要 (但不是替代)。CC BY-SA 4.0的完整协议内容您可以访问如下网址获取：https://creativecommons.org/licenses/by-sa/4.0/legalcode。

修订记录

| 日期     | 修订版本 | 修改描述                                              | 作者    |
| -------- | -------- | ----------------------------------------------------- | ------- |
| 2024.3.2 | 1.0      | openGauss 6.0.0版本分区表性能提升需求测试报告初稿完成 | liutong |

 关键词：分区表、性能、tpmC



摘要：

 本文对openGauss 6.0.0版本分区表性能提升需求模式测试情况进行详细说明，并给出最终测试结论。



缩略语清单：

| 缩略语 | 英文全名 | 中文解释 |
| ------ | -------- | -------- |
|        |          |          |

# 1     特性概述

本特性从6.0.0版本开始对分区表性能进行性能优化，包括tpcc模型导入时间缩短、并发测试性能提升，以及对分区表执行查询、插入、指定分区插入等操作的性能提升。

# 2     特性测试信息

本节描述被测对象的版本信息和测试的时间及测试轮次，包括依赖的硬件。

| 版本名称             | 测试起始时间 | 测试结束时间 |
| -------------------- | ------------ | ------------ |
| openGauss 6.0.0 RC05 | 2024-2-19    | 2024-2-21    |
| openGauss 6.0.0 RC06 | 2024-2-22    | 2024-2-28    |
| openGauss 6.0.0 RC07 | 2024-2-29    | 2024-3-2     |

硬件环境信息：

| 硬件型号                                                     | 硬件配置信息                                                 | 备注 |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ---- |
| ARM+openEuler 2P<br />TaiShan 200 (Model 2280 7260)          | CPU：Kunpeng-920 2p 128核<br />内存：768G<br />硬盘：NVME 3.7T * 4<br />OS：openEuler release 20.03 (LTS)<br />文件系统：XFS<br />网卡：4*25GE Hi1822 |      |
| 加压端：<br />ARM+openEuler 2P<br />TaiShan 200 (Model 2280 7260) | CPU：Kunpeng-920 2p 128核<br />内存：256G<br />OS：openEuler release 20.03 (LTS)<br />网卡：4*25GE Hi1822 **(与数据库端在同一个交换机)** |      |

OS版本说明如下：

| 操作系统  | OS版本      | 版本说明                                                     |
| --------- | ----------- | ------------------------------------------------------------ |
| OpenEuler | 20.03 (LTS) | openEuler 20.03 (LTS)，aarch版本ISO:<br />SHA256:419592be9cba55a2b800e761d865550f28133875920e7bb9c2d5cdaad90a9cbf |

# 3     测试结论概述

## 3.1   测试整体结论

分区表性能提升需求共计执行5个用例，主要覆盖了tpcc模型导入时间缩短、并发测试性能提升，以及对分区表执行查询、插入、指定分区插入等操作性能提升，共发现0个问题单，整体质量良好。

| 测试活动                                                     | 活动评价                                                     |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| 在数据库中建立3000分区的分区表，执行tpcc数据导入，查看master版本tpcc数据导入时间是否小于30分钟，是否比5.0.0版本所需时间缩短 | 在数据库中建立3000分区的分区表，之后执行tpcc数据导入并统计导入时间。master版本导入时间为1410s，5.0.0版本导入时间为1619s。tpcc数据导入时间小于30分钟且导入时间缩短为原来的87%，符合预期。 |
| 在数据库中建立3000分区的分区表，执行tpcc性能测试，查看master版本是否比5.0.0版本tpcc性能测试数据提升超过10w | 在数据库中建立3000分区的分区表，之后进行tpcc性能测试。1000仓800并发，master版本tpcc性能值为55.0w，5.0.0版本tpcc性能值为41.1w。tpcc性能相比5.0.0版本性能提升13.9w，符合预期。 |
| 对5000分区的分区表执行分区表查询语句，和5.0.0版本进行对比，查看master版本是否比5.0.0版本耗时缩短30%以上 | 在数据库中建立5000分区的分区表，之后执行分区表查询语句100000次。<br />单分区键场景下master版本耗时66.274s，5.0.0版本183.175s，耗时缩短63.8%。<br />多分区键场景下73.425s，5.0.0版本202.717s，耗时缩短63.7%，符合预期。 |
| 对4370分区的分区表执行分区表插入语句和分区表指定分区插入语句，查看master版本总耗时是否小于15s，是否比5.0.0版本耗时缩短30%以上 | 在数据库中建立4370分区的分区表，分别执行分区表插入语句和分区表指定分区插入语句。<br />执行分区表插入语句，master版本耗时8.948s，小于15s，5.0.0版本耗时29.688s，耗时缩短69.8%，符合预期。<br />执行分区表指定分区插入语句，master版本耗时8.965s，小于15s，5.0.0版本耗时29.706s，时间缩短69.8%，符合预期。<br /> |

### 

## 3.2   约束说明

（1）本报告中的各场景测试结果中的处理时间，指的是openGauss的处理时间，不包含其他第三方业务的处理时间；

（2）本次性能测试是在实验室网络环境下，搭建测试环境并进行的性能测试，网络条件较稳定，不考虑现网与实验室的网络条件差异；

（3）本报告中，使用benchmarkSQL工具模拟压力场景，代表的仅是已知业务模型，没有特殊业务场景，不能代表在现网复杂场景下的实际处理能力；

（4）本次测试是在固定的网络、物料、软件版本等配套的前提下进行的，如果实际环境与本次测试存在不同，请自行评估性能差异，本次测试环境具体情况，请参考第二章节。

## 3.3   问题分析

### 3.3.1 遗留问题影响以及规避措施

| 问题单号 | 问题描述 | 问题级别 | 问题影响和规避措施 | 当前状态 |
| -------- | -------- | -------- | ------------------ | -------- |
|          |          |          |                    |          |

### 3.3.2 问题统计

|        | 问题总数 | 严重 | 主要 | 次要 | 不重要 |
| ------ | -------- | ---- | ---- | ---- | ------ |
| 数目   | 0        | 0    | 0    | 0    | 0      |
| 百分比 | 0%       | 0%   | 0%   | 0%   | 0%     |

### 3.3.3 问题单汇总

| 序号 | issue号 | 问题级别 | 问题简述 | 问题状态 |
| ---- | ------- | -------- | -------- | -------- |
|      |         |          |          |          |

# 4     测试执行

## 4.1   测试结果

### 4.1.1 tpcc数据导入性能测试

| 测试步骤                                                     | 测试结果                                                     |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| 1、部署master版本数据库，设置高性能参数，并附加以下参数：<br />local_syscache_threshold = 512MB<br />global_syscache_threshold = 1GB<br />thread_pool_attr = '800,4,(cpubind:1-28,32-60,64-92,96-124)'<br />autovacuum=false<br />num_internal_lock_partitions='CLOG_PART=256,CSNLOG_PART=512,<br />LOG2_LOCKTABLE_PART=4,TWOPHASE_PART=1,FASTPATH_PART=80'<br />之后在数据库中建立3000分区的分区表<br />2、修改benchmarksql工具的runDatabasebuild.sh文件，BEFORE_LOAD和AFTER_LOAD参数置为空。<br />3、执行./runDatabasebuild.sh test_3000_parts.pg导入1000仓数据，记录执行时间<br />4、对5.0.0版本数据库依次执行步骤1-3<br />5、对两次的时间进行对比，查看master版本tpcc数据导入时间是否小于30分钟，是否比5.0.0版本所需时间缩短 | master版本导入时间为1410s，5.0.0版本导入时间为1619s。tpcc数据导入时间小于30分钟且导入时间缩短为原来的87%，符合预期。 |

### 4.1.2 tpcc性能测试

| 测试步骤                                                     | 测试结果                                                     |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| 1、部署master版本数据库，设置高性能参数，并附加以下参数：<br />local_syscache_threshold = 512MB<br />global_syscache_threshold = 1GB<br />thread_pool_attr = '800,4,(cpubind:1-28,32-60,64-92,96-124)'<br />autovacuum=false<br />num_internal_lock_partitions='CLOG_PART=256,CSNLOG_PART=512,<br />LOG2_LOCKTABLE_PART=4,TWOPHASE_PART=1,FASTPATH_PART=80'<br />之后在数据库中建立3000分区的分区表<br />2、导入1000仓数据、建立索引<br />3、800并发下执行1h的tpcc性能测试<br />4、对5.0.0版本数据库依次执行步骤1-3<br />5、对两次的性能值进行对比，查看master版本tpcc性能测试数据是否比5.0.0版本提升超过10w | 1000仓800并发下，master版本tpcc性能值为55.0w，5.0.0版本tpcc性能值为41.1w。tpcc性能相比5.0.0版本性能提升13.9w，符合预期。 |

### 4.1.3 分区表查询性能测试

| 测试步骤                                                     | 测试结果                                                     |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| 1、部署master版本数据库，设置高性能参数，并附加以下参数：<br />local_syscache_threshold = 512MB<br />global_syscache_threshold = 1GB<br />thread_pool_attr = '800,4,(cpubind:1-28,32-60,64-92,96-124)'<br />autovacuum=false<br />num_internal_lock_partitions='CLOG_PART=256,CSNLOG_PART=512,<br />LOG2_LOCKTABLE_PART=4,TWOPHASE_PART=1,FASTPATH_PART=80'<br />之后建立5000分区的单分区键的list分区表<br />2、通过pgbench执行100000次分区表查询并统计总时间<br />3、建立5000分区的多分区键的list分区表，并通过pgbench执行100000次分区表查询并统计总时间<br />4、对5.0.0版本数据库依次执行步骤1-3<br />5、对master版本和5.0.0版本的耗时进行对比，查看master版本是否比5.0.0版本耗时缩短30%以上 | 在数据库中建立5000分区的分区表，之后执行分区表查询语句100000次。<br />单分区键场景下master版本耗时66.274s，5.0.0版本耗时183.175s，时间缩短63.8%。<br />多分区键场景下master版本耗时73.425s，5.0.0版本耗时202.717s，时间缩短63.7%，符合预期。 |

### 4.1.4 分区表插入语句性能测试

| 测试步骤                                                     | 测试结果                                                     |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| 1、部署master版本数据库，设置高性能参数，并附加以下参数：<br />local_syscache_threshold = 512MB<br />global_syscache_threshold = 1GB<br />thread_pool_attr = '800,4,(cpubind:1-28,32-60,64-92,96-124)'<br />autovacuum=false<br />num_internal_lock_partitions='CLOG_PART=256,CSNLOG_PART=512,<br />LOG2_LOCKTABLE_PART=4,TWOPHASE_PART=1,FASTPATH_PART=80'<br />之后建立总计4370分区的list-list分区表<br />2、执行分区表插入语句并统计时间<br />3、执行分区表指定插入语句并统计时间<br />4、对5.0.0版本数据库依次执行步骤1-3<br />5、对master版本和5.0.0版本的耗时进行对比，查看master版本总耗时是否小于15s，是否比5.0.0版本耗时缩短30%以上 | 在数据库中建立4370分区的分区表，分别执行分区表插入语句和分区表指定分区插入语句。<br />执行分区表插入语句，master版本耗时8.948s，小于15s，5.0.0版本耗时29.688s，耗时缩短69.8%，符合预期。<br />执行分区表指定分区插入语句，master版本耗时8.965s，小于15s，5.0.0版本耗时29.706s，时间缩短69.8%，符合预期。<br /> |



## 4.2   测试执行统计数据

| 版本名称             | 测试用例数 | 用例执行结果           | 发现问题单数 |
| -------------------- | ---------- | ---------------------- | ------------ |
| openGauss 6.0.0 RC05 | 1          | Passed:1<br />Failed:0 | 0            |
| openGauss 6.0.0 RC06 | 5          | Passed:5<br />Failed:0 | 0            |
| openGauss 6.0.0 RC07 | 5          | Passed:5<br />Failed:0 | 0            |

###### 数据项说明：

首轮测试用例执行5个，通过5个。

本需求缺陷密度为0(缺陷个数)/2.506k(代码行数)=0(个/kloc)。

## 4.3   后续测试建议

无

# 5     附件

*无*

 



 

 
