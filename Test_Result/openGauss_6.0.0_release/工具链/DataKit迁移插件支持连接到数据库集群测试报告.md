![avatar](../../images/openGauss.png)

版权所有 © 2024  openGauss社区
 您对“本文档”的复制、使用、修改及分发受知识共享(Creative Commons)署名—相同方式共享4.0国际公共许可协议(以下简称“CC BY-SA 4.0”)的约束。为了方便用户理解，您可以通过访问[*https://creativecommons.org/licenses/by-sa/4.0/*](https://creativecommons.org/licenses/by-sa/4.0/) 了解CC BY-SA 4.0的概要 (但不是替代)。CC BY-SA 4.0的完整协议内容您可以访问如下网址获取：[*https://creativecommons.org/licenses/by-sa/4.0/legalcode*](https://creativecommons.org/licenses/by-sa/4.0/legalcode)。

修订记录

| 日期      | 修订版本 | 修改描述 | 作者   |
| --------- | -------- | -------- | ------ |
| 2024/8/13 | 1.0      |          | 姚雨驰 |

[TOC]

**Keywords 关键词**：*XX*

**Abstract 摘要**：*给出本阶段的测试范围、结果、分析及质量评价，同时对测试活动进行回顾总结。*

**缩略语清单： **

| 缩略语 | 英文全名 | 中文解释 |
| ------ | -------- | -------- |
| 无     |          |          |

***


# 1 概述

DataKit迁移插件支持通过关联资源中心连接到数据库集群，将集群所有节点IP连接串下发到增量迁移和反向迁移工具，确保主机故障时可自动轮询切换到新主节点

# 2 测试版本说明

*本章节描述测试版本的基本信息*，*包括测试对象是什么，以及在什么环境下开展的测试，具体包括被测版本、周边配套版本、平台版本和测试环境*。

*描述被测对象的版本信息和测试的时间及测试轮次*。

## 2.1 测试版本信息

###   2.1.1 被测版本

*本节描述每轮被测对象的版本信息（若使用了补丁，补丁版本号不能遗漏)；描述测试的时间、地点和测试人员。建议使用以下表格说明，可自行增减表中字段*

| 版本名称               | 软件包名称    | 测试起始时间 | 测试结束时间 | 测试人员 |
| ---------------------- | ------------- | ------------ | ------------ | -------- |
| build time: 2024-07-28 | datakit-6.0.0 | 2024-08-01   | 2024-08-12   | 姚雨驰   |

###  2.1.2 配套测试的版本

*描述发布版本所涉及到的配套版本信息，包括配套产品版本、配套工具版本、内嵌平台配套版本等。针对版本配套表中唯一版本的，可简略说明，如果不唯一或是市场一线的特别要求，就要注明主要的相关产品配套版本信息（不支持或支持的特殊性等）。建议使用以下表格说明，可自行增减表中字段*

| 版本名称                                       | 配套版本        | 版本说明 |
| ---------------------------------------------- | --------------- | -------- |
| openGauss-datakit-6.0.0 build time: 2024-07-28 | openGauss 6.0.0 |          |

## 2.2 测试环境描述

*描述本次测试的测试环境（包括记录所使用工具、环境软硬件版本信息，环境组网配置信息， 测试仪器及辅助设备等）*。

*记录所使用的测试工具中的软件和单板硬件版本信息。*

*记录使用到的测试仪器及辅助设备，说明其型号和规格。记录环境组网配置信息。*

*建议使用以下表格说明，可自行增减表中字段*

###  2.2.1 环境硬件信息

| 环境信息                                                     | 硬件型号          | 硬件配置信息                                                 | 备注 |
| ------------------------------------------------------------ | ----------------- | ------------------------------------------------------------ | ---- |
| 20.20.20.79<br />20.20.20.56<br />20.20.20.117<br />20.20.20.115 | aarch64+openEuler | CPU：Kunpeng-920<br />内存：765Gi<br />硬盘：2.9T<br />OS：openEuler release 20.03 (LTS) |      |

# 3 版本概要测试结论、关键风险和规避措施

## 3.1 测试结论总结

DataKit迁移插件支持连接到数据库集群需求测试累计发现4个缺陷，已验收4个，总体质量良好

## 3.2 约束说明

1-要求设置openGauss的guc参数`enable_slot_log=on`，以支持主备数据之间之间逻辑复制槽同步。否则可能会出现历史主节点数据因数据量过大，导致主节点发生切换前，未全部反向迁移，新的主节点启动后，原主节点未来得及迁移的数据丢失的情况。
2-由于需要保证主备切换时主备间逻辑复制槽的一致性，需要配置debezium的`opengauss-source.properties`配置文件中`slot.drop.on.stop=false`，此参数用于控制重连时是否删除上一次连接时的逻辑复制槽，默认为true。当然使用datakit数据迁移时无需手动配置此参数，datakit会自动配置。但是使用portal和debezium进行迁移时，需要手动配置。

## 3.3 关键风险和规避措施

无

# 4 版本详细测试结论

*本章节针对总体测试策略计划的测试内容，给出详细的测试结论。*

## 4.1 特性测试结论

###   4.1.1 新需求质量评价

*建议以表格的形式汇总本阶段新特性的商用化建议（此章节除了考虑可靠性、性能、开源等风险评估之外，还需考虑基础特性安全与隐私风险），如下表格所示。*

*下表仅供参考，不作为强制输出方式。*

| 特性                                    | 特性价值评估 | 应用说明及关键约束假设依赖                                   | 关键遗留事项如缺陷等 | 测试整体覆盖情况 | 特性质量评估               | 主要风险 |
| --------------------------------------- | ------------ | ------------------------------------------------------------ | -------------------- | ---------------- | -------------------------- | -------- |
| **DataKit迁移插件支持连接到数据库集群** | 满足         | 1-要求设置openGauss的guc参数`enable_slot_log=on`，以支持主备数据之间之间逻辑复制槽同步。否则可能会出现历史主节点数据因数据量过大，导致主节点发生切换前，未全部反向迁移，新的主节点启动后，原主节点未来得及迁移的数据丢失的情况。<br/>2-由于需要保证主备切换时主备间逻辑复制槽的一致性，需要配置debezium的`opengauss-source.properties`配置文件中`slot.drop.on.stop=false`，此参数用于控制重连时是否删除上一次连接时的逻辑复制槽，默认为true。当然使用datakit数据迁移时无需手动配置此参数，datakit会自动配置。但是使用portal和debezium进行迁移时，需要手动配置。 | 暂不支持增量迁移     | 良好             | <font color=green>▮</font> | 无       |



# 5 测试对象质量评估

##  5.1 覆盖率分析

本次测试覆盖的对象有datakit反向迁移，portal反向迁移，debezium反向迁移，这些对象查询结果验证功能与需求相符，异常情况有合理报错。

##  5.2 缺陷统计和分析

*给出各特性或模块缺陷的分布或分类统计以及缺陷走势分析。建议通过表格说明，下表仅供参考，不作为强制输出方式*

###   5.2.1 缺陷统计

|        | 问题总数 | 严重 | 主要 | 次要 | 不重要 |
| ------ | -------- | ---- | ---- | ---- | ------ |
| 数目   | 4        | 0    | 1    | 3    | 0      |
| 百分比 | 100%     | 0%   | 25%  | 75%  | 0%     |

###   5.2.2 缺陷列表

| 序号 | issue号                                                      | 问题级别 | 问题简述                                                     | 问题状态 |
| ---- | ------------------------------------------------------------ | -------- | ------------------------------------------------------------ | -------- |
| 1    | [IAHMHP](https://e.gitee.com/opengaussorg/issues/table?issue=IAHMHP) | 次要     | 【测试类型：工具功能】【datakit迁移】创建迁移任务时opengauss5.0.3版本单机环境无法显示database信息 | 已验收   |
| 2    | [IAHN22](https://gitee.com/opengauss/openGauss-workbench/issues/IAHN22?from=project-issue) | 主要     | 【测试类型：工具功能】【datakit迁】反向迁移过程中主备切换，迁移数据缺失 | 已验收   |
| 3    | [IAIQWK](https://e.gitee.com/opengaussorg/issues/table?issue=IAIQWK) | 次要     | 【测试类型：工具功能】【datakit迁移】反向迁移过程中kill -9数据库主节点进程，迁移工具无法重连到数据库 | 已验收   |
| 4    | [IAJBTH](https://e.gitee.com/opengaussorg/issues/table?issue=IAJBTH) | 次要     | 【测试类型：工具功能】【datakit反向迁移】guc参数wal_sender_timeout默认值为6，反向迁移过程中主备切换偶现报错中断迁移，需要调大 | 已验收   |

# 6 测试过程评估

*本章节对测试过程进行评估，包括测试策略、测试设计和测试执行，目的是审视测试过程的执行情况，分析有待进一步开展测试和需要改进的地方。*

##  6.1 测试策略回顾

*回顾本阶段的测试策略，建议以表格的方式检查测试策略规定的活动是否都已经落实。*

| 编号 | 特性     | 验证策略                                                     | 是否按照测试策略执行 |
| ---- | -------- | ------------------------------------------------------------ | -------------------- |
| 1    | 功能测试 | 功能测试与需求相符，对于边界值等异常情况给出合理报错，执行结果符合预期 | YES                  |

##  6.2 测试设计评估

*提供对本次测试活动的测试设计的评估。可结合测试设计评审建议；评审完成，测试过程中，发现的新增或删减的测试点进行说明。*

| 编号 | 测试点修改说明             | 修改原因                                                   | 是否影响测试质量 |
| ---- | -------------------------- | ---------------------------------------------------------- | ---------------- |
| 1.   | 增加集群反复切换主备测试点 | 受wal_sender_timeout参数影响，主备同步时间超时后会影响迁移 | 否               |

##  6.3 测试执行评估

*提供对本次测试活动的测试执行过程的评估结论。描述对测试执行活动的改进建议，以供后续测试执行活动中借鉴参考；*

*测试执行活动评估结论可依据以下提供的“测试执行统计数据”及“测试用例执行结果统计数据”进行分析而给出。*

###  6.3.1 测试执行统计数据

| 版本名称                | 工作量投入(人天) | 测试用例数 | 用例执行数 | 发现缺陷数 | 总代码行数 | 缺陷密度 |
| ----------------------- | ---------------- | ---------- | ---------- | ---------- | ---------- | -------- |
| openGauss-datakit-6.0.0 | 10               | 31         | 31         | 4          | 666        | 6/kloc   |

###  6.3.2 测试用例执行结果统计数据

*对本次测试用例执行结果统计，其中的字段可根据实际情况进行设计和裁剪。对于Failed，Blocked，Unavailable的测试用例项不为0，须给出说明，并明确相应的后续计划（如：对于物料问题导致未执行用例，则需明确相应的物料计划；对于Blocked用例，需明确问题解决与相应版本的测试时间等）。对于最后一轮测试，要给出相应的规避措施。*

| 总测试用例数 | 实际测试的用例数 | Passed | Failed | Blocked | Unavailable | 执行率 | 执行通过率 |
| ------------ | ---------------- | ------ | ------ | ------- | ----------- | ------ | ---------- |
| 31           | 31               | 100%   | 0      | 0       | 0           | 100%   | 100%       |

# 7 附件

##  7.1 附件1：遗留问题列表

无

##  7.2 附件2：特性相关PR

*提供本需求相关的代码pr及资料pr*

源代码pr：

**数据迁移适配连接openGuass集群**：https://e.gitee.com/opengaussorg/repos/opengauss/openGauss-workbench/pulls/737

**portal适配连接openGaus数据库集群**：https://e.gitee.com/opengaussorg/repos/opengauss/openGauss-migration-portal/pulls/148

**反向迁移适配连接openGuass数据库集群**：https://e.gitee.com/opengaussorg/repos/opengauss/debezium/pulls/247

**连接openGauss数据库时，支持配置测试连接次数**：https://e.gitee.com/opengaussorg/repos/opengauss/debezium/pulls/250

**连接数据库集群时，增加前置校验逻辑复制槽主备同步参数是否打开**:https://e.gitee.com/opengaussorg/repos/opengauss/openGauss-migration-portal/pulls/151

**适配数据迁移前置校验增加逻辑复制主备同步参数**：https://e.gitee.com/opengaussorg/repos/opengauss/openGauss-workbench/pulls/766

**实现反向迁移重连openGauss时不删除逻辑复制槽**：https://e.gitee.com/opengaussorg/repos/opengauss/debezium/pulls/254

**DataKit发送连接集群的迁移任务时，不再配置反向迁移结束时，debezium不删除逻辑复制槽**：https://e.gitee.com/opengaussorg/repos/opengauss/openGauss-workbench/pulls/772

**补充连接数据库集群特性说明文档**https://e.gitee.com/opengaussorg/repos/opengauss/openGauss-workbench/pulls/808
